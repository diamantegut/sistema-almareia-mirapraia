Baseado na auditoria do cÃ³digo fonte, identifiquei a causa raiz dos problemas relatados: a lÃ³gica de caixa estÃ¡ **fragmentada e duplicada** nos controladores (`routes.py`), ignorando o serviÃ§o central (`CashierService`) que deveria gerenciar essas regras.

### ğŸ” DiagnÃ³stico dos Problemas (Auditoria)

1.  **ViolaÃ§Ã£o de InstÃ¢ncia Ãšnica**:
    *   As rotas do Restaurante e RecepÃ§Ã£o criam sessÃµes manualmente (ex: `sessions.append(new_session)`), ignorando a verificaÃ§Ã£o `get_active_session` do `CashierService`. Isso permite que mÃºltiplos caixas do mesmo tipo sejam abertos se o sistema falhar em detectar o estado anterior.
2.  **Falta de ValidaÃ§Ã£o de Saldo (Sangria)**:
    *   As operaÃ§Ãµes de "Sangria" e "Suprimento" sÃ£o feitas manualmente nas rotas, sem nenhuma verificaÃ§Ã£o se o saldo resultante serÃ¡ negativo. O `CashierService` possui lÃ³gica para transferÃªncias, mas nÃ£o estÃ¡ sendo usado consistentemente para saques simples.
3.  **TransferÃªncias Inconsistentes**:
    *   O **Caixa de Reservas** (Hotel) sequer possui a funcionalidade de transferÃªncia implementada em sua rota.
    *   O **Caixa do Restaurante** chama `CashierService.transfer_funds`, mas o contexto manual ao redor pode gerar estados de erro nÃ£o tratados.
4.  **CÃ³digo Duplicado e FrÃ¡gil**:
    *   Cada rota (`restaurant`, `reception_cashier`, `reception_reservations`) reimplementa a lÃ³gica de abrir/fechar/somar, criando 3 versÃµes diferentes da mesma regra de negÃ³cio.

---

### ğŸ› ï¸ Plano de CorreÃ§Ã£o e PadronizaÃ§Ã£o

#### 1. Fortalecimento do `CashierService` (NÃºcleo)
*   **Implementar ValidaÃ§Ã£o de Saldo**: Adicionar verificaÃ§Ã£o obrigatÃ³ria de saldo positivo antes de qualquer operaÃ§Ã£o de dÃ©bito (`add_transaction` com tipo `out` ou `withdrawal`).
*   **Padronizar IDs**: Unificar o formato de ID de sessÃ£o (atualmente misturado entre `SESSION_`, `CASHIER_REST_` e `REC_RES_`).
*   **Suporte a CNPJ**: Adicionar metadados explÃ­citos de "Entidade" (Hotel vs Restaurante) na criaÃ§Ã£o da sessÃ£o.

#### 2. RefatoraÃ§Ã£o das Rotas (IntegraÃ§Ã£o)
Vou reescrever as rotas de caixa (`restaurant`, `reception`, `reservations`) para que **deleguem 100% da lÃ³gica** para o `CashierService`.
*   **Abertura**: Substituir criaÃ§Ã£o manual por `CashierService.open_session()`.
*   **MovimentaÃ§Ã£o**: Substituir appends manuais por `CashierService.add_transaction()`.
*   **TransferÃªncia**: Implementar/Corrigir a chamada `CashierService.transfer_funds()` em todos os 3 caixas.

#### 3. ImplementaÃ§Ã£o do Caixa de Reservas (Hotel)
*   Ativar plenamente o "Terceiro Caixa" com as mesmas capacidades dos demais (Suprimento, Sangria, TransferÃªncia), garantindo a segregaÃ§Ã£o financeira do Hotel.

#### 4. Testes de ValidaÃ§Ã£o
*   Criarei um script de teste automatizado (`tests/test_cashier_scenarios.py`) para simular:
    *   Tentativa de abrir 2 caixas do mesmo tipo (deve falhar).
    *   Tentativa de sangria maior que o saldo (deve falhar).
    *   Ciclo completo de transferÃªncia: Restaurante -> RecepÃ§Ã£o -> Reservas.

Este plano garante que todos os caixas obedeÃ§am Ã s mesmas regras estritas, eliminando inconsistÃªncias e garantindo a integridade financeira.
