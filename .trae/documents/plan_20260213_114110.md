
# Plano de Correção e Melhoria do Mapa de Reservas (Recepção)

Este plano detalha as correções técnicas para resolver as falhas críticas no mapa de reservas, focando em usabilidade (Drag & Drop horizontal), integridade de dados (validação de conflitos e preços) e experiência do usuário (Ficha de Hóspede).

## 1. Backend (Lógica de Negócio e API)

### 1.1. Novo Endpoint de Cálculo e Validação
Criar um endpoint unificado `/api/reception/calculate_reservation_update` que será chamado **antes** de confirmar qualquer alteração (mover ou redimensionar).
*   **Input:** `reservation_id`, `new_room` (opcional), `new_checkin` (opcional), `new_checkout` (opcional).
*   **Lógica:**
    *   Verificar conflitos de disponibilidade (Quarto ocupado ou reservado).
    *   Verificar capacidade do novo quarto (se houver troca).
    *   Calcula o novo valor total baseado na tarifa do quarto/categoria e número de dias.
    *   Retorna: `valid` (bool), `conflict_message` (str), `old_total`, `new_total`, `price_diff`.

### 1.2. Atualização dos Endpoints de Ação
*   Atualizar `/api/reception/move_reservation` para aceitar novas datas (além de novo quarto).
*   Atualizar `/api/reception/resize_reservation` para validar o preço calculado pelo backend, em vez de depender apenas do input manual.

### 1.3. Definição de Capacidades
*   Adicionar mapeamento de capacidade de hóspedes por quarto em `ReservationService` para validação de trocas.

## 2. Frontend (Interface e Interatividade)

### 2.1. Ficha do Hóspede (Clique)
*   Refatorar o evento `onclick` das barras de reserva para garantir que o modal abra via AJAX.
*   Garantir que o modal exiba todos os campos solicitados (documentos, contato completo).

### 2.2. Drag & Drop Horizontal (Mudança de Datas)
*   **Correção Crítica:** Alterar a função JavaScript `drop` para calcular o deslocamento de dias (`deltaDays`) baseado na posição horizontal do soltar.
*   **Snap:** Implementar lógica de arredondamento para garantir que a reserva sempre "encaixe" no início do dia (Slot PM), evitando posições quebradas.
*   **Feedback Visual:** Melhorar o estilo `drag-over` para indicar onde a reserva vai cair.

### 2.3. Redimensionamento (Extensão de Estadia)
*   Atualizar o evento `resizeUp` para chamar o novo endpoint de cálculo (`calculate_reservation_update`).
*   Exibir o modal de confirmação com os valores retornados pelo backend (ex: "Valor adicional calculado: R$ 200,00").

### 2.4. Movimentação Vertical (Troca de Quarto)
*   Integrar a validação de capacidade no momento do `drop`.
*   Exibir alerta se o usuário tentar mover para um quarto com capacidade inferior.

## 3. Estrutura de Arquivos

*   `app/services/reservation_service.py`: Adicionar lógica de cálculo de preço e validação de capacidade.
*   `app/blueprints/reception/routes.py`: Adicionar rota de cálculo e atualizar rotas de persistência.
*   `app/templates/reception_reservations.html`: Refatoração pesada do JavaScript (DnD, Resize, Modais).

## 4. Testes e Validação
*   Criar script de teste automatizado `tests/test_reservation_logic.py` para simular cenários de conflito e cálculo de preço.
