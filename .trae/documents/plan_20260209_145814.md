Vou realizar a reestruturação completa do módulo de impressão conforme solicitado. Abaixo detalho o plano de execução:

### 1. Auditoria e Identificação (Concluído Parcialmente)
Já identifiquei os pontos críticos no código:
*   **IP Hardcoded**: Encontrado `192.168.69.60` forçado em `app/services/printing_service.py` (função `print_bill`).
*   **Portas Fixas**: Uso recorrente da porta `9100` sem configuração explícita.
*   **Serviços Afetados**: `printing_service.py`, `fiscal_service.py` e `printer_manager.py`.

### 2. Desenvolvimento do Modal de Configuração (Admin)
*   **Interface**: Atualizar `config_printers.html` para incluir um painel de "Atribuição de Impressoras".
*   **Funcionalidades**:
    *   **Mapeamento**: Criar seletores para vincular impressoras cadastradas a funções específicas:
        *   Impressora Fiscal (NFC-e)
        *   Impressora de Contas (Restaurante)
        *   Impressora de Produção (Cozinha/Bar)
        *   Impressora da Recepção (Relatórios/Extratos)
    *   **Teste de Conexão**: Botão para enviar um "Ping" de impressão para validar IP/Porta.
*   **Backend**: Atualizar `admin/routes.py` para salvar essas associações em `printer_settings.json`.

### 3. Refatoração do Código (Core)
*   **`printing_service.py`**:
    *   Remover o IP `192.168.69.60` e a lógica de hardcoding.
    *   Reescrever `print_bill`, `print_fiscal_receipt` e `print_order_items` para ler as configurações de `printer_settings.json`.
    *   Implementar lógica de fallback: Se a impressora específica não estiver configurada, tentar usar uma padrão ou retornar erro amigável.

### 4. Implementação na Página de Consumo (Recepção)
*   **Nova Rota**: Criar `/reception/print_individual_bills/<room_num>`.
*   **Layout Térmico (80mm)**: Implementar nova função de formatação `format_individual_bill_thermal` que gera:
    *   **Cabeçalho**: Logo/Nome do Hotel.
    *   **Corpo**: Lista de itens agrupada por hóspede (se disponível) ou cronológica.
    *   **Totais**: Subtotal e Total Geral destacados.
    *   **Rodapé**: Texto legal e agradecimento.
*   **Interface**: Adicionar botão "Imprimir Extrato (80mm)" no modal de fechamento de conta ou na visualização de consumo.

### 5. Sistema de Testes
*   Criar `tests/test_printing_system.py` para simular:
    *   Carregamento de configurações.
    *   Formatação de strings ESC/POS (Térmica).
    *   Comportamento do sistema quando a impressora está "offline" (mock de socket).

### Próximos Passos
Após sua aprovação, iniciarei pela criação do **Modal de Configuração** e refatoração do `printing_service.py` para eliminar os IPs fixos imediatamente.
