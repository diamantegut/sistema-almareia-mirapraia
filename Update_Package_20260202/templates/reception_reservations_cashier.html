{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>üìÖ Caixa Recep√ß√£o - Reservas</h2>
            <p class="text-muted">Gest√£o de Check-in, Check-out e Pagamentos Antecipados</p>
        </div>
        <div>
            <a href="{{ url_for('reception_cashier') }}" class="btn btn-outline-primary me-2">
                <i class="bi bi-receipt"></i> Ir para Contas
            </a>
            <a href="{{ url_for('reception_dashboard') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    {% if not cashier %}
    <!-- CASHIER CLOSED STATE -->
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-primary text-white text-center py-3">
                    <h4 class="mb-0"><i class="bi bi-lock-fill"></i> Caixa de Reservas Fechado</h4>
                </div>
                <div class="card-body p-4">
                    <p class="text-center text-muted mb-4">O caixa de reservas est√° fechado. Informe o valor inicial para abrir.</p>
                    
                    <form method="POST">
                        <input type="hidden" name="action" value="open_cashier">
                        <div class="mb-4">
                            <label class="form-label">Fundo de Caixa (R$)</label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text">R$</span>
                                <input type="tel" class="form-control" name="opening_balance" value="0.00" required onfocus="this.select()" oninput="formatCurrency(this)">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 btn-lg">
                            <i class="bi bi-unlock-fill"></i> Abrir Caixa de Reservas
                        </button>
                    </form>
                </div>
            </div>
            
            {% if sessions|length > 1 %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Hist√≥rico Recente</h5>
                </div>
                <ul class="list-group list-group-flush">
                    {% for session in sessions[-5:]|reverse %}
                        {% if session.status == 'closed' %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <div><strong>Aberto:</strong> {{ session.opened_at }}</div>
                                <div class="text-muted small">Fechado: {{ session.closed_at }}</div>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold text-success">R$ {{ "%.2f"|format(session.closing_balance) }}</div>
                            </div>
                        </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
    
    {% else %}
    <!-- CASHIER OPEN STATE -->
    <div class="row g-3">
        <!-- Summary Cards -->
        <div class="col-md-4">
            <div class="card bg-primary text-white h-100">
                <div class="card-body text-center">
                    <h6 class="card-title opacity-75">Saldo Atual</h6>
                    {% if session.get('role') == 'admin' %}
                    <h2 class="display-6 fw-bold">R$ {{ "%.2f"|format(total_balance) }}</h2>
                    <div class="small mt-2 opacity-75">
                        Abertura: R$ {{ "%.2f"|format(cashier.opening_balance) }}
                    </div>
                    {% else %}
                    <h2 class="display-6 fw-bold">R$ ****</h2>
                    <div class="small mt-2 opacity-75">
                        Abertura: R$ ****
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Recebimentos por Forma de Pagamento</h5>
                </div>
                <div class="card-body">
                    <div class="row row-cols-2 row-cols-md-4 g-2">
                        {% for method, amount in current_totals.items() %}
                        <div class="col">
                            <div class="border rounded p-2 text-center bg-light">
                                <div class="small text-muted text-uppercase">{{ method }}</div>
                                {% if session.get('role') == 'admin' %}
                                <div class="fw-bold">R$ {{ "%.2f"|format(amount) }}</div>
                                {% else %}
                                <div class="fw-bold">R$ ****</div>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <div class="col-12 text-center text-muted py-3">
                            Nenhum recebimento registrado ainda.
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="col-md-12">
            <div class="card">
                <div class="card-body d-flex gap-2 justify-content-end bg-light">
                    <!-- Generic Add Transaction (Sale) for Reservations -->
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#saleModal">
                        <i class="bi bi-cash-coin"></i> Registrar Recebimento
                    </button>
                    
                    <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#sangriaModal">
                        <i class="bi bi-dash-circle"></i> Sangria
                    </button>
                    <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#suprimentoModal">
                        <i class="bi bi-plus-circle"></i> Suprimento
                    </button>
                    <button type="button" class="btn btn-dark ms-auto" data-bs-toggle="modal" data-bs-target="#closeCashierModal">
                        <i class="bi bi-lock-fill"></i> Fechar Caixa
                    </button>
                </div>
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Movimenta√ß√µes</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Hor√°rio</th>
                                <th>Tipo</th>
                                <th>Descri√ß√£o</th>
                                <th>Forma Pagto</th>
                                <th class="text-end">Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for t in cashier.transactions|reverse %}
                            <tr>
                                <td>{{ t.timestamp.split(' ')[1] if t.timestamp else t.time }}</td>
                                <td>
                                    {% if t.type == 'sale' %}
                                        <span class="badge bg-success">Recebimento</span>
                                    {% elif t.category == 'Pagamento de Conta' or t.type == 'in' %}
                                        <span class="badge bg-success">Recebimento</span>
                                    {% elif t.category == 'Suprimento' or t.type == 'deposit' %}
                                        <span class="badge bg-info text-dark">Suprimento</span>
                                    {% elif t.category == 'Sangria' or t.type == 'withdrawal' or t.type == 'out' %}
                                        <span class="badge bg-danger">Sangria</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ t.category|default(t.type) }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ t.description }}</td>
                                <td>{{ t.payment_method|default('-')|title }}</td>
                                <td class="text-end fw-bold {{ 'text-danger' if t.type == 'out' else 'text-success' }}">
                                    {% if t.type == 'out' %}-{% endif %}
                                    R$ {{ "%.2f"|format(t.amount) }}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center py-4 text-muted">
                                    Nenhuma movimenta√ß√£o registrada.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Sale Modal (New for Reservations) -->
    <div class="modal fade" id="saleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Registrar Recebimento (Reserva/Check-in)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="add_transaction">
                        <input type="hidden" name="type" value="sale">
                        <div class="mb-3">
                            <label class="form-label">Valor (R$)</label>
                            <input type="tel" class="form-control" name="amount" required onfocus="this.select()" oninput="formatCurrency(this)">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descri√ß√£o (Ex: Check-in Quarto 101)</label>
                            <input type="text" class="form-control" name="description" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Forma de Pagamento</label>
                            <select class="form-select" name="payment_method" required>
                                {% for method in payment_methods %}
                                <option value="{{ method.id }}">{{ method.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">Confirmar Recebimento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sangria Modal -->
    <div class="modal fade" id="sangriaModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Realizar Sangria (Retirada)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="add_transaction">
                        <input type="hidden" name="type" value="withdrawal">
                        <div class="mb-3">
                            <label class="form-label">Valor (R$)</label>
                            <input type="tel" class="form-control" name="amount" required onfocus="this.select()" oninput="formatCurrency(this)">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descri√ß√£o / Motivo</label>
                            <input type="text" class="form-control" name="description" required placeholder="Ex: Pagamento fornecedor">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">Confirmar Sangria</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Suprimento Modal -->
    <div class="modal fade" id="suprimentoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Realizar Suprimento (Entrada)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="add_transaction">
                        <input type="hidden" name="type" value="deposit">
                        <div class="mb-3">
                            <label class="form-label">Valor (R$)</label>
                            <input type="number" step="0.01" class="form-control" name="amount" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descri√ß√£o / Origem</label>
                            <input type="text" class="form-control" name="description" required placeholder="Ex: Troco adicional">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">Confirmar Suprimento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Close Cashier Modal -->
    <div class="modal fade" id="closeCashierModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">Fechar Caixa de Reservas</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="close_cashier">
                        <p>Confira os valores antes de fechar.</p>
                        <div class="alert alert-info">
                            Saldo Calculado pelo Sistema: <strong>R$ {{ "%.2f"|format(total_balance) }}</strong>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Saldo Final em Gaveta (Real)</label>
                            <input type="number" step="0.01" class="form-control" name="closing_balance" required value="{{ "%.2f"|format(total_balance) }}">
                            <div class="form-text">Informe o valor contado fisicamente.</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-dark">Confirmar Fechamento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
    function formatCurrency(input) {
        let value = input.value.replace(/\D/g, '');
        value = (value / 100).toFixed(2) + '';
        input.value = value;
    }
</script>
{% endblock %}
