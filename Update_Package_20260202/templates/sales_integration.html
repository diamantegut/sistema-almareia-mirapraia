{% extends 'base.html' %}

{% block title %}Integração de Vendas - Back of the House<script>
    document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('.datepicker-input');
        
        inputs.forEach(input => {
            const calendar = document.createElement('div');
            calendar.className = 'datepicker-container';
            calendar.style.position = 'absolute';
            calendar.style.background = 'white';
            calendar.style.border = '1px solid #ddd';
            calendar.style.padding = '10px';
            calendar.style.zIndex = '1000';
            calendar.style.display = 'none';
            document.body.appendChild(calendar);
            
            let currentDate = new Date();
            let selectedDate = null;
            
            if (input.value) {
                const parts = input.value.split('/');
                if (parts.length === 3) {
                    selectedDate = new Date(parts[2], parts[1] - 1, parts[0]);
                    currentDate = new Date(selectedDate);
                }
            }

            function renderCalendar(date) {
                calendar.innerHTML = '';
                const year = date.getFullYear();
                const month = date.getMonth();
                
                const header = document.createElement('div');
                header.style.display = 'flex';
                header.style.justifyContent = 'space-between';
                header.style.marginBottom = '10px';
                
                const prevBtn = document.createElement('button');
                prevBtn.innerText = '<';
                prevBtn.onclick = (e) => { e.preventDefault(); e.stopPropagation(); currentDate.setMonth(month - 1); renderCalendar(currentDate); };
                
                const nextBtn = document.createElement('button');
                nextBtn.innerText = '>';
                nextBtn.onclick = (e) => { e.preventDefault(); e.stopPropagation(); currentDate.setMonth(month + 1); renderCalendar(currentDate); };
                
                const title = document.createElement('span');
                const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                title.innerText = `${months[month]} ${year}`;
                
                header.appendChild(prevBtn);
                header.appendChild(title);
                header.appendChild(nextBtn);
                calendar.appendChild(header);
                
                const grid = document.createElement('div');
                grid.style.display = 'grid';
                grid.style.gridTemplateColumns = 'repeat(7, 1fr)';
                grid.style.gap = '2px';
                
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const startDay = new Date(year, month, 1).getDay();
                
                for(let i=0; i<startDay; i++) grid.appendChild(document.createElement('div'));
                
                for(let i=1; i<=daysInMonth; i++) {
                    const el = document.createElement('div');
                    el.innerText = i;
                    el.style.padding = '5px';
                    el.style.cursor = 'pointer';
                    el.style.textAlign = 'center';
                    if (selectedDate && i === selectedDate.getDate() && month === selectedDate.getMonth()) el.style.background = '#3498db';
                    el.onclick = (e) => {
                        e.stopPropagation();
                        selectedDate = new Date(year, month, i);
                        input.value = `${i.toString().padStart(2,'0')}/${(month+1).toString().padStart(2,'0')}/${year}`;
                        calendar.style.display = 'none';
                    };
                    grid.appendChild(el);
                }
                calendar.appendChild(grid);
            }
            
            input.addEventListener('focus', () => {
                const rect = input.getBoundingClientRect();
                calendar.style.top = (rect.bottom + window.scrollY) + 'px';
                calendar.style.left = (rect.left + window.scrollX) + 'px';
                calendar.style.display = 'block';
                renderCalendar(currentDate);
            });
            
            // Close on click outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.datepicker-container') && e.target !== input) {
                    calendar.style.display = 'none';
                }
            });
        });
    });
</script>
{% endblock %}

{% block content %}
<div class="service-page">
    <div class="service-header">
        <span class="service-icon"><i class="bi bi-link-45deg"></i></span>
        <h2>Integração de Produtos de Venda</h2>
    </div>

    <!-- Status da Automação -->
    {% if sync_status %}
        {% if sync_status.status == 'failed' %}
        <div style="background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #f5c6cb;">
            <strong><i class="bi bi-exclamation-triangle-fill"></i> Alerta de Sincronização:</strong>
            A sincronização automática para o dia <strong>{{ sync_status.current_target_date }}</strong> falhou após {{ sync_status.attempts }} tentativas.
            <br>
            <small>Erro: {{ sync_status.error_message }}</small>
            <br>
            <small>Última tentativa: {{ sync_status.last_attempt_time }}</small>
        </div>
        {% elif sync_status.status == 'success' and sync_status.last_success_date %}
        <div style="background-color: #d4edda; color: #155724; padding: 10px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #c3e6cb; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 1.2em;"><i class="bi bi-check-circle-fill"></i></span>
            <div>
                <strong>Sincronização Automática Ativa</strong><br>
                <small>Vendas de {{ sync_status.last_success_date }} processadas com sucesso.</small>
            </div>
        </div>
        {% endif %}
    {% endif %}

    <div style="margin-bottom: 20px;">
        <a href="{{ url_for('index') }}" class="action-btn" style="background-color: #95a5a6; text-decoration: none;"><i class="bi bi-arrow-left"></i> Voltar</a>
    </div>


    <!-- Operação: Importação Automática -->
    <div class="operation-section" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 30px; border-left: 5px solid #27ae60;">
        <h3 style="margin-top: 0; color: #27ae60;"><i class="bi bi-arrow-repeat"></i> Importação Automática (Pasta Vendas)</h3>
        <p style="color: #7f8c8d; margin-bottom: 15px;">
            O sistema irá escanear a pasta <code>Vendas</code> e processar automaticamente novos arquivos de Excel.
        </p>
        <form method="POST" action="{{ url_for('auto_import_sales') }}">
            <button type="submit" class="action-btn" style="background-color: #27ae60; width: 100%;"><i class="bi bi-rocket-takeoff-fill"></i> Processar Novos Arquivos</button>
        </form>
    </div>

    <!-- Operação: Baixa de Estoque por Vendas -->
    <div class="operation-section" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 30px; border-left: 5px solid #e67e22;">
        <h3 style="margin-top: 0; color: #d35400;"><i class="bi bi-box-arrow-up"></i> Processar Vendas e Baixar Estoque</h3>
        
        <div style="margin-bottom: 15px; background: #fdf2e9; padding: 10px; border-radius: 4px;">
            <strong>Último período processado até:</strong> 
            {% if last_processed_date %}
                <span style="color: #c0392b; font-weight: bold;">{{ last_processed_date.split('-')[2] }}/{{ last_processed_date.split('-')[1] }}/{{ last_processed_date.split('-')[0] }}</span>
            {% else %}
                <span style="color: #7f8c8d;">Nenhum histórico encontrado.</span>
            {% endif %}
        </div>

        <form method="POST" action="{{ url_for('process_sales_log') }}" enctype="multipart/form-data" style="display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap;">
            <div class="form-group">
                <label>Arquivo de Vendas (.xlsx)</label>
                <input type="file" name="sales_file" accept=".xlsx" required style="padding: 5px;">
            </div>
            
            <div class="form-group">
                <label>Data Inicial</label>
                <div class="date-input-wrapper" style="position: relative;">
                    <input type="text" name="start_date" class="datepicker-input" placeholder="DD/MM/AAAA" required autocomplete="off" maxlength="10" style="padding: 8px; width: 120px;">
                    <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; pointer-events: none;"><i class="bi bi-calendar-event"></i></span>
                </div>
            </div>
            
            <div class="form-group">
                <label>Data Final</label>
                <div class="date-input-wrapper" style="position: relative;">
                    <input type="text" name="end_date" class="datepicker-input" placeholder="DD/MM/AAAA" required autocomplete="off" maxlength="10" style="padding: 8px; width: 120px;">
                    <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; pointer-events: none;"><i class="bi bi-calendar-event"></i></span>
                </div>
            </div>
            
            <button type="submit" class="action-btn" style="background-color: #e67e22; height: 38px;"><i class="bi bi-graph-down-arrow"></i> Processar</button>
        </form>
        <p style="font-size: 0.85em; color: #7f8c8d; margin-top: 10px; margin-bottom: 0;">
            <i class="fas fa-info-circle"></i> O sistema validará a continuidade das datas. O início deve ser o dia seguinte ao último processamento.
        </p>
    </div>

    <!-- Configuração: Escanear Produtos -->
    <div class="actions-bar" style="margin-bottom: 20px;">
        <h3 style="margin-top: 0; font-size: 1.1em; color: #2c3e50;">Configuração de Produtos</h3>
        <form method="POST" action="{{ url_for('scan_sales_products') }}" style="margin: 0;">
            <button type="submit" class="action-btn" style="background-color: #1e3a8a;"><i class="bi bi-arrow-repeat"></i> Escanear Arquivo de Produtos (Atualizar Catálogo)</button>
        </form>
    </div>

    <!-- Datalist for Stock Products (Shared) -->
    <datalist id="stock_list">
        {% for p in stock_products %}
        <option value="{{ p.name }}">{{ p.unit | abbreviate_unit }}</option>
        {% endfor %}
    </datalist>

    <script type="application/json" id="stock-units-data">
        {
        {% for p in stock_products %}
        "{{ p.name|replace('"', '\\"') }}": "{{ p.unit | abbreviate_unit }}"{% if not loop.last %},{% endif %}
        {% endfor %}
        }
    </script>

    <script>
        const stockUnitsDataEl = document.getElementById('stock-units-data');
        const stockUnits = stockUnitsDataEl ? JSON.parse(stockUnitsDataEl.textContent || '{}') : {};
        
        function updateUnitHint(input) {
            const prodName = input.value;
            const unit = stockUnits[prodName];
            const form = input.closest('form');
            
            // For Unlinked cards (has label)
            const qtyLabel = form.querySelector('.qty-label');
            if (qtyLabel) {
                 if (unit) {
                    let hint = unit;
                    const u = unit.toLowerCase().trim();
                    if (['kg', 'kilograma', 'kg.'].includes(u)) hint = 'g';
                    else if (['l', 'litro', 'l.'].includes(u)) hint = 'ml';
                    qtyLabel.innerText = `Qtd. Baixa (${hint}):`;
                } else {
                    qtyLabel.innerText = 'Qtd. Baixa:';
                }
            }
            
            // For Linked table (compact, uses placeholder)
            const qtyInput = form.querySelector('input[name="qty"]');
            if (qtyInput && !qtyLabel) {
                 if (unit) {
                    let hint = unit;
                    const u = unit.toLowerCase().trim();
                    if (['kg', 'kilograma', 'kg.'].includes(u)) hint = 'g';
                    else if (['l', 'litro', 'l.'].includes(u)) hint = 'ml';
                    qtyInput.placeholder = `Qtd (${hint})`;
                } else {
                    qtyInput.placeholder = 'Qtd';
                }
            }
        }
    </script>

    {% if unlinked_products %}
    <div class="alert-section" style="background-color: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <h3 style="color: #856404; margin-top: 0;"><i class="bi bi-exclamation-triangle-fill"></i> Produtos sem Vínculo de Estoque</h3>
        <p style="color: #856404;">Os seguintes produtos de venda não estão vinculados a nenhum item de estoque. Vincule-os para permitir a baixa automática.</p>
        
        <div class="unlinked-list">
            {% for sales_name, data in unlinked_products.items() %}
            <div class="unlinked-item" style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 10px; border-left: 5px solid #e74c3c;">
                <div style="margin-bottom: 10px;">
                    <strong>Produto de Venda:</strong> {{ sales_name }} <span style="color: #7f8c8d; font-size: 0.9em;">({{ data.category }})</span>
                </div>
                
                <form method="POST" action="{{ url_for('link_sales_product') }}" class="link-form" style="display: flex; gap: 10px; align-items: flex-end;">
                    <input type="hidden" name="sales_name" value="{{ sales_name }}">
                    
                    <div class="form-group" style="flex: 2;">
                        <label style="font-size: 0.8em;">Item de Estoque:</label>
                        <input type="text" list="stock_list" name="stock_product" required placeholder="Digite para buscar..." style="width: 100%; padding: 8px;" oninput="updateUnitHint(this)">
                    </div>
                    
                    <div class="form-group" style="flex: 1;">
                        <label class="qty-label" style="font-size: 0.8em;">Qtd. Baixa:</label>
                        <input type="number" name="qty" step="0.001" min="0" required placeholder="0.000" style="width: 100%; padding: 8px;">
                    </div>
                    
                    <button type="submit" style="background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;"> Vincular</button>
                </form>

                <form method="POST" action="{{ url_for('ignore_sales_product') }}" style="margin-top: 10px;">
                    <input type="hidden" name="sales_name" value="{{ sales_name }}">
                    <button type="submit" style="background: #95a5a6; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85em;"><i class="bi bi-slash-circle"></i> Não Vincular</button>
                </form>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="success-message" style="background-color: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <i class="bi bi-check-circle-fill"></i> Todos os produtos de venda identificados estão vinculados a itens de estoque!
    </div>
    {% endif %}

    <div class="linked-section">
        <h3><i class="bi bi-clipboard-check"></i> Produtos Vinculados</h3>
        <div class="table-responsive mt-3">
            <table class="table table-striped table-hover" id="linkedProductsTable">
                <thead>
                    <tr>
                        <th>Produto de Venda</th>
                    <th>Categoria</th>
                    <th>Itens de Estoque Vinculados</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for sales_name, data in linked_products.items() %}
                <tr>
                    <td>{{ sales_name }}</td>
                    <td>{{ data.category }}</td>
                    <td>
                        <ul style="margin: 0; padding-left: 20px;">
                            {% for link in data.linked_stock %}
                            <li>{{ link.qty }} x {{ link.product_name }}</li>
                            {% endfor %}
                        </ul>
                    </td>
                    <td>
                        <button onclick="toggleEdit('{{ loop.index }}')" style="background: #1e3a8a; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em;">Editar</button>
                    </td>
                </tr>
                <tr id="edit-row-{{ loop.index }}" style="display: none; background: #f9f9f9;">
                    <td colspan="4">
                        <div style="padding: 10px;">
                            <strong>Adicionar mais itens ou remover vínculos para: {{ sales_name }}</strong>
                            <form method="POST" action="{{ url_for('link_sales_product') }}" style="margin-top: 10px; display: flex; gap: 10px;">
                                <input type="hidden" name="sales_name" value="{{ sales_name }}">
                                <input type="text" list="stock_list" name="stock_product" required placeholder="Digite para buscar..." style="padding: 5px; flex: 1;" oninput="updateUnitHint(this)">
                                <input type="number" name="qty" step="0.001" placeholder="Qtd" required style="width: 80px; padding: 5px;">
                                <button type="submit" style="background: #27ae60; color: white; border: none; padding: 5px 10px; border-radius: 4px;">Adicionar</button>
                            </form>
                            
                            <div style="margin-top: 10px;">
                                {% for link in data.linked_stock %}
                                <form method="POST" action="{{ url_for('unlink_sales_product') }}" style="display: inline-block; margin-right: 10px;">
                                    <input type="hidden" name="sales_name" value="{{ sales_name }}">
                                    <input type="hidden" name="stock_product" value="{{ link.product_name }}">
                                    <span style="background: #eee; padding: 2px 5px; border-radius: 3px;">
                                        {{ link.product_name }} ({{ link.qty }})
                                        <button type="submit" style="background: none; border: none; color: #c0392b; cursor: pointer; font-weight: bold;">×</button>
                                    </span>
                                </form>
                                {% endfor %}
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <a href="{{ url_for('index') }}" class="back-link">← Voltar para Menu</a>
</div>

<script>
    function toggleEdit(index) {
        const row = document.getElementById('edit-row-' + index);
        if (row.style.display === 'none') {
            row.style.display = 'table-row';
        } else {
            row.style.display = 'none';
        }
    }
</script>
{% endblock %}
