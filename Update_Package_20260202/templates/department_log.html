{% extends 'base.html' %}

{% block title %}Logs do Departamento{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Logs de Ações - {{ department_name }}</h2>
        <a href="{{ url_for('index') }}" class="btn btn-secondary">Voltar</a>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">Filtros</h5>
        </div>
        <div class="card-body">
            <form id="filterForm" class="row g-3">
                <div class="col-md-3">
                    <label for="startDate" class="form-label">Data Inicial</label>
                    <input type="date" class="form-control" id="startDate" name="start_date">
                </div>
                <div class="col-md-3">
                    <label for="endDate" class="form-label">Data Final</label>
                    <input type="date" class="form-control" id="endDate" name="end_date">
                </div>
                <div class="col-md-3">
                    <label for="actionType" class="form-label">Tipo de Ação</label>
                    <input type="text" class="form-control" id="actionType" name="action" placeholder="Ex: Criou usuário">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Filtrar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Data/Hora</th>
                            <th>Colaborador</th>
                            <th>Ação</th>
                            <th>Entidade</th>
                            <th>Severidade</th>
                            <th>Detalhes</th>
                        </tr>
                    </thead>
                    <tbody id="logsTableBody">
                        <!-- Logs will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer clearfix">
            <div class="float-end">
                <nav aria-label="Page navigation">
                    <ul class="pagination mb-0" id="paginationControls">
                        <!-- Pagination will be loaded here -->
                    </ul>
                </nav>
            </div>
            <div class="text-muted pt-2" id="totalRecords">
                Total: 0 registros
            </div>
        </div>
    </div>
</div>

<!-- Modal Details -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes do Log</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre id="jsonDetails" class="bg-light p-3 border rounded"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const departmentId = "{{ department_id }}";
    let currentPage = 1;

    function loadLogs(page = 1) {
        const formData = new FormData(document.getElementById('filterForm'));
        const params = new URLSearchParams(formData);
        params.append('page', page);
        
        fetch(`/api/logs/department/${departmentId}?` + params.toString())
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('logsTableBody');
                tbody.innerHTML = '';
                
                if (data.items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">Nenhum registro encontrado.</td></tr>';
                }
                
                data.items.forEach(log => {
                    const tr = document.createElement('tr');
                    
                    // Format Date
                    const dateObj = new Date(log.timestamp);
                    const dateStr = dateObj.toLocaleString('pt-BR');
                    
                    // Severity Badge
                    let badgeClass = 'bg-secondary';
                    if (log.nivel_severidade === 'INFO') badgeClass = 'bg-info text-dark';
                    if (log.nivel_severidade === 'ALTERAÇÃO') badgeClass = 'bg-warning text-dark';
                    if (log.nivel_severidade === 'CRÍTICO') badgeClass = 'bg-danger';
                    
                    const detailsBtn = log.detalhes ? 
                        `<button class="btn btn-sm btn-outline-primary btn-details" data-details='${JSON.stringify(log.detalhes)}'>Ver</button>` : 
                        '-';

                    tr.innerHTML = `
                        <td>${dateStr}</td>
                        <td>${log.colaborador_id}</td>
                        <td>${log.acao}</td>
                        <td>${log.entidade}</td>
                        <td><span class="badge ${badgeClass}">${log.nivel_severidade}</span></td>
                        <td>${detailsBtn}</td>
                    `;
                    tbody.appendChild(tr);
                });
                
                // Update Pagination
                renderPagination(data);
                document.getElementById('totalRecords').textContent = `Total: ${data.total} registros`;
                
                // Bind Details Buttons
                document.querySelectorAll('.btn-details').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const details = JSON.parse(this.getAttribute('data-details'));
                        document.getElementById('jsonDetails').textContent = JSON.stringify(details, null, 2);
                        new bootstrap.Modal(document.getElementById('detailsModal')).show();
                    });
                });
            })
            .catch(error => console.error('Error loading logs:', error));
    }

    function renderPagination(data) {
        const ul = document.getElementById('paginationControls');
        ul.innerHTML = '';
        
        // Prev
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${!data.has_prev ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${data.current_page - 1}">Anterior</a>`;
        ul.appendChild(prevLi);
        
        // Next
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${!data.has_next ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${data.current_page + 1}">Próximo</a>`;
        ul.appendChild(nextLi);
        
        ul.querySelectorAll('a').forEach(a => {
            a.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.getAttribute('data-page'));
                if (page > 0) loadLogs(page);
            });
        });
    }

    document.getElementById('filterForm').addEventListener('submit', function(e) {
        e.preventDefault();
        loadLogs(1);
    });

    // Initial Load
    loadLogs();
});
</script>
{% endblock %}
