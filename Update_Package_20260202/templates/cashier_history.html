{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2>Histórico de Caixas</h2>
    
    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label for="start_date" class="form-label">Data Início</label>
                    <input type="text" class="form-control datepicker" id="start_date" name="start_date" value="{{ request.args.get('start_date', '') }}" placeholder="dd/mm/aaaa">
                </div>
                <div class="col-md-3">
                    <label for="end_date" class="form-label">Data Fim</label>
                    <input type="text" class="form-control datepicker" id="end_date" name="end_date" value="{{ request.args.get('end_date', '') }}" placeholder="dd/mm/aaaa">
                </div>
                <div class="col-md-3">
                    <label for="type" class="form-label">Tipo de Caixa</label>
                    <select class="form-select" id="type" name="type">
                        <option value="">Todos</option>
                        <option value="restaurant" {% if request.args.get('type') == 'restaurant' %}selected{% endif %}>Restaurante</option>
                        <option value="guest_consumption" {% if request.args.get('type') == 'guest_consumption' %}selected{% endif %}>Consumo de Hóspedes</option>
                        <option value="daily_rates" {% if request.args.get('type') == 'daily_rates' %}selected{% endif %}>Diárias</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Filtrar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Results Table -->
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID Sessão</th>
                    <th>Tipo</th>
                    <th>Abertura</th>
                    <th>Fechamento</th>
                    <th>Responsável</th>
                    <th>Saldo Inicial</th>
                    <th>Total Entrada</th>
                    <th>Total Saída</th>
                    <th>Saldo Final (Sistema)</th>
                    <th>Saldo Informado</th>
                    <th>Diferença</th>
                    <th>Status</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for session in sessions %}
                <tr class="{% if session.has_divergence %}table-danger{% endif %}">
                    <td><small>{{ session.id.split('_')[-1] }}</small></td>
                    <td>
                        {% if session.type == 'restaurant' %}Restaurante
                        {% elif session.type == 'guest_consumption' or session.type == 'reception_room_billing' %}Hóspedes
                        {% elif session.type == 'daily_rates' %}Diárias
                        {% else %}{{ session.type }}{% endif %}
                    </td>
                    <td>{{ session.opened_at }}</td>
                    <td>{{ session.closed_at or '-' }}</td>
                    <td>{{ session.user }}</td>
                    <td>R$ {{ "%.2f"|format(session.opening_balance) }}</td>
                    <td class="text-success">R$ {{ "%.2f"|format(session.total_in) }}</td>
                    <td class="text-danger">R$ {{ "%.2f"|format(session.total_out) }}</td>
                    <td>R$ {{ "%.2f"|format(session.balance) }}</td>
                    <td>
                        {% if session.closing_balance is defined %}
                        R$ {{ "%.2f"|format(session.closing_balance) }}
                        {% else %}-{% endif %}
                    </td>
                    <td class="{% if session.has_divergence %}text-danger fw-bold{% endif %}">
                        {% if session.difference is defined %}
                        R$ {{ "%.2f"|format(session.difference) }}
                        {% else %}-{% endif %}
                    </td>
                    <td>
                        {% if session.status == 'open' %}
                        <span class="badge bg-success">Aberto</span>
                        {% else %}
                        <span class="badge bg-secondary">Fechado</span>
                        {% endif %}
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#detailsModal{{ loop.index }}">
                            Detalhes
                        </button>
                    </td>
                </tr>

                <!-- Details Modal -->
                <div class="modal fade" id="detailsModal{{ loop.index }}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Detalhes da Sessão</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <h6>Transações</h6>
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Hora</th>
                                            <th>Descrição</th>
                                            <th>Tipo</th>
                                            <th>Valor</th>
                                            <th>Método</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for t in session.transactions %}
                                        <tr>
                                            <td>{{ t.time or t.timestamp.split(' ')[1] }}</td>
                                            <td>{{ t.description }}</td>
                                            <td>
                                                {% if t.type in ['in', 'sale', 'deposit'] %}
                                                <span class="text-success">Entrada</span>
                                                {% else %}
                                                <span class="text-danger">Saída</span>
                                                {% endif %}
                                            </td>
                                            <td>R$ {{ "%.2f"|format(t.amount) }}</td>
                                            <td>{{ t.payment_method or '-' }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    // Initialize datepickers if you have a library, otherwise simple input
    // Assuming standard bootstrap datepicker or similar is available in base
    document.addEventListener('DOMContentLoaded', function() {
        // Add simple masking or datepicker init here if needed
    });
</script>
{% endblock %}
