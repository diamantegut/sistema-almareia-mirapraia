{% extends 'base.html' %}

{% block title %}Controle de Quartos - Governança{% endblock %}


{% block content %}
<div class="container mt-4">
    <div class="alert alert-secondary" role="alert">
        Página de Governança carregada. Se não vê conteúdo, faça um reload (Ctrl+F5).
    </div>
    <style>
        .btn, .btn-sm {
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
    </style>
    <!-- Header with Back Button and Stats -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-brush"></i> Governança - Controle de Quartos</h2>
            <a href="{{ url_for('index') }}" class="btn btn-secondary btn-sm" aria-label="Voltar para Menu">← Voltar para Menu</a>
        </div>
        <div>
            <button class="btn btn-warning text-dark me-2" onclick="openManualLaunchModal()">
                <i class="bi bi-plus-circle"></i> Adicionar Consumo
            </button>
            <button class="btn btn-info text-white" data-bs-toggle="modal" data-bs-target="#statsModal">
                <i class="bi bi-clock-history"></i> Estatísticas de Tempo
            </button>
        </div>
    </div>

    <!-- Rooms Grid -->
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4">
        {% set excluded_rooms = [4, 5, 6, 7, 8, 9, 10, 13, 18, 19, 20, 27, 28, 29, 30] %}
        {% for i in range(1, 36) %}
            {% if i not in excluded_rooms %}
                {% set room_num = i|format_room %}
                {% set occ_data = occupancy.get(room_num) %}
                {% set clean_data = cleaning_status.get(room_num, {}) %}
                {% set status = clean_data.get('status', 'dirty') %}
                
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <!-- Card Header: Room Number & Occupancy Badge -->
                        <div class="card-header d-flex justify-content-between align-items-center bg-light">
                            <h5 class="mb-0 fw-bold">Quarto {{ room_num }}</h5>
                            {% if occ_data %}
                                <span class="badge bg-danger">Ocupado</span>
                            {% else %}
                                <span class="badge bg-success">Livre</span>
                            {% endif %}
                        </div>
                        
                        <!-- Card Body: Status & Info -->
                        <div class="card-body">
                            <!-- Occupancy Info -->
                            {% if occ_data %}
                                <div class="mb-3 text-muted small">
                                    <i class="bi bi-person-fill"></i> {{ occ_data.guest_name }}<br>
                                    <i class="bi bi-calendar-event"></i> Saída: {{ occ_data.checkout }}
                                </div>
                            {% else %}
                                <div class="mb-3 text-muted small">
                                    <i class="bi bi-house-door"></i> Quarto Vago
                                </div>
                            {% endif %}

                            <hr>

                            <!-- Cleaning Status Display -->
                            <div class="text-center mb-3">
                                {% if linen_exchange_needed and linen_exchange_needed.get(room_num) %}
                                    <div class="alert alert-info py-1 small mb-2 fw-bold" style="background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460;">
                                        <i class="bi bi-arrow-repeat"></i> TROCA DE ENXOVAL HOJE
                                        <div class="small fw-normal">Estadia de Longa Duração</div>
                                    </div>
                                {% endif %}

                                {% if status == 'clean' %}
                                    <h4 class="text-success"><i class="bi bi-stars"></i> Limpo</h4>
                                    <div class="badge bg-warning text-dark mb-1">Aguardando Inspeção</div>
                                    <small class="text-muted d-block">Por: {{ clean_data.last_cleaned_by }} em {{ clean_data.last_cleaned_at }}</small>
                                    
                                    <!-- Coffee Capsule Deduction Button -->
                                    {% if not occ_data %}
                                    <button class="btn btn-outline-brown btn-sm mt-2 w-100" onclick="openCapsuleModal('{{ room_num }}')" style="color: #6f4e37; border-color: #6f4e37;">
                                        <i class="bi bi-cup-hot"></i> Deduzir 2 Cápsulas
                                    </button>
                                    <div class="text-center mt-1">
                                         <a href="#" class="text-muted small" onclick="undoCapsuleDeduction('{{ room_num }}'); return false;">
                                             <i class="bi bi-arrow-counterclockwise"></i> Desfazer
                                         </a>
                                    </div>
                                    {% endif %}

                                {% elif status == 'inspected' %}
                                    <h4 class="text-primary"><i class="bi bi-check-all"></i> Pronto</h4>
                                    <div class="badge bg-success mb-1">Liberado</div>
                                    <small class="text-muted d-block">Insp.: {{ clean_data.get('inspected_by', 'Recepção') }}</small>
                                {% elif status == 'rejected' %}
                                    <h4 class="text-danger"><i class="bi bi-exclamation-triangle-fill"></i> REPROVADO</h4>
                                    <div class="alert alert-danger py-2 small mb-2 text-start">
                                        <strong>Motivo:</strong><br>
                                        {{ clean_data.get('rejection_reason', 'Não informado') }}
                                    </div>
                                    <small class="text-muted">Reprovado em: {{ clean_data.get('rejected_at', '') }}</small>
                                {% elif status == 'in_progress' %}
                                    <h4 class="text-warning"><i class="bi bi-hourglass-split"></i> Em Limpeza</h4>
                                    <small class="text-muted">Início: {{ clean_data.last_update }}<br>Camareira: {{ clean_data.maid }}</small>
                                {% elif status == 'dirty_checkout' %}
                                    <h4 class="text-danger fw-bold" style="color: #d63031 !important;"><i class="bi bi-box-arrow-left"></i> SAÍDA</h4>
                                    <div class="alert alert-danger py-1 small mb-0">
                                        <strong>Limpeza Completa Necessária</strong><br>
                                        Troca Total de Enxoval
                                    </div>
                                    {% if clean_data.last_guest %}
                                    <small class="text-muted d-block mt-1">Hóspede anterior: {{ clean_data.last_guest }}</small>
                                    {% endif %}
                                    <button class="btn btn-outline-primary btn-sm w-100 mt-2" onclick="openFrigobarModal('{{ room_num }}')">
                                        <i class="bi bi-snow"></i> Lançar Frigobar (Pré-Limpeza)
                                    </button>
                                    <small class="text-muted d-block mt-2">Liberado em: {{ clean_data.marked_at }}</small>
                                {% else %}
                                    <h4 class="text-secondary"><i class="bi bi-bucket"></i> Sujo</h4>
                                    {% if clean_data.marked_at %}
                                    <small class="text-muted">Marcado em: {{ clean_data.marked_at }}</small>
                                    {% endif %}
                                {% endif %}
                            </div>

                            <!-- Actions -->
                            <div class="d-grid gap-2">
                                {% if status == 'in_progress' %}
                                    <button type="button" class="btn btn-success w-100" onclick="openMinibarModal('{{ room_num }}')">
                                        <i class="bi bi-check-circle"></i> Finalizar Limpeza
                                    </button>
                                {% else %}
                                    <form method="POST">
                                        <input type="hidden" name="action" value="start_cleaning">
                                        <input type="hidden" name="room_number" value="{{ room_num }}">
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="bi bi-play-circle"></i> Iniciar Limpeza
                                        </button>
                                    </form>
                                    
                                    {% if status == 'clean' %}
                                    <form method="POST" class="mt-2">
                                        <input type="hidden" name="action" value="mark_dirty">
                                        <input type="hidden" name="room_number" value="{{ room_num }}">
                                        <button type="submit" class="btn btn-outline-secondary btn-sm w-100">
                                            Marcar como Sujo
                                        </button>
                                    </form>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>
</div>

<!-- Stats Modal -->
<div class="modal fade" id="statsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-bar-chart-line-fill"></i> Painel de Estatísticas de Limpeza</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                
                <!-- Toolbar -->
                <div class="row mb-3 align-items-center">
                    <div class="col-md-8">
                        <div class="btn-group">
                            <button class="btn btn-outline-secondary active" onclick="filterStats('all')">Todos</button>
                            <button class="btn btn-outline-secondary" onclick="filterStats('today')">Hoje</button>
                            <button class="btn btn-outline-secondary" onclick="filterStats('month')">Este Mês</button>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-success btn-sm" onclick="exportStats('csv')"><i class="bi bi-file-earmark-spreadsheet"></i> CSV</button>
                        <button class="btn btn-danger btn-sm" onclick="exportStats('pdf')"><i class="bi bi-file-earmark-pdf"></i> PDF</button>
                    </div>
                </div>

                <!-- Daily History Table -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-white fw-bold">
                        <i class="bi bi-calendar-check"></i> Histórico Diário Detalhado
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-hover table-striped mb-0" id="dailyStatsTable">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>Data</th>
                                        <th>Funcionário</th>
                                        <th class="text-center">Total Quartos</th>
                                        <th class="text-center">Média Normal (min)</th>
                                        <th class="text-center">Média Checkout (min)</th>
                                        <th class="text-center">Qtd. Normal</th>
                                        <th class="text-center">Qtd. Checkout</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for stat in daily_details %}
                                    <tr class="stats-row" data-date="{{ stat.date }}">
                                        <td>{{ stat.date }}</td>
                                        <td class="fw-bold">{{ stat.maid }}</td>
                                        <td class="text-center">{{ stat.total_rooms }}</td>
                                        <td class="text-center">{{ stat.avg_normal }}</td>
                                        <td class="text-center">{{ stat.avg_checkout }}</td>
                                        <td class="text-center">{{ stat.count_normal }}</td>
                                        <td class="text-center">{{ stat.count_checkout }}</td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="7" class="text-center text-muted py-3">Nenhum registro encontrado.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="row g-3">
                    <!-- Monthly Average -->
                    <div class="col-md-6">
                        <div class="card h-100 shadow-sm border-info">
                            <div class="card-header bg-info text-white">
                                <i class="bi bi-calendar-month"></i> Média Mensal ({{ month_stats.name }})
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-4 mb-2">
                                        <h3 class="fw-bold text-dark">{{ month_stats.total_rooms }}</h3>
                                        <small class="text-muted">Total Quartos</small>
                                    </div>
                                    <div class="col-4 mb-2">
                                        <h4 class="fw-bold text-primary">{{ month_stats.avg_normal }}</h4>
                                        <small class="text-muted">Média Normal</small>
                                    </div>
                                    <div class="col-4 mb-2">
                                        <h4 class="fw-bold text-danger">{{ month_stats.avg_checkout }}</h4>
                                        <small class="text-muted">Média Checkout</small>
                                    </div>
                                    <div class="col-12 mt-2">
                                        <small class="d-block text-muted">Detalhes: {{ month_stats.count_normal }} Normal / {{ month_stats.count_checkout }} Checkout</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Yearly Average -->
                    <div class="col-md-6">
                        <div class="card h-100 shadow-sm border-secondary">
                            <div class="card-header bg-secondary text-white">
                                <i class="bi bi-calendar3"></i> Média Anual ({{ year_stats.name }})
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-4 mb-2">
                                        <h3 class="fw-bold text-dark">{{ year_stats.total_rooms }}</h3>
                                        <small class="text-muted">Total Quartos</small>
                                    </div>
                                    <div class="col-4 mb-2">
                                        <h4 class="fw-bold text-primary">{{ year_stats.avg_normal }}</h4>
                                        <small class="text-muted">Média Normal</small>
                                    </div>
                                    <div class="col-4 mb-2">
                                        <h4 class="fw-bold text-danger">{{ year_stats.avg_checkout }}</h4>
                                        <small class="text-muted">Média Checkout</small>
                                    </div>
                                    <div class="col-12 mt-2">
                                        <small class="d-block text-muted">Detalhes: {{ year_stats.count_normal }} Normal / {{ year_stats.count_checkout }} Checkout</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script>
    function filterStats(period) {
        const rows = document.querySelectorAll('.stats-row');
        
        const now = new Date();
        const day = String(now.getDate()).padStart(2, '0');
        const month = String(now.getMonth() + 1).padStart(2, '0'); // 0-11 -> 01-12
        const year = now.getFullYear();
        
        const todayStr = `${day}/${month}/${year}`;
        const currentMonthVal = now.getMonth(); // 0-11
        const currentYearVal = now.getFullYear();

        rows.forEach(row => {
            const dateStr = row.getAttribute('data-date'); // dd/mm/yyyy
            let show = true;
            
            if (period === 'today') {
                show = (dateStr === todayStr);
            } else if (period === 'month') {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    const m = parseInt(parts[1]);
                    const y = parseInt(parts[2]);
                    if (m - 1 !== currentMonthVal || y !== currentYearVal) {
                        show = false;
                    }
                }
            }
            
            row.style.display = show ? '' : 'none';
        });
        
        // Update active button state
        document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
        if(window.event && window.event.target) {
             window.event.target.classList.add('active');
        }
    }

    function exportStats(type) {
        if (type === 'csv') {
            let csv = 'Data;Funcionário;Total Quartos;Média Normal;Média Checkout;Qtd Normal;Qtd Checkout\\n';
            document.querySelectorAll('.stats-row').forEach(row => {
                if (row.style.display !== 'none') {
                    const cols = row.querySelectorAll('td');
                    const line = Array.from(cols).map(c => c.innerText).join(';');
                    csv += line + '\\n';
                }
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'estatisticas_limpeza.csv';
            link.click();
        } else if (type === 'pdf') {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.text("Relatório de Estatísticas de Limpeza", 14, 15);
            
            const rows = [];
            document.querySelectorAll('.stats-row').forEach(row => {
                if (row.style.display !== 'none') {
                    const cols = row.querySelectorAll('td');
                    rows.push(Array.from(cols).map(c => c.innerText));
                }
            });
            
            doc.autoTable({
                head: [['Data', 'Funcionário', 'Total', 'Méd. Normal', 'Méd. Checkout', 'Qtd. Normal', 'Qtd. Checkout']],
                body: rows,
                startY: 20,
            });
            
            doc.save('estatisticas_limpeza.pdf');
        }
    }
</script>

<!-- Minibar Check Modal -->
<div class="modal fade" id="minibarCheckModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Verificação de Frigobar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="lead text-center mb-4">Houve consumo de itens do frigobar neste quarto?</p>
                <form id="finishCleaningForm" method="POST">
                    <input type="hidden" name="action" value="finish_cleaning">
                    <input type="hidden" id="modalRoomNum" name="room_number" value="">
                    <input type="hidden" id="redirectMinibar" name="redirect_minibar" value="false">
                    
                    <div class="d-grid gap-3">
                        <button type="button" class="btn btn-primary btn-lg" onclick="openFrigobarModal(document.getElementById('modalRoomNum').value, true)">
                            <i class="bi bi-cart-plus"></i> Sim, Lançar Consumo
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="submitFinish(false)">
                            <i class="bi bi-check-lg"></i> Não, Apenas Finalizar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let lastReceiptData = null;

function printLastReceipt() {
    if (!lastReceiptData) return;
    
    const printWindow = window.open('', '_blank', 'width=400,height=600');
    printWindow.document.write(`
        <html>
        <head>
            <title>Comprovante - Café</title>
            <style>
                body { font-family: 'Courier New', monospace; padding: 20px; text-align: center; }
                .header { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; border-bottom: 2px dashed #000; padding-bottom: 10px; }
                .item { margin: 8px 0; text-align: left; }
                .label { font-weight: bold; }
                .line { border-top: 1px dashed #000; margin: 15px 0; }
                .footer { font-size: 0.8em; margin-top: 20px; }
            </style>
        </head>
        <body>
            <div class="header">COMPROVANTE DE DEDUÇÃO<br>GOVERNANÇA</div>
            <div class="item"><span class="label">Data:</span> ${lastReceiptData.date}</div>
            <div class="item"><span class="label">Hora:</span> ${lastReceiptData.time}</div>
            <div class="item"><span class="label">Quarto:</span> ${lastReceiptData.room}</div>
            <div class="item"><span class="label">Resp.:</span> ${lastReceiptData.staff}</div>
            <div class="line"></div>
            <div class="item"><span class="label">Item:</span> ${lastReceiptData.item}</div>
            <div class="item"><span class="label">Qtd:</span> ${lastReceiptData.qty}</div>
            <div class="line"></div>
            <br><br>
            <div class="item">Assinatura: __________________</div>
            <div class="footer">Sistema Interno</div>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 250);
}

function openMinibarModal(roomNum) {
    document.getElementById('modalRoomNum').value = roomNum;
    var myModal = new bootstrap.Modal(document.getElementById('minibarCheckModal'));
    myModal.show();
}

function submitFinish(hasConsumption) {
    document.getElementById('redirectMinibar').value = hasConsumption ? 'true' : 'false';
    document.getElementById('finishCleaningForm').submit();
}

function openCapsuleModal(roomNum) {
    document.getElementById('capsuleRoomNum').value = roomNum;
    document.getElementById('capsuleRoomDisplay').textContent = roomNum;
    var myModal = new bootstrap.Modal(document.getElementById('capsuleDeductionModal'));
    myModal.show();
}

function submitCapsuleDeduction() {
            const roomNum = document.getElementById('capsuleRoomNum').value;
            const btn = document.getElementById('btnConfirmCapsule');
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processando...';
            
            fetch('/governance/deduct_coffee', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ room_number: roomNum })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Hide deduction modal
                    const deductionModalEl = document.getElementById('capsuleDeductionModal');
                    const deductionModal = bootstrap.Modal.getInstance(deductionModalEl);
                    deductionModal.hide();
                    
                    // Store data
                    lastReceiptData = data.receipt;
                    
                    // Populate Receipt Modal
                    const content = `
                        <h4 class="text-success mb-3">Dedução Realizada!</h4>
                        <div class="card p-3 bg-light text-start mx-auto" style="max-width: 300px; font-family: monospace;">
                            <div><strong>Data:</strong> ${data.receipt.date} ${data.receipt.time}</div>
                            <div><strong>Quarto:</strong> ${data.receipt.room}</div>
                            <div><strong>Resp.:</strong> ${data.receipt.staff}</div>
                            <hr class="my-2">
                            <div>${data.receipt.item}</div>
                            <div><strong>Qtd:</strong> ${data.receipt.qty}</div>
                        </div>
                    `;
                    document.getElementById('receiptContent').innerHTML = content;
                    
                    // Show Receipt Modal
                    const receiptModal = new bootstrap.Modal(document.getElementById('receiptModal'));
                    receiptModal.show();
                } else {
                    alert('Erro: ' + data.error);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erro ao processar solicitação.');
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
        }

        function undoCapsuleDeduction(roomNum) {
            if (!confirm('Deseja realmente desfazer a última dedução de cápsulas para o quarto ' + roomNum + '?')) {
                return;
            }
            
            fetch('/governance/undo_deduct_coffee', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ room_number: roomNum })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Estorno realizado com sucesso!');
                    location.reload();
                } else {
                    alert('Erro: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erro ao processar solicitação.');
            });
        }
</script>

<!-- Capsule Deduction Modal -->
<div class="modal fade" id="capsuleDeductionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Deduzir Cápsulas de Café</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Confirma a dedução de <strong>2 Cápsulas de Café</strong> do estoque para o Quarto <span id="capsuleRoomDisplay" class="fw-bold"></span>?</p>
                <div class="alert alert-warning small">
                    <i class="bi bi-exclamation-triangle"></i> Esta ação deduzirá do estoque da Governança.
                </div>
                <input type="hidden" id="capsuleRoomNum">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnConfirmCapsule" onclick="submitCapsuleDeduction()" style="background-color: #6f4e37; border-color: #6f4e37;">
                    Confirmar Dedução
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Receipt Modal -->
<div class="modal fade" id="receiptModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-check-circle"></i> Sucesso</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center" id="receiptContent">
                <!-- Content via JS -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="printLastReceipt()">
                    <i class="bi bi-printer"></i> Imprimir Comprovante
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Launch Frigobar Modal -->
<div class="modal fade" id="launchFrigobarModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-snow"></i> Lançamento de Frigobar<span id="modalTitleRoomPart"> - Quarto <span id="frigobarRoomDisplay"></span></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="frigobarRoomNum">
                
                <div id="manualRoomSelectContainer" class="mb-3 d-none">
                    <label for="manualRoomSelect" class="form-label fw-bold">Selecione o Quarto:</label>
                    <select id="manualRoomSelect" class="form-select" onchange="document.getElementById('frigobarRoomNum').value = this.value">
                        <option value="">-- Selecione --</option>
                        {% for room_key, data in occupancy.items() %}
                        <option value="{{ room_key }}">Quarto {{ room_key }} - {{ data.guest_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="alert alert-info small">
                    <i class="bi bi-info-circle"></i> Selecione os itens consumidos. O lançamento será automático.
                </div>
                
                <div class="list-group mb-3" style="max-height: 400px; overflow-y: auto;">
                    {% for item in frigobar_items %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">{{ item.name }}</div>
                            <small class="text-muted">R$ {{ "%.2f"|format(item.price) }}</small>
                        </div>
                        <div class="input-group" style="width: 140px;">
                            <button class="btn btn-outline-secondary btn-sm" type="button" onclick="updateQty('{{ item.id }}', -1)">-</button>
                            <input type="text" class="form-control form-control-sm text-center frigobar-qty" id="qty-{{ item.id }}" data-id="{{ item.id }}" value="0" readonly>
                            <button class="btn btn-outline-secondary btn-sm" type="button" onclick="updateQty('{{ item.id }}', 1)">+</button>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center p-3 text-muted">Nenhum item de frigobar cadastrado.</div>
                    {% endfor %}
                </div>
                
                <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded">
                    <strong>Total Estimado:</strong>
                    <span class="fw-bold text-primary fs-5">R$ <span id="frigobarTotal">0.00</span></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnLaunchFrigobar" onclick="submitFrigobar()">
                    <i class="bi bi-check-lg"></i> Confirmar Lançamento
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let productPrices = {};

    function openManualLaunchModal() {
        openFrigobarModal(null, false, true);
    }

    function openFrigobarModal(roomNum, fromCheckModal=false, manualMode=false) {
        if(fromCheckModal) {
            // Close check modal first
            const checkModalEl = document.getElementById('minibarCheckModal');
            const checkModal = bootstrap.Modal.getInstance(checkModalEl);
            if(checkModal) checkModal.hide();
        }
        
        const container = document.getElementById('manualRoomSelectContainer');
        const displaySpan = document.getElementById('frigobarRoomDisplay');
        const titleRoomPart = document.getElementById('modalTitleRoomPart');
        const select = document.getElementById('manualRoomSelect');
        const hiddenInput = document.getElementById('frigobarRoomNum');

        if (manualMode) {
            container.classList.remove('d-none');
            if(titleRoomPart) titleRoomPart.style.display = 'none';
            select.value = "";
            hiddenInput.value = "";
        } else {
            container.classList.add('d-none');
            if(titleRoomPart) titleRoomPart.style.display = 'inline';
            displaySpan.textContent = roomNum;
            hiddenInput.value = roomNum;
        }
        
        refreshFrigobarList().then(() => {
            document.querySelectorAll('.frigobar-qty').forEach(input => {
                input.value = 0;
            });
            updateTotal();
            
            var myModal = new bootstrap.Modal(document.getElementById('launchFrigobarModal'));
            myModal.show();
        });
    }
    
    function refreshFrigobarList(retryCount = 0) {
        const container = document.querySelector('#launchFrigobarModal .list-group');
        if (!container) return Promise.resolve();
        
        if (retryCount === 0) {
            container.innerHTML = '<div class="text-center p-3 text-muted"><span class="spinner-border spinner-border-sm"></span> Carregando itens de frigobar...</div>';
        }
        
        return fetch('/api/frigobar/items', {method: 'GET'})
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na resposta do servidor: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                const items = data.items || [];
                productPrices = {};
                
                if (items.length === 0) {
                    container.innerHTML = '<div class="text-center p-3 text-muted">Nenhum item de frigobar cadastrado.</div>';
                    return;
                }
                
                let html = '';
                items.forEach(item => {
                    const id = item.id;
                    const name = item.name;
                    const price = parseFloat(item.price);
                    productPrices[id] = price;
                    html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">${name}</div>
                            <small class="text-muted">R$ ${price.toFixed(2)}</small>
                        </div>
                        <div class="input-group" style="width: 140px;">
                            <button class="btn btn-outline-secondary btn-sm" type="button" onclick="updateQty('${id}', -1)">-</button>
                            <input type="text" class="form-control form-control-sm text-center frigobar-qty" id="qty-${id}" data-id="${id}" value="0" readonly>
                            <button class="btn btn-outline-secondary btn-sm" type="button" onclick="updateQty('${id}', 1)">+</button>
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
            })
            .catch(err => {
                console.error("Failed to load frigobar items:", err);
                if (retryCount < 3) {
                    const delay = (retryCount + 1) * 1000;
                    container.innerHTML = `<div class="text-center p-3 text-warning">Falha na conexão. Tentando novamente em ${retryCount+1}s...</div>`;
                    setTimeout(() => refreshFrigobarList(retryCount + 1), delay);
                } else {
                    container.innerHTML = `
                        <div class="text-center p-3 text-danger">
                            <p>Erro ao carregar itens de frigobar.</p>
                            <small>${err.message}</small><br>
                            <button class="btn btn-sm btn-outline-danger mt-2" onclick="refreshFrigobarList()">Tentar Novamente</button>
                        </div>`;
                }
            });
    }
    
    function updateQty(id, delta) {
        const input = document.getElementById('qty-' + id);
        let val = parseInt(input.value) || 0;
        val += delta;
        if(val < 0) val = 0;
        input.value = val;
        updateTotal();
    }
    
    function updateTotal() {
        let total = 0;
        document.querySelectorAll('.frigobar-qty').forEach(input => {
            const id = input.getAttribute('data-id');
            const qty = parseInt(input.value) || 0;
            if(productPrices[id]) {
                total += qty * productPrices[id];
            }
        });
        document.getElementById('frigobarTotal').textContent = total.toFixed(2);
    }
    
    function submitFrigobar() {
        const roomNum = document.getElementById('frigobarRoomNum').value;
        
        if (!roomNum) {
            alert("Por favor, selecione um quarto.");
            return;
        }

        const items = [];
        
        document.querySelectorAll('.frigobar-qty').forEach(input => {
            const qty = parseInt(input.value) || 0;
            if(qty > 0) {
                items.push({
                    id: input.getAttribute('data-id'),
                    qty: qty
                });
            }
        });
        
        if(items.length === 0) {
            alert("Selecione pelo menos um item.");
            return;
        }
        
        const btn = document.getElementById('btnLaunchFrigobar');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processando...';
        
        fetch('/governance/launch_frigobar', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ room_number: roomNum, items: items })
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                // Close Modal
                const modalEl = document.getElementById('launchFrigobarModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
                
                alert("Lançamento realizado com sucesso!");
                
                // If we came here from "Finish Cleaning" flow, we might want to finish it now
                // But simplified: just let them click "Finish" again and say "No" to consumption 
                // OR we can auto-finish. For now, simple is better.
                // If the user wants to finish cleaning, they can click "Finalizar" -> "Não" (since they just launched it).
                
            } else {
                alert('Erro: ' + data.error);
            }
            btn.disabled = false;
            btn.innerHTML = originalText;
        })
        .catch(err => {
            console.error(err);
            alert('Erro de comunicação.');
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
    }
</script>
                <button type="button" class="btn-close btn-close-white" onclick="location.reload()"></button>
            </div>
            <div class="modal-body text-center" id="receiptContent">
                <!-- Injected via JS -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="location.reload()">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="printLastReceipt()">
                    <i class="bi bi-printer"></i> Imprimir Comprovante
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
