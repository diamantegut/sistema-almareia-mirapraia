{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-receipt-cutoff"></i> Pool de Contas Fiscais</h2>
        <div>
            <a href="{{ url_for('fiscal_config') }}" class="btn btn-outline-primary me-2">
                <i class="bi bi-gear"></i> Configurações Fiscais
            </a>
            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <form method="GET" class="row g-3 align-items-end">
                <div class="col-md-2">
                    <label class="form-label">Data Início</label>
                    <input type="date" name="start_date" class="form-control" value="{{ request.args.get('start_date', '') }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Data Fim</label>
                    <input type="date" name="end_date" class="form-control" value="{{ request.args.get('end_date', '') }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Origem</label>
                    <select name="origin" class="form-select">
                        <option value="">Todas</option>
                        <option value="restaurant" {% if request.args.get('origin') == 'restaurant' %}selected{% endif %}>Restaurante</option>
                        <option value="reception" {% if request.args.get('origin') == 'reception' %}selected{% endif %}>Recepção</option>
                        <option value="daily_rates" {% if request.args.get('origin') == 'daily_rates' %}selected{% endif %}>Diárias</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Status</label>
                    <select name="status" class="form-select">
                        <option value="">Todos</option>
                        <option value="pending" {% if request.args.get('status') == 'pending' %}selected{% endif %}>Pendente</option>
                        <option value="emitted" {% if request.args.get('status') == 'emitted' %}selected{% endif %}>Emitida</option>
                        <option value="ignored" {% if request.args.get('status') == 'ignored' %}selected{% endif %}>Ignorada/Não Fiscal</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100"><i class="bi bi-filter"></i> Filtrar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Accounts Table -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th>Data/Hora</th>
                            <th>Origem</th>
                            <th>ID Original</th>
                            <th>Série</th>
                            <th>Número</th>
                            <th>Total</th>
                            <th>Pagamento</th>
                            <th>Cliente</th>
                            <th>Status</th>
                            <th class="text-end">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in pool %}
                        <tr id="row-{{ entry.id }}">
                            <td>{{ entry.closed_at }}</td>
                            <td>
                                {% if entry.origin == 'restaurant' %}
                                    <span class="badge bg-warning text-dark"><i class="bi bi-cup-straw"></i> Restaurante</span>
                                {% elif entry.origin == 'reception' %}
                                    <span class="badge bg-info text-dark"><i class="bi bi-door-open"></i> Recepção</span>
                                {% elif entry.origin == 'daily_rates' %}
                                    <span class="badge bg-primary"><i class="bi bi-building"></i> Diárias</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ entry.origin }}</span>
                                {% endif %}
                            </td>
                            <td>{{ entry.original_id }}</td>
                            <td>{{ entry.serie|default('-') }}</td>
                            <td>{{ entry.number|default('-') }}</td>
                            <td class="fw-bold">R$ {{ "%.2f"|format(entry.total_amount) }}</td>
                            <td>
                                {% for pm in entry.payment_methods %}
                                    <div>
                                        <small>{{ pm.method }}</small>
                                        {% if pm.is_fiscal %}
                                            <i class="bi bi-check-circle-fill text-success" title="Fiscal"></i>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </td>
                            <td>
                                {% if entry.customer.name %}
                                    <div>{{ entry.customer.name }}</div>
                                {% endif %}
                                {% if entry.customer.cpf_cnpj %}
                                    <small class="text-muted">{{ entry.customer.cpf_cnpj }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if entry.status == 'pending' %}
                                    <span class="badge bg-warning text-dark">Pendente</span>
                                {% elif entry.status == 'emitted' %}
                                    <span class="badge bg-success">Emitida</span>
                                {% elif entry.status == 'error' %}
                                    <span class="badge bg-danger">Erro</span>
                                {% elif entry.status == 'ignored' %}
                                    <span class="badge bg-secondary">Ignorada</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-info" onclick="viewDetails('{{ entry.id }}')">
                                    <i class="bi bi-eye"></i>
                                </button>
                                {% if entry.status == 'pending' or entry.status == 'error' %}
                                    <button class="btn btn-sm btn-success" onclick="emitInvoice('{{ entry.id }}')">
                                        <i class="bi bi-cloud-upload"></i> Emitir
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="ignoreEntry('{{ entry.id }}')">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="10" class="text-center py-4 text-muted">Nenhuma conta encontrada.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes da Conta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailsContent">
                <!-- Loaded via JS -->
            </div>
        </div>
    </div>
</div>

<script>
const poolData = {{ pool|tojson }};

function viewDetails(id) {
    const entry = poolData.find(e => e.id === id);
    if (!entry) return;
    
    let itemsHtml = '<table class="table table-sm table-striped"><thead><tr><th>Item</th><th>Qtd</th><th>Preço</th><th>Total</th></tr></thead><tbody>';
    entry.items.forEach(item => {
        // Handle different item structures if necessary
        const qty = item.qty || item.quantity || 1;
        const price = item.price || item.unit_price || 0;
        const total = (qty * price).toFixed(2);
        itemsHtml += `<tr>
            <td>${item.name || item.description}</td>
            <td>${qty}</td>
            <td>R$ ${parseFloat(price).toFixed(2)}</td>
            <td>R$ ${total}</td>
        </tr>`;
    });
    itemsHtml += '</tbody></table>';

    const content = document.getElementById('detailsContent');
    content.innerHTML = `
        <div class="row mb-3">
            <div class="col-md-6">
                <p><strong>Origem:</strong> ${entry.origin}</p>
                <p><strong>ID Original:</strong> ${entry.original_id}</p>
                <p><strong>Fechado em:</strong> ${entry.closed_at}</p>
                <p><strong>Fechado por:</strong> ${entry.closed_by}</p>
            </div>
            <div class="col-md-6 text-end">
                <h3 class="text-primary">R$ ${entry.total_amount.toFixed(2)}</h3>
                <span class="badge bg-${entry.status === 'emitted' ? 'success' : (entry.status === 'pending' ? 'warning' : 'secondary')} fs-6">${entry.status.toUpperCase()}</span>
            </div>
        </div>
        <hr>
        <h5>Itens do Pedido</h5>
        ${itemsHtml}
        <hr>
        <div class="row">
            <div class="col-md-6">
                <h5>Cliente</h5>
                <p class="mb-1"><strong>Nome:</strong> ${entry.customer.name || 'Consumidor Final'}</p>
                <p class="mb-1"><strong>CPF/CNPJ:</strong> ${entry.customer.cpf_cnpj || 'Não informado'}</p>
            </div>
            <div class="col-md-6">
                 <h5>Pagamento</h5>
                 <ul class="list-unstyled">
                    ${entry.payment_methods.map(pm => `<li>${pm.method}: R$ ${pm.amount.toFixed(2)}</li>`).join('')}
                 </ul>
            </div>
        </div>
        ${entry.notes ? `<div class="alert alert-info mt-3"><i class="bi bi-info-circle"></i> ${entry.notes}</div>` : ''}
    `;
    
    new bootstrap.Modal(document.getElementById('detailsModal')).show();
}

async function emitInvoice(id) {
    if (!confirm('Deseja emitir a nota fiscal para esta conta?')) return;

    try {
        const response = await fetch('/admin/fiscal/pool/action', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ action: 'emit', id: id })
        });
        
        const result = await response.json();
        if (result.success) {
            alert('Emissão iniciada com sucesso!');
            location.reload();
        } else {
            alert('Erro ao iniciar emissão: ' + result.error);
        }
    } catch (e) {
        alert('Erro de comunicação com o servidor.');
        console.error(e);
    }
}

async function ignoreEntry(id) {
    if (!confirm('Deseja marcar esta conta como "Ignorada/Não Fiscal"?')) return;

    try {
        const response = await fetch('/admin/fiscal/pool/action', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ action: 'ignore', id: id })
        });
        
        const result = await response.json();
        if (result.success) {
            location.reload();
        } else {
            alert('Erro: ' + result.error);
        }
    } catch (e) {
        alert('Erro de comunicação com o servidor.');
    }
}
</script>
{% endblock %}