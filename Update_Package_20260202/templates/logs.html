{% extends 'base.html' %}
{% block title %}Logs do Sistema - Back of the House{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-journal-text"></i> Logs do Sistema</h2>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                <li class="breadcrumb-item active">Logs</li>
            </ol>
        </nav>
    </div>
    
    <div class="card shadow-sm">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="logsTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab" aria-controls="orders" aria-selected="true">
                        <i class="bi bi-cart-check"></i> Logs de Pedidos
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system" type="button" role="tab" aria-controls="system" aria-selected="false">
                        <i class="bi bi-cpu"></i> Logs do Sistema
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="actions-tab" data-bs-toggle="tab" data-bs-target="#actions" type="button" role="tab" aria-controls="actions" aria-selected="false">
                        <i class="bi bi-activity"></i> Ações
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="stock-tab" data-bs-toggle="tab" data-bs-target="#stock" type="button" role="tab" aria-controls="stock" aria-selected="false">
                        <i class="bi bi-box-seam"></i> Estoque
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="cleaning-tab" data-bs-toggle="tab" data-bs-target="#cleaning" type="button" role="tab" aria-controls="cleaning" aria-selected="false">
                        <i class="bi bi-stars"></i> Camareiras
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="inspection-tab" data-bs-toggle="tab" data-bs-target="#inspection" type="button" role="tab" aria-controls="inspection" aria-selected="false">
                        <i class="bi bi-clipboard-check"></i> Inspeções
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="audit-tab" data-bs-toggle="tab" data-bs-target="#audit" type="button" role="tab" aria-controls="audit" aria-selected="false">
                        <i class="bi bi-shield-check"></i> Auditoria
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="backups-tab" data-bs-toggle="tab" data-bs-target="#backups" type="button" role="tab" aria-controls="backups" aria-selected="false">
                        <i class="bi bi-hdd-stack"></i> Backups
                    </button>
                </li>
            </ul>
        </div>
        
        <div class="card-body">
            <div class="tab-content" id="logsTabContent">
                <!-- Orders Tab -->
                <div class="tab-pane fade show active" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                     <!-- Controls -->
                     <div class="row g-3 mb-4 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">Data do Log:</label>
                            <input type="date" id="ordersDate" class="form-control" value="{{ today }}">
                        </div>
                        <div class="col-md-3">
                             <label class="form-label">Filtrar (Busca):</label>
                             <input type="text" id="ordersSearch" class="form-control" placeholder="Mesa, Atendente...">
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-primary" onclick="loadLogs('orders')">
                                <i class="bi bi-search"></i> Buscar
                            </button>
                            <button class="btn btn-success" onclick="exportLogs('orders')">
                                <i class="bi bi-file-earmark-arrow-down"></i> Exportar (JSON)
                            </button>
                        </div>
                     </div>
                     
                     <!-- Table -->
                     <div class="table-responsive">
                        <table class="table table-hover table-striped" id="ordersTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Hora</th>
                                    <th>Ação</th>
                                    <th>Mesa</th>
                                    <th>Atendente</th>
                                    <th>Itens</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                     </div>
                </div>
                
                <!-- System Tab -->
                <div class="tab-pane fade" id="system" role="tabpanel" aria-labelledby="system-tab">
                     <!-- Controls -->
                     <div class="row g-3 mb-4 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">Data do Log:</label>
                            <input type="date" id="systemDate" class="form-control" value="{{ today }}">
                        </div>
                        <div class="col-md-3">
                             <label class="form-label">Filtrar (Busca):</label>
                             <input type="text" id="systemSearch" class="form-control" placeholder="Ação, Usuário...">
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-primary" onclick="loadLogs('system')">
                                <i class="bi bi-search"></i> Buscar
                            </button>
                            <button class="btn btn-success" onclick="exportLogs('system')">
                                <i class="bi bi-file-earmark-arrow-down"></i> Exportar (JSON)
                            </button>
                        </div>
                     </div>
                     
                     <!-- Table -->
                     <div class="table-responsive">
                        <table class="table table-hover table-striped" id="systemTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Hora</th>
                                    <th>Ação</th>
                                    <th>Usuário</th>
                                    <th>Categoria</th>
                                    <th style="width: 40%;">Detalhes</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                     </div>
                </div>

                <div class="tab-pane fade" id="actions" role="tabpanel" aria-labelledby="actions-tab">
                     <div class="row g-3 mb-4 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">Data do Log:</label>
                            <input type="date" id="actionsDate" class="form-control" value="{{ today }}">
                        </div>
                        <div class="col-md-3">
                             <label class="form-label">Filtrar (Busca):</label>
                             <input type="text" id="actionsSearch" class="form-control" placeholder="Ação, Usuário, Departamento...">
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-primary" onclick="loadLogs('actions')">
                                <i class="bi bi-search"></i> Buscar
                            </button>
                            <button class="btn btn-success" onclick="exportLogs('actions')">
                                <i class="bi bi-file-earmark-arrow-down"></i> Exportar (JSON)
                            </button>
                        </div>
                     </div>
                     
                     <div class="table-responsive">
                        <table class="table table-hover table-striped" id="actionsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Hora</th>
                                    <th>Ação</th>
                                    <th>Usuário</th>
                                    <th>Departamento</th>
                                    <th style="width: 40%;">Detalhes</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                     </div>
                </div>

                <div class="tab-pane fade" id="stock" role="tabpanel" aria-labelledby="stock-tab">
                     <div class="row g-3 mb-4 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">Data do Log:</label>
                            <input type="date" id="stockDate" class="form-control" value="{{ today }}">
                        </div>
                        <div class="col-md-3">
                             <label class="form-label">Filtrar (Busca):</label>
                             <input type="text" id="stockSearch" class="form-control" placeholder="Produto, Usuário, Departamento...">
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-primary" onclick="loadLogs('stock')">
                                <i class="bi bi-search"></i> Buscar
                            </button>
                            <button class="btn btn-success" onclick="exportLogs('stock')">
                                <i class="bi bi-file-earmark-arrow-down"></i> Exportar (JSON)
                            </button>
                        </div>
                     </div>
                     
                     <div class="table-responsive">
                        <table class="table table-hover table-striped" id="stockTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Hora</th>
                                    <th>Departamento</th>
                                    <th>Usuário</th>
                                    <th>Ação</th>
                                    <th>Produto</th>
                                    <th>Qtd</th>
                                    <th style="width: 40%;">Detalhes</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                     </div>
                </div>

                <div class="tab-pane fade" id="cleaning" role="tabpanel" aria-labelledby="cleaning-tab">
                     <div class="row g-3 mb-4 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">Data do Log:</label>
                            <input type="date" id="cleaningDate" class="form-control" value="{{ today }}">
                        </div>
                        <div class="col-md-3">
                             <label class="form-label">Filtrar (Busca):</label>
                             <input type="text" id="cleaningSearch" class="form-control" placeholder="Quarto, Camareira...">
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-primary" onclick="loadLogs('cleaning')">
                                <i class="bi bi-search"></i> Buscar
                            </button>
                            <button class="btn btn-success" onclick="exportLogs('cleaning')">
                                <i class="bi bi-file-earmark-arrow-down"></i> Exportar (JSON)
                            </button>
                        </div>
                     </div>
                     
                     <div class="table-responsive">
                        <table class="table table-hover table-striped" id="cleaningTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Início</th>
                                    <th>Fim</th>
                                    <th>Quarto</th>
                                    <th>Camareira</th>
                                    <th>Duração (min)</th>
                                    <th>Tipo</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                     </div>
                </div>

                <div class="tab-pane fade" id="inspection" role="tabpanel" aria-labelledby="inspection-tab">
                     <div class="row g-3 mb-4 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">Data do Log:</label>
                            <input type="date" id="inspectionDate" class="form-control" value="{{ today }}">
                        </div>
                        <div class="col-md-3">
                             <label class="form-label">Filtrar (Busca):</label>
                             <input type="text" id="inspectionSearch" class="form-control" placeholder="Quarto, Usuário, Resultado...">
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-primary" onclick="loadLogs('inspection')">
                                <i class="bi bi-search"></i> Buscar
                            </button>
                            <button class="btn btn-success" onclick="exportLogs('inspection')">
                                <i class="bi bi-file-earmark-arrow-down"></i> Exportar (JSON)
                            </button>
                        </div>
                     </div>
                     
                     <div class="table-responsive">
                        <table class="table table-hover table-striped" id="inspectionTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Hora</th>
                                    <th>Quarto</th>
                                    <th>Usuário</th>
                                    <th>Resultado</th>
                                    <th style="width: 40%;">Observação</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                     </div>
                </div>

                <div class="tab-pane fade" id="audit" role="tabpanel" aria-labelledby="audit-tab">
                     <div class="row g-3 mb-4 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">Data do Log:</label>
                            <input type="date" id="auditDate" class="form-control" value="{{ today }}">
                        </div>
                        <div class="col-md-3">
                             <label class="form-label">Filtrar (Busca):</label>
                             <input type="text" id="auditSearch" class="form-control" placeholder="Ação, Usuário, Alvo...">
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-primary" onclick="loadLogs('audit')">
                                <i class="bi bi-search"></i> Buscar
                            </button>
                            <button class="btn btn-success" onclick="exportLogs('audit')">
                                <i class="bi bi-file-earmark-arrow-down"></i> Exportar (JSON)
                            </button>
                        </div>
                     </div>
                     
                     <div class="table-responsive">
                        <table class="table table-hover table-striped" id="auditTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Hora</th>
                                    <th>Usuário</th>
                                    <th>Ação</th>
                                    <th>Alvo</th>
                                    <th style="width: 40%;">Detalhes</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                     </div>
                </div>

                <div class="tab-pane fade" id="backups" role="tabpanel" aria-labelledby="backups-tab">
                     <div class="row g-3 mb-4 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">Data do Log:</label>
                            <input type="date" id="backupsDate" class="form-control" value="{{ today }}">
                        </div>
                        <div class="col-md-3">
                             <label class="form-label">Filtrar (Busca):</label>
                             <input type="text" id="backupsSearch" class="form-control" placeholder="Fonte, Status, Texto...">
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-primary" onclick="loadLogs('backups')">
                                <i class="bi bi-search"></i> Buscar
                            </button>
                            <button class="btn btn-success" onclick="exportLogs('backups')">
                                <i class="bi bi-file-earmark-arrow-down"></i> Exportar (JSON)
                            </button>
                        </div>
                     </div>
                     
                     <div class="table-responsive">
                        <table class="table table-hover table-striped" id="backupsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Hora</th>
                                    <th>Fonte</th>
                                    <th>Nível</th>
                                    <th style="width: 55%;">Mensagem</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                     </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function loadLogs(type) {
        const dateInput = document.getElementById(`${type}Date`);
        const searchInput = document.getElementById(`${type}Search`);
        const date = dateInput ? dateInput.value : '';
        const search = (searchInput ? searchInput.value : '').toLowerCase();
        const tbody = document.querySelector(`#${type}Table tbody`);
        
        tbody.innerHTML = '<tr><td colspan="100%" class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><br>Carregando logs...</td></tr>';
        
        fetch(`/api/logs/${type}?date=${date}`)
            .then(res => res.json())
            .then(data => {
                tbody.innerHTML = '';
                
                const filteredData = data.filter(log => {
                    if (!search) return true;
                    return JSON.stringify(log).toLowerCase().includes(search);
                });

                if(filteredData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="100%" class="text-center py-4 text-muted">Nenhum registro encontrado para esta data/filtro.</td></tr>';
                    return;
                }
                
                filteredData.reverse().forEach(log => {
                    let row = '';
                    const time = (log.timestamp || '').split(' ')[1] || (log.timestamp || '-');
                    
                    if(type === 'orders') {
                        let itemsStr = '-';
                        if (log.items && Array.isArray(log.items)) {
                            itemsStr = log.items.map(i => `${i.quantity || 1}x ${i.name || i.product_name || 'Item'}`).join(', ');
                        }
                        
                        let badgeClass = 'bg-secondary';
                        if (log.action === 'create') badgeClass = 'bg-success';
                        if (log.action === 'cancel') badgeClass = 'bg-danger';
                        
                        row = `
                            <tr>
                                <td class="font-monospace">${time}</td>
                                <td><span class="badge ${badgeClass}">${log.action}</span></td>
                                <td class="fw-bold">${log.table}</td>
                                <td>${log.waiter}</td>
                                <td class="small" title="${itemsStr}">${itemsStr.length > 60 ? itemsStr.substring(0, 60) + '...' : itemsStr}</td>
                                <td>R$ ${parseFloat(log.total || 0).toFixed(2)}</td>
                                <td>${log.status}</td>
                            </tr>
                        `;
                    } else if (type === 'system') {
                        let detailsStr = '';
                        if (typeof log.details === 'object') {
                            detailsStr = `<pre class="mb-0 small" style="max-height: 100px; overflow-y: auto;">${JSON.stringify(log.details, null, 2)}</pre>`;
                        } else {
                            detailsStr = log.details;
                        }
                        
                        row = `
                            <tr>
                                <td class="font-monospace">${time}</td>
                                <td class="fw-bold">${log.action}</td>
                                <td>${log.user}</td>
                                <td><span class="badge bg-info text-dark">${log.category}</span></td>
                                <td>${detailsStr}</td>
                            </tr>
                        `;
                    } else if (type === 'actions') {
                        row = `
                            <tr>
                                <td class="font-monospace">${time}</td>
                                <td class="fw-bold">${log.action || ''}</td>
                                <td>${log.user || ''}</td>
                                <td><span class="badge bg-secondary">${log.department || ''}</span></td>
                                <td>${log.details || ''}</td>
                            </tr>
                        `;
                    } else if (type === 'stock') {
                        row = `
                            <tr>
                                <td class="font-monospace">${time}</td>
                                <td><span class="badge bg-secondary">${log.department || ''}</span></td>
                                <td>${log.user || ''}</td>
                                <td class="fw-bold">${log.action || ''}</td>
                                <td>${log.product || ''}</td>
                                <td class="font-monospace">${typeof log.qty === 'number' ? log.qty.toFixed(3) : (log.qty ?? '')}</td>
                                <td>${log.details || ''}</td>
                            </tr>
                        `;
                    } else if (type === 'cleaning') {
                        row = `
                            <tr>
                                <td class="font-monospace">${log.start_time || ''}</td>
                                <td class="font-monospace">${log.end_time || ''}</td>
                                <td class="fw-bold">${log.room || ''}</td>
                                <td>${log.maid || ''}</td>
                                <td class="font-monospace">${log.duration_minutes ?? ''}</td>
                                <td>${log.type || ''}</td>
                            </tr>
                        `;
                    } else if (type === 'inspection') {
                        const obs = log.observation || '';
                        row = `
                            <tr>
                                <td class="font-monospace">${time}</td>
                                <td class="fw-bold">${log.room_number || ''}</td>
                                <td>${log.user || ''}</td>
                                <td><span class="badge ${log.result === 'passed' ? 'bg-success' : (log.result === 'failed' ? 'bg-danger' : 'bg-secondary')}">${log.result || ''}</span></td>
                                <td class="small" title="${obs}">${obs.length > 120 ? obs.substring(0, 120) + '...' : obs}</td>
                            </tr>
                        `;
                    } else if (type === 'audit') {
                        let detailsStr = '';
                        const detailsObj = log.target_details;
                        if (typeof detailsObj === 'object' && detailsObj !== null) {
                            detailsStr = `<pre class="mb-0 small" style="max-height: 100px; overflow-y: auto;">${JSON.stringify(detailsObj, null, 2)}</pre>`;
                        }
                        const justification = log.justification ? `<div class="small text-muted">${log.justification}</div>` : '';
                        row = `
                            <tr>
                                <td class="font-monospace">${time}</td>
                                <td>${log.user || ''}</td>
                                <td class="fw-bold">${log.action || ''}</td>
                                <td class="font-monospace">${log.target_id || ''}</td>
                                <td>${detailsStr}${justification}</td>
                            </tr>
                        `;
                    } else if (type === 'backups') {
                        row = `
                            <tr>
                                <td class="font-monospace">${time}</td>
                                <td>${log.source || ''}</td>
                                <td><span class="badge bg-secondary">${log.level || ''}</span></td>
                                <td class="small">${log.message || ''}</td>
                            </tr>
                        `;
                    }
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            })
            .catch(err => {
                console.error(err);
                tbody.innerHTML = '<tr><td colspan="100%" class="text-center text-danger py-4">Erro ao carregar logs. Verifique o console.</td></tr>';
            });
    }
    
    function exportLogs(type) {
        const dateInput = document.getElementById(`${type}Date`);
        const date = dateInput ? dateInput.value : '';
        window.location.href = `/api/logs/${type}/export?date=${date}`;
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        loadLogs('orders');
        document.querySelectorAll('#logsTab button[data-bs-toggle="tab"]').forEach(btn => {
            btn.addEventListener('shown.bs.tab', (e) => {
                const target = e.target.getAttribute('data-bs-target');
                if (target && target.startsWith('#')) {
                    const type = target.substring(1);
                    loadLogs(type);
                }
            });
        });
    });
</script>
{% endblock %}
