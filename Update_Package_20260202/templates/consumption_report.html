<style>
    @media print {
        @page {
            size: A4 portrait;
            margin: 1cm;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 9pt;
            color: #000;
            background: #fff;
        }
        .consumption-report {
            width: 100%;
        }
        .no-print {
            display: none !important;
        }
        .table {
            width: 100%;
            margin-bottom: 0.5rem;
            border-collapse: collapse;
        }
        .table th, .table td {
            padding: 2px 4px;
            border-bottom: 1px solid #ddd;
            vertical-align: top;
        }
        .table th {
            border-bottom: 2px solid #000;
            text-align: left;
            font-weight: bold;
            font-size: 8pt;
            text-transform: uppercase;
        }
        .section-header {
            font-size: 10pt;
            font-weight: bold;
            margin-top: 10px;
            margin-bottom: 4px;
            border-bottom: 1px solid #000;
            padding-bottom: 2px;
            text-transform: uppercase;
        }
        .total-row td {
            font-weight: bold;
            border-top: 1px solid #000;
        }
        .text-end { text-align: right; }
        .text-center { text-align: center; }
        
        /* Compact header */
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #000;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        .report-title {
            text-align: center;
        }
        .report-title h3 { margin: 0; font-size: 14pt; }
        .report-title h4 { margin: 0; font-size: 11pt; }
        
        .guest-info {
            font-size: 9pt;
            margin-bottom: 10px;
        }
        
        .summary-box {
            margin-top: 15px;
            border: 1px solid #000;
            padding: 5px;
            width: 50%;
            float: right;
        }
        .service-fee-note {
            margin-top: 20px;
            font-size: 8pt;
            color: #555;
            border-top: 1px dashed #ccc;
            padding-top: 5px;
            clear: both;
        }
    }
    
    /* Screen styles (copy of print mainly) */
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 9pt;
    }
    .consumption-report {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }
    .table {
        width: 100%;
        margin-bottom: 0.5rem;
        border-collapse: collapse;
    }
    .table th, .table td {
        padding: 4px;
        border-bottom: 1px solid #ddd;
    }
    .table th {
        font-weight: bold;
        background-color: #f8f9fa;
    }
    .section-header {
        font-size: 11pt;
        font-weight: bold;
        margin-top: 20px;
        margin-bottom: 5px;
        border-bottom: 2px solid #eee;
        padding-bottom: 2px;
    }
    .text-end { text-align: right; }
    .text-center { text-align: center; }
    .report-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    .badge {
        display: inline-block;
        padding: 0.25em 0.4em;
        font-size: 75%;
        font-weight: 700;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
    }
    .bg-info { background-color: #0dcaf0; color: #000; }
    .bg-warning { background-color: #ffc107; color: #000; }
</style>

<div class="consumption-report">
    <div class="report-header">
        <div style="width: 20%;">
            <img src="{{ url_for('static', filename='img/LOGO-almareia.png', _external=True) }}" alt="Almareia" style="max-height: 50px;">
        </div>
        <div class="report-title" style="flex-grow: 1;">
            <h3>EXTRATO DE CONSUMO</h3>
            <h4>Quarto {{ room_number }}</h4>
        </div>
        <div style="width: 20%; text-align: right;">
            <img src="{{ url_for('static', filename='img/LOGO-MIRA.PNG', _external=True) }}" alt="Mirapraia" style="max-height: 50px;">
        </div>
    </div>
    
    <div class="guest-info">
        <div style="float: left;"><strong>Hóspede:</strong> {{ guest_name }}</div>
        <div style="float: right;"><strong>Emissão:</strong> {{ generation_date }}</div>
        <div style="clear: both;"></div>
    </div>

    {% set totals = namespace(minibar=0, restaurant=0, service=0) %}
    {% set minibar_charges = charges|selectattr('source', 'equalto', 'minibar')|list %}
    {% set restaurant_charges = charges|rejectattr('source', 'equalto', 'minibar')|list %}

    <!-- FRIGOBAR SECTION -->
    {% if minibar_charges %}
    <div class="section-header">FRIGOBAR</div>
    <table class="table table-sm">
        <thead>
            <tr>
                <th style="width: 15%">Data</th>
                <th style="width: 45%">Item</th>
                <th style="width: 10%" class="text-center">Qtd</th>
                <th style="width: 15%" class="text-end">Unit.</th>
                <th style="width: 15%" class="text-end">Total</th>
            </tr>
        </thead>
        <tbody>
            {% for charge in minibar_charges %}
                {% for item in charge.line_items %}
                <tr>
                    <td>{{ charge.date }}</td>
                    <td>{{ item.name }}</td>
                    <td class="text-center">{{ item.qty }}</td>
                    <td class="text-end">{{ "%.2f"|format(item.unit_price) }}</td>
                    <td class="text-end">{{ "%.2f"|format(item.total) }}</td>
                </tr>
                {% endfor %}
                {% set totals.minibar = totals.minibar + (charge.total or 0) %}
            {% endfor %}
            <tr class="total-row">
                <td colspan="4" class="text-end">Total Frigobar:</td>
                <td class="text-end">R$ {{ "%.2f"|format(totals.minibar) }}</td>
            </tr>
        </tbody>
    </table>
    {% endif %}

    <!-- RESTAURANT SECTION -->
    {% if restaurant_charges %}
    <div class="section-header">RESTAURANTE / BAR</div>
    <table class="table table-sm">
        <thead>
            <tr>
                <th style="width: 15%">Data</th>
                <th style="width: 45%">Item</th>
                <th style="width: 10%" class="text-center">Qtd</th>
                <th style="width: 15%" class="text-end">Unit.</th>
                <th style="width: 15%" class="text-end">Total</th>
            </tr>
        </thead>
        <tbody>
            {% for charge in restaurant_charges %}
                {% for item in charge.line_items %}
                <tr>
                    <td>{{ charge.date }} <small>{{ charge.time }}</small></td>
                    <td>{{ item.name }}</td>
                    <td class="text-center">{{ item.qty }}</td>
                    <td class="text-end">{{ "%.2f"|format(item.unit_price) }}</td>
                    <td class="text-end">{{ "%.2f"|format(item.total) }}</td>
                </tr>
                {% endfor %}
                {% set totals.restaurant = totals.restaurant + ((charge.total or 0) - (charge.service_fee or 0)) %}
                {% set totals.service = totals.service + (charge.service_fee or 0) %}
            {% endfor %}
            <tr class="total-row">
                <td colspan="4" class="text-end">Subtotal Consumo:</td>
                <td class="text-end">R$ {{ "%.2f"|format(totals.restaurant) }}</td>
            </tr>
        </tbody>
    </table>
    {% endif %}

    <!-- SUMMARY SECTION -->
    <div style="overflow: hidden;">
        <div class="summary-box">
            <table class="table" style="margin: 0; border: none;">
                <tr>
                    <td style="border: none;">Total Frigobar:</td>
                    <td class="text-end" style="border: none;">R$ {{ "%.2f"|format(totals.minibar) }}</td>
                </tr>
                <tr>
                    <td style="border: none;">Total Consumo:</td>
                    <td class="text-end" style="border: none;">R$ {{ "%.2f"|format(totals.restaurant) }}</td>
                </tr>
                {% if totals.service > 0 %}
                <tr>
                    <td style="border: none;">Taxa de Serviço (10%):</td>
                    <td class="text-end" style="border: none;">R$ {{ "%.2f"|format(totals.service) }}</td>
                </tr>
                {% endif %}
                <tr style="font-weight: bold; font-size: 11pt; border-top: 2px solid #000;">
                    <td style="border: none;">TOTAL GERAL:</td>
                    <td class="text-end" style="border: none;">R$ {{ "%.2f"|format(totals.minibar + totals.restaurant + totals.service) }}</td>
                </tr>
            </table>
        </div>
    </div>

    {% if totals.service > 0 %}
    <div class="service-fee-note">
        * Inclui R$ {{ "%.2f"|format(totals.service) }} referente a 10% de taxa de serviço (opcional/já pago conforme comanda).
    </div>
    {% endif %}
    
    <div style="margin-top: 30px; text-align: center; font-size: 8pt;">
        <p>________________________________________________</p>
        <p>Assinatura do Hóspede</p>
    </div>
</div>
