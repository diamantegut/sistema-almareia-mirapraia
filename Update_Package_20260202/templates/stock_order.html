{% extends 'base.html' %}

{% block title %}Comprar Mercadoria - Estoques{% endblock %}

{% block content %}
<style>
    .product-row.suggested {
        background-color: #fff9e6;
    }
    .stock-low {
        color: #e74c3c;
    }
    .stock-good {
        color: #27ae60;
    }
</style>
<div class="service-page">
    <div class="service-header">
            <span class="service-icon"><i class="bi bi-file-earmark-text"></i></span>
            <h2>Comprar Mercadoria</h2>
        </div>

    <div style="margin-bottom: 20px;">
        <a href="{{ url_for('index') }}" class="action-btn" style="background-color: #95a5a6; text-decoration: none;"><i class="bi bi-arrow-left"></i> Voltar</a>
    </div>

    <div class="card">
        <!-- Suggestion Buttons -->
        <div class="suggestion-actions" style="margin-bottom: 20px; display: flex; gap: 10px; justify-content: flex-end;">
            <a href="{{ url_for('stock_order') }}" class="action-btn" style="background-color: #95a5a6; font-size: 0.9em;"><i class="bi bi-x-circle"></i> Limpar Sugestões</a>
            <a href="{{ url_for('stock_order', suggest='min_stock') }}" class="action-btn" style="background-color: #e67e22; font-size: 0.9em;"><i class="bi bi-exclamation-triangle-fill"></i> Sugerir por Estoque Mínimo</a>
            <a href="{{ url_for('stock_order', suggest='frequency') }}" class="action-btn" style="background-color: #1e3a8a; font-size: 0.9em;"><i class="bi bi-calendar-event"></i> Sugerir por Frequência</a>
        </div>

        <div class="filter-section" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <div class="form-row" style="align-items: flex-end; gap: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label>Modo de Seleção:</label>
                    <select id="filterMode" onchange="updateFilter()" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="supplier">Por Fornecedor</option>
                        <option value="category">Por Categoria</option>
                        <option value="all">Todos os Produtos</option>
                    </select>
                </div>

                <div class="form-group" id="supplierGroup" style="flex: 2;">
                    <label>Selecione o Fornecedor:</label>
                    <select id="supplierSelect" onchange="applyFilter()" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="">Selecione...</option>
                        {% for s in suppliers %}
                        <option value="{{ s.name }}">{{ s.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group" id="categoryGroup" style="display: none; flex: 2;">
                    <label>Selecione a Categoria:</label>
                    <select id="categorySelect" onchange="applyFilter()" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="">Selecione...</option>
                        {% for c in categories %}
                        <option value="{{ c }}">{{ c }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group" style="flex: 2;">
                    <label>Buscar Produto:</label>
                    <input type="text" id="searchInput" onkeyup="applyFilter()" placeholder="Digite o nome..." style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                </div>
            </div>
        </div>

        <form method="POST" action="{{ url_for('stock_order') }}" target="_blank">
            <!-- Hidden field to pass selected supplier name if needed for print header -->
            <input type="hidden" name="selected_supplier" id="hiddenSupplier">

            <div class="products-list">
                <table class="table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: #f1f2f6;">
                            <th>Produto</th>
                            <th>Fornecedores</th>
                            <th>Estoque Atual</th>
                            <th>Embalagem</th>
                            <th>Preço Unit.</th>
                            <th style="width: 140px;">Qtd. Necessária</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        {% if not products %}
                        <tr>
                            <td colspan="6" style="padding: 30px; text-align: center; color: #7f8c8d;">
                                {% if request.args.get('suggest') %}
                                    <i>Nenhuma sugestão encontrada para este critério. Todos os produtos estão em dia! <i class="bi bi-emoji-smile-fill"></i></i>
                                {% else %}
                                    Nenhum produto cadastrado.
                                {% endif %}
                            </td>
                        </tr>
                        {% endif %}
                        {% for product in products %}
                        <tr class="product-row {% if product.suggested_qty > 0 %}suggested{% endif %}" 
                            data-suppliers="{{ product.suppliers|tojson|forceescape }}"
                            data-category="{{ product.category }}"
                            style="border-bottom: 1px solid #eee;">
                            <td>
                                {{ product.name }}
                                {% if product.suggestion_reason %}
                                <div style="font-size: 0.8em; color: #d35400;">
                                    <i class="bi bi-info-circle-fill"></i> {{ product.suggestion_reason }}
                                </div>
                                {% endif %}
                            </td>
                            <td>
                                {% if product.suppliers %}
                                    {{ product.suppliers|join(', ') }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td style="font-weight: bold;" class="{{ 'stock-low' if (product.balance or 0) < (product.min_stock or 0) else 'stock-good' }}">
                                {{ "%.2f"|format(product.balance or 0) }} {{ product.unit }}
                                {% if (product.balance or 0) < (product.min_stock or 0) %}
                                    <small>(Mín: {{ "%.2f"|format(product.min_stock or 0) }})</small>
                                {% endif %}
                            </td>
                            <td>
                                {{ product.package_size or '-' }}
                            </td>
                            <td>
                                R$ {{ "%.2f"|format(product.price or 0) }}
                            </td>
                            <td>
                                <input type="number" step="0.01" min="0" 
                                       name="qty_{{ product.id }}" 
                                       value="{{ product.suggested_qty if product.suggested_qty > 0 else '' }}"
                                       placeholder="0.00"
                                       style="width: 100px; padding: 5px;">
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
                <div id="noProductsMsg" style="display: none; padding: 20px; text-align: center; color: #7f8c8d;">
                    Nenhum produto encontrado para o filtro selecionado.
                </div>
            </div>

            <div class="form-actions" style="margin-top: 20px; justify-content: flex-end;">
                <button type="submit" class="action-btn" style="background-color: #27ae60;"><i class="bi bi-printer-fill"></i> Comprar Mercadoria</button>
            </div>
        </form>
    </div>
    
    <div class="form-actions" style="margin-top: 20px;">
        <a href="{{ url_for('index') }}" class="cancel-link">Voltar</a>
    </div>
</div>

<script>
function updateFilter() {
    var mode = document.getElementById('filterMode').value;
    var supplierGroup = document.getElementById('supplierGroup');
    var categoryGroup = document.getElementById('categoryGroup');
    
    // Reset selections
    var supplierSelect = document.getElementById('supplierSelect');
    supplierSelect.value = '';
    if (supplierSelect.tomselect) supplierSelect.tomselect.setValue('');

    var categorySelect = document.getElementById('categorySelect');
    categorySelect.value = '';
    if (categorySelect.tomselect) categorySelect.tomselect.setValue('');
    
    if (mode === 'supplier') {
        supplierGroup.style.display = 'block';
        categoryGroup.style.display = 'none';
    } else if (mode === 'category') {
        supplierGroup.style.display = 'none';
        categoryGroup.style.display = 'block';
    } else {
        supplierGroup.style.display = 'none';
        categoryGroup.style.display = 'none';
    }
    applyFilter();
}

function applyFilter() {
    var mode = document.getElementById('filterMode').value;
    var selectedSupplier = document.getElementById('supplierSelect').value;
    var selectedCategory = document.getElementById('categorySelect').value;
    var searchText = document.getElementById('searchInput').value.toLowerCase();
    var rows = document.querySelectorAll('.product-row');
    var visibleCount = 0;

    // Update hidden supplier field for print view
    document.getElementById('hiddenSupplier').value = (mode === 'supplier') ? selectedSupplier : '';

    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var show = false;
        
        if (mode === 'all') {
            show = true;
        } else if (mode === 'supplier') {
            if (selectedSupplier) {
                // Check if product has this supplier
                var suppliers = JSON.parse(row.dataset.suppliers || '[]');
                if (suppliers.indexOf(selectedSupplier) !== -1) {
                    show = true;
                }
            } else {
                show = true; 
            }
        } else if (mode === 'category') {
            if (selectedCategory) {
                if (row.dataset.category === selectedCategory) {
                    show = true;
                }
            } else {
                show = true;
            }
        }
        
        // Apply text search filter
        if (show && searchText) {
            var productName = row.querySelector('td:first-child').innerText.toLowerCase();
            if (productName.indexOf(searchText) === -1) {
                show = false;
            }
        }

        if (show) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    }

    var msg = document.getElementById('noProductsMsg');
    if (visibleCount === 0) {
        msg.style.display = 'block';
    } else {
        msg.style.display = 'none';
    }
}

// Initial call
updateFilter();
</script>
{% endblock %}
