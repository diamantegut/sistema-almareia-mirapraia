{% extends 'base.html' %}

{% block content %}
<div class="service-container">
    <div class="header-section">
        <h1>Separação e Entrega de Materiais</h1>
        <p>Pedidos pendentes de separação e entrega.</p>
    </div>

    <div style="margin-bottom: 20px;">
        <a href="{{ url_for('index') }}" class="action-btn" style="background-color: #95a5a6; text-decoration: none;">← Voltar</a>
    </div>

    {% if requests %}
        {% for req in requests %}
        <div class="request-card" style="background: white; border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
            <div class="req-header" style="display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <div>
                    <strong>Departamento:</strong> {{ req.department }}<br>
                    <strong>Solicitante:</strong> {{ req.user }}<br>
                    <small>Data: {{ req.date }} às {{ req.time }}</small>
                </div>
                <div style="text-align: right;">
                    <span class="badge {{ 'badge-danger' if req.type == 'Emergency' else 'badge-primary' }}">
                        {{ 'Emergência' if req.type == 'Emergency' else 'Padrão' }}
                    </span>
                    <br>
                    <small>ID: {{ req.id }}</small>
                </div>
            </div>

            <form action="{{ url_for('stock_fulfillment') }}" method="POST">
                <input type="hidden" name="req_id" value="{{ req.id }}">
                
                <table class="table" style="margin-bottom: 15px;">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Qtd. Solicitada</th>
                            <th>Qtd. Entregue</th>
                            <th>Destino</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if req.items_structured %}
                            {% for item in req.items_structured %}
                            <tr>
                                <td>{{ item.name }}</td>
                                <td>{{ item.qty }}</td>
                                <td>
                                    <input type="number" step="0.01" name="qty_{{ req.id }}_{{ loop.index0 }}" 
                                           value="{{ item.qty }}" class="form-control" style="width: 100px;">
                                </td>
                                <td>
                                    <select name="destination_{{ req.id }}_{{ loop.index0 }}" class="form-control" style="width: 150px;">
                                        {% for dept in departments %}
                                            <option value="{{ dept }}" {% if dept == req.department %}selected{% endif %}>{{ dept }}</option>
                                        {% endfor %}
                                        <option value="USO INTERNO">USO INTERNO</option>
                                    </select>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <!-- Fallback for legacy text requests -->
                            <tr>
                                <td colspan="3">
                                    {{ req.items }} <br>
                                    <small class="text-warning">Pedido antigo (texto). Entrega total assumida.</small>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>

                <div class="form-actions" style="justify-content: flex-end;">
                    <button type="submit" class="action-btn" style="background-color: #27ae60;">Confirmar Entrega</button>
                </div>
            </form>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <p>Não há solicitações pendentes de separação.</p>
            <a href="{{ url_for('index') }}" class="action-btn">Voltar</a>
        </div>
    {% endif %}
</div>
{% endblock %}