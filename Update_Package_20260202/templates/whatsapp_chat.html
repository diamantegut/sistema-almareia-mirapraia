{% extends "base.html" %}

{% block title %}Chat WhatsApp - Recepção{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h3><i class="bi bi-whatsapp text-success"></i> Chat WhatsApp Recepção</h3>
            <a href="{{ url_for('reception_dashboard') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    <div class="row" style="height: 75vh;">
        <!-- Conversation List -->
        <div class="col-md-4 col-lg-3 border-end d-flex flex-column h-100">
            <div class="p-2 border-bottom">
                <input type="text" id="searchContact" class="form-control form-control-sm" placeholder="Buscar conversa...">
            </div>
            <div class="list-group list-group-flush overflow-auto flex-grow-1" id="conversationList">
                <!-- Loaded via JS -->
                <div class="text-center p-3 text-muted">Carregando conversas...</div>
            </div>
        </div>

        <!-- Chat Window -->
        <div class="col-md-8 col-lg-9 d-flex flex-column h-100 bg-light">
            <!-- Header -->
            <div class="p-2 border-bottom bg-white d-none justify-content-between align-items-center" id="chatHeader">
                <div>
                    <h6 class="mb-0 d-flex align-items-center">
                        <span id="chatContactName">Selecione uma conversa</span>
                        <button class="btn btn-sm btn-link text-secondary p-0 ms-2" onclick="editName()" title="Editar Nome">
                            <i class="bi bi-pencil" style="font-size: 0.9rem;"></i>
                        </button>
                    </h6>
                    <small class="text-muted" id="chatContactPhone" style="font-size: 0.8rem;"></small>
                    <div id="chatTags" class="mt-1"></div>
                </div>
                <div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="tagDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-tag"></i> Tags
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="tagDropdown" id="tagDropdownMenu">
                            <!-- Loaded via JS -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Messages Area -->
            <div class="flex-grow-1 overflow-auto p-3" id="messagesArea" style="background-color: #e5ddd5;">
                <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                    Selecione um contato para iniciar o chat
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-2 bg-white border-top" id="inputArea" style="display: none;">
                <div class="input-group">
                    <button class="btn btn-outline-primary" type="button" id="improveBtn" title="Melhorar Gramática">
                        <i class="bi bi-magic"></i>
                    </button>
                    <input type="text" id="messageInput" class="form-control" placeholder="Digite sua mensagem...">
                    <button class="btn btn-success" type="button" id="sendBtn">
                        <i class="bi bi-send"></i> Enviar
                    </button>
                </div>
                <small class="text-muted" style="font-size: 0.7rem;">Mensagens enviadas via WhatsApp Cloud API.</small>
            </div>
        </div>
    </div>
</div>

<!-- Tag Management Modal -->
<div class="modal fade" id="tagsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gerenciar Tags</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" id="newTagName" class="form-control" placeholder="Nome da Tag">
                    <input type="color" id="newTagColor" class="form-control form-control-color" value="#6c757d" title="Cor da Tag">
                    <button class="btn btn-success" onclick="addNewTag()">Adicionar</button>
                </div>
                <div class="alert alert-info py-1 px-2 mb-2" style="font-size: 0.85rem;">
                    <i class="bi bi-info-circle"></i> Use as setas para reordenar a prioridade das tags.
                </div>
                <ul class="list-group" id="tagsListConfig">
                    <!-- Dynamic list -->
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Edit Name Modal -->
<div class="modal fade" id="nameModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Nome</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Nome do Contato</label>
                    <input type="text" id="editNameInput" class="form-control" placeholder="Ex: João da Silva">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary btn-sm" onclick="saveName()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentPhone = null;
let currentTags = [];
let allTagsConfig = []; // Loaded from backend
let nameModalInstance = null;
let tagsModalInstance = null;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize Modals
    nameModalInstance = new bootstrap.Modal(document.getElementById('nameModal'));
    tagsModalInstance = new bootstrap.Modal(document.getElementById('tagsModal'));

    loadTagsConfig().then(() => {
        loadConversations();
    });

    // Send on Enter
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    
    document.getElementById('improveBtn').addEventListener('click', function() {
        const input = document.getElementById('messageInput');
        const text = input.value;
        if (!text) return;
        
        const icon = this.querySelector('i');
        const originalClass = icon.className;
        icon.className = 'spinner-border spinner-border-sm';
        
        fetch('/api/chat/improve_text', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({text: text})
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                input.value = data.text;
            }
        })
        .finally(() => {
            icon.className = originalClass;
        });
    });

    // Auto refresh
    setInterval(function() {
        if (currentPhone) {
            loadMessages(currentPhone, false); 
        }
        loadConversations();
    }, 10000); // 10s
});

// --- Tags Management ---

function loadTagsConfig() {
    return fetch('/api/chat/tags_config')
        .then(r => r.json())
        .then(data => {
            allTagsConfig = data.tags || [];
            updateTagDropdown();
            updateTagsConfigList();
        });
}

function updateTagDropdown() {
    const menu = document.getElementById('tagDropdownMenu');
    let html = '';
    
    allTagsConfig.forEach(tag => {
        const safeName = tag.name.replace(/'/g, "\\'");
        // Check if tag is active
        const isActive = currentTags.includes(tag.name);
        const checkMark = isActive ? '<i class="bi bi-check me-1"></i>' : '';
        const activeClass = isActive ? 'active' : '';
        
        html += `<li><a class="dropdown-item ${activeClass}" href="#" onclick="event.preventDefault(); event.stopPropagation(); toggleTag('${safeName}')">
            ${checkMark}<span class="badge" style="background-color: ${tag.color}">${tag.name}</span>
        </a></li>`;
    });
    
    html += `<li><hr class="dropdown-divider"></li>`;
    html += `<li><a class="dropdown-item" href="#" onclick="event.preventDefault(); openTagsModal()">
        <i class="bi bi-gear"></i> Gerenciar Tags
    </a></li>`;
    
    menu.innerHTML = html;
}

function openTagsModal() {
    tagsModalInstance.show();
}

function updateTagsConfigList() {
    const list = document.getElementById('tagsListConfig');
    let html = '';
    
    allTagsConfig.forEach((tag, index) => {
        html += `
        <li class="list-group-item d-flex justify-content-between align-items-center p-2">
            <div class="d-flex align-items-center">
                <input type="color" class="form-control form-control-color form-control-sm me-2" value="${tag.color}" onchange="updateTagColor(${index}, this.value)" title="Mudar cor">
                <input type="text" class="form-control form-control-sm border-0" value="${tag.name}" onchange="updateTagName(${index}, this.value)" style="width: 150px;">
            </div>
            <div>
                <button class="btn btn-sm btn-outline-secondary py-0 px-1" onclick="moveTag(${index}, -1)" ${index === 0 ? 'disabled' : ''} title="Subir">▲</button>
                <button class="btn btn-sm btn-outline-secondary py-0 px-1" onclick="moveTag(${index}, 1)" ${index === allTagsConfig.length - 1 ? 'disabled' : ''} title="Descer">▼</button>
                <button class="btn btn-sm btn-outline-danger py-0 px-1 ms-1" onclick="deleteTag(${index})" title="Remover">×</button>
            </div>
        </li>
        `;
    });
    
    list.innerHTML = html;
}

function addNewTag() {
    const nameInput = document.getElementById('newTagName');
    const colorInput = document.getElementById('newTagColor');
    const name = nameInput.value.trim();
    const color = colorInput.value;
    
    if (!name) return;
    
    allTagsConfig.push({name, color});
    nameInput.value = '';
    
    saveTagsConfig();
}

function deleteTag(index) {
    if (confirm('Tem certeza que deseja remover esta tag?')) {
        allTagsConfig.splice(index, 1);
        saveTagsConfig();
    }
}

function moveTag(index, direction) {
    if (direction === -1 && index > 0) {
        // Move Up
        [allTagsConfig[index], allTagsConfig[index - 1]] = [allTagsConfig[index - 1], allTagsConfig[index]];
    } else if (direction === 1 && index < allTagsConfig.length - 1) {
        // Move Down
        [allTagsConfig[index], allTagsConfig[index + 1]] = [allTagsConfig[index + 1], allTagsConfig[index]];
    }
    saveTagsConfig();
}

function updateTagColor(index, newColor) {
    allTagsConfig[index].color = newColor;
    saveTagsConfig();
}

function updateTagName(index, newName) {
    if (!newName.trim()) return;
    allTagsConfig[index].name = newName.trim();
    saveTagsConfig();
}

function saveTagsConfig() {
    // Update UI immediately
    updateTagsConfigList();
    updateTagDropdown();
    loadConversations(); // Re-render groups
    
    fetch('/api/chat/tags_config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({tags: allTagsConfig})
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success) {
            alert('Erro ao salvar tags: ' + (data.error || 'Erro desconhecido'));
        }
    });
}

// --- Conversation List & Chat ---

function loadConversations() {
    const search = document.getElementById('searchContact').value.toLowerCase();
    
    fetch('/api/chat/conversations')
        .then(r => r.json())
        .then(conversations => {
            const list = document.getElementById('conversationList');
            
            if (conversations.length === 0) {
                list.innerHTML = '<div class="text-center p-3 text-muted">Nenhuma conversa iniciada.</div>';
                return;
            }

            // Filter if searching
            if (search) {
                conversations = conversations.filter(c => 
                    c.phone.includes(search) || 
                    (c.name && c.name.toLowerCase().includes(search)) ||
                    (c.last_message && c.last_message.content && c.last_message.content.toLowerCase().includes(search))
                );
            }

            // Grouping Logic based on Priority (allTagsConfig order)
            const groups = {};
            // Initialize groups in order
            allTagsConfig.forEach(tag => {
                groups[tag.name] = [];
            });
            groups['Outros'] = [];

            conversations.forEach(conv => {
                let assigned = false;
                
                if (conv.tags && conv.tags.length > 0) {
                    // Find matching tags
                    conv.tags.forEach(tagName => {
                        if (groups[tagName]) {
                            groups[tagName].push(conv);
                            assigned = true;
                        }
                    });
                }
                
                // If not assigned to any known tag, put in Outros
                // Note: If a conversation has multiple tags, it appears in multiple groups.
                // If we want it only in the highest priority group:
                // We would iterate allTagsConfig and find the first match.
                // Requirement: "fila de prioridade de tag" implies order matters.
                // Let's stick to "appear in all relevant groups" for visibility, 
                // but displayed in order of groups.
                
                if (!assigned) {
                    groups['Outros'].push(conv);
                }
            });

            let html = '';
            
            // Render groups in order
            const orderedGroupNames = [...allTagsConfig.map(t => t.name), 'Outros'];
            
            orderedGroupNames.forEach(groupName => {
                const convs = groups[groupName];
                if (!convs || convs.length === 0) return;
                
                // Sort conversations within group by date desc
                convs.sort((a, b) => {
                    const tA = a.last_message ? new Date(a.last_message.timestamp).getTime() : 0;
                    const tB = b.last_message ? new Date(b.last_message.timestamp).getTime() : 0;
                    return tB - tA;
                });

                html += `
                <div class="bg-light px-2 py-1 border-bottom border-top fw-bold text-uppercase d-flex justify-content-between align-items-center text-secondary" style="font-size: 0.7rem; background-color: #f8f9fa;">
                    ${groupName}
                    <span class="badge bg-secondary rounded-pill" style="font-size: 0.6em;">${convs.length}</span>
                </div>
                `;
                
                convs.forEach(conv => {
                    const activeClass = (currentPhone === conv.phone) ? 'active' : '';
                    const lastMsg = conv.last_message ? conv.last_message.content : '';
                    const timestamp = conv.last_message ? new Date(conv.last_message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                    const isUnread = conv.last_message && conv.last_message.type === 'received';
                    const displayName = conv.name || conv.phone; // Show name if available
                    
                    // Render tags badges
                    let tagsHtml = '';
                    if (conv.tags) {
                        conv.tags.forEach(tName => {
                            const tConfig = allTagsConfig.find(t => t.name === tName);
                            const color = tConfig ? tConfig.color : '#6c757d';
                            tagsHtml += `<span class="badge me-1" style="background-color: ${color}; font-size: 0.75em; padding: 3px 5px;">${tName}</span>`;
                        });
                    }

                    // Compact Item
                    html += `
                    <a href="#" class="list-group-item list-group-item-action ${activeClass} p-2 border-bottom-0" onclick="selectConversation('${conv.phone}')" style="font-size: 0.85rem;">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <strong class="text-truncate" style="max-width: 75%; font-size: 0.9rem; color: #333;">
                                ${displayName}
                            </strong>
                        </div>
                        <div class="mt-1">${tagsHtml}</div>
                    </a>
                    `;
                });
            });
            
            list.innerHTML = html;
        });
}

// --- Name Editing ---

function editName() {
    if (!currentPhone) return;
    
    // Get current name
    const currentName = document.getElementById('chatContactName').innerText;
    // If it's the phone number, empty the input
    const isPhone = currentName.replace(/\D/g, '') === currentPhone;
    
    document.getElementById('editNameInput').value = isPhone ? '' : currentName;
    nameModalInstance.show();
}

function saveName() {
    const name = document.getElementById('editNameInput').value.trim();
    if (!currentPhone) {
        console.error('saveName: No currentPhone set');
        return;
    }
    
    fetch('/api/chat/name', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            phone: currentPhone,
            name: name
        })
    })
    .then(r => {
        if (!r.ok) throw new Error('Network response was not ok: ' + r.statusText);
        return r.json();
    })
    .then(data => {
        if (data.success) {
            nameModalInstance.hide();
            // Update UI
            document.getElementById('chatContactName').innerText = name || currentPhone;
            loadConversations(); // Refresh list to show new name
        } else {
            console.error('Save name failed:', data);
            alert('Erro ao salvar nome: ' + (data.message || 'Erro desconhecido'));
        }
    })
    .catch(err => {
        console.error('Error saving name:', err);
        alert('Erro de conexão ao salvar nome.');
    });
}

function selectConversation(phone) {
    currentPhone = phone;
    const header = document.getElementById('chatHeader');
    header.classList.remove('d-none');
    header.classList.add('d-flex');
    document.getElementById('inputArea').style.display = 'block';
    
    // We need to fetch the specific conversation data to get the name if we don't have it
    // But loadMessages doesn't return name.
    // Let's use the list data or fetch it. 
    // Optimization: find in the loaded list? 
    // For now, let's just use the API to get details if needed, or rely on what we have.
    // Actually, `loadConversations` updates the list. 
    // Let's fetch name from `chat_service.get_contact_name` via a new endpoint or existing?
    // We can just set the phone first, then loadTags (which returns tags).
    // Let's just update the header with what we know or fetch it.
    
    // Let's try to find it in the DOM or re-fetch.
    // Simplest: The list item click sets the name? 
    // Better: Add an endpoint or return name in `loadTags`?
    // Let's update `loadTags` to also return name.
    
    document.getElementById('chatContactName').innerText = formatPhone(phone); // Placeholder
    document.getElementById('chatContactPhone').innerText = phone;
    
    loadMessages(phone, true);
    loadTagsAndName(phone);
    loadConversations(); // Update active state
}

function loadTagsAndName(phone) {
    // We reuse the tags endpoint, maybe we should update backend to return name there too?
    // Or just use the conversation list data which we have.
    // But `loadConversations` is async.
    
    // Let's update backend `get_tags` to include name? 
    // No, let's just make a dedicated call or update `loadTags` to use a better endpoint.
    // Actually, `get_tags` only returns tags list.
    // I'll create `loadTagsAndName` that calls `loadTags` AND fetches name logic?
    
    // Better: modify backend `/api/chat/tags/<phone>` to return {tags: [], name: "..."}
    // Checking backend... `api_chat_tags` returns `jsonify({'tags': tags})`.
    // I should update it to return name too.
    
    fetch(`/api/chat/tags/${phone}`)
        .then(r => r.json())
        .then(data => {
            currentTags = data.tags || [];
            if (data.name) {
                document.getElementById('chatContactName').innerText = data.name;
            }
            renderTags();
            updateTagDropdown();
        });
}

// ... existing message/tag functions ...

function loadMessages(phone, scroll) {
    fetch(`/api/chat/history/${phone}`)
        .then(r => r.json())
        .then(msgs => {
            const area = document.getElementById('messagesArea');
            let html = '';
            
            msgs.forEach(msg => {
                const isSent = msg.type === 'sent';
                const align = isSent ? 'end' : 'start';
                const bg = isSent ? 'bg-success text-white' : 'bg-white';
                const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                html += `
                <div class="d-flex justify-content-${align} mb-2">
                    <div class="card ${bg} shadow-sm" style="max-width: 70%; border-radius: 15px;">
                        <div class="card-body py-2 px-3">
                            <p class="mb-0" style="font-size: 0.9rem;">${msg.content}</p>
                            <div class="text-${isSent ? 'light' : 'muted'} small text-end" style="font-size: 0.65rem;">${time}</div>
                        </div>
                    </div>
                </div>
                `;
            });
            
            if (msgs.length === 0) {
                html = '<div class="text-center p-3 text-muted">Inicie a conversa...</div>';
            }
            
            if (area.innerHTML !== html) {
                 area.innerHTML = html;
                 if (scroll) scrollToBottom();
            }
        });
}

function sendMessage() {
    const input = document.getElementById('messageInput');
    const msg = input.value.trim();
    if (!msg || !currentPhone) return;
    
    input.value = '';
    
    fetch('/api/chat/send', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            phone: currentPhone,
            message: msg
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadMessages(currentPhone, true);
        } else {
            alert('Erro ao enviar: ' + data.message);
        }
    });
}

function scrollToBottom() {
    const area = document.getElementById('messagesArea');
    area.scrollTop = area.scrollHeight;
}

function renderTags() {
    const container = document.getElementById('chatTags');
    let html = '';
    currentTags.forEach(tagName => {
        const tConfig = allTagsConfig.find(t => t.name === tagName);
        const color = tConfig ? tConfig.color : '#6c757d';
        html += `<span class="badge me-1" style="background-color: ${color}; font-size: 0.85em;">${tagName}</span>`;
    });
    container.innerHTML = html;
}

function toggleTag(tag) {
    if (!currentPhone) return;
    
    // Toggle logic
    const index = currentTags.indexOf(tag);
    if (index > -1) {
        currentTags.splice(index, 1);
    } else {
        currentTags.push(tag);
    }
    
    renderTags();
    updateTagDropdown(); // Update checkmarks
    
    fetch('/api/chat/tags', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            phone: currentPhone,
            tags: currentTags
        })
    }).then(r => r.json())
      .then(data => {
          loadConversations();
      });
}

function formatPhone(phone) {
    return phone; 
}
</script>
{% endblock %}
