{% extends 'base.html' %}

{% block title %}Requisição de Material - Back of the House{% endblock %}

{% block content %}
<div class="service-page">
    <div class="service-header">
        <span class="service-icon"><i class="bi bi-box-seam-fill"></i></span>
        <h2>Nova Requisição de Material</h2>
    </div>

    <div style="margin-bottom: 20px;">
        <a href="{{ url_for('index') }}" class="action-btn" style="background-color: #95a5a6; text-decoration: none;"><i class="bi bi-arrow-left"></i> Voltar</a>
    </div>

    <form method="POST" action="{{ url_for('new_stock_request') }}" class="maintenance-form" id="stockForm">
        <div class="form-group">
            <label>Tipo de Requisição:</label>
            <div class="radio-group">
                <label>
                    <input type="radio" name="type" value="Standard" checked onchange="toggleWarning()">
                    Padrão (Segunda/Quinta)
                </label>
                <label>
                    <input type="radio" name="type" value="Emergency" onchange="toggleWarning()">
                    Emergência (Sujeito a Multa após 2 pedidos/mês)
                </label>
            </div>
        </div>

        <div id="standard-warning" class="warning-box" style="display:none; background-color: #fff3cd; color: #856404; padding: 10px; margin-bottom: 15px; border: 1px solid #ffeeba; border-radius: 5px;">
            <i class="bi bi-exclamation-triangle-fill"></i> Pedidos Padrão só podem ser enviados às <strong>Segundas</strong> e <strong>Quintas</strong>.
        </div>

        <div id="emergency-warning" class="warning-box" style="display:none; background-color: #f8d7da; color: #721c24; padding: 10px; margin-bottom: 15px; border: 1px solid #f5c6cb; border-radius: 5px;">
            <i class="bi bi-exclamation-triangle-fill"></i> Pedidos de emergência são contabilizados. Após 2 pedidos no mês, será gerada uma multa para o departamento.
        </div>

        <div class="card" style="margin-bottom: 20px; background-color: #f9f9f9; padding: 15px;">
            <h4>Adicionar Itens</h4>
            <div class="form-row" style="display: flex; gap: 10px; align-items: flex-end;">
                <div class="form-group" style="flex: 3;">
                    <label for="productSelect">Produto:</label>
                    <select id="productSelect" class="filter-select" style="width: 100%;">
                        <option value="">Selecione um produto...</option>
                        {% for product in products %}
                        <option value="{{ product.name }}" data-id="{{ product.id }}">{{ product.name }} ({{ product.department }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="productQty">Qtd:</label>
                    <input type="number" id="productQty" min="1" value="1" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
                </div>
                <div class="form-group" style="flex: 0;">
                    <button type="button" onclick="addItem()" class="action-btn" style="margin-bottom: 0; background-color: #27ae60;"><i class="bi bi-plus-circle-fill"></i> Adicionar</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h4>Lista de Itens para Requisição</h4>
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="itemsTable">
                    <thead>
                        <tr>
                        <th>Produto</th>
                        <th width="80">Qtd</th>
                        <th width="50">Ação</th>
                    </tr>
                </thead>
                <tbody id="itemsListBody">
                    <!-- Items added by JS will appear here -->
                    <tr id="emptyRow">
                        <td colspan="3" style="text-align: center; color: #7f8c8d;">Nenhum item adicionado à lista.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Hidden input to store JSON data -->
        <input type="hidden" name="items_json" id="itemsJson">

        <div class="form-actions" style="margin-top: 20px;">
            <button type="submit" class="action-btn" onclick="return prepareSubmission()">Enviar Requisição</button>
            <a href="{{ url_for('index') }}" class="cancel-link">Cancelar</a>
        </div>
    </form>
</div>

<script>
let requestItems = [];

function toggleWarning() {
    const type = document.querySelector('input[name="type"]:checked').value;
    const today = new Date().getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
    
    if (type === 'Emergency') {
        document.getElementById('emergency-warning').style.display = 'block';
        document.getElementById('standard-warning').style.display = 'none';
    } else {
        document.getElementById('emergency-warning').style.display = 'none';
        // Python weekday: Mon=0, Thu=3. JS getDay: Mon=1, Thu=4.
        if (today !== 1 && today !== 4) {
             document.getElementById('standard-warning').style.display = 'block';
        } else {
             document.getElementById('standard-warning').style.display = 'none';
        }
    }
}

function addItem() {
    const select = document.getElementById('productSelect');
    const qtyInput = document.getElementById('productQty');
    
    const productName = select.value;
    const qty = parseInt(qtyInput.value);
    
    if (!productName) {
        alert('Selecione um produto.');
        return;
    }
    
    if (qty <= 0) {
        alert('Quantidade inválida.');
        return;
    }

    // Check if already in list
    const existingIndex = requestItems.findIndex(item => item.name === productName);
    if (existingIndex >= 0) {
        requestItems[existingIndex].qty += qty;
    } else {
        requestItems.push({
            name: productName,
            qty: qty
        });
    }
    
    renderList();
    
    // Reset inputs
    select.value = "";
    qtyInput.value = 1;
    select.focus();
}

function removeItem(index) {
    requestItems.splice(index, 1);
    renderList();
}

function renderList() {
    const tbody = document.getElementById('itemsListBody');
    tbody.innerHTML = '';
    
    if (requestItems.length === 0) {
        tbody.innerHTML = '<tr id="emptyRow"><td colspan="3" style="text-align: center; color: #7f8c8d;">Nenhum item adicionado à lista.</td></tr>';
        return;
    }
    
    requestItems.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${item.name}</td>
            <td>${item.qty}</td>
            <td><button type="button" onclick="removeItem(${index})" style="background: none; border: none; cursor: pointer; color: #e74c3c;"><i class="bi bi-trash-fill"></i></button></td>
        `;
        tbody.appendChild(tr);
    });
}

function prepareSubmission() {
    if (requestItems.length === 0) {
        alert('Adicione pelo menos um item à lista antes de enviar.');
        return false;
    }
    
    document.getElementById('itemsJson').value = JSON.stringify(requestItems);
    return true;
}

// Run on load
toggleWarning();
</script>
{% endblock %}
