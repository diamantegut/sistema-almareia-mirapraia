{% extends 'base.html' %}

{% block title %}Relatório Mensal de Conferências - Back of the House{% endblock %}

{% block content %}
<div class="report-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2><i class="bi bi-calendar-event"></i> Relatório Mensal de Conferências (16-15)</h2>
        <a href="{{ url_for('stock.conference_history') }}" class="action-btn" style="background-color: #95a5a6; text-decoration: none;">← Voltar</a>
    </div>

    <div class="card" style="margin-bottom: 20px;">
        <form method="POST" action="{{ url_for('stock.conference_monthly_report') }}" style="display: flex; align-items: center; gap: 10px;">
            <label for="period">Selecione o Período:</label>
            <select name="period" id="period" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;" onchange="this.form.submit()">
                {% for p in periods %}
                <option value="{{ p }}" {% if p == selected_period %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
            </select>
            <noscript><button type="submit" class="action-btn">Filtrar</button></noscript>
        </form>
    </div>

    {% if selected_period %}
    <div class="card" style="margin-bottom: 20px; border-left: 5px solid #e74c3c;">
        <h3>Resumo Financeiro do Período</h3>
        <p style="font-size: 1.1em;">Perdas Totais Capturadas: <strong style="color: #c0392b; font-size: 1.5em;">R$ {{ "%.2f"|format(total_loss) }}</strong></p>
    </div>

    <div class="summary-card">
        <h3><i class="bi bi-graph-down"></i> Detalhamento das Discrepâncias por Departamento</h3>
        {% if discrepancies_by_dept %}
            {% for dept, dept_discrepancies in discrepancies_by_dept.items() %}
            <div style="margin-top: 20px; margin-bottom: 10px;">
                <h4 style="border-bottom: 2px solid #3498db; padding-bottom: 5px; color: #2c3e50;">{{ dept }}</h4>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                            <th>Data</th>
                            <th>Produto</th>
                            <th>Qtd Sistema</th>
                            <th>Qtd Contada</th>
                            <th>Diferença</th>
                            <th>Valor (Perda/Ganho)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for disc in dept_discrepancies %}
                        <tr>
                            <td>{{ disc.date }}</td>
                            <td>{{ disc.product_name }}</td>
                            <td>{{ disc.system_qty }} {{ disc.unit }}</td>
                            <td>{{ disc.counted_qty }} {{ disc.unit }}</td>
                            <td class="{% if disc.difference < 0 %}text-danger{% else %}text-success{% endif %}" style="font-weight: bold;">
                                {{ "%.2f"|format(disc.difference) }}
                            </td>
                            <td class="{% if disc.value < 0 %}text-danger{% else %}text-success{% endif %}" style="font-weight: bold;">
                                R$ {{ "%.2f"|format(disc.value) }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endfor %}
        {% else %}
        <p>Nenhuma discrepância registrada neste período.</p>
        {% endif %}
    </div>

    <div class="card">
        <h3><i class="bi bi-exclamation-triangle"></i> Itens Não Conferidos (Geral)</h3>
        {% if uncounted %}
        <ul style="list-style-type: none; padding: 0;">
            {% for item in uncounted %}
            <li style="padding: 10px; border-bottom: 1px solid #eee;">
                <small style="color: #7f8c8d;">{{ item.department }} (Conf: #{{ item.conference_id }})</small><br>
                <strong>{{ item.product_name }}</strong>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p>Todos os itens foram conferidos em todas as conferências deste período.</p>
        {% endif %}
    </div>
    {% else %}
    <p>Selecione um período para visualizar o relatório.</p>
    {% endif %}
</div>
{% endblock %}
