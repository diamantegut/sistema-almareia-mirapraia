{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-receipt-cutoff"></i> Pool de Contas Fiscais</h2>
        <div>
            <a href="{{ url_for('admin.fiscal_config') }}" class="btn btn-outline-primary me-2">
                <i class="bi bi-gear"></i> Configurações Fiscais
            </a>
            <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    <div class="row g-3 mb-3">
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="text-muted">Pagamentos Fiscais (Totais no Mês)</div>
                    <div class="fs-4 fw-bold">R$ {{ "%.2f"|format(total_fiscal or 0) }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="text-muted">Emitidos no Mês</div>
                    <div class="fs-4 fw-bold text-success">R$ {{ "%.2f"|format(emitted_fiscal or 0) }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="text-muted">A Emitir (Diferença)</div>
                    <div class="fs-4 fw-bold text-danger">R$ {{ "%.2f"|format(pending_fiscal or 0) }}</div>
                    <div class="mt-3">
                        <button type="button" class="btn btn-success w-100" onclick="emitUntilMatch()" {% if (pending_fiscal or 0) <= 0 %}disabled{% endif %}>
                            <i class="bi bi-cloud-upload"></i> Emitir até equiparar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <form method="GET" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">Mês de Referência</label>
                    <select name="month" class="form-select">
                        {% for m in months %}
                            <option value="{{ m }}" {% if m == selected_month %}selected{% endif %}>
                                {{ m.split('-')[1] }}/{{ m.split('-')[0] }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Origem</label>
                    <select name="origin" class="form-select" disabled>
                        <option value="">Todas</option>
                        <option value="restaurant">Restaurante</option>
                        <option value="reception">Recepção</option>
                        <option value="daily_rates">Diárias</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Status</label>
                    <select name="status" class="form-select" disabled>
                        <option value="">Todos</option>
                        <option value="pending">Pendente</option>
                        <option value="emitted">Emitida</option>
                        <option value="ignored">Ignorada/Não Fiscal</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100"><i class="bi bi-filter"></i> Filtrar</button>
                </div>
            </form>
        </div>
    </div>
    <script>
        async function emitUntilMatch() {
            const btn = event.currentTarget;
            btn.disabled = true;
            const original = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processando...';
            try {
                const resp = await fetch('{{ url_for("admin.fiscal_pool_emit_until") }}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ month: '{{ selected_month }}' })
                });
                const data = await resp.json();
                if (data.success) {
                    alert(`Concluído. Emitidas: ${data.emitted}. Falhas: ${data.failed}. Restante: R$ ${Number(data.remaining||0).toFixed(2)}`);
                    location.reload();
                } else {
                    alert(data.error || 'Falha ao processar.');
                }
            } catch (e) {
                alert('Erro inesperado: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = original;
            }
        }
    </script>

    <!-- Accounts Table -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th>Data/Hora</th>
                            <th>Origem</th>
                            <th>ID Original</th>
                            <th>Série</th>
                            <th>Número</th>
                            <th>Total</th>
                            <th>Pagamento</th>
                            <th>Cliente</th>
                            <th>Status</th>
                            <th class="text-end">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in pool %}
                        <tr id="row-{{ entry.id }}">
                            <td>{{ entry.closed_at }}</td>
                            <td>
                                {% if entry.origin == 'restaurant' %}
                                    <span class="badge bg-warning text-dark"><i class="bi bi-cup-straw"></i> Restaurante</span>
                                {% elif entry.origin == 'reception' %}
                                    <span class="badge bg-info text-dark"><i class="bi bi-door-open"></i> Recepção</span>
                                {% elif entry.origin == 'daily_rates' %}
                                    <span class="badge bg-primary"><i class="bi bi-building"></i> Diárias</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ entry.origin }}</span>
                                {% endif %}
                            </td>
                            <td>{{ entry.original_id }}</td>
                            <td>{{ entry.serie|default('-') }}</td>
                            <td>{{ entry.number|default('-') }}</td>
                            <td>R$ {{ "%.2f"|format(entry.get('total_amount', 0)) }}</td>
                            <td>
                                {% for pm in entry.payment_methods %}
                                    <div>
                                        <small>{{ pm.method }}</small>
                                        {% if pm.is_fiscal %}
                                            <i class="bi bi-check-circle-fill text-success" title="Fiscal"></i>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </td>
                            <td>
                                {% if entry.get('customer') and entry.customer.get('name') %}
                                    <div>{{ entry.customer.name }}</div>
                                {% endif %}
                                {% if entry.get('customer') and entry.customer.get('cpf_cnpj') %}
                                    <small class="text-muted">{{ entry.customer.cpf_cnpj }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if entry.get('status') == 'pending' %}
                                    <span class="badge bg-warning text-dark">Pendente</span>
                                {% elif entry.get('status') == 'emitted' %}
                                    <span class="badge bg-success">Emitida</span>
                                {% elif entry.get('status') == 'error' %}
                                    <span class="badge bg-danger">Erro</span>
                                {% elif entry.get('status') == 'failed' %}
                                    <span class="badge bg-danger">Falha</span>
                                {% elif entry.get('status') == 'ignored' %}
                                    <span class="badge bg-secondary">Ignorada</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-info" onclick="viewDetails('{{ entry.id }}')">
                                    <i class="bi bi-eye"></i>
                                </button>
                                {% if entry.status in ['pending','error','failed'] %}
                                    <button class="btn btn-sm btn-success" onclick="emitInvoice('{{ entry.id }}')">
                                        <i class="bi bi-cloud-upload"></i> Emitir
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="ignoreEntry('{{ entry.id }}')">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="10" class="text-center py-4 text-muted">Nenhuma conta encontrada.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes da Conta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailsContent">
                <!-- Loaded via JS -->
            </div>
        </div>
    </div>
</div>

<script id="pool-data" type="application/json">{{ pool|tojson }}</script>
<script>
const poolData = JSON.parse(document.getElementById('pool-data').textContent);

function viewDetails(id) {
    const entry = poolData.find(e => e.id === id);
    if (!entry) return;
    
    let itemsHtml = '<table class="table table-sm table-striped"><thead><tr><th>Item</th><th>Qtd</th><th>Preço</th><th>Total</th></tr></thead><tbody>';
    entry.items.forEach(item => {
        // Handle different item structures if necessary
        const qty = item.qty || item.quantity || 1;
        const price = item.price || item.unit_price || 0;
        const total = (qty * price).toFixed(2);
        itemsHtml += `<tr>
            <td>${item.name || item.description}</td>
            <td>${qty}</td>
            <td>R$ ${parseFloat(price).toFixed(2)}</td>
            <td>R$ ${total}</td>
        </tr>`;
    });
    itemsHtml += '</tbody></table>';

    const content = document.getElementById('detailsContent');
    const errorHtml = entry.last_error ? `
        <div class="alert alert-danger mt-3">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <strong> Erro na última emissão:</strong><br>
            <small>${entry.last_error}</small>
        </div>
    ` : '';

    content.innerHTML = `
        <div class="row mb-3">
            <div class="col-md-6">
                <p><strong>Origem:</strong> ${entry.origin}</p>
                <p><strong>ID Original:</strong> ${entry.original_id}</p>
                <p><strong>Fechado em:</strong> ${entry.closed_at}</p>
                <p><strong>Fechado por:</strong> ${entry.closed_by}</p>
            </div>
            <div class="col-md-6 text-end">
                <h3 class="text-primary">R$ ${entry.total_amount.toFixed(2)}</h3>
                <span class="badge bg-${entry.status === 'emitted' ? 'success' : (entry.status === 'pending' ? 'warning' : 'secondary')} fs-6">${entry.status.toUpperCase()}</span>
                ${entry.status === 'emitted' ? `
                  <div class="mt-3 d-flex gap-2 justify-content-end">
                    <button class="btn btn-outline-secondary btn-sm" onclick="downloadXml('${entry.id}')">
                      <i class="bi bi-download"></i> Baixar XML
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="downloadPdf('${entry.id}')">
                      <i class="bi bi-file-earmark-pdf"></i> Baixar PDF da Nota
                    </button>
                  </div>
                  <div id="xml-status-${entry.id}" class="form-text mt-1 text-muted">
                    ${entry.xml_ready ? 'XML disponível.' : 'Aguardando disponibilidade do XML...'}
                  </div>
                ` : ''}
            </div>
        </div>
        <hr>
        <h5>Itens do Pedido</h5>
        ${itemsHtml}
        <hr>
        <div class="row">
            <div class="col-md-6">
                <h5>Cliente</h5>
                <p class="mb-1"><strong>Nome:</strong> ${entry.customer.name || 'Consumidor Final'}</p>
                <p class="mb-1"><strong>CPF/CNPJ:</strong> ${entry.customer.cpf_cnpj || 'Não informado'}</p>
            </div>
            <div class="col-md-6">
                 <h5>Pagamento</h5>
                 <ul class="list-unstyled">
                    ${entry.payment_methods.map(pm => `<li>${pm.method}: R$ ${pm.amount.toFixed(2)}</li>`).join('')}
                 </ul>
            </div>
        </div>
        ${entry.notes ? `<div class="alert alert-info mt-3"><i class="bi bi-info-circle"></i> ${entry.notes}</div>` : ''}
        ${errorHtml}
    `;
    
    new bootstrap.Modal(document.getElementById('detailsModal')).show();
}

async function emitInvoice(id) {
    if (!confirm('Deseja iniciar a emissão fiscal para esta conta?')) return;
    
    // Show loading state (optional)
    const btn = document.querySelector(`#row-${id} .btn-success`);
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Emitindo...';
    }

    try {
        const response = await fetch('/admin/fiscal/pool/action', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ action: 'emit', id: id })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Emissão iniciada com sucesso!');
            location.reload();
        } else {
            console.error('Erro emissão:', result);
            alert('Erro ao iniciar emissão: ' + (result.error || 'Erro desconhecido'));
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-cloud-upload"></i> Emitir';
            }
        }
    } catch (e) {
        console.error('Exceção emissão:', e);
        alert('Erro de conexão ou servidor: ' + e.message);
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-cloud-upload"></i> Emitir';
        }
    }
}

async function openXmlFolder(id) {
    downloadXml(id);
}

async function printInvoice(id) {
    alert('Impressão substituída por salvamento de PDF. Use "Abrir PDF da Nota".');
}

async function pollXmlStatus(id, attempts=6, intervalMs=5000) {
    for (let i = 0; i < attempts; i++) {
        try {
            const response = await fetch('/admin/fiscal/pool/xml_status', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ entry_id: id })
            });
            const result = await response.json();
            if (result.success && result.ready) {
                const el = document.getElementById(`xml-status-${id}`);
                if (el) el.textContent = 'XML disponível.';
                return;
            }
        } catch (_) {}
        await new Promise(r => setTimeout(r, intervalMs));
    }
}

function downloadXml(id) {
    window.location.href = '/admin/fiscal/pool/download_xml/' + id;
}

function downloadPdf(id) {
    fetch('/admin/fiscal/pool/open_pdf', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ entry_id: id })
    })
    .then(resp => {
        if (!resp.ok) {
            return resp.json().then(data => { throw new Error(data.error || 'Falha ao baixar PDF'); });
        }
        return resp.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'nota.pdf';
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
    })
    .catch(err => {
        alert('Erro ao baixar PDF: ' + err.message);
    });
}
async function ignoreEntry(id) {
    if (!confirm('Deseja marcar esta conta como "Ignorada/Não Fiscal"?')) return;

    try {
        const response = await fetch('/admin/fiscal/pool/action', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ action: 'ignore', id: id })
        });
        
        const result = await response.json();
        if (result.success) {
            location.reload();
        } else {
            alert('Erro: ' + result.error);
        }
    } catch (e) {
        alert('Erro de comunicação com o servidor.');
    }
}
</script>
{% endblock %}
