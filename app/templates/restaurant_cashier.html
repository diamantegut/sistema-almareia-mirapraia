{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üí∞ Caixa do Restaurante</h2>
        <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Voltar
        </a>
    </div>

    {% if not cashier %}
    <!-- CASHIER CLOSED STATE -->
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white text-center py-3">
                    <h4 class="mb-0"><i class="bi bi-lock-fill"></i> Caixa Fechado</h4>
                </div>
                <div class="card-body p-4">
                    <p class="text-center text-muted mb-4">O caixa est√° fechado. Informe o valor inicial para abrir.</p>
                    
                    <form method="POST">
                        <input type="hidden" name="action" value="open_cashier">
                        <div class="mb-4">
                            <label class="form-label">Fundo de Caixa (R$)</label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text">R$</span>
                                <input type="tel" class="form-control" name="opening_balance" value="0.00" required onfocus="this.select()" oninput="formatCurrency(this)">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success w-100 btn-lg">
                            <i class="bi bi-unlock-fill"></i> Abrir Caixa
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Historic removed -->
        </div>
    </div>
    
    {% else %}
    <!-- CASHIER OPEN STATE -->
    <div class="row g-3">
        <!-- Summary Cards -->
        <div class="col-md-4">
            <div class="card bg-primary text-white h-100">
                <div class="card-body text-center">
                    <h6 class="card-title opacity-75">Saldo Atual</h6>
                    {% if session.get('role') == 'admin' %}
                    <h2 class="display-6 fw-bold">R$ {{ "%.2f"|format(total_balance) }}</h2>
                    <div class="small mt-2 opacity-75">
                        Abertura: R$ {{ "%.2f"|format(cashier.opening_balance) }}
                    </div>
                    {% else %}
                    <h2 class="display-6 fw-bold">R$ ****</h2>
                    <div class="small mt-2 opacity-75">
                        Abertura: R$ ****
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Vendas por Forma de Pagamento</h5>
                </div>
                <div class="card-body">
                    <div class="row row-cols-2 row-cols-md-4 g-2">
                        {% for method, amount in current_totals.items() %}
                        <div class="col">
                            <div class="border rounded p-2 text-center bg-light">
                                <div class="small text-muted text-uppercase">{{ method }}</div>
                                {% if session.get('role') == 'admin' %}
                                <div class="fw-bold">R$ {{ "%.2f"|format(amount) }}</div>
                                {% else %}
                                <div class="fw-bold">R$ ****</div>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <div class="col-12 text-center text-muted py-3">
                            Nenhuma venda registrada ainda.
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="col-md-12">
            <div class="card">
                <div class="card-body d-grid gap-2 d-md-flex justify-content-md-end bg-light">
                    {% if session.get('role') in ['admin', 'gerente', 'supervisor'] %}
                    <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#sangriaModal">
                        <i class="bi bi-dash-circle"></i> Sangria
                    </button>
                    {% endif %}
                    <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#suprimentoModal">
                        <i class="bi bi-plus-circle"></i> Suprimento
                    </button>
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#transferModal">
                        <i class="bi bi-arrow-left-right"></i> Transfer√™ncia
                    </button>
                    <button type="button" class="btn btn-dark ms-md-auto" data-bs-toggle="modal" data-bs-target="#closeCashierModal">
                        <i class="bi bi-lock-fill"></i> Fechar Caixa
                    </button>
                </div>
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Movimenta√ß√µes</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Hor√°rio</th>
                                <th>Tipo</th>
                                <th>Descri√ß√£o</th>
                                <th>Forma Pagto</th>
                                <th class="text-end">Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for t in displayed_transactions|reverse %}
                            <tr>
                                <td>{{ t.timestamp.split(' ')[1] if t.timestamp else t.time }}</td>
                                <td>
                                    {% if t.type == 'sale' %}
                                        <span class="badge bg-success">Venda</span>
                                    {% elif t.type == 'deposit' %}
                                        <span class="badge bg-info text-dark">Suprimento</span>
                                    {% elif t.type == 'withdrawal' %}
                                        <span class="badge bg-danger">Sangria</span>
                                    {% elif t.type == 'in' %}
                                        <span class="badge bg-success">Recebimento</span>
                                    {% elif t.type == 'out' %}
                                        <span class="badge bg-danger">Sa√≠da</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ t.type }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ t.description }}
                                    {% if t.flags %}
                                        {% for flag in t.flags %}
                                            {% if flag.type == 'service_removed' %}
                                                <span class="badge bg-warning text-dark ms-1" title="Valor: R$ {{ '%.2f'|format(flag.value) }}">Sem Servi√ßo</span>
                                            {% elif flag.type == 'discount_applied' %}
                                                <span class="badge bg-info text-dark ms-1" title="Valor: R$ {{ '%.2f'|format(flag.value) }}">Desconto</span>
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        {# Fallback for legacy transactions #}
                                        {% if '10% Off' in t.description %}
                                            <span class="badge bg-warning text-dark ms-1">Sem 10%</span>
                                        {% endif %}
                                        {% if 'Desc:' in t.description %}
                                            <span class="badge bg-info text-dark ms-1">Desconto</span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if t.is_group and t.payment_method == 'M√∫ltiplo' %}
                                        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#paymentModal{{ loop.index }}">
                                            <i class="bi bi-wallet2"></i> M√∫ltiplo
                                        </button>

                                        <!-- Modal for this transaction -->
                                        <div class="modal fade" id="paymentModal{{ loop.index }}" tabindex="-1" aria-hidden="true">
                                            <div class="modal-dialog modal-dialog-centered">
                                                <div class="modal-content">
                                                    <div class="modal-header bg-light">
                                                        <h5 class="modal-title">Detalhamento de Pagamento</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-light rounded">
                                                            <span class="fw-bold text-muted">Total Transa√ß√£o</span>
                                                            <span class="h5 mb-0 text-success fw-bold">R$ {{ "%.2f"|format(t.amount) }}</span>
                                                        </div>
                                                        <div class="list-group list-group-flush">
                                                            {% for sub in t.sub_transactions %}
                                                            <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                                                <div>
                                                                    <div class="fw-bold">{{ sub.method }}</div>
                                                                    <small class="text-muted">{{ sub.timestamp.split(' ')[1] }} ‚Ä¢ {{ sub.percent }}%</small>
                                                                </div>
                                                                <span class="fw-bold">R$ {{ "%.2f"|format(sub.amount) }}</span>
                                                            </div>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% else %}
                                        {{ t.payment_method|default('-')|title }}
                                    {% endif %}
                                </td>
                                <td class="text-end fw-bold {{ 'text-danger' if t.type in ['withdrawal', 'out'] else 'text-success' }}">
                                    {% if t.type in ['withdrawal', 'out'] %}-{% endif %}
                                    R$ {{ "%.2f"|format(t.amount) }}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center py-4 text-muted">
                                    Nenhuma movimenta√ß√£o registrada.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Sangria Modal -->
    <div class="modal fade" id="sangriaModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Realizar Sangria (Retirada)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="add_transaction">
                        <input type="hidden" name="type" value="withdrawal">
                        <div class="mb-3">
                            <label class="form-label">Valor (R$)</label>
                            <input type="tel" class="form-control" name="amount" required onfocus="this.select()" oninput="formatCurrency(this)">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descri√ß√£o / Motivo</label>
                            <input type="text" class="form-control" name="description" required placeholder="Ex: Pagamento fornecedor">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">Confirmar Sangria</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Suprimento Modal -->
    <div class="modal fade" id="suprimentoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Realizar Suprimento (Entrada)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="add_transaction">
                        <input type="hidden" name="type" value="deposit">
                        <div class="mb-3">
                            <label class="form-label">Valor (R$)</label>
                            <input type="tel" class="form-control" name="amount" required onfocus="this.select()" oninput="formatCurrency(this)">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descri√ß√£o / Origem</label>
                            <input type="text" class="form-control" name="description" required placeholder="Ex: Troco adicional">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">Confirmar Suprimento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Transfer Modal -->
    <div class="modal fade" id="transferModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Realizar Transfer√™ncia</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST">
                    <input type="hidden" name="action" value="add_transaction">
                    <input type="hidden" name="type" value="transfer">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Caixa de Destino</label>
                            <select class="form-select" name="target_cashier" required>
                                <option value="reception">Caixa Recep√ß√£o</option>
                                <option value="reception_reservations">Caixa Reservas</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Valor (R$)</label>
                            <input type="tel" class="form-control" name="amount" required onfocus="this.select()" oninput="formatCurrency(this)">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Motivo / Descri√ß√£o</label>
                            <input type="text" class="form-control" name="description" required placeholder="Ex: Transfer√™ncia de troco">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Realizar Transfer√™ncia</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Close Cashier Modal -->
    <div class="modal fade" id="closeCashierModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">Fechar Caixa</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" onsubmit="return confirm('ATEN√á√ÉO: Voc√™ est√° prestes a fechar o caixa do restaurante. Esta a√ß√£o √© irrevers√≠vel e bloquear√° novas opera√ß√µes at√© a reabertura.\n\nTem certeza que conferiu todos os valores e deseja continuar?');">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="close_cashier">
                        <p>Confira os valores antes de fechar.</p>
                        <div class="alert alert-info">
                            Saldo Calculado pelo Sistema: <strong>R$ {{ "%.2f"|format(total_balance) }}</strong>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Saldo Final em Gaveta (Real)</label>
                            <input type="tel" class="form-control" name="closing_balance" required value="{{ "%.2f"|format(total_balance)|replace('.', ',') }}" onfocus="this.select()" oninput="formatCurrency(this)">
                            <div class="form-text">Informe o valor contado fisicamente.</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-dark">Confirmar Fechamento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
</div>
<script>
    window.formatCurrency = function(input) {
        let value = input.value.replace(/\D/g, '');
        if (value === '') {
            input.value = '';
            return;
        }
        let floatVal = parseInt(value) / 100;
        input.value = floatVal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };
</script>

{% endblock %}