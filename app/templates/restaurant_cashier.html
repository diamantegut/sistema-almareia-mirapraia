{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üí∞ Caixa do Restaurante</h2>
        <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Voltar
        </a>
    </div>

    {% if not cashier %}
    <!-- CASHIER CLOSED STATE -->
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white text-center py-3">
                    <h4 class="mb-0"><i class="bi bi-lock-fill"></i> Caixa Fechado</h4>
                </div>
                <div class="card-body p-4">
                    <p class="text-center text-muted mb-4">O caixa est√° fechado. Informe o valor inicial para abrir.</p>
                    
                    <form method="POST">
                        <input type="hidden" name="action" value="open_cashier">
                        <div class="mb-4">
                            <label class="form-label">Fundo de Caixa (R$)</label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text">R$</span>
                                <input type="tel" class="form-control" name="opening_balance" value="0.00" required onfocus="this.select()" oninput="formatCurrency(this)">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success w-100 btn-lg">
                            <i class="bi bi-unlock-fill"></i> Abrir Caixa
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Historic removed -->
        </div>
    </div>
    
    {% else %}
    <!-- CASHIER OPEN STATE -->
    <div class="row g-3">
        <!-- Summary Cards -->
        <div class="col-md-4">
            <div class="card bg-primary text-white h-100">
                <div class="card-body text-center">
                    <h6 class="card-title opacity-75">Saldo Atual</h6>
                    {% if session.get('role') == 'admin' %}
                    <h2 class="display-6 fw-bold">R$ {{ "%.2f"|format(total_balance) }}</h2>
                    <div class="small mt-2 opacity-75">
                        Abertura: R$ {{ "%.2f"|format(cashier.opening_balance) }}
                    </div>
                    {% else %}
                    <h2 class="display-6 fw-bold">R$ ****</h2>
                    <div class="small mt-2 opacity-75">
                        Abertura: R$ ****
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Vendas por Forma de Pagamento</h5>
                </div>
                <div class="card-body">
                    <div class="row row-cols-2 row-cols-md-4 g-2">
                        {% for method, amount in current_totals.items() %}
                        <div class="col">
                            <div class="border rounded p-2 text-center bg-light">
                                <div class="small text-muted text-uppercase">{{ method }}</div>
                                {% if session.get('role') == 'admin' %}
                                <div class="fw-bold">R$ {{ "%.2f"|format(amount) }}</div>
                                {% else %}
                                <div class="fw-bold">R$ ****</div>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <div class="col-12 text-center text-muted py-3">
                            Nenhuma venda registrada ainda.
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="col-md-12">
            <div class="card">
                <div class="card-body d-grid gap-2 d-md-flex justify-content-md-end bg-light">
                    {% if session.get('role') in ['admin', 'gerente', 'supervisor'] %}
                    <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#sangriaModal">
                        <i class="bi bi-dash-circle"></i> Sangria
                    </button>
                    {% endif %}
                    <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#suprimentoModal">
                        <i class="bi bi-plus-circle"></i> Suprimento
                    </button>
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#transferModal">
                        <i class="bi bi-arrow-left-right"></i> Transfer√™ncia
                    </button>
                    <button type="button" class="btn btn-dark ms-md-auto" data-bs-toggle="modal" data-bs-target="#closeCashierModal">
                        <i class="bi bi-lock-fill"></i> Fechar Caixa
                    </button>
                </div>
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Movimenta√ß√µes</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Hor√°rio</th>
                                <th>Tipo</th>
                                <th>Descri√ß√£o</th>
                                <th>Forma Pagto</th>
                                <th class="text-end">Valor</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-body">
                            {% for t in displayed_transactions %}
                            <tr>
                                <td>{{ t.timestamp.split(' ')[1] if t.timestamp else t.time }}</td>
                                <td>
                                    {% if t.type == 'sale' %}
                                        <span class="badge bg-success">Venda</span>
                                    {% elif t.type == 'deposit' %}
                                        <span class="badge bg-info text-dark">Suprimento</span>
                                    {% elif t.type == 'withdrawal' %}
                                        <span class="badge bg-danger">Sangria</span>
                                    {% elif t.type == 'in' %}
                                        <span class="badge bg-success">Recebimento</span>
                                    {% elif t.type == 'out' %}
                                        <span class="badge bg-danger">Sa√≠da</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ t.type }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ t.description }}
                                    {% if t.flags %}
                                        {% for flag in t.flags %}
                                            {% if flag.type == 'service_removed' %}
                                                <span class="badge bg-warning text-dark ms-1" title="Valor: R$ {{ '%.2f'|format(flag.value) }}">Sem Servi√ßo</span>
                                            {% elif flag.type == 'discount_applied' %}
                                                <span class="badge bg-info text-dark ms-1" title="Valor: R$ {{ '%.2f'|format(flag.value) }}">Desconto</span>
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        {# Fallback for legacy transactions #}
                                        {% if '10% Off' in t.description %}
                                            <span class="badge bg-warning text-dark ms-1">Sem 10%</span>
                                        {% endif %}
                                        {% if 'Desc:' in t.description %}
                                            <span class="badge bg-info text-dark ms-1">Desconto</span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if t.is_group and t.payment_method == 'M√∫ltiplo' %}
                                        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#paymentModal{{ loop.index }}">
                                            <i class="bi bi-wallet2"></i> M√∫ltiplo
                                        </button>

                                        <!-- Modal for this transaction -->
                                        <div class="modal fade" id="paymentModal{{ loop.index }}" tabindex="-1" aria-hidden="true">
                                            <div class="modal-dialog modal-dialog-centered">
                                                <div class="modal-content">
                                                    <div class="modal-header bg-light">
                                                        <h5 class="modal-title">Detalhamento de Pagamento</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-light rounded">
                                                            <span class="fw-bold text-muted">Total Transa√ß√£o</span>
                                                            <span class="h5 mb-0 text-success fw-bold">R$ {{ "%.2f"|format(t.amount) }}</span>
                                                        </div>
                                                        <div class="list-group list-group-flush">
                                                            {% for sub in t.sub_transactions %}
                                                            <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                                                <div>
                                                                    <div class="fw-bold">{{ sub.method }}</div>
                                                                    <small class="text-muted">{{ sub.timestamp.split(' ')[1] }} ‚Ä¢ {{ sub.percent }}%</small>
                                                                </div>
                                                                <span class="fw-bold">R$ {{ "%.2f"|format(sub.amount) }}</span>
                                                            </div>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% else %}
                                        {{ t.payment_method|default('-')|title }}
                                    {% endif %}
                                </td>
                                <td class="text-end fw-bold {{ 'text-danger' if t.type in ['withdrawal', 'out'] else 'text-success' }}">
                                    {% if t.type in ['withdrawal', 'out'] %}-{% endif %}
                                    R$ {{ "%.2f"|format(t.amount) }}
                                </td>
                            </tr>
                            {% else %}
                            <tr id="no-transactions-row">
                                <td colspan="5" class="text-center py-4 text-muted">
                                    Nenhuma movimenta√ß√£o registrada.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    {% if has_more %}
                    <div class="text-center p-3" id="loading-more-container">
                        <button id="load-more-btn" class="btn btn-outline-primary" onclick="loadMoreTransactions()">
                            Carregar Mais
                        </button>
                        <div id="loading-spinner" class="spinner-border text-primary d-none" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Sangria Modal -->
    <div class="modal fade" id="sangriaModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Realizar Sangria (Retirada)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="sangriaForm" onsubmit="handleTransaction(event, 'sangriaModal')">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="add_transaction">
                        <input type="hidden" name="type" value="withdrawal">
                        <input type="hidden" name="idempotency_key" class="idempotency-key">
                        <div class="mb-3">
                            <label class="form-label">Valor (R$)</label>
                            <input type="tel" class="form-control" name="amount" required onfocus="this.select()" oninput="formatCurrency(this)">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descri√ß√£o / Motivo</label>
                            <input type="text" class="form-control" name="description" required placeholder="Ex: Pagamento fornecedor">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">
                            <span class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                            Confirmar Sangria
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Suprimento Modal -->
    <div class="modal fade" id="suprimentoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Realizar Suprimento (Entrada)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="suprimentoForm" onsubmit="handleTransaction(event, 'suprimentoModal')">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="add_transaction">
                        <input type="hidden" name="type" value="deposit">
                        <input type="hidden" name="idempotency_key" class="idempotency-key" id="suprimentoIdempotencyKey">
                        <div class="mb-3">
                            <label class="form-label">Valor (R$)</label>
                            <input type="tel" class="form-control" name="amount" required onfocus="this.select()" oninput="formatCurrency(this)">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descri√ß√£o / Origem</label>
                            <input type="text" class="form-control" name="description" required placeholder="Ex: Troco adicional">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success" id="btnConfirmSuprimento">
                            <span class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                            Confirmar Suprimento
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Transfer Modal -->
    <div class="modal fade" id="transferModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Realizar Transfer√™ncia</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="transferForm" onsubmit="handleTransaction(event, 'transferModal')">
                    <input type="hidden" name="action" value="add_transaction">
                    <input type="hidden" name="type" value="transfer">
                    <input type="hidden" name="idempotency_key" class="idempotency-key">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Caixa de Destino</label>
                            <select class="form-select" name="target_cashier" required>
                                <option value="reception">Caixa Recep√ß√£o</option>
                                <option value="reception_reservations">Caixa Reservas</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Valor (R$)</label>
                            <input type="tel" class="form-control" name="amount" required onfocus="this.select()" oninput="formatCurrency(this)">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Motivo / Descri√ß√£o</label>
                            <input type="text" class="form-control" name="description" required placeholder="Ex: Transfer√™ncia de troco">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <span class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                            Realizar Transfer√™ncia
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Close Cashier Modal -->
    <div class="modal fade" id="closeCashierModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">Fechar Caixa</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" onsubmit="return confirm('ATEN√á√ÉO: Voc√™ est√° prestes a fechar o caixa do restaurante. Esta a√ß√£o √© irrevers√≠vel e bloquear√° novas opera√ß√µes at√© a reabertura.\n\nTem certeza que conferiu todos os valores e deseja continuar?');">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="close_cashier">
                        <p>Confira os valores antes de fechar.</p>
                        <div class="alert alert-info">
                            Saldo Calculado em Dinheiro pelo Sistema: <strong>R$ {{ "%.2f"|format(total_balance) }}</strong>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Saldo Final em Dinheiro (Gaveta)</label>
                            <input type="tel" class="form-control" name="closing_cash" required placeholder="0,00" onfocus="this.select()" oninput="formatCurrency(this)">
                            <div class="form-text">Informe o valor em dinheiro contado fisicamente na gaveta.</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Total em Outras Formas de Pagamento</label>
                            <input type="tel" class="form-control" name="closing_non_cash" required placeholder="0,00" onfocus="this.select()" oninput="formatCurrency(this)">
                            <div class="form-text">Somat√≥rio declarado de cart√µes, Pix e demais formas.</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-dark">Confirmar Fechamento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
</div>
<script>
    let currentPage = {{ current_page|default(1) }};
    let isLoading = false;
    let hasMore = {{ 'true' if has_more else 'false' }};

    function loadMoreTransactions() {
        if (isLoading || !hasMore) return;

        isLoading = true;
        document.getElementById('load-more-btn').classList.add('d-none');
        document.getElementById('loading-spinner').classList.remove('d-none');

        const nextPage = currentPage + 1;
        
        fetch(`${window.location.pathname}?page=${nextPage}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('transactions-body');
            const noTxRow = document.getElementById('no-transactions-row');
            if (noTxRow) noTxRow.remove();

            data.transactions.forEach(t => {
                const row = document.createElement('tr');
                
                // Determine badges
                let typeBadge = '';
                if (t.type === 'sale') typeBadge = '<span class="badge bg-success">Venda</span>';
                else if (t.type === 'deposit') typeBadge = '<span class="badge bg-info text-dark">Suprimento</span>';
                else if (t.type === 'withdrawal') typeBadge = '<span class="badge bg-danger">Sangria</span>';
                else if (t.type === 'in') typeBadge = '<span class="badge bg-success">Recebimento</span>';
                else if (t.type === 'out') typeBadge = '<span class="badge bg-danger">Sa√≠da</span>';
                else typeBadge = `<span class="badge bg-secondary">${t.type}</span>`;

                // Determine Payment Method Column
                let paymentCol = '';
                if (t.is_group && t.payment_method === 'M√∫ltiplo') {
                    // Note: Dynamically creating modals for legacy items loaded via AJAX might be complex.
                    // Simplified: Just show "M√∫ltiplo" or simple list.
                    // For full fidelity, we'd need to append the modal HTML too.
                    // For now, let's just show "M√∫ltiplo" with a tooltip or simple text to avoid DOM bloat.
                    paymentCol = '<span class="text-primary"><i class="bi bi-wallet2"></i> M√∫ltiplo</span>';
                } else {
                    paymentCol = (t.payment_method || '-');
                    // Capitalize first letter
                    paymentCol = paymentCol.charAt(0).toUpperCase() + paymentCol.slice(1);
                }

                // Amount Class
                const amountClass = ['withdrawal', 'out'].includes(t.type) ? 'text-danger' : 'text-success';
                const prefix = ['withdrawal', 'out'].includes(t.type) ? '-' : '';

                row.innerHTML = `
                    <td>${t.timestamp ? t.timestamp.split(' ')[1] : t.time}</td>
                    <td>${typeBadge}</td>
                    <td>${t.description}</td>
                    <td>${paymentCol}</td>
                    <td class="text-end fw-bold ${amountClass}">
                        ${prefix} R$ ${parseFloat(t.amount).toFixed(2)}
                    </td>
                `;
                tbody.appendChild(row);
            });

            currentPage = data.current_page;
            hasMore = data.has_more;

            if (!hasMore) {
                const container = document.getElementById('loading-more-container');
                if (container) container.remove();
            } else {
                document.getElementById('load-more-btn').classList.remove('d-none');
                document.getElementById('loading-spinner').classList.add('d-none');
            }
        })
        .catch(err => {
            console.error('Error loading transactions:', err);
            alert('Erro ao carregar mais transa√ß√µes.');
            document.getElementById('load-more-btn').classList.remove('d-none');
            document.getElementById('loading-spinner').classList.add('d-none');
        })
        .finally(() => {
            isLoading = false;
        });
    }

    // Generic Async Transaction Handler
    async function handleTransaction(event, modalId) {
        event.preventDefault();
        
        const form = event.target;
        const submitBtn = form.querySelector('button[type="submit"]');
        const spinner = submitBtn.querySelector('.spinner-border');
        
        // Disable UI
        submitBtn.disabled = true;
        if (spinner) spinner.classList.remove('d-none');
        
        const formData = new FormData(form);
        
        try {
            const response = await fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            const result = await response.json();
            
            if (result.success || (result.message && !result.error)) {
                // Success
                const modalEl = document.getElementById(modalId);
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
                form.reset();
                
                // Regenerate UUID for next time
                const keyInput = form.querySelector('.idempotency-key');
                if (keyInput) keyInput.value = generateUUID();
                
                // Reload to show new data
                window.location.reload(); 
            } else {
                // Error
                alert(result.error || result.message || 'Erro ao processar transa√ß√£o.');
                submitBtn.disabled = false;
                if (spinner) spinner.classList.add('d-none');
            }
        } catch (error) {
            console.error('Error:', error);
            // If response is not JSON (e.g. standard redirect), reload
            window.location.reload();
        }
    }


    window.formatCurrency = function(input) {
        let value = input.value.replace(/\D/g, '');
        if (value === '') {
            input.value = '';
            return;
        }
        let floatVal = parseInt(value) / 100;
        input.value = floatVal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };

    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    const suprimentoModal = document.getElementById('suprimentoModal');
    if (suprimentoModal) {
        suprimentoModal.addEventListener('show.bs.modal', function () {
            const keyInput = document.getElementById('suprimentoIdempotencyKey');
            if (keyInput) keyInput.value = generateUUID();
        });
    }

    // Initialize UUIDs on Modal Show (All Modals)
    document.addEventListener('DOMContentLoaded', function() {
        ['suprimentoModal', 'sangriaModal', 'transferModal'].forEach(id => {
            const modal = document.getElementById(id);
            if (modal) {
                modal.addEventListener('show.bs.modal', function () {
                    const form = modal.querySelector('form');
                    const keyInput = form.querySelector('.idempotency-key');
                    if (keyInput) keyInput.value = generateUUID();
                });
            }
        });
    });
</script>

{% endblock %}
