{% extends "base.html" %}

{% block title %}Mapa de Reservas - Recepção{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4 bg-light min-vh-100">
    <!-- Header Section -->
    <div class="row align-items-center mb-4 g-3">
        <!-- Title & Date Nav -->
        <div class="col-lg-5 col-md-6">
            <div class="d-flex align-items-center gap-3">
                <div class="bg-white p-2 rounded shadow-sm">
                    <i class="bi bi-calendar-week-fill text-primary fs-4"></i>
                </div>
                <div>
                    <h4 class="mb-0 fw-bold text-dark">Mapa de Reservas</h4>
                    <small class="text-muted">{{ start_date.strftime('%B %Y')|capitalize }}</small>
                </div>
                
                <div class="vr mx-2 text-muted"></div>
                
                <form action="{{ url_for('reception.reception_reservations') }}" method="get" class="d-flex align-items-center gap-2 bg-white p-1 rounded shadow-sm border">
                    <button type="submit" class="btn btn-sm btn-link text-dark text-decoration-none" onclick="document.querySelector('input[name=start_date]').stepDown(7);"><i class="bi bi-chevron-left"></i></button>
                    <input type="date" name="start_date" class="form-control form-control-sm border-0 bg-transparent fw-bold text-center" style="width: 130px;" value="{{ start_date.strftime('%Y-%m-%d') }}" onchange="this.form.submit()">
                    <button type="submit" class="btn btn-sm btn-link text-dark text-decoration-none" onclick="document.querySelector('input[name=start_date]').stepUp(7);"><i class="bi bi-chevron-right"></i></button>
                    <div class="vr mx-1"></div>
                    <a href="{{ url_for('reception.reception_reservations') }}" class="btn btn-sm btn-primary px-3 rounded-pill" title="Ir para Hoje">Hoje</a>
                </form>
            </div>
        </div>

        <!-- Action Toolbar -->
        <div class="col-lg-7 col-md-6">
            <div class="d-flex justify-content-md-end gap-2 flex-wrap">
                <!-- Main Actions -->
                <div class="bg-white p-1 rounded shadow-sm d-flex gap-1 border">
                    <button class="btn btn-light btn-sm fw-medium d-flex align-items-center gap-2 action-btn" onclick="openNewReservationModal()" data-bs-toggle="tooltip" title="Criar nova reserva manualmente">
                        <i class="bi bi-plus-circle-fill text-primary"></i> <span class="d-none d-xl-inline">Nova Reserva</span>
                    </button>
                    <div class="vr my-1"></div>
                    <button class="btn btn-light btn-sm fw-medium d-flex align-items-center gap-2 action-btn" onclick="document.getElementById('fileUploadInput').click()" data-bs-toggle="tooltip" title="Importar planilha de reservas">
                        <i class="bi bi-cloud-upload-fill text-secondary"></i> <span class="d-none d-xl-inline">Importar</span>
                    </button>
                    <div class="vr my-1"></div>
                    <button class="btn btn-light btn-sm fw-medium d-flex align-items-center gap-2 action-btn" onclick="runPreAllocation()" data-bs-toggle="tooltip" title="Executar algoritmo de pré-alocação">
                        <i class="bi bi-magic text-warning"></i> <span class="d-none d-xl-inline">Pré-alocação</span>
                    </button>
                </div>
                
                <input type="file" id="fileUploadInput" class="d-none" accept=".xlsx, .csv" onchange="uploadReservationsFile(this)">

                <!-- Navigation & Cashier -->
                <a href="{{ url_for('reception.reception_reservations_cashier') }}" class="btn btn-success btn-sm shadow-sm d-flex align-items-center gap-2 px-3 fw-bold">
                    <i class="bi bi-wallet2"></i> Caixa
                </a>
                
                <a href="{{ url_for('reception.reception_dashboard') }}" class="btn btn-outline-secondary btn-sm shadow-sm d-flex align-items-center gap-2 px-3">
                    <i class="bi bi-arrow-return-left"></i> Voltar
                </a>
            </div>
        </div>
    </div>

    <!-- Gantt Chart Card -->
    <div class="card border-0 shadow-sm rounded-3 overflow-hidden">
        <!-- Optional: Filter Bar inside Card Header could go here -->
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-sm mb-0" style="font-size: 0.75rem; table-layout: fixed; width: 100%;">
                    <colgroup>
                        <col style="width: 100px;">
                        {% for d in days %}
                        <col>
                        <col>
                        {% endfor %}
                    </colgroup>
                    <thead class="table-light text-center sticky-top">
                        <tr>
                            <th style="width: 100px;" class="bg-light sticky-start">Quarto</th>
                            {% for d in days %}
                            <th colspan="2" style="font-size: 0.6rem; padding: 1px;" class="{{ 'bg-warning text-dark' if d.is_weekend else '' }} text-center align-middle">
                                <div class="d-flex flex-column align-items-center" style="line-height: 1;">
                                    <span class="fw-bold">{{ d.day }}</span>
                                    <span style="font-size: 0.5rem; text-transform: uppercase;">{{ d.weekday }}</span>
                                </div>
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for group in grouped_rooms %}
                        <!-- Category Header -->
                        {% set cat_class = '' %}
                        {% if 'Areia' in group.category %} {% set cat_class = 'cat-areia' %}
                        {% elif 'Mar Família' in group.category %} {% set cat_class = 'cat-mar-familia' %}
                        {% elif 'Mar' in group.category %} {% set cat_class = 'cat-mar' %}
                        {% elif 'Banheira' in group.category %} {% set cat_class = 'cat-alma-banheira' %}
                        {% elif 'Alma' in group.category %} {% set cat_class = 'cat-alma' %}
                        {% elif 'Diamante' in group.category %} {% set cat_class = 'cat-master' %}
                        {% endif %}
                        
                        <tr class="{{ cat_class }}">
                            <td colspan="{{ (days|length * 2) + 1 }}" class="fw-bold px-1 py-0 text-uppercase small text-muted" style="font-size: 0.7rem; background: inherit;">
                                {{ group.category }}
                            </td>
                        </tr>
                        
                        {% for room in group.rooms %}
                        <tr>
                            <td class="fw-bold text-center bg-light sticky-start p-0 align-middle" style="height: 24px; line-height: 24px; font-size: 0.75rem;">{{ room }}</td>
                            {% for segment in segments.get(room, []) %}
                                {% set start_slot = segment.data.start_day %}
                                {% set end_slot = start_slot + segment.length - 1 %}
                                {% set is_midnight = (end_slot % 2 != 0) %}
                                {% set border_class = 'border-midnight' if is_midnight else 'border-noon' %}

                                {% if segment.type == 'empty' %}
                                    <td colspan="{{ segment.length }}" class="p-0 droppable-cell {{ border_class }}"
                                        data-room="{{ room }}"
                                        data-day-start="{{ segment.data.start_day }}"
                                        data-length="{{ segment.length }}"
                                        ondrop="drop(event)" 
                                        ondragover="allowDrop(event)"
                                        onmousedown="startDraw(event, this)"
                                        onmouseover="continueDraw(event, this)"
                                        onmouseup="endDraw(event, this)">
                                        <div style="height: 24px; width: 100%;"></div>
                                    </td>
                                {% else %}
                                    {% set cell = segment.data %}
                                    {% set bg_class = 'bg-occupied' if segment.type == 'occupied' else 'bg-reserved' %}
                                    {% set text_class = '' %} <!-- Text color handled by CSS now -->
                                    {% set is_draggable = true %} {# Always draggable if reserved or occupied #}
                                    
                                    <td colspan="{{ segment.length }}" class="text-center p-0 position-relative {{ border_class }}" 
                                        style="vertical-align: middle;"
                                        title="{{ cell.guest }} ({{ cell.checkin }} - {{ cell.checkout }})"
                                        data-res-id="{{ cell.id }}"
                                        data-room="{{ room }}"
                                        data-guest="{{ cell.guest }}"
                                        data-checkin="{{ cell.checkin }}"
                                        data-checkout="{{ cell.checkout }}"
                                        data-category="{{ cell.category }}"
                                        data-status="{{ cell.payment_status }}"
                                        data-channel="{{ cell.channel }}"
                                        data-amount="{{ cell.amount }}"
                                        data-paid="{{ cell.paid_amount }}"
                                        data-to-receive="{{ cell.to_receive }}"
                                        data-days="{{ segment.length }}"
                                        data-start-day="{{ segment.data.start_day }}">
                                        
                                        <!-- Handles -->
                                        {% if is_draggable %}
                                        <div class="resize-handle resize-start" onmousedown="startResize(event, 'start', '{{ cell.id }}', Number('{{ segment.data.start_day }}'), Number('{{ segment.length }}'), '{{ room }}')"></div>
                                        <div class="resize-handle resize-end" onmousedown="startResize(event, 'end', '{{ cell.id }}', Number('{{ segment.data.start_day }}'), Number('{{ segment.length }}'), '{{ room }}')"></div>
                                        {% endif %}
                                        
                                        <div class="d-flex align-items-center justify-content-between px-2 res-bar-content {{ bg_class }}" 
                                             draggable="{{ 'true' if is_draggable else 'false' }}"
                                             ondragstart="drag(event)"
                                             ondblclick="handleResDblClick(event, this)" 
                                             style="cursor: grab;">
                                            <!-- Channel Icon (Left) -->
                                            <div class="me-1 small opacity-75">
                                                {% set channel = (cell.channel or '')|lower %}
                                                {% if 'booking' in channel %}
                                                    <i class="bi bi-calendar-check" title="Booking.com"></i>
                                                {% elif 'airbnb' in channel %}
                                                    <i class="bi bi-house-door" title="Airbnb"></i>
                                                {% elif 'expedia' in channel %}
                                                    <i class="bi bi-airplane" title="Expedia"></i>
                                                {% elif 'direto' in channel or 'balcão' in channel %}
                                                    <i class="bi bi-person-badge" title="Direto"></i>
                                                {% elif 'whatsapp' in channel %}
                                                    <i class="bi bi-whatsapp" title="WhatsApp"></i>
                                                {% else %}
                                                    <i class="bi bi-globe" title="Outros"></i>
                                                {% endif %}
                                            </div>

                                            <!-- Guest Name (Center/Truncated) -->
                                            <span class="fw-bold text-truncate flex-grow-1 text-start px-1" style="font-size: 0.75rem;">{{ cell.guest }}</span>

                                            <!-- Status Icon (Right) -->
                                            <div class="ms-1 small">
                                                {% if cell.payment_status == 'Pago' %}
                                                    <i class="bi bi-check-circle-fill text-white" title="Pago"></i>
                                                {% elif cell.payment_status == 'Parcial' %}
                                                    <i class="bi bi-pie-chart-fill text-dark" title="Parcial" style="opacity: 0.6;"></i>
                                                {% else %}
                                                    <i class="bi bi-exclamation-circle-fill text-danger" title="Pendente"></i>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                {% endif %}
                            {% endfor %}
                        </tr>
                        {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
    /* Modern UI Tweaks */
    .action-btn {
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }
    .action-btn:hover {
        background-color: #f8f9fa;
        border-color: #dee2e6;
        transform: translateY(-1px);
    }
    .action-btn:active {
        transform: translateY(0);
    }
    
    /* Category Colors - Soft Pastels with Strong Borders */
    .cat-areia { background-color: #fff8e1; border-left: 4px solid #ffc107; }
    .cat-mar-familia { background-color: #e3f2fd; border-left: 4px solid #0dcaf0; }
    .cat-mar { background-color: #e8f4fd; border-left: 4px solid #0d6efd; }
    .cat-alma-banheira { background-color: #f8d7da; border-left: 4px solid #dc3545; }
    .cat-alma { background-color: #f2dae2; border-left: 4px solid #d63384; }
    .cat-master { background-color: #e9ecef; border-left: 4px solid #212529; }

    /* Grid Lines */
    .border-midnight { border-right: 1px solid #adb5bd !important; } /* Stronger line for day separation */
    .border-noon { border-right: 1px dashed #dee2e6 !important; } /* Softer line for noon */

    /* Reservation Bars */
    .res-bar-content {
        height: 28px; /* Slightly taller */
        width: 100%; 
        font-size: 0.7rem; 
        line-height: 28px; 
        overflow: hidden; 
        white-space: nowrap; 
        text-overflow: ellipsis;
        border-radius: 4px; /* Rounded bars */
        box-shadow: 0 1px 2px rgba(0,0,0,0.1); /* Subtle shadow */
    }
    
    .res-bar-content:active {
        cursor: grabbing !important;
    }
    
    /* Occupied vs Reserved Colors */
    .bg-occupied { background: linear-gradient(135deg, #0d6efd, #0b5ed7); color: white; }
    .bg-reserved { background: linear-gradient(135deg, #ffc107, #ffca2c); color: #212529; }
    
    /* Table Header Sticky Fixes */
    thead.sticky-top th {
        box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
        z-index: 10;
    }
    
    .droppable-cell.drag-over {
        background-color: rgba(13, 110, 253, 0.1) !important;
        outline: 2px dashed #0d6efd;
        z-index: 5;
    }
    
    .resize-handle {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 12px; /* Wider handle area */
        cursor: col-resize;
        z-index: 20;
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    td:hover .resize-handle { opacity: 1; }
    .resize-handle:hover { background-color: rgba(0,0,0,0.1); }
    .resize-start { left: 0; }
    .resize-end { right: 0; }
</style>

<script id="grid-data" type="application/json">{{ grid|tojson }}</script>
<script>
    var currentYear = Number("{{ year }}");
    var currentMonth = Number("{{ month }}");
    var startDateStr = "{{ start_date.strftime('%Y-%m-%d') }}";
    var gridStartDate = new Date(startDateStr + "T00:00:00");
    var gridData = JSON.parse(document.getElementById('grid-data').textContent);
    var draggedData = null;
    
    // --- Helper: Snap to Day Start (PM = Odd index) ---
    function snapToDayStart(slotIndex) {
        // Slot 0 = AM, Slot 1 = PM (Check-in).
        // If even, add 1 to make it PM.
        if (slotIndex % 2 === 0) return slotIndex + 1;
        return slotIndex;
    }

    // --- Helper: Format Date ---
    var fmtDate = (d) => d.getDate().toString().padStart(2, '0') + '/' + (d.getMonth()+1).toString().padStart(2, '0') + '/' + d.getFullYear();

    // --- Helper: Calculate Date from Slot ---
    function getDateFromSlot(slotIndex) {
        var dayIndex = Math.floor(slotIndex / 2);
        var d = new Date(gridStartDate);
        d.setDate(gridStartDate.getDate() + dayIndex);
        return d;
    }
    
    // --- Draw to Create Logic ---
    var isDrawing = false;
    var drawRoom = null;
    var drawStartSlot = null;
    var drawEndSlot = null;
    var drawStartCell = null;
    
    function startDraw(ev, cell) {
        if (ev.button !== 0) return; // Only left click
        isDrawing = true;
        drawRoom = cell.dataset.room;
        
        // Calculate exact slot based on mouse X within the cell
        var rect = cell.getBoundingClientRect();
        var cellLength = parseInt(cell.dataset.length);
        var cellStart = parseInt(cell.dataset.dayStart);
        var slotWidth = rect.width / cellLength;
        var clickX = ev.clientX - rect.left;
        var slotOffset = Math.floor(clickX / slotWidth);
        
        drawStartSlot = cellStart + slotOffset;
        drawEndSlot = drawStartSlot; // Initial single slot
        drawStartCell = cell;
        
        // Visual feedback
        clearSelection();
        highlightSelection(drawRoom, drawStartSlot, drawEndSlot);
        
        // Prevent default drag behavior if any
        ev.preventDefault();
    }
    
    function continueDraw(ev, cell) {
        if (!isDrawing) return;
        if (cell.dataset.room !== drawRoom) return; // Stay in same room
        
        var rect = cell.getBoundingClientRect();
        var cellLength = parseInt(cell.dataset.length);
        var cellStart = parseInt(cell.dataset.dayStart);
        var slotWidth = rect.width / cellLength;
        var clickX = ev.clientX - rect.left;
        var slotOffset = Math.floor(clickX / slotWidth);
        
        var currentSlot = cellStart + slotOffset;
        drawEndSlot = currentSlot;
        
        highlightSelection(drawRoom, drawStartSlot, drawEndSlot);
    }
    
    function endDraw(ev, cell) {
        if (!isDrawing) return;
        isDrawing = false;
        
        // Ensure start < end
        var start = Math.min(drawStartSlot, drawEndSlot);
        var end = Math.max(drawStartSlot, drawEndSlot);
        
        // Snap to days
        // If we select half-day slots, we probably want full days for new reservation?
        // Let's check logic:
        // Slot 0 (AM), 1 (PM).
        // If start is 0 (AM), Checkin Date AM? Usually Checkin is PM (1).
        // If start is 1 (PM), Checkin Date PM.
        
        // Let's enforce Checkin at PM (Odd) and Checkout at AM (Even)?
        // Or just map slots to dates.
        
        var checkinDate = getDateFromSlot(start);
        // For checkout, if we selected up to 'end' slot.
        // If end is AM (even), it includes that morning.
        // If end is PM (odd), it includes that night.
        // Checkout date should be the date AFTER the last occupied slot?
        // Actually, logic: getDateFromSlot(slot) returns the date of that slot.
        // If I select slots 0, 1 (Day 1 AM, Day 1 PM).
        // Checkin: Day 1. Checkout: Day 2.
        // Logic: Checkout = getDateFromSlot(end + 1).
        
        var checkoutDate = getDateFromSlot(end + 1);
        
        // If only 1 slot selected (click), maybe ignore or default to 1 night?
        if (start === end) {
            checkoutDate = getDateFromSlot(start + 2); // Minimum 1 day (2 slots)
        }
        
        var checkinStr = fmtDate(checkinDate);
        var checkoutStr = fmtDate(checkoutDate);
        
        // Open Modal
        openNewReservationModal(drawRoom, checkinStr, checkoutStr);
        
        // Clear selection after a delay or immediately?
        // Keep it until modal closes?
        // For now, clear.
        clearSelection();
    }
    
    function highlightSelection(room, start, end) {
        clearSelection();
        var min = Math.min(start, end);
        var max = Math.max(start, end);
        
        // Find all empty cells in this room that overlap with range
        var row = document.querySelector(`tr td[data-room="${room}"]`).parentNode;
        var cells = row.querySelectorAll('.droppable-cell');
        
        cells.forEach(c => {
            var cStart = parseInt(c.dataset.dayStart);
            var cLen = parseInt(c.dataset.length);
            var cEnd = cStart + cLen - 1;
            
            // Check overlap
            if (cStart <= max && cEnd >= min) {
                // Calculate overlap relative to cell
                var selStart = Math.max(min, cStart);
                var selEnd = Math.min(max, cEnd);
                
                var startOffset = selStart - cStart;
                var endOffset = selEnd - cStart;
                var len = endOffset - startOffset + 1;
                
                // Create highlight div
                var h = document.createElement('div');
                h.className = 'selection-highlight';
                h.style.position = 'absolute';
                h.style.top = '0';
                h.style.height = '100%';
                h.style.backgroundColor = 'rgba(0, 123, 255, 0.3)';
                h.style.pointerEvents = 'none'; // Click through
                
                // Width calculation
                // We need precise width %
                var widthPct = (len / cLen) * 100;
                var leftPct = (startOffset / cLen) * 100;
                
                h.style.width = widthPct + '%';
                h.style.left = leftPct + '%';
                
                // Ensure cell is relative
                if (getComputedStyle(c).position === 'static') {
                    c.style.position = 'relative';
                }
                c.appendChild(h);
            }
        });
    }
    
    function clearSelection() {
        document.querySelectorAll('.selection-highlight').forEach(el => el.remove());
    }
    
    function openNewReservationModal(room, checkin, checkout) {
        // Log to debug
        console.log("Opening New Res Modal:", room, checkin, checkout);
        
        var modalEl = document.getElementById('newReservationModal');
        if (modalEl) {
            // Find inputs inside the form
            var form = document.getElementById('newResForm');
            if (form) {
                // We need to map 'room' to category if possible, or just note it.
                // The current modal only has 'category', not specific 'room' select?
                // Wait, manual reservation usually asks for category. 
                // But if we draw on a specific room row, we should pre-select that category/room.
                // Looking at the modal HTML: it has 'category' select.
                
                // Let's try to infer category from room number if we have the mapping available in JS?
                // We don't have the mapping explicitly in JS variable, but we can try to guess or add a hidden room field.
                // For now, let's set dates.
                
                // Date inputs are type="date", expecting YYYY-MM-DD
                // checkin/checkout are DD/MM/YYYY from fmtDate.
                // Need to convert back.
                
                var partsIn = checkin.split('/');
                var yyyy_mm_dd_in = `${partsIn[2]}-${partsIn[1]}-${partsIn[0]}`;
                
                var partsOut = checkout.split('/');
                var yyyy_mm_dd_out = `${partsOut[2]}-${partsOut[1]}-${partsOut[0]}`;
                
                var inInput = form.querySelector('input[name="checkin"]');
                var outInput = form.querySelector('input[name="checkout"]');
                
                if(inInput) inInput.value = yyyy_mm_dd_in;
                if(outInput) outInput.value = yyyy_mm_dd_out;
                
                // Try to set category based on room (heuristic)
                var catSelect = form.querySelector('select[name="category"]');
                if (catSelect && room) {
                    var roomInt = parseInt(room);
                    var catVal = "";
                    if ([1,2,3].includes(roomInt)) catVal = "Suíte Areia";
                    else if (roomInt === 11) catVal = "Suíte Mar Família";
                    else if ([12,14,15,16,17,21,22,23,24,25,26].includes(roomInt)) catVal = "Suíte Mar";
                    else if ([31,35].includes(roomInt)) catVal = "Suíte Alma c/ Banheira";
                    else if ([32,34].includes(roomInt)) catVal = "Suíte Alma";
                    else if (roomInt === 33) catVal = "Suíte Master Diamante";
                    
                    if (catVal) catSelect.value = catVal;
                    
                    // Also, we might want to force the specific room assignment?
                    // The backend create_manual_reservation doesn't seem to take 'room' directly?
                    // It creates a reservation, then we might need to allocate it.
                    // Or we can add a hidden 'room' field to the form and handle it in backend?
                    // Let's check backend: create_manual_reservation just saves to JSON.
                    // It doesn't allocate.
                    // So we should probably allocate it immediately after creation?
                    // Or add 'room' to the payload and have backend handle it.
                    
                    // Let's add a hidden input for room if it doesn't exist
                    var roomInput = form.querySelector('input[name="allocated_room"]');
                    if (!roomInput) {
                        roomInput = document.createElement('input');
                        roomInput.type = 'hidden';
                        roomInput.name = 'allocated_room';
                        form.appendChild(roomInput);
                    }
                    roomInput.value = room;
                }
            }
            
            var modal = new bootstrap.Modal(modalEl);
            modal.show();
        } else {
             console.log("New Reservation Modal not found.");
        }
    }

    // --- End Draw Logic ---

    // --- Helper: Call Backend Calculation ---
    function calculateUpdate(resId, newRoom, checkin, checkout, callback) {
        fetch('/api/reception/calculate_reservation_update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                reservation_id: resId,
                new_room: newRoom,
                new_checkin: checkin,
                new_checkout: checkout
            })
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                callback(data.data);
            } else {
                alert("Erro ao calcular atualização: " + data.error);
            }
        })
        .catch(err => alert("Erro de comunicação ao calcular."));
    }

    // Move Logic
    var isDragging = false;
    
    function drag(ev) {
        isDragging = true;
        var td = ev.target.closest('td');
        if (!td) return;
        
        // Calculate and store initial X position for delta calculation
        ev.dataTransfer.setData("startX", ev.clientX);
        ev.dataTransfer.setData("resId", td.dataset.resId);
        ev.dataTransfer.setData("guest", td.dataset.guest);
        ev.dataTransfer.setData("days", td.dataset.days);
        ev.dataTransfer.setData("startDay", td.dataset.startDay);
        
        // Visual feedback
        ev.target.style.opacity = '0.5';
        
        draggedData = {
            resId: td.dataset.resId,
            guest: td.dataset.guest,
            days: parseInt(td.dataset.days),
            startDay: parseInt(td.dataset.startDay),
            startX: ev.clientX
        };
    }
    
    document.addEventListener('dragend', function(ev) {
        if (ev.target.classList.contains('res-bar-content')) {
            ev.target.style.opacity = '1';
        }
        // Small delay to prevent click firing immediately after drag
        setTimeout(() => { isDragging = false; }, 100);
    });

    function allowDrop(ev) {
        ev.preventDefault();
        var td = ev.target.closest('td');
        if(td && td.classList.contains('droppable-cell')) {
            td.classList.add('drag-over');
        }
    }
    
    document.addEventListener('dragleave', function(ev) {
        if (ev.target.classList.contains('droppable-cell')) {
            ev.target.classList.remove('drag-over');
        }
    });

    function drop(ev) {
        ev.preventDefault();
        
        var target = ev.target;
        while (target.tagName !== 'TD' && target) {
            target = target.parentNode;
        }
        
        if (!target) return;
        target.classList.remove('drag-over');
        
        // Get Drag Data
        var resId = ev.dataTransfer.getData("resId") || (draggedData ? draggedData.resId : null);
        var guest = ev.dataTransfer.getData("guest") || (draggedData ? draggedData.guest : null);
        var daysRequired = parseInt(ev.dataTransfer.getData("days") || (draggedData ? draggedData.days : 0));
        var originalStartDay = parseInt(ev.dataTransfer.getData("startDay") || (draggedData ? draggedData.startDay : 0));
        var startX = parseInt(ev.dataTransfer.getData("startX") || (draggedData ? draggedData.startX : 0));
        
        if (!resId) return;

        // Calculate Delta Slots based on horizontal movement
        // We need to know the width of a slot. 
        // We can approximate by looking at the target cell width (which is N slots wide)
        var targetSlotLength = parseInt(target.dataset.length) || 1;
        var rect = target.getBoundingClientRect();
        var slotWidth = rect.width / targetSlotLength;
        
        var deltaX = ev.clientX - startX;
        var deltaSlots = Math.round(deltaX / slotWidth);
        
        // Determine New Room
        var newRoom = target.dataset.room;
        
        // Determine New Start Slot
        // If we stayed in the same room, we use delta.
        // If we changed rooms, we need to map to the new room's timeline.
        // But drag & drop usually implies visual movement relative to grid.
        // The grid is aligned vertically (same slots for all rooms).
        // So dropping at X position corresponds to same time slot regardless of room row.
        // Thus, we can just use Original Start Slot + Delta Slots.
        
        var newStartSlot = originalStartDay + deltaSlots;
        
        // SNAP: Align to nearest PM slot (Check-in time)
        // Check-in usually happens in PM (Odd slots: 1, 3, 5...).
        // Slot 0 = StartDate AM, Slot 1 = StartDate PM.
        // So we want odd numbers if possible, or consistent with existing logic.
        // Let's enforce check-in at PM (odd index)
        if (newStartSlot % 2 === 0) newStartSlot += 1; 
        
        // Ensure within bounds
        if (newStartSlot < 0) newStartSlot = 1; // Minimum valid slot
        
        // Calculate New Dates
        var checkinDate = getDateFromSlot(newStartSlot);
        var checkoutDate = getDateFromSlot(newStartSlot + daysRequired);
        
        var checkinStr = fmtDate(checkinDate);
        var checkoutStr = fmtDate(checkoutDate);
        
        // Call Backend to Calculate/Validate
        calculateUpdate(resId, newRoom, checkinStr, checkoutStr, function(calcData) {
            if (!calcData.valid) {
                alert("Conflito detectado pelo servidor: " + calcData.conflict_message);
                return;
            }
            
            window.pendingMove = {
                reservation_id: resId,
                new_room: newRoom,
                checkin: checkinStr,
                checkout: checkoutStr,
                calc: calcData
            };
            
            // Prepare Modal
            document.getElementById('moveGuest').textContent = guest;
            document.getElementById('moveRoom').textContent = newRoom;
            document.getElementById('moveDates').textContent = checkinStr + ' - ' + checkoutStr;
            
            // Price Info
            var priceHtml = '';
            if (calcData.diff !== 0) {
                var diffStr = calcData.diff > 0 ? '+ R$ ' + calcData.diff.toFixed(2) : '- R$ ' + Math.abs(calcData.diff).toFixed(2);
                priceHtml = `Valor atual: R$ ${calcData.old_total.toFixed(2)}<br>
                             Novo valor: <strong>R$ ${calcData.new_total.toFixed(2)}</strong> (${diffStr})`;
                document.getElementById('movePriceInfo').innerHTML = priceHtml;
                document.getElementById('priceAdjYes').checked = true;
                togglePriceInput(true);
                document.getElementById('newPrice').value = calcData.new_total.toFixed(2);
            } else {
                document.getElementById('movePriceInfo').innerHTML = "Sem alteração de valor.";
                document.getElementById('priceAdjNo').checked = true;
                togglePriceInput(false);
            }
            
            var moveModal = new bootstrap.Modal(document.getElementById('moveModal'));
            moveModal.show();
        });
    }
    
    // Check Collisions (Client Side)
    function checkCollision(room, startDay, duration, currentResId) {
        if (!gridData[room]) return false;
        
        for (var i = 0; i < duration; i++) {
            var day = startDay + i;
            var cell = gridData[room][String(day)] || gridData[room][day];
            
            if (cell) {
                // Ignore if it's the SAME reservation (checking by ID)
                // This allows self-overlap (e.g. extending date or moving partially over itself)
                if (cell.id && String(cell.id) === String(currentResId)) {
                    continue; 
                }

                if (cell.status === 'occupied') {
                    // It's occupied by someone else (ID check failed above)
                    return true;
                }
                if (cell.status === 'reserved') {
                    // It's reserved by someone else (ID check failed above)
                    return true;
                }
            }
        }
        return false;
    }

    // Modal UI Logic
    function togglePriceInput(show) {
        var container = document.getElementById('newPriceContainer');
        if (show) {
            container.classList.remove('d-none');
        } else {
            container.classList.add('d-none');
            // document.getElementById('newPrice').value = ''; // Don't clear, keep calc value
        }
    }

    function confirmMove() {
        if (!window.pendingMove) return;
        
        var data = window.pendingMove;
        var priceAdjType = document.querySelector('input[name="priceAdj"]:checked').value;
        
        var payload = {
            reservation_id: data.reservation_id,
            new_room: data.new_room,
            checkin: data.checkin,
            checkout: data.checkout
        };
        
        if (priceAdjType === 'yes') {
            var amount = document.getElementById('newPrice').value;
            payload.price_adjustment = {
                type: 'manual',
                amount: amount
            };
        }
        
        var btn = document.querySelector('#moveModal .btn-primary');
        btn.disabled = true;
        btn.textContent = "Salvando...";
        
        fetch('/api/reception/move_reservation', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                location.reload();
            } else {
                alert("Erro ao mover reserva: " + result.error);
                btn.disabled = false;
                btn.textContent = "Confirmar Mudança";
            }
        })
        .catch(err => {
            console.error(err);
            alert("Erro de comunicação.");
            btn.disabled = false;
            btn.textContent = "Confirmar Mudança";
        });
    }

    // Resize Logic
    var resizing = false;
    var resizeData = {};

    function startResize(ev, direction, resId, startSlot, length, room) {
        ev.stopPropagation();
        ev.preventDefault(); 
        
        resizing = true;
        var td = ev.target.parentNode;
        
        resizeData = {
            resId: resId,
            direction: direction,
            startSlot: startSlot,
            length: length,
            room: room,
            startX: ev.clientX,
            originalWidth: td.getBoundingClientRect().width,
            cellWidth: td.getBoundingClientRect().width / length,
            td: td
        };
        
        document.addEventListener('mousemove', resizeMove);
        document.addEventListener('mouseup', resizeUp);
    }

    function resizeMove(ev) {
        if (!resizing) return;
        
        var deltaX = ev.clientX - resizeData.startX;
        var deltaSlots = Math.round(deltaX / resizeData.cellWidth);
        
        // Enforce 2-slot increments (Full Days)
        deltaSlots = Math.round(deltaSlots / 2) * 2;
        
        var newLength = resizeData.length;
        var newStartSlot = resizeData.startSlot;
        
        if (resizeData.direction === 'end') {
            newLength = resizeData.length + deltaSlots;
        } else {
            newLength = resizeData.length - deltaSlots;
            newStartSlot = resizeData.startSlot + deltaSlots;
        }
        
        if (newLength < 2) return; 
        if (newStartSlot < 0) return; 
        
        resizeData.td.style.opacity = 0.7;
        document.body.style.cursor = 'col-resize';
    }

    function resizeUp(ev) {
        if (!resizing) return;
        resizing = false;
        document.removeEventListener('mousemove', resizeMove);
        document.removeEventListener('mouseup', resizeUp);
        document.body.style.cursor = 'default';
        resizeData.td.style.opacity = 1;
        
        var deltaX = ev.clientX - resizeData.startX;
        var deltaSlots = Math.round(deltaX / resizeData.cellWidth);
        var deltaDays = Math.round(deltaSlots / 2);
        deltaSlots = deltaDays * 2;
        
        if (deltaSlots === 0) return;
        
        var newStartSlot = resizeData.startSlot;
        var newLength = resizeData.length;
        
        if (resizeData.direction === 'end') {
            newLength = resizeData.length + deltaSlots;
        } else {
            newStartSlot = resizeData.startSlot + deltaSlots;
            newLength = resizeData.length - deltaSlots;
        }
        
        if (newLength < 2) {
            alert("A estadia mínima é de 1 diária.");
            return;
        }
        if (newStartSlot < 0) {
            alert("Data inválida.");
            return;
        }
        
        if (checkCollision(resizeData.room, newStartSlot, newLength, resizeData.resId)) {
            alert("Conflito de datas com outra reserva.");
            return;
        }
        
        var checkinDate = getDateFromSlot(newStartSlot);
        var checkoutDate = getDateFromSlot(newStartSlot + newLength);
        var checkinStr = fmtDate(checkinDate);
        var checkoutStr = fmtDate(checkoutDate);
        
        // Call Backend Calculation
        calculateUpdate(resizeData.resId, resizeData.room, checkinStr, checkoutStr, function(calcData) {
            if (!calcData.valid) {
                alert("Conflito detectado pelo servidor: " + calcData.conflict_message);
                return;
            }
            
            window.pendingResize = {
                reservation_id: resizeData.resId,
                checkin: checkinStr,
                checkout: checkoutStr,
                room_number: resizeData.room,
                calc: calcData
            };
            
            var guestName = resizeData.td.querySelector('.fw-bold').textContent;
            document.getElementById('resizeGuest').textContent = guestName;
            document.getElementById('resizeDates').textContent = checkinStr + ' - ' + checkoutStr;
            
            // Show Calculated Price
             var priceHtml = '';
            if (calcData.diff !== 0) {
                var diffStr = calcData.diff > 0 ? '+ R$ ' + calcData.diff.toFixed(2) : '- R$ ' + Math.abs(calcData.diff).toFixed(2);
                priceHtml = `<div class="alert alert-info py-2">
                                Valor atual: R$ ${calcData.old_total.toFixed(2)}<br>
                                Novo valor sugerido: <strong>R$ ${calcData.new_total.toFixed(2)}</strong> (${diffStr})
                             </div>`;
                document.getElementById('resizePriceInfo').innerHTML = priceHtml;
                document.getElementById('resizePriceAdj').value = calcData.diff.toFixed(2);
            } else {
                document.getElementById('resizePriceInfo').innerHTML = "<div class='alert alert-secondary py-2'>Sem alteração de valor calculada.</div>";
                document.getElementById('resizePriceAdj').value = '';
            }
            
            var modal = new bootstrap.Modal(document.getElementById('resizeModal'));
            modal.show();
        });
    }
    
    function confirmResize() {
        if (!window.pendingResize) return;
        
        var data = window.pendingResize;
        var priceAdj = document.getElementById('resizePriceAdj').value;
        
        var payload = {
            reservation_id: data.reservation_id,
            checkin: data.checkin,
            checkout: data.checkout,
            room_number: data.room_number
        };
        
        if (priceAdj) {
            payload.price_adjustment = {
                type: 'manual',
                amount: priceAdj
            };
        }
        
        fetch('/api/reception/resize_reservation', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert("Erro ao alterar reserva: " + data.message);
            }
        })
        .catch(err => alert("Erro de comunicação."));
    }
    
    // Toggle fiscal fields based on borrower type
    function toggleFiscalFields() {
        var type = document.getElementById('fiscalBorrowerType').value;
        var countryField = document.getElementById('fiscalCountry');
        
        if (type === 'foreigner') {
            countryField.disabled = false;
        } else {
            countryField.disabled = true;
            countryField.value = '';
        }
    }

    // Explicit Double Click Handler
    function handleResDblClick(ev, el) {
        if (isDragging) return;
        ev.stopPropagation(); 
        
        // Find closest TD that has reservation data
        // Note: The element 'el' is .res-bar-content, its parent is TD
        var td = el.closest('td');
        if(td) {
            console.log("Double Click Detected. Opening modal for guest:", td.dataset.guest);
            openReservationModalFromData(td);
        }
    }

    // Guest Details & Upload (Existing functions)
    // Global Click Listener REMOVED - Using inline onclick for robustness against Drag & Drop
    
    window.openReservationModalFromData = function(el) {
        console.log('Opening reservation modal for:', el.dataset.guest);
        try {
            var d = el.dataset;
            openReservationModal(d.guest, d.checkin, d.checkout, d.category, d.status, d.channel, d.amount, d.paid, d.toReceive, d.resId, 'reserved');
        } catch (e) {
            console.error('Error opening modal:', e);
        }
    };

    function openReservationModal(guest, checkin, checkout, category, status, channel, amount, paid, to_receive, id, type) {
        console.log('openReservationModal called', {guest, id});
        
        // Default to Guest Tab (Cadastro) as requested
        var guestTabEl = document.querySelector('#resTab button[data-bs-target="#guest"]');
        if(guestTabEl) {
            var guestTab = new bootstrap.Tab(guestTabEl);
            guestTab.show();
        }
        
        // Helper to format currency
        var fmtMoney = (val) => {
            if (val === undefined || val === null || val === '') return '-';
            var num = parseFloat(val);
            if (isNaN(num)) return val; // Return original string if not a number
            return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        };

        document.getElementById('modalGuestName').textContent = guest || 'Hóspede';
        document.getElementById('modalDates').textContent = (checkin || '') + ' até ' + (checkout || '');
        document.getElementById('modalCategory').textContent = category || '';
        document.getElementById('modalChannel').textContent = channel || 'Direto';
        document.getElementById('modalStatus').textContent = status || 'N/A';
        document.getElementById('modalAmount').textContent = fmtMoney(amount);
        document.getElementById('modalPaid').textContent = fmtMoney(paid);
        document.getElementById('modalToReceive').textContent = fmtMoney(to_receive);
        
        var guestIdField = document.getElementById('guestResId');
        if(guestIdField) guestIdField.value = id || '';
        
        const statusBadge = document.getElementById('modalStatusBadge');
        if (statusBadge) {
            statusBadge.textContent = status || 'N/A';
            statusBadge.className = 'badge ' + (status === 'Pago' ? 'bg-success' : 'bg-warning text-dark');
        }
        
        if(document.getElementById('guestPhone')) {
            // Reset fields
            document.getElementById('guestPhone').value = '';
            document.getElementById('guestEmail').value = '';
            document.getElementById('guestDob').value = '';
            document.getElementById('guestDocId').value = '';
            document.getElementById('guestAddress').value = '';
            
            // Reset Fiscal
            document.getElementById('fiscalBorrowerType').value = 'cpf';
            document.getElementById('fiscalDocNumber').value = '';
            document.getElementById('fiscalAddressFull').value = '';
            document.getElementById('fiscalMunicipality').value = 'Tamandaré';
            document.getElementById('fiscalCountry').value = '';
            toggleFiscalFields();
            
            // Reset Operational
            document.getElementById('dietGluten').checked = false;
            document.getElementById('dietLactose').checked = false;
            document.getElementById('dietVegan').checked = false;
            document.getElementById('dietVegetarian').checked = false;
            document.getElementById('opAllergies').value = '';
            document.getElementById('opBreakfastStart').value = '';
            document.getElementById('opBreakfastEnd').value = '';
            document.getElementById('opCommemorative').value = '';

            document.getElementById('docPreview').innerHTML = '';
            document.getElementById('modalAvgDaily').textContent = 'Carregando...';
            
            if (id) {
                fetch('/api/guest/details/' + id)
                    .then(res => res.json())
                    .then(data => {
                        if(data.success) {
                            if(data.data.reservation && data.data.reservation.avg_daily_paid) {
                                document.getElementById('modalAvgDaily').textContent = 'R$ ' + data.data.reservation.avg_daily_paid.toFixed(2);
                            } else {
                                document.getElementById('modalAvgDaily').textContent = 'R$ 0.00';
                            }
                            
                            var guestData = data.data.guest;
                            if(guestData) {
                                // Personal Info
                                if (guestData.personal_info) {
                                    var info = guestData.personal_info;
                                    document.getElementById('guestPhone').value = info.phone || '';
                                    document.getElementById('guestEmail').value = info.email || '';
                                    document.getElementById('guestDob').value = info.dob || '';
                                    document.getElementById('guestDocId').value = info.doc_id || '';
                                    document.getElementById('guestAddress').value = info.address || '';
                                    
                                    if(info.document_photo_path) {
                                        document.getElementById('docPreview').innerHTML = 
                                            '<div class="alert alert-success py-1"><i class="bi bi-check-circle"></i> Documento enviado</div>';
                                    }
                                }
                                
                                // Fiscal Info
                                if (guestData.fiscal_info) {
                                    var fiscal = guestData.fiscal_info;
                                    document.getElementById('fiscalBorrowerType').value = fiscal.borrower_type || 'cpf';
                                    document.getElementById('fiscalDocNumber').value = fiscal.cpf || fiscal.cnpj || fiscal.foreigner_passport || '';
                                    document.getElementById('fiscalAddressFull').value = fiscal.address || '';
                                    document.getElementById('fiscalMunicipality').value = fiscal.municipality || 'Tamandaré';
                                    document.getElementById('fiscalCountry').value = fiscal.foreigner_country || '';
                                    toggleFiscalFields();
                                }
                                
                                // Operational Info
                                if (guestData.operational_info) {
                                    var op = guestData.operational_info;
                                    var restrictions = op.dietary_restrictions || [];
                                    document.getElementById('dietGluten').checked = restrictions.includes('gluten_free');
                                    document.getElementById('dietLactose').checked = restrictions.includes('lactose_free');
                                    document.getElementById('dietVegan').checked = restrictions.includes('vegan');
                                    document.getElementById('dietVegetarian').checked = restrictions.includes('vegetarian');
                                    
                                    document.getElementById('opAllergies').value = op.allergies || '';
                                    document.getElementById('opBreakfastStart').value = op.breakfast_time_start || '';
                                    document.getElementById('opBreakfastEnd').value = op.breakfast_time_end || '';
                                    
                                    var comm = op.commemorative_dates || [];
                                    document.getElementById('opCommemorative').value = comm.join(', ');
                                }
                            }
                        }
                    })
                    .catch(err => console.error('Error fetching details:', err));
            }
        }

        var modalEl = document.getElementById('reservationModal');
        if (modalEl) {
            var myModal = bootstrap.Modal.getInstance(modalEl);
            if (!myModal) {
                myModal = new bootstrap.Modal(modalEl);
            }
            myModal.show();
        } else {
            console.error('Modal element #reservationModal not found');
        }
    }

    function saveGuestData() {
        var resId = document.getElementById('guestResId').value;
        
        // Personal Info
        var personalInfo = {
            phone: document.getElementById('guestPhone').value,
            email: document.getElementById('guestEmail').value,
            dob: document.getElementById('guestDob').value,
            doc_id: document.getElementById('guestDocId').value,
            address: document.getElementById('guestAddress').value
        };
        
        // Fiscal Info
        var borrowerType = document.getElementById('fiscalBorrowerType').value;
        var docNumber = document.getElementById('fiscalDocNumber').value;
        var fiscalInfo = {
            borrower_type: borrowerType,
            address: document.getElementById('fiscalAddressFull').value,
            municipality: document.getElementById('fiscalMunicipality').value,
            foreigner_country: document.getElementById('fiscalCountry').value
        };
        
        // Map document number to correct field
        if (borrowerType === 'cpf') fiscalInfo.cpf = docNumber;
        else if (borrowerType === 'cnpj') fiscalInfo.cnpj = docNumber;
        else if (borrowerType === 'foreigner') fiscalInfo.foreigner_passport = docNumber;
        
        // Operational Info
        var restrictions = [];
        if(document.getElementById('dietGluten').checked) restrictions.push('gluten_free');
        if(document.getElementById('dietLactose').checked) restrictions.push('lactose_free');
        if(document.getElementById('dietVegan').checked) restrictions.push('vegan');
        if(document.getElementById('dietVegetarian').checked) restrictions.push('vegetarian');
        
        var commDates = document.getElementById('opCommemorative').value
            .split(',')
            .map(s => s.trim())
            .filter(s => s.length > 0);
            
        var operationalInfo = {
            dietary_restrictions: restrictions,
            allergies: document.getElementById('opAllergies').value,
            breakfast_time_start: document.getElementById('opBreakfastStart').value,
            breakfast_time_end: document.getElementById('opBreakfastEnd').value,
            commemorative_dates: commDates
        };
        
        var payload = {
            reservation_id: resId,
            personal_info: personalInfo,
            fiscal_info: fiscalInfo,
            operational_info: operationalInfo
        };
        
        fetch('/api/guest/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                alert('Dados salvos com sucesso!');
            } else {
                alert('Erro ao salvar: ' + data.error);
            }
        });
    }
    
    function uploadGuestDoc() {
        var resId = document.getElementById('guestResId').value;
        var fileInput = document.getElementById('guestDocFile');
        
        if(fileInput.files.length === 0) {
            alert("Selecione um arquivo.");
            return;
        }
        
        var formData = new FormData();
        formData.append('reservation_id', resId);
        formData.append('document_photo', fileInput.files[0]);
        
        fetch('/api/guest/upload_document', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                alert('Documento enviado com sucesso!');
                document.getElementById('docPreview').innerHTML = 
                    '<div class="alert alert-success py-1"><i class="bi bi-check-circle"></i> Documento enviado</div>';
                fileInput.value = '';
            } else {
                alert('Erro ao enviar: ' + data.error);
            }
        });
    }
</script>

<!-- New Reservation Modal -->
<div class="modal fade" id="newReservationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Nova Reserva Manual</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newResForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Hóspede (Responsável)</label>
                            <input type="text" class="form-control" name="guest_name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Categoria</label>
                            <select class="form-select" name="category">
                                <option value="Suíte Areia">Suíte Areia</option>
                                <option value="Suíte Mar">Suíte Mar</option>
                                <option value="Suíte Mar Família">Suíte Mar Família</option>
                                <option value="Suíte Alma">Suíte Alma</option>
                                <option value="Suíte Alma c/ Banheira">Suíte Alma c/ Banheira</option>
                                <option value="Suíte Master Diamante">Suíte Master Diamante</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Check-in</label>
                            <input type="date" class="form-control" name="checkin" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Check-out</label>
                            <input type="date" class="form-control" name="checkout" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Valor Total (R$)</label>
                            <input type="number" step="0.01" class="form-control" name="amount" value="0.00">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Pago (R$)</label>
                            <input type="number" step="0.01" class="form-control" name="paid_amount" value="0.00">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">A Receber (R$)</label>
                            <input type="number" step="0.01" class="form-control" name="to_receive" value="0.00">
                        </div>
                    </div>
                    <div class="row mb-3">
                         <div class="col-md-6">
                             <label class="form-label">Canal</label>
                             <select class="form-select" name="channel">
                                 <option value="Direto">Direto (Balcão/Telefone)</option>
                                 <option value="WhatsApp">WhatsApp</option>
                                 <option value="Booking.com">Booking.com</option>
                                 <option value="Airbnb">Airbnb</option>
                                 <option value="Expedia">Expedia</option>
                             </select>
                         </div>
                         <div class="col-md-6">
                             <label class="form-label">Status Pagamento</label>
                             <select class="form-select" name="status">
                                 <option value="Pendente">Pendente</option>
                                 <option value="Parcial">Parcial</option>
                                 <option value="Pago">Pago</option>
                             </select>
                         </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="submitNewReservation()">Salvar Reserva</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- File Upload ---
    function uploadReservationsFile(input) {
        if (!input.files || !input.files[0]) return;
        
        var formData = new FormData();
        formData.append('file', input.files[0]);
        
        // Show loading state on button
        var btn = input.previousElementSibling;
        var originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Enviando...';
        
        fetch('/api/reception/upload_reservations', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert("Erro: " + data.error);
            }
        })
        .catch(err => {
            console.error(err);
            alert("Erro de conexão.");
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalText;
            input.value = ''; // Reset
        });
    }

    // --- New Reservation ---
    function openNewReservationModal() {
        var modal = new bootstrap.Modal(document.getElementById('newReservationModal'));
        modal.show();
    }
    
    function submitNewReservation() {
        var form = document.getElementById('newResForm');
        var formData = new FormData(form);
        var data = Object.fromEntries(formData.entries());
        
        // Format dates to DD/MM/YYYY
        if (data.checkin) {
            var d = new Date(data.checkin);
            // Fix timezone offset issue by treating as UTC or appending time
            d = new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate());
            data.checkin = d.toLocaleDateString('pt-BR');
        }
        if (data.checkout) {
            var d = new Date(data.checkout);
            d = new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate());
            data.checkout = d.toLocaleDateString('pt-BR');
        }
        
        var btn = document.querySelector('#newReservationModal .btn-primary');
        btn.disabled = true;
        btn.innerHTML = 'Salvando...';
        
        fetch('/api/reception/create_manual_reservation', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(resData => {
            if (resData.success) {
                alert("Reserva criada com sucesso!");
                location.reload();
            } else {
                alert("Erro: " + resData.error);
                btn.disabled = false;
                btn.innerHTML = 'Salvar Reserva';
            }
        })
        .catch(err => {
            alert("Erro de comunicação.");
            btn.disabled = false;
            btn.innerHTML = 'Salvar Reserva';
        });
    }
    
    // --- Pre-Allocation ---
    function runPreAllocation() {
        var btn = document.querySelector('button[onclick="runPreAllocation()"]');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processando...';
        
        fetch('/api/reception/auto_pre_allocate', {
            method: 'POST'
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                var count = data.actions.length;
                if (count > 0) {
                    alert(`${count} reservas foram pré-alocadas!\n\n` + data.actions.join('\n'));
                    location.reload();
                } else {
                    alert("Nenhuma nova pré-alocação necessária no momento.");
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-magic"></i> Pré-alocação';
                }
            } else {
                alert("Erro: " + data.error);
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-magic"></i> Pré-alocação';
            }
        })
        .catch(err => {
            alert("Erro de comunicação.");
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-magic"></i> Pré-alocação';
        });
    }
</script>

<!-- Move Confirmation Modal -->
<div class="modal fade" id="moveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Mover Reserva</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Mover reserva de <strong><span id="moveGuest"></span></strong> para o quarto <strong><span id="moveRoom"></span></strong>?</p>
                <p>Novas datas: <strong><span id="moveDates"></span></strong></p>
                
                <hr>
                <div class="mb-3" id="movePriceInfo"></div>
                
                <div class="mb-3">
                    <label class="form-label">Haverá ajuste no valor da diária?</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="priceAdj" id="priceAdjNo" value="no" checked onclick="togglePriceInput(false)">
                        <label class="form-check-label" for="priceAdjNo">
                            Manter valor original
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="priceAdj" id="priceAdjYes" value="yes" onclick="togglePriceInput(true)">
                        <label class="form-check-label" for="priceAdjYes">
                            Sim, ajustar valor
                        </label>
                    </div>
                </div>
                
                <div class="mb-3 d-none" id="newPriceContainer">
                    <label for="newPrice" class="form-label">Novo Valor Total (R$)</label>
                    <input type="number" class="form-control" id="newPrice" step="0.01">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmMove()">Confirmar Mudança</button>
            </div>
        </div>
    </div>
</div>

<!-- Resize Confirmation Modal -->
<div class="modal fade" id="resizeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Alterar Período da Reserva</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Alterar reserva de <strong><span id="resizeGuest"></span></strong>?</p>
                <p>Novo período: <strong><span id="resizeDates"></span></strong></p>
                
                <hr>
                <div id="resizePriceInfo" class="mb-3"></div>
                
                <div class="mb-3">
                    <label for="resizePriceAdj" class="form-label">Ajuste de Valor (Opcional)</label>
                    <input type="text" class="form-control" id="resizePriceAdj" placeholder="Ex: +100.00 ou -50.00 ou 1200.00">
                    <div class="form-text">Deixe em branco para manter o valor original.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmResize()">Confirmar Alteração</button>
            </div>
        </div>
    </div>
</div>

<!-- Reservation Details Modal -->
<div class="modal fade" id="reservationModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title" id="modalGuestName">Guest Name</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        
        <ul class="nav nav-tabs mb-3" id="resTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">Reserva</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="guest-tab" data-bs-toggle="tab" data-bs-target="#guest" type="button" role="tab">Dados Pessoais</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="fiscal-tab" data-bs-toggle="tab" data-bs-target="#fiscal" type="button" role="tab">Fiscal</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="operational-tab" data-bs-toggle="tab" data-bs-target="#operational" type="button" role="tab">Operacional</button>
          </li>
        </ul>
        
        <div class="tab-content" id="resTabContent">
          <!-- Reservation Info Tab -->
          <div class="tab-pane fade show active" id="info" role="tabpanel">
            <div class="row mb-3">
                <div class="col-6">
                    <small class="text-muted d-block">Check-in / Check-out</small>
                    <strong id="modalDates"></strong>
                </div>
                <div class="col-6">
                    <small class="text-muted d-block">Categoria</small>
                    <strong id="modalCategory"></strong>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-6">
                    <small class="text-muted d-block">Canal de Reserva (Origem)</small>
                    <strong id="modalChannel"></strong>
                </div>
                <div class="col-6">
                    <small class="text-muted d-block">Status Pagamento</small>
                    <span id="modalStatusBadge" class="badge bg-secondary"></span>
                </div>
            </div>
            <div class="row bg-light p-2 rounded mb-3">
                <div class="col-4">
                    <small class="text-muted d-block">Valor Total</small>
                    <strong id="modalAmount" class="text-dark"></strong>
                </div>
                <div class="col-4">
                    <small class="text-muted d-block">Valor Pago</small>
                    <strong id="modalPaid" class="text-success"></strong>
                </div>
                <div class="col-4">
                    <small class="text-muted d-block">A Receber</small>
                    <strong id="modalToReceive" class="text-danger"></strong>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-12">
                     <small class="text-muted d-block">Valor Médio da Diária (Paga)</small>
                     <strong id="modalAvgDaily" class="text-primary fs-5">R$ 0.00</strong>
                </div>
            </div>
            
            <div class="mt-4 d-grid gap-2">
                <a href="{{ url_for('reception.reception_reservations_cashier') }}" class="btn btn-outline-primary">
                    <i class="bi bi-wallet2"></i> Ir para Caixa de Reservas
                </a>
            </div>
          </div>
          
          <!-- Guest Details Tab -->
          <div class="tab-pane fade" id="guest" role="tabpanel">
             <form id="guestForm">
                 <input type="hidden" id="guestResId">
                 <div class="row mb-3">
                     <div class="col-md-6">
                         <label class="form-label">Telefone de Contato</label>
                         <input type="text" class="form-control" id="guestPhone">
                     </div>
                     <div class="col-md-6">
                         <label class="form-label">Email</label>
                         <input type="email" class="form-control" id="guestEmail">
                     </div>
                 </div>
                 <div class="row mb-3">
                     <div class="col-md-6">
                         <label class="form-label">Data de Nascimento</label>
                         <input type="date" class="form-control" id="guestDob">
                     </div>
                     <div class="col-md-6">
                         <label class="form-label">RG / Documento Civil</label>
                         <input type="text" class="form-control" id="guestDocId">
                     </div>
                 </div>
                 <div class="mb-3">
                     <label class="form-label">Endereço Completo</label>
                     <textarea class="form-control" id="guestAddress" rows="2"></textarea>
                 </div>
                 
                 <div class="mb-3">
                     <label class="form-label">Documento (Foto)</label>
                     <div class="input-group">
                         <input type="file" class="form-control" id="guestDocFile" accept="image/*">
                         <button class="btn btn-outline-secondary" type="button" onclick="uploadGuestDoc()">Upload</button>
                     </div>
                     <small class="text-muted">Formatos: JPG, PNG. Máx 5MB.</small>
                     <div id="docPreview" class="mt-2"></div>
                 </div>
             </form>
          </div>

          <!-- Fiscal Tab -->
          <div class="tab-pane fade" id="fiscal" role="tabpanel">
             <div class="row mb-3">
                 <div class="col-md-4">
                     <label class="form-label">Tipo Tomador</label>
                     <select class="form-select" id="fiscalBorrowerType" onchange="toggleFiscalFields()">
                         <option value="cpf">Pessoa Física (CPF)</option>
                         <option value="cnpj">Pessoa Jurídica (CNPJ)</option>
                         <option value="foreigner">Estrangeiro</option>
                     </select>
                 </div>
                 <div class="col-md-8">
                     <label class="form-label">Documento Fiscal (CPF/CNPJ)</label>
                     <input type="text" class="form-control" id="fiscalDocNumber">
                 </div>
             </div>
             <div class="mb-3">
                 <label class="form-label">Endereço Fiscal (Logradouro, Nº, Bairro)</label>
                 <input type="text" class="form-control" id="fiscalAddressFull">
             </div>
             <div class="row mb-3">
                 <div class="col-md-6">
                     <label class="form-label">Município</label>
                     <input type="text" class="form-control" id="fiscalMunicipality" value="Tamandaré">
                 </div>
                 <div class="col-md-6">
                     <label class="form-label">País (Estrangeiro)</label>
                     <input type="text" class="form-control" id="fiscalCountry" disabled>
                 </div>
             </div>
          </div>

          <!-- Operational Tab -->
          <div class="tab-pane fade" id="operational" role="tabpanel">
             <div class="mb-3">
                 <label class="form-label fw-bold">Restrições Alimentares</label>
                 <div class="d-flex gap-3 flex-wrap">
                     <div class="form-check">
                         <input class="form-check-input" type="checkbox" id="dietGluten">
                         <label class="form-check-label" for="dietGluten">Sem Glúten</label>
                     </div>
                     <div class="form-check">
                         <input class="form-check-input" type="checkbox" id="dietLactose">
                         <label class="form-check-label" for="dietLactose">Sem Lactose</label>
                     </div>
                     <div class="form-check">
                         <input class="form-check-input" type="checkbox" id="dietVegan">
                         <label class="form-check-label" for="dietVegan">Vegano</label>
                     </div>
                     <div class="form-check">
                         <input class="form-check-input" type="checkbox" id="dietVegetarian">
                         <label class="form-check-label" for="dietVegetarian">Vegetariano</label>
                     </div>
                 </div>
             </div>
             <div class="mb-3">
                 <label class="form-label">Outras Alergias / Observações</label>
                 <textarea class="form-control" id="opAllergies" rows="2"></textarea>
             </div>
             <div class="row mb-3">
                 <div class="col-md-6">
                     <label class="form-label">Horário Café (Início)</label>
                     <input type="time" class="form-control" id="opBreakfastStart">
                 </div>
                 <div class="col-md-6">
                     <label class="form-label">Horário Café (Fim)</label>
                     <input type="time" class="form-control" id="opBreakfastEnd">
                 </div>
             </div>
             <div class="mb-3">
                 <label class="form-label">Datas Comemorativas</label>
                 <input type="text" class="form-control" id="opCommemorative" placeholder="Ex: Aniversário em 25/10">
             </div>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        <button type="button" class="btn btn-primary" onclick="saveGuestData()">Salvar Alterações</button>
        <button type="button" class="btn btn-success" onclick="generatePreCheckinLink()">Gerar Pré-Check-in</button>
      </div>
    </div>
  </div>
</div>

<script>
    function generatePreCheckinLink() {
        var resId = document.getElementById('guestResId').value;
        var guestName = document.getElementById('modalGuestName').textContent;
        var guestPhone = document.getElementById('guestPhone').value;
        
        if (!confirm(`Gerar link de pré-check-in para ${guestName}?`)) return;

        var sendWa = false;
        if (guestPhone) {
            sendWa = confirm(`Deseja enviar o link via WhatsApp para ${guestPhone}?`);
        } else {
            alert("Telefone não cadastrado. O link será gerado mas não enviado.");
        }
        
        var btn = document.querySelector('button[onclick="generatePreCheckinLink()"]');
        var originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = "Gerando...";
        
        fetch('/api/reception/generate_pre_checkin', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                reservation_id: resId,
                guest_name: guestName,
                send_whatsapp: sendWa
            })
        })
        .then(res => res.json())
        .then(data => {
            btn.disabled = false;
            btn.textContent = originalText;
            
            if(data.success) {
                var msg = `Link gerado com sucesso!\n\n${data.link}`;
                if (data.whatsapp_result) {
                    if (data.whatsapp_result.error) {
                        msg += `\n\nErro no envio do WhatsApp: ${data.whatsapp_result.error}`;
                    } else {
                        msg += `\n\nWhatsApp enviado com sucesso!`;
                    }
                }
                alert(msg);
                
                // Copy to clipboard
                navigator.clipboard.writeText(data.link).then(() => {
                    // alert("Link copiado para a área de transferência!");
                }, () => {});
                
            } else {
                alert(`Erro ao gerar link: ${data.error}`);
            }
        })
        .catch(err => {
            console.error(err);
            alert("Erro de comunicação.");
            btn.disabled = false;
            btn.textContent = originalText;
        });
    }
</script>
{% endblock %}