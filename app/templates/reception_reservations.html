{% extends "base.html" %}

{% block title %}Mapa de Reservas - Recepção{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center gap-3">
            <h2><i class="bi bi-calendar-week-fill"></i> Mapa de Reservas</h2>
            
            <form action="{{ url_for('reception.reception_reservations') }}" method="get" class="d-flex align-items-center gap-2">
                <input type="date" name="start_date" class="form-control" value="{{ start_date.strftime('%Y-%m-%d') }}" onchange="this.form.submit()">
                <a href="{{ url_for('reception.reception_reservations') }}" class="btn btn-outline-primary" title="Ir para Hoje">
                    Hoje
                </a>
            </form>
        </div>
        <div>
            <a href="{{ url_for('reception.reception_dashboard') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    <!-- Gantt Chart Card -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-grid-3x3"></i> Ocupação dos Quartos</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-sm mb-0" style="font-size: 0.75rem; table-layout: fixed; width: 100%;">
                    <colgroup>
                        <col style="width: 100px;">
                        {% for d in days %}
                        <col>
                        <col>
                        {% endfor %}
                    </colgroup>
                    <thead class="table-light text-center sticky-top">
                        <tr>
                            <th style="width: 100px;" class="bg-light sticky-start">Quarto</th>
                            {% for d in days %}
                            <th colspan="2" style="font-size: 0.6rem; padding: 1px;" class="{{ 'bg-warning text-dark' if d.is_weekend else '' }} text-center align-middle">
                                <div class="d-flex flex-column align-items-center" style="line-height: 1;">
                                    <span class="fw-bold">{{ d.day }}</span>
                                    <span style="font-size: 0.5rem; text-transform: uppercase;">{{ d.weekday }}</span>
                                </div>
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for group in grouped_rooms %}
                        <!-- Category Header -->
                        {% set cat_class = '' %}
                        {% if 'Areia' in group.category %} {% set cat_class = 'cat-areia' %}
                        {% elif 'Mar Família' in group.category %} {% set cat_class = 'cat-mar-familia' %}
                        {% elif 'Mar' in group.category %} {% set cat_class = 'cat-mar' %}
                        {% elif 'Banheira' in group.category %} {% set cat_class = 'cat-alma-banheira' %}
                        {% elif 'Alma' in group.category %} {% set cat_class = 'cat-alma' %}
                        {% elif 'Diamante' in group.category %} {% set cat_class = 'cat-master' %}
                        {% endif %}
                        
                        <tr class="{{ cat_class }}">
                            <td colspan="{{ (days|length * 2) + 1 }}" class="fw-bold px-1 py-0 text-uppercase small text-muted" style="font-size: 0.7rem; background: inherit;">
                                {{ group.category }}
                            </td>
                        </tr>
                        
                        {% for room in group.rooms %}
                        <tr>
                            <td class="fw-bold text-center bg-light sticky-start p-0 align-middle" style="height: 24px; line-height: 24px; font-size: 0.75rem;">{{ room }}</td>
                            {% for segment in segments.get(room, []) %}
                                {% set start_slot = segment.data.start_day %}
                                {% set end_slot = start_slot + segment.length - 1 %}
                                {% set is_midnight = (end_slot % 2 != 0) %}
                                {% set border_class = 'border-midnight' if is_midnight else 'border-noon' %}

                                {% if segment.type == 'empty' %}
                                    <td colspan="{{ segment.length }}" class="p-0 droppable-cell {{ border_class }}"
                                        data-room="{{ room }}"
                                        data-day-start="{{ segment.data.start_day }}"
                                        data-length="{{ segment.length }}"
                                        ondrop="drop(event)" 
                                        ondragover="allowDrop(event)">
                                        <div style="height: 24px; width: 100%;"></div>
                                    </td>
                                {% else %}
                                    {% set cell = segment.data %}
                                    {% set bg_class = 'bg-primary' if segment.type == 'occupied' else 'bg-warning' %}
                                    {% set text_class = 'text-white' if segment.type == 'occupied' else 'text-dark' %}
                                    {% set is_draggable = segment.type == 'reserved' %}
                                    
                                    <td colspan="{{ segment.length }}" class="{{ bg_class }} {{ text_class }} text-center p-0 position-relative {{ border_class }}" 
                                        style="cursor: pointer;"
                                        title="{{ cell.guest }} ({{ cell.checkin }} - {{ cell.checkout }})"
                                        draggable="{{ 'true' if is_draggable else 'false' }}"
                                        ondragstart="drag(event)"
                                        data-res-id="{{ cell.id }}"
                                        data-room="{{ room }}"
                                        data-guest="{{ cell.guest }}"
                                        data-days="{{ segment.length }}"
                                        data-start-day="{{ segment.data.start_day }}"
                                        onclick="openReservationModal('{{ cell.guest }}', '{{ cell.checkin }}', '{{ cell.checkout }}', '{{ cell.category }}', '{{ cell.payment_status }}', '{{ cell.channel }}', '{{ cell.amount }}', '{{ cell.paid_amount }}', '{{ cell.to_receive }}', '{{ cell.id }}', '{{ segment.type }}')">
                                        
                                        <!-- Handles -->
                                        {% if is_draggable %}
                                        <div class="resize-handle resize-start" onmousedown="startResize(event, 'start', '{{ cell.id }}', Number('{{ segment.data.start_day }}'), Number('{{ segment.length }}'), '{{ room }}')"></div>
                                        <div class="resize-handle resize-end" onmousedown="startResize(event, 'end', '{{ cell.id }}', Number('{{ segment.data.start_day }}'), Number('{{ segment.length }}'), '{{ room }}')"></div>
                                        {% endif %}
                                        
                                        <div class="d-flex align-items-center justify-content-between px-1 res-bar-content">
                                            <!-- Channel Icon (Left) -->
                                            <div class="me-1 small">
                                                {% set channel = (cell.channel or '')|lower %}
                                                {% if 'booking' in channel %}
                                                    <i class="bi bi-calendar-check" title="Booking.com"></i>
                                                {% elif 'airbnb' in channel %}
                                                    <i class="bi bi-house-door" title="Airbnb"></i>
                                                {% elif 'expedia' in channel %}
                                                    <i class="bi bi-airplane" title="Expedia"></i>
                                                {% elif 'direto' in channel or 'balcão' in channel %}
                                                    <i class="bi bi-person-badge" title="Direto"></i>
                                                {% elif 'whatsapp' in channel %}
                                                    <i class="bi bi-whatsapp" title="WhatsApp"></i>
                                                {% else %}
                                                    <i class="bi bi-globe" title="Outros"></i>
                                                {% endif %}
                                            </div>

                                            <!-- Guest Name (Center/Truncated) -->
                                            <span class="fw-bold text-truncate flex-grow-1 text-start" style="font-size: 0.75rem;">{{ cell.guest }}</span>

                                            <!-- Status Icon (Right) -->
                                            <div class="ms-1 small">
                                                {% if cell.payment_status == 'Pago' %}
                                                    <i class="bi bi-check-circle-fill text-light" title="Pago"></i>
                                                {% elif cell.payment_status == 'Parcial' %}
                                                    <i class="bi bi-pie-chart-fill text-warning" title="Parcial" style="filter: brightness(0.8);"></i>
                                                {% else %}
                                                    <i class="bi bi-exclamation-circle-fill text-danger" title="Pendente"></i>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                {% endif %}
                            {% endfor %}
                        </tr>
                        {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
    .cat-areia { background-color: #fcf8e3; border-left: 4px solid #f0ad4e; }
    .cat-mar-familia { background-color: #d9edf7; border-left: 4px solid #5bc0de; }
    .cat-mar { background-color: #e8f4fd; border-left: 4px solid #007bff; }
    .cat-alma-banheira { background-color: #f2dede; border-left: 4px solid #d9534f; }
    .cat-alma { background-color: #f9f2f4; border-left: 4px solid #c7254e; }
    .cat-master { background-color: #e6e6e6; border-left: 4px solid #333; }

    .border-midnight {
        border-right: 2px solid #aaa !important;
    }
    .border-noon {
        border-right: 1px dashed #ddd !important;
    }
    
    .droppable-cell.drag-over {
        background-color: #e2e6ea !important;
        outline: 2px dashed #007bff;
    }
    
    .resize-handle {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 10px;
        cursor: col-resize;
        z-index: 5;
        opacity: 0;
        transition: opacity 0.2s;
        background-color: rgba(0,0,0,0.2);
    }
    
    td:hover .resize-handle {
        opacity: 1;
    }
    
    .resize-start { left: 0; }
    .resize-end { right: 0; }
    
    .res-bar-content {
        height: 24px; 
        width: 100%; 
        font-size: 0.75rem; 
        line-height: 24px; 
        overflow: hidden; 
        white-space: nowrap; 
        text-overflow: ellipsis;
    }
</style>

<script id="grid-data" type="application/json">{{ grid|tojson }}</script>
<script>
    var currentYear = Number("{{ year }}");
    var currentMonth = Number("{{ month }}");
    var startDateStr = "{{ start_date.strftime('%Y-%m-%d') }}";
    var gridStartDate = new Date(startDateStr + "T00:00:00");
    var gridData = JSON.parse(document.getElementById('grid-data').textContent);
    var draggedData = null;
    
    // Move Logic
    function drag(ev) {
        ev.dataTransfer.setData("resId", ev.target.dataset.resId);
        ev.dataTransfer.setData("guest", ev.target.dataset.guest);
        ev.dataTransfer.setData("days", ev.target.dataset.days);
        ev.dataTransfer.setData("startDay", ev.target.dataset.startDay);
        
        // Fallback for some browsers
        draggedData = {
            resId: ev.target.dataset.resId,
            guest: ev.target.dataset.guest,
            days: parseInt(ev.target.dataset.days),
            startDay: parseInt(ev.target.dataset.startDay)
        };
    }

    function allowDrop(ev) {
        ev.preventDefault();
        ev.target.closest('td').classList.add('drag-over');
    }
    
    // Add dragleave to remove highlight
    document.addEventListener('dragleave', function(ev) {
        if (ev.target.classList.contains('droppable-cell')) {
            ev.target.classList.remove('drag-over');
        }
    });

    function drop(ev) {
        ev.preventDefault();
        
        // Find the TD element
        var target = ev.target;
        while (target.tagName !== 'TD' && target) {
            target = target.parentNode;
        }
        
        if (!target) return;
        target.classList.remove('drag-over');
        
        var resId = ev.dataTransfer.getData("resId");
        var guest = ev.dataTransfer.getData("guest");
        var daysRequired = parseInt(ev.dataTransfer.getData("days"));
        var originalStartDay = parseInt(ev.dataTransfer.getData("startDay"));
        
        if (!resId && draggedData) {
            resId = draggedData.resId;
            guest = draggedData.guest;
            daysRequired = draggedData.days;
            originalStartDay = draggedData.startDay;
        }

        var room = target.dataset.room;
        
        // Calculate Target Start Slot
        var segmentStart = parseInt(target.dataset.dayStart);
        var segmentLength = parseInt(target.dataset.length);
        var rect = target.getBoundingClientRect();
        var clickX = ev.clientX - rect.left;
        var cellWidth = rect.width / segmentLength;
        var slotOffset = Math.floor(clickX / cellWidth);
        var targetSlot = segmentStart + slotOffset;
        
        // SNAP TO PM (Middle of Day)
        // Check-in should always be PM (Odd).
        var targetDayIndex = Math.floor(targetSlot / 2);
        var newStartSlot = (targetDayIndex * 2) + 1;
        
        // For now, we only support changing ROOM, preserving original dates.
        // So we use originalStartDay for collision check in the NEW room.
        newStartSlot = originalStartDay;
        
        if (checkCollision(room, newStartSlot, daysRequired, resId)) {
             alert("Não é possível mover para este quarto: Conflito de datas.");
             return;
        }

        window.pendingMove = {
            reservation_id: resId,
            new_room: room
        };
        
        // Prepare Modal
        document.getElementById('moveGuest').textContent = guest;
        document.getElementById('moveRoom').textContent = room + " (Mantendo datas originais)";
        
        // Show Modal
        var moveModal = new bootstrap.Modal(document.getElementById('moveModal'));
        moveModal.show();
    }
    
    // Check Collisions
    function checkCollision(room, startDay, duration, currentResId) {
        if (!gridData[room]) return false;
        
        for (var i = 0; i < duration; i++) {
            var day = startDay + i;
            var cell = gridData[room][String(day)] || gridData[room][day];
            
            if (cell) {
                if (cell.status === 'occupied') return true;
                if (cell.status === 'reserved') {
                    if (cell.id && String(cell.id) !== String(currentResId)) {
                        return true;
                    }
                }
            }
        }
        return false;
    }

    // Modal UI Logic
    function togglePriceInput(show) {
        var container = document.getElementById('newPriceContainer');
        if (show) {
            container.classList.remove('d-none');
        } else {
            container.classList.add('d-none');
            document.getElementById('newPrice').value = '';
        }
    }

    function confirmMove() {
        if (!window.pendingMove) return;
        
        var data = window.pendingMove;
        var priceAdjType = document.querySelector('input[name="priceAdj"]:checked').value;
        
        var payload = {
            reservation_id: data.reservation_id,
            new_room: data.new_room
        };
        
        if (priceAdjType === 'yes') {
            var amount = document.getElementById('newPrice').value;
            if (!amount) {
                alert("Por favor, informe o novo valor.");
                return;
            }
            payload.price_adjustment = {
                type: 'manual',
                amount: amount
            };
        }
        
        var btn = document.querySelector('#moveModal .btn-primary');
        btn.disabled = true;
        btn.textContent = "Salvando...";
        
        fetch('/api/reception/move_reservation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                location.reload();
            } else {
                alert("Erro ao mover reserva: " + result.error);
                btn.disabled = false;
                btn.textContent = "Confirmar Mudança";
            }
        })
        .catch(err => {
            console.error(err);
            alert("Erro de comunicação com o servidor.");
            btn.disabled = false;
            btn.textContent = "Confirmar Mudança";
        });
    }

    // Resize Logic
    var resizing = false;
    var resizeData = {};

    function startResize(ev, direction, resId, startSlot, length, room) {
        ev.stopPropagation();
        ev.preventDefault(); // Prevent dragstart
        
        resizing = true;
        var td = ev.target.parentNode;
        
        resizeData = {
            resId: resId,
            direction: direction,
            startSlot: startSlot,
            length: length,
            room: room,
            startX: ev.clientX,
            originalWidth: td.getBoundingClientRect().width,
            cellWidth: td.getBoundingClientRect().width / length,
            td: td
        };
        
        document.addEventListener('mousemove', resizeMove);
        document.addEventListener('mouseup', resizeUp);
    }

    function resizeMove(ev) {
        if (!resizing) return;
        
        var deltaX = ev.clientX - resizeData.startX;
        var deltaSlots = Math.round(deltaX / resizeData.cellWidth);
        
        // Enforce 2-slot increments (Full Days) to keep PM-in/AM-out alignment
        deltaSlots = Math.round(deltaSlots / 2) * 2;
        
        var newLength = resizeData.length;
        var newStartSlot = resizeData.startSlot;
        
        if (resizeData.direction === 'end') {
            newLength = resizeData.length + deltaSlots;
        } else {
            newLength = resizeData.length - deltaSlots;
            newStartSlot = resizeData.startSlot + deltaSlots;
        }
        
        // Validation
        if (newLength < 2) return; // Min 1 night (2 slots)
        if (newStartSlot < 0) return; // Cannot start before month begin
        
        // Visual Preview (Simple width adjustment)
        resizeData.td.style.opacity = 0.7;
        document.body.style.cursor = 'col-resize';
    }

    function resizeUp(ev) {
        if (!resizing) return;
        resizing = false;
        document.removeEventListener('mousemove', resizeMove);
        document.removeEventListener('mouseup', resizeUp);
        document.body.style.cursor = 'default';
        resizeData.td.style.opacity = 1;
        
        var deltaX = ev.clientX - resizeData.startX;
        var deltaSlots = Math.round(deltaX / resizeData.cellWidth);
        
        // Snap to Full Days (2 slots)
        var deltaDays = Math.round(deltaSlots / 2);
        deltaSlots = deltaDays * 2;
        
        if (deltaSlots === 0) return;
        
        var newStartSlot = resizeData.startSlot;
        var newLength = resizeData.length;
        
        if (resizeData.direction === 'end') {
            newLength = resizeData.length + deltaSlots;
        } else {
            newStartSlot = resizeData.startSlot + deltaSlots;
            newLength = resizeData.length - deltaSlots;
        }
        
        if (newLength < 2) {
            alert("A estadia mínima é de 1 diária.");
            return;
        }

        if (newStartSlot < 0) {
            alert("Não é possível mover para antes do início do mês.");
            return;
        }
        
        // Check Collision for new period
        if (checkCollision(resizeData.room, newStartSlot, newLength, resizeData.resId)) {
            alert("Conflito de datas com outra reserva ou ocupação.");
            return;
        }
        
        // Calculate Dates
        // Slot 0 = Day 1 AM.
        // Slot 1 = Day 1 PM (Check-in).
        // Check-in Date:
        // If newStartSlot is odd (e.g. 1), day is floor(1/2)+1 = 1.
        // If newStartSlot is even (e.g. 0), day is floor(0/2)+1 = 1.
        // But system expects Check-in at PM.
        // If we snap to 2 slots, startSlot should preserve parity (Odd).
        
        var startDayIndex = Math.floor(newStartSlot / 2); // 0-based day index relative to grid start
        
        var checkinDate = new Date(gridStartDate);
        checkinDate.setDate(gridStartDate.getDate() + startDayIndex);
        
        var checkoutDate = new Date(gridStartDate);
        var endDayIndex = Math.floor((newStartSlot + newLength) / 2);
        checkoutDate.setDate(gridStartDate.getDate() + endDayIndex);
        
        var fmt = (d) => d.getDate().toString().padStart(2, '0') + '/' + (d.getMonth()+1).toString().padStart(2, '0') + '/' + d.getFullYear();
        
        window.pendingResize = {
            reservation_id: resizeData.resId,
            checkin: fmt(checkinDate),
            checkout: fmt(checkoutDate),
            room_number: resizeData.room
        };
        
        // Show Modal
        var guestName = resizeData.td.querySelector('.fw-bold').textContent;
        document.getElementById('resizeGuest').textContent = guestName;
        document.getElementById('resizeDates').textContent = fmt(checkinDate) + ' - ' + fmt(checkoutDate);
        
        var modal = new bootstrap.Modal(document.getElementById('resizeModal'));
        modal.show();
    }
    
    function confirmResize() {
        if (!window.pendingResize) return;
        
        var data = window.pendingResize;
        var priceAdj = document.getElementById('resizePriceAdj').value;
        
        var payload = {
            reservation_id: data.reservation_id,
            checkin: data.checkin,
            checkout: data.checkout,
            room_number: data.room_number
        };
        
        if (priceAdj) {
            payload.price_adjustment = {
                type: 'manual',
                amount: priceAdj
            };
        }
        
        fetch('/api/reception/resize_reservation', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert("Erro ao alterar reserva: " + data.message);
            }
        })
        .catch(err => alert("Erro de comunicação."));
    }
    
    // Toggle fiscal fields based on borrower type
    function toggleFiscalFields() {
        var type = document.getElementById('fiscalBorrowerType').value;
        var countryField = document.getElementById('fiscalCountry');
        
        if (type === 'foreigner') {
            countryField.disabled = false;
        } else {
            countryField.disabled = true;
            countryField.value = '';
        }
    }

    // Guest Details & Upload (Existing functions)
    function openReservationModal(guest, checkin, checkout, category, status, channel, amount, paid, to_receive, id, type) {
        // Default to Guest Tab (Cadastro) as requested
        var guestTabEl = document.querySelector('#resTab button[data-bs-target="#guest"]');
        if(guestTabEl) {
            var guestTab = new bootstrap.Tab(guestTabEl);
            guestTab.show();
        }
        
        document.getElementById('modalGuestName').textContent = guest;
        document.getElementById('modalDates').textContent = checkin + ' até ' + checkout;
        document.getElementById('modalCategory').textContent = category;
        document.getElementById('modalChannel').textContent = channel || 'Direto';
        document.getElementById('modalStatus').textContent = status || 'N/A';
        document.getElementById('modalAmount').textContent = amount ? 'R$ ' + amount : '-';
        document.getElementById('modalPaid').textContent = paid ? 'R$ ' + paid : '-';
        document.getElementById('modalToReceive').textContent = to_receive ? 'R$ ' + to_receive : '-';
        
        var guestIdField = document.getElementById('guestResId');
        if(guestIdField) guestIdField.value = id;
        
        const statusBadge = document.getElementById('modalStatusBadge');
        statusBadge.textContent = status || 'N/A';
        statusBadge.className = 'badge ' + (status === 'Pago' ? 'bg-success' : 'bg-warning text-dark');
        
        if(document.getElementById('guestPhone')) {
            // Reset fields
            document.getElementById('guestPhone').value = '';
            document.getElementById('guestEmail').value = '';
            document.getElementById('guestDob').value = '';
            document.getElementById('guestDocId').value = '';
            document.getElementById('guestAddress').value = '';
            
            // Reset Fiscal
            document.getElementById('fiscalBorrowerType').value = 'cpf';
            document.getElementById('fiscalDocNumber').value = '';
            document.getElementById('fiscalAddressFull').value = '';
            document.getElementById('fiscalMunicipality').value = 'Tamandaré';
            document.getElementById('fiscalCountry').value = '';
            toggleFiscalFields();
            
            // Reset Operational
            document.getElementById('dietGluten').checked = false;
            document.getElementById('dietLactose').checked = false;
            document.getElementById('dietVegan').checked = false;
            document.getElementById('dietVegetarian').checked = false;
            document.getElementById('opAllergies').value = '';
            document.getElementById('opBreakfastStart').value = '';
            document.getElementById('opBreakfastEnd').value = '';
            document.getElementById('opCommemorative').value = '';

            document.getElementById('docPreview').innerHTML = '';
            document.getElementById('modalAvgDaily').textContent = 'Carregando...';
            
            fetch('/api/guest/details/' + id)
                .then(res => res.json())
                .then(data => {
                    if(data.success) {
                        if(data.data.reservation && data.data.reservation.avg_daily_paid) {
                            document.getElementById('modalAvgDaily').textContent = 'R$ ' + data.data.reservation.avg_daily_paid.toFixed(2);
                        } else {
                            document.getElementById('modalAvgDaily').textContent = 'R$ 0.00';
                        }
                        
                        var guestData = data.data.guest;
                        if(guestData) {
                            // Personal Info
                            if (guestData.personal_info) {
                                var info = guestData.personal_info;
                                document.getElementById('guestPhone').value = info.phone || '';
                                document.getElementById('guestEmail').value = info.email || '';
                                document.getElementById('guestDob').value = info.dob || '';
                                document.getElementById('guestDocId').value = info.doc_id || '';
                                document.getElementById('guestAddress').value = info.address || '';
                                
                                if(info.document_photo_path) {
                                    document.getElementById('docPreview').innerHTML = 
                                        '<div class="alert alert-success py-1"><i class="bi bi-check-circle"></i> Documento enviado</div>';
                                }
                            }
                            
                            // Fiscal Info
                            if (guestData.fiscal_info) {
                                var fiscal = guestData.fiscal_info;
                                document.getElementById('fiscalBorrowerType').value = fiscal.borrower_type || 'cpf';
                                document.getElementById('fiscalDocNumber').value = fiscal.cpf || fiscal.cnpj || fiscal.foreigner_passport || '';
                                document.getElementById('fiscalAddressFull').value = fiscal.address || '';
                                document.getElementById('fiscalMunicipality').value = fiscal.municipality || 'Tamandaré';
                                document.getElementById('fiscalCountry').value = fiscal.foreigner_country || '';
                                toggleFiscalFields();
                            }
                            
                            // Operational Info
                            if (guestData.operational_info) {
                                var op = guestData.operational_info;
                                var restrictions = op.dietary_restrictions || [];
                                document.getElementById('dietGluten').checked = restrictions.includes('gluten_free');
                                document.getElementById('dietLactose').checked = restrictions.includes('lactose_free');
                                document.getElementById('dietVegan').checked = restrictions.includes('vegan');
                                document.getElementById('dietVegetarian').checked = restrictions.includes('vegetarian');
                                
                                document.getElementById('opAllergies').value = op.allergies || '';
                                document.getElementById('opBreakfastStart').value = op.breakfast_time_start || '';
                                document.getElementById('opBreakfastEnd').value = op.breakfast_time_end || '';
                                
                                var comm = op.commemorative_dates || [];
                                document.getElementById('opCommemorative').value = comm.join(', ');
                            }
                        }
                    }
                })
                .catch(err => console.error(err));
        }

        var myModal = new bootstrap.Modal(document.getElementById('reservationModal'));
        myModal.show();
    }

    function saveGuestData() {
        var resId = document.getElementById('guestResId').value;
        
        // Personal Info
        var personalInfo = {
            phone: document.getElementById('guestPhone').value,
            email: document.getElementById('guestEmail').value,
            dob: document.getElementById('guestDob').value,
            doc_id: document.getElementById('guestDocId').value,
            address: document.getElementById('guestAddress').value
        };
        
        // Fiscal Info
        var borrowerType = document.getElementById('fiscalBorrowerType').value;
        var docNumber = document.getElementById('fiscalDocNumber').value;
        var fiscalInfo = {
            borrower_type: borrowerType,
            address: document.getElementById('fiscalAddressFull').value,
            municipality: document.getElementById('fiscalMunicipality').value,
            foreigner_country: document.getElementById('fiscalCountry').value
        };
        
        // Map document number to correct field
        if (borrowerType === 'cpf') fiscalInfo.cpf = docNumber;
        else if (borrowerType === 'cnpj') fiscalInfo.cnpj = docNumber;
        else if (borrowerType === 'foreigner') fiscalInfo.foreigner_passport = docNumber;
        
        // Operational Info
        var restrictions = [];
        if(document.getElementById('dietGluten').checked) restrictions.push('gluten_free');
        if(document.getElementById('dietLactose').checked) restrictions.push('lactose_free');
        if(document.getElementById('dietVegan').checked) restrictions.push('vegan');
        if(document.getElementById('dietVegetarian').checked) restrictions.push('vegetarian');
        
        var commDates = document.getElementById('opCommemorative').value
            .split(',')
            .map(s => s.trim())
            .filter(s => s.length > 0);
            
        var operationalInfo = {
            dietary_restrictions: restrictions,
            allergies: document.getElementById('opAllergies').value,
            breakfast_time_start: document.getElementById('opBreakfastStart').value,
            breakfast_time_end: document.getElementById('opBreakfastEnd').value,
            commemorative_dates: commDates
        };
        
        var payload = {
            reservation_id: resId,
            personal_info: personalInfo,
            fiscal_info: fiscalInfo,
            operational_info: operationalInfo
        };
        
        fetch('/api/guest/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                alert('Dados salvos com sucesso!');
            } else {
                alert('Erro ao salvar: ' + data.error);
            }
        });
    }
    
    function uploadGuestDoc() {
        var resId = document.getElementById('guestResId').value;
        var fileInput = document.getElementById('guestDocFile');
        
        if(fileInput.files.length === 0) {
            alert("Selecione um arquivo.");
            return;
        }
        
        var formData = new FormData();
        formData.append('reservation_id', resId);
        formData.append('document_photo', fileInput.files[0]);
        
        fetch('/api/guest/upload_document', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                alert('Documento enviado com sucesso!');
                document.getElementById('docPreview').innerHTML = 
                    '<div class="alert alert-success py-1"><i class="bi bi-check-circle"></i> Documento enviado</div>';
                fileInput.value = '';
            } else {
                alert('Erro ao enviar: ' + data.error);
            }
        });
    }
</script>

<!-- Move Confirmation Modal -->
<div class="modal fade" id="moveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Mover Reserva</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Mover reserva de <strong><span id="moveGuest"></span></strong> para o quarto <strong><span id="moveRoom"></span></strong>?</p>
                
                <hr>
                <div class="mb-3">
                    <label class="form-label">Haverá ajuste no valor da diária?</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="priceAdj" id="priceAdjNo" value="no" checked onclick="togglePriceInput(false)">
                        <label class="form-check-label" for="priceAdjNo">
                            Manter valor original
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="priceAdj" id="priceAdjYes" value="yes" onclick="togglePriceInput(true)">
                        <label class="form-check-label" for="priceAdjYes">
                            Sim, ajustar valor
                        </label>
                    </div>
                </div>
                
                <div class="mb-3 d-none" id="newPriceContainer">
                    <label for="newPrice" class="form-label">Novo Valor Total (R$)</label>
                    <input type="number" class="form-control" id="newPrice" step="0.01">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmMove()">Confirmar Mudança</button>
            </div>
        </div>
    </div>
</div>

<!-- Resize Confirmation Modal -->
<div class="modal fade" id="resizeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Alterar Período da Reserva</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Alterar reserva de <strong><span id="resizeGuest"></span></strong>?</p>
                <p>Novo período: <strong><span id="resizeDates"></span></strong></p>
                
                <hr>
                <div class="mb-3">
                    <label for="resizePriceAdj" class="form-label">Ajuste de Valor (Opcional)</label>
                    <input type="text" class="form-control" id="resizePriceAdj" placeholder="Ex: +100.00 ou -50.00 ou 1200.00">
                    <div class="form-text">Deixe em branco para manter o valor original.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmResize()">Confirmar Alteração</button>
            </div>
        </div>
    </div>
</div>

<!-- Reservation Details Modal -->
<div class="modal fade" id="reservationModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title" id="modalGuestName">Guest Name</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        
        <ul class="nav nav-tabs mb-3" id="resTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">Reserva</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="guest-tab" data-bs-toggle="tab" data-bs-target="#guest" type="button" role="tab">Dados Pessoais</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="fiscal-tab" data-bs-toggle="tab" data-bs-target="#fiscal" type="button" role="tab">Fiscal</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="operational-tab" data-bs-toggle="tab" data-bs-target="#operational" type="button" role="tab">Operacional</button>
          </li>
        </ul>
        
        <div class="tab-content" id="resTabContent">
          <!-- Reservation Info Tab -->
          <div class="tab-pane fade show active" id="info" role="tabpanel">
            <div class="row mb-3">
                <div class="col-6">
                    <small class="text-muted d-block">Check-in / Check-out</small>
                    <strong id="modalDates"></strong>
                </div>
                <div class="col-6">
                    <small class="text-muted d-block">Categoria</small>
                    <strong id="modalCategory"></strong>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-6">
                    <small class="text-muted d-block">Canal de Reserva (Origem)</small>
                    <strong id="modalChannel"></strong>
                </div>
                <div class="col-6">
                    <small class="text-muted d-block">Status Pagamento</small>
                    <span id="modalStatusBadge" class="badge bg-secondary"></span>
                </div>
            </div>
            <div class="row bg-light p-2 rounded mb-3">
                <div class="col-4">
                    <small class="text-muted d-block">Valor Total</small>
                    <strong id="modalAmount" class="text-dark"></strong>
                </div>
                <div class="col-4">
                    <small class="text-muted d-block">Valor Pago</small>
                    <strong id="modalPaid" class="text-success"></strong>
                </div>
                <div class="col-4">
                    <small class="text-muted d-block">A Receber</small>
                    <strong id="modalToReceive" class="text-danger"></strong>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-12">
                     <small class="text-muted d-block">Valor Médio da Diária (Paga)</small>
                     <strong id="modalAvgDaily" class="text-primary fs-5">R$ 0.00</strong>
                </div>
            </div>
            
            <div class="mt-4 d-grid gap-2">
                <a href="{{ url_for('reception.reception_reservations_cashier') }}" class="btn btn-outline-primary">
                    <i class="bi bi-wallet2"></i> Ir para Caixa de Reservas
                </a>
            </div>
          </div>
          
          <!-- Guest Details Tab -->
          <div class="tab-pane fade" id="guest" role="tabpanel">
             <form id="guestForm">
                 <input type="hidden" id="guestResId">
                 <div class="row mb-3">
                     <div class="col-md-6">
                         <label class="form-label">Telefone de Contato</label>
                         <input type="text" class="form-control" id="guestPhone">
                     </div>
                     <div class="col-md-6">
                         <label class="form-label">Email</label>
                         <input type="email" class="form-control" id="guestEmail">
                     </div>
                 </div>
                 <div class="row mb-3">
                     <div class="col-md-6">
                         <label class="form-label">Data de Nascimento</label>
                         <input type="date" class="form-control" id="guestDob">
                     </div>
                     <div class="col-md-6">
                         <label class="form-label">RG / Documento Civil</label>
                         <input type="text" class="form-control" id="guestDocId">
                     </div>
                 </div>
                 <div class="mb-3">
                     <label class="form-label">Endereço Completo</label>
                     <textarea class="form-control" id="guestAddress" rows="2"></textarea>
                 </div>
                 
                 <div class="mb-3">
                     <label class="form-label">Documento (Foto)</label>
                     <div class="input-group">
                         <input type="file" class="form-control" id="guestDocFile" accept="image/*">
                         <button class="btn btn-outline-secondary" type="button" onclick="uploadGuestDoc()">Upload</button>
                     </div>
                     <small class="text-muted">Formatos: JPG, PNG. Máx 5MB.</small>
                     <div id="docPreview" class="mt-2"></div>
                 </div>
             </form>
          </div>

          <!-- Fiscal Tab -->
          <div class="tab-pane fade" id="fiscal" role="tabpanel">
             <div class="row mb-3">
                 <div class="col-md-4">
                     <label class="form-label">Tipo Tomador</label>
                     <select class="form-select" id="fiscalBorrowerType" onchange="toggleFiscalFields()">
                         <option value="cpf">Pessoa Física (CPF)</option>
                         <option value="cnpj">Pessoa Jurídica (CNPJ)</option>
                         <option value="foreigner">Estrangeiro</option>
                     </select>
                 </div>
                 <div class="col-md-8">
                     <label class="form-label">Documento Fiscal (CPF/CNPJ)</label>
                     <input type="text" class="form-control" id="fiscalDocNumber">
                 </div>
             </div>
             <div class="mb-3">
                 <label class="form-label">Endereço Fiscal (Logradouro, Nº, Bairro)</label>
                 <input type="text" class="form-control" id="fiscalAddressFull">
             </div>
             <div class="row mb-3">
                 <div class="col-md-6">
                     <label class="form-label">Município</label>
                     <input type="text" class="form-control" id="fiscalMunicipality" value="Tamandaré">
                 </div>
                 <div class="col-md-6">
                     <label class="form-label">País (Estrangeiro)</label>
                     <input type="text" class="form-control" id="fiscalCountry" disabled>
                 </div>
             </div>
          </div>

          <!-- Operational Tab -->
          <div class="tab-pane fade" id="operational" role="tabpanel">
             <div class="mb-3">
                 <label class="form-label fw-bold">Restrições Alimentares</label>
                 <div class="d-flex gap-3 flex-wrap">
                     <div class="form-check">
                         <input class="form-check-input" type="checkbox" id="dietGluten">
                         <label class="form-check-label" for="dietGluten">Sem Glúten</label>
                     </div>
                     <div class="form-check">
                         <input class="form-check-input" type="checkbox" id="dietLactose">
                         <label class="form-check-label" for="dietLactose">Sem Lactose</label>
                     </div>
                     <div class="form-check">
                         <input class="form-check-input" type="checkbox" id="dietVegan">
                         <label class="form-check-label" for="dietVegan">Vegano</label>
                     </div>
                     <div class="form-check">
                         <input class="form-check-input" type="checkbox" id="dietVegetarian">
                         <label class="form-check-label" for="dietVegetarian">Vegetariano</label>
                     </div>
                 </div>
             </div>
             <div class="mb-3">
                 <label class="form-label">Outras Alergias / Observações</label>
                 <textarea class="form-control" id="opAllergies" rows="2"></textarea>
             </div>
             <div class="row mb-3">
                 <div class="col-md-6">
                     <label class="form-label">Horário Café (Início)</label>
                     <input type="time" class="form-control" id="opBreakfastStart">
                 </div>
                 <div class="col-md-6">
                     <label class="form-label">Horário Café (Fim)</label>
                     <input type="time" class="form-control" id="opBreakfastEnd">
                 </div>
             </div>
             <div class="mb-3">
                 <label class="form-label">Datas Comemorativas</label>
                 <input type="text" class="form-control" id="opCommemorative" placeholder="Ex: Aniversário em 25/10">
             </div>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        <button type="button" class="btn btn-primary" onclick="saveGuestData()">Salvar Alterações</button>
        <button type="button" class="btn btn-success" onclick="generatePreCheckinLink()">Gerar Pré-Check-in</button>
      </div>
    </div>
  </div>
</div>

<script>
    function generatePreCheckinLink() {
        var resId = document.getElementById('guestResId').value;
        var guestName = document.getElementById('modalGuestName').textContent;
        var guestPhone = document.getElementById('guestPhone').value;
        
        if (!confirm(`Gerar link de pré-check-in para ${guestName}?`)) return;

        var sendWa = false;
        if (guestPhone) {
            sendWa = confirm(`Deseja enviar o link via WhatsApp para ${guestPhone}?`);
        } else {
            alert("Telefone não cadastrado. O link será gerado mas não enviado.");
        }
        
        var btn = document.querySelector('button[onclick="generatePreCheckinLink()"]');
        var originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = "Gerando...";
        
        fetch('/api/reception/generate_pre_checkin', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                reservation_id: resId,
                guest_name: guestName,
                send_whatsapp: sendWa
            })
        })
        .then(res => res.json())
        .then(data => {
            btn.disabled = false;
            btn.textContent = originalText;
            
            if(data.success) {
                var msg = `Link gerado com sucesso!\n\n${data.link}`;
                if (data.whatsapp_result) {
                    if (data.whatsapp_result.error) {
                        msg += `\n\nErro no envio do WhatsApp: ${data.whatsapp_result.error}`;
                    } else {
                        msg += `\n\nWhatsApp enviado com sucesso!`;
                    }
                }
                alert(msg);
                
                // Copy to clipboard
                navigator.clipboard.writeText(data.link).then(() => {
                    // alert("Link copiado para a área de transferência!");
                }, () => {});
                
            } else {
                alert(`Erro ao gerar link: ${data.error}`);
            }
        })
        .catch(err => {
            console.error(err);
            alert("Erro de comunicação.");
            btn.disabled = false;
            btn.textContent = originalText;
        });
    }
</script>
{% endblock %}