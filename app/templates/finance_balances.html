{% extends "base.html" %}

{% block content %}
<style>
    @media print {
        .hide-print {
            display: none !important;
        }
        .card {
            border: none !important;
            box-shadow: none !important;
        }
        .modal {
            position: static;
            display: block; /* Show modal content if open? No, better to hide modal overlay issues */
        }
        /* Improve table readability in print */
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        .table th, .table td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        /* Ensure background colors are printed */
        body {
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
    }
</style>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4 hide-print">
        <h2><i class="bi bi-clipboard-data"></i> Gestão Financeira</h2>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" onclick="window.print()">
                <i class="bi bi-printer"></i> Imprimir / PDF
            </button>
            <button class="btn btn-success" onclick="exportBalanceData()">
                <i class="bi bi-file-earmark-excel"></i> Exportar Excel
            </button>
        </div>
    </div>

    <ul class="nav nav-tabs mb-4 hide-print" id="financeTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="balances-tab" data-bs-toggle="tab" data-bs-target="#balances" type="button" role="tab">Balanços de Caixa</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="closed-accounts-tab" data-bs-toggle="tab" data-bs-target="#closed-accounts" type="button" role="tab" onclick="loadClosedAccounts()">Contas Fechadas (Histórico)</button>
        </li>
    </ul>

    <div class="tab-content" id="financeTabsContent">
        <!-- BALANCES TAB -->
        <div class="tab-pane fade show active" id="balances" role="tabpanel">
            <!-- Filters Card -->
            <div class="card mb-4 hide-print">
                <div class="card-body">
                    <form id="balanceFilterForm" class="row g-3 align-items-end">
                        <div class="col-md-2">
                            <label for="period_type" class="form-label">Período</label>
                            <select class="form-select" id="period_type" name="period_type">
                                <option value="monthly">Mensal</option>
                                <option value="quarterly">Trimestral</option>
                                <option value="semiannual">Semestral</option>
                                <option value="annual">Anual</option>
                            </select>
                        </div>
                        
                        <div class="col-md-2" id="year_container">
                            <label for="year" class="form-label">Ano</label>
                            <select class="form-select" id="year" name="year">
                                <!-- Populated by JS -->
                            </select>
                        </div>

                        <div class="col-md-2" id="specific_period_container">
                            <label for="specific_value" class="form-label" id="specific_label">Mês</label>
                            <select class="form-select" id="specific_value" name="specific_value">
                                <!-- Populated by JS -->
                            </select>
                        </div>

                        <div class="col-md-2">
                            <label for="user_filter" class="form-label">Usuário</label>
                            <select class="form-select" id="user_filter" name="user_filter">
                                <option value="">Todos</option>
                                {% for u in users %}
                                <option value="{{ u.username }}">{{ u.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-2">
                            <label for="payment_method_filter" class="form-label">Pagamento</label>
                            <select class="form-select" id="payment_method_filter" name="payment_method_filter">
                                <option value="">Todas</option>
                                {% for pm in payment_methods %}
                                <option value="{{ pm.name }}">{{ pm.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-2">
                            <button type="button" class="btn btn-primary w-100" onclick="loadBalanceData()">
                                <i class="bi bi-search"></i> Filtrar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="text-center d-none my-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-2">Processando dados...</p>
            </div>

            <!-- Results Area -->
            <div id="resultsArea" class="d-none">
                <div class="row" id="cardsContainer"></div>
                
                <div class="card mt-4">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Detalhamento Consolidado</h5>
                        <!-- <button class="btn btn-sm btn-outline-primary" onclick="toggleAllDetails()">Expandir/Recolher Tudo</button> -->
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered" id="detailsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Caixa / Usuário</th>
                                        <th class="text-end">Saldo Inicial</th>
                                        <th class="text-end text-success">Entradas</th>
                                        <th class="text-end text-danger">Saídas</th>
                                        <th class="text-end fw-bold">Saldo Final</th>
                                        <th class="text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Table rows injected here -->
                                </tbody>
                                <tfoot class="table-light fw-bold">
                                    <tr id="tableTotalRow">
                                        <td>TOTAL</td>
                                        <td class="text-end" id="totalInitial">0.00</td>
                                        <td class="text-end text-success" id="totalIn">0.00</td>
                                        <td class="text-end text-danger" id="totalOut">0.00</td>
                                        <td class="text-end" id="totalFinal">0.00</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="anomalyAlert" class="alert alert-warning d-none mt-4">
                <i class="bi bi-exclamation-triangle-fill"></i> Foram identificadas possíveis divergências entre saldos e movimentos em alguns caixas. Reveja os valores destacados para auditoria.
            </div>

            <!-- No Data Message -->
            <div id="noDataMessage" class="alert alert-info d-none mt-4">
                <i class="bi bi-info-circle"></i> Nenhum dado encontrado para o período selecionado.
            </div>
        </div>

        <!-- CLOSED ACCOUNTS TAB -->
        <div class="tab-pane fade" id="closed-accounts" role="tabpanel">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Histórico de Contas Fechadas</h5>
                    <button class="btn btn-sm btn-primary" onclick="loadClosedAccounts()">
                        <i class="bi bi-arrow-clockwise"></i> Atualizar
                    </button>
                </div>
                <div class="card-body">
                    <!-- Tabs for Cashier Filtering -->
                    <ul class="nav nav-pills mb-3" id="closedAccountsPills">
                        <li class="nav-item">
                            <button class="nav-link active" id="pill-all-tab" onclick="filterClosedAccounts('')">Todos</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="pill-reception-tab" onclick="filterClosedAccounts('reception_room')">Recepção</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="pill-restaurant-tab" onclick="filterClosedAccounts('restaurant_table')">Restaurante</button>
                        </li>
                    </ul>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="closedAccountsTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Data Fechamento</th>
                                    <th>Origem / ID Original</th>
                                    <th>Valor Total</th>
                                    <th>Fechado Por</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="closedAccountsBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination Controls -->
                    <div id="closedAccountsPagination" class="d-flex justify-content-center mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailsModalLabel">Detalhamento de Sessões</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Abertura</th>
                                    <th>Fechamento</th>
                                    <th>Usuário</th>
                                    <th class="text-end">Saldo Inicial</th>
                                    <th class="text-end">Saldo Final</th>
                                </tr>
                            </thead>
                            <tbody id="detailsModalBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reopen Modal -->
    <div class="modal fade" id="reopenModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">Reabrir Conta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill"></i> Atenção: A reabertura de conta irá reverter as operações financeiras e restaurar o pedido/mesa. Esta ação será registrada.
                    </div>
                    <form id="reopenForm">
                        <input type="hidden" id="reopenClosedId">
                        <div class="mb-3">
                            <label for="reopenReason" class="form-label fw-bold">Motivo da Reabertura (Obrigatório)</label>
                            <textarea class="form-control" id="reopenReason" rows="3" required placeholder="Descreva o motivo..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning fw-bold" onclick="confirmReopen()">Confirmar Reabertura</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth() + 1;
    const isAdminUser = "{{ session.get('role', '') }}" === "admin";
    let currentData = [];
    let currentFilters = {
        period_type: 'monthly',
        year: String(currentYear),
        specific_value: String(currentMonth)
    };

    // Initialize Filters
    function initFilters() {
        // Populate Years (Current - 5 to Current + 1)
        const yearSelect = document.getElementById('year');
        for (let y = currentYear + 1; y >= currentYear - 5; y--) {
            let option = new Option(y, y);
            if (y === currentYear) option.selected = true;
            yearSelect.add(option);
        }

        updateSpecificSelectors();
        
        document.getElementById('period_type').addEventListener('change', updateSpecificSelectors);
        
        // Initial Load
        loadBalanceData();
    }

    function updateSpecificSelectors() {
        const type = document.getElementById('period_type').value;
        const container = document.getElementById('specific_period_container');
        const label = document.getElementById('specific_label');
        const select = document.getElementById('specific_value');
        
        select.innerHTML = '';
        container.classList.remove('d-none');

        if (type === 'monthly') {
            label.textContent = 'Mês';
            const months = [
                'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            months.forEach((m, i) => {
                let option = new Option(m, i + 1);
                if (i + 1 === currentMonth) option.selected = true;
                select.add(option);
            });
        } else if (type === 'quarterly') {
            label.textContent = 'Trimestre';
            select.add(new Option('1º Trimestre (Jan-Mar)', '1'));
            select.add(new Option('2º Trimestre (Abr-Jun)', '2'));
            select.add(new Option('3º Trimestre (Jul-Set)', '3'));
            select.add(new Option('4º Trimestre (Out-Dez)', '4'));
        } else if (type === 'semiannual') {
            label.textContent = 'Semestre';
            select.add(new Option('1º Semestre (Jan-Jun)', '1'));
            select.add(new Option('2º Semestre (Jul-Dez)', '2'));
        } else if (type === 'annual') {
            container.classList.add('d-none');
            select.innerHTML = '<option value="0" selected>Anual</option>'; // Dummy value
        }
    }

    function formatCurrency(value) {
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
    }

    async function loadBalanceData() {
        const formData = new FormData(document.getElementById('balanceFilterForm'));
        const params = new URLSearchParams(formData);
        currentFilters = {
            period_type: formData.get('period_type') || 'monthly',
            year: formData.get('year') || String(currentYear),
            specific_value: formData.get('specific_value') || String(currentMonth)
        };
        
        document.getElementById('loadingIndicator').classList.remove('d-none');
        document.getElementById('resultsArea').classList.add('d-none');
        document.getElementById('noDataMessage').classList.add('d-none');

        try {
            const response = await fetch(`{{ url_for('finance.finance_balances_data') }}?${params.toString()}`);
            const data = await response.json();

            if (data.success) {
                if (data.data.length > 0) {
                    currentData = data.data; // Store for details
                    renderResults(data.data);
                    document.getElementById('resultsArea').classList.remove('d-none');
                } else {
                    document.getElementById('noDataMessage').classList.remove('d-none');
                }
            } else {
                alert('Erro ao carregar dados: ' + data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Erro ao comunicar com o servidor.');
        } finally {
            document.getElementById('loadingIndicator').classList.add('d-none');
        }
    }

    function renderResults(items) {
        const cardsContainer = document.getElementById('cardsContainer');
        const tableBody = document.querySelector('#detailsTable tbody');
        
        cardsContainer.innerHTML = '';
        tableBody.innerHTML = '';

        let totalInitial = 0;
        let totalIn = 0;
        let totalOut = 0;
        let totalFinal = 0;
    
        items.forEach((item, index) => {
            totalInitial += item.initial_balance;
            totalIn += item.total_in;
            totalOut += item.total_out;
            totalFinal += item.final_balance;

            const cardCol = document.createElement('div');
            const hasContinuity = !!item.has_continuity_issue;
            const cardBorderClass = (item.has_anomaly || hasContinuity) ? 'border-warning border-2' : 'border-0';
            const anomalyBadge = item.has_anomaly
                ? '<span class="badge bg-warning text-dark ms-2">Divergência pendente</span>'
                : (item.has_approved_divergence
                    ? '<span class="badge bg-secondary text-light ms-2">Divergência aprovada</span>'
                    : '');
            const continuityBadge = hasContinuity
                ? '<span class="badge bg-info text-dark ms-2">Alerta de continuidade</span>'
                : '';
            const finalClass = item.final_balance >= 0 ? 'text-success' : 'text-danger';
            const adminNotice = item.has_anomaly && isAdminUser
                ? '<small class="text-warning d-block mt-2">Diferença pendente de aprovação.</small>'
                : '';
            const approveButton = item.has_anomaly && isAdminUser && item.type_key ? `
                <button class="btn btn-sm btn-warning mt-2 w-100" onclick="approveDivergences('${item.type_key}')">
                    <i class="bi bi-check-circle"></i> Aprovar divergências
                </button>
            ` : '';
            cardCol.className = 'col-md-4 mb-4';
            cardCol.innerHTML = `
                <div class="card h-100 shadow-sm ${cardBorderClass}">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
                                <i class="bi bi-wallet2 text-primary fs-4"></i>
                            </div>
                            <div>
                                <h6 class="card-subtitle text-muted text-uppercase small">${item.type_label}${anomalyBadge}${continuityBadge}</h6>
                                <h5 class="card-title mb-0">${item.user}</h5>
                            </div>
                        </div>
                        <div class="row g-2">
                            <div class="col-6">
                                <small class="text-muted d-block">Saldo Inicial</small>
                                <span class="fw-bold">${formatCurrency(item.initial_balance)}</span>
                            </div>
                            <div class="col-6 text-end">
                                <small class="text-muted d-block">Saldo Final</small>
                                <span class="fw-bold ${finalClass}">${formatCurrency(item.final_balance)}</span>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Entradas</small>
                                <span class="text-success small"><i class="bi bi-arrow-up"></i> ${formatCurrency(item.total_in)}</span>
                            </div>
                            <div class="col-6 text-end">
                                <small class="text-muted d-block">Saídas</small>
                                <span class="text-danger small"><i class="bi bi-arrow-down"></i> ${formatCurrency(item.total_out)}</span>
                            </div>
                        </div>
                        ${adminNotice}
                        <div class="mt-3 text-center">
                            <button class="btn btn-sm btn-outline-primary w-100 mb-1" onclick="openDetailsModal(${index})">
                                <i class="bi bi-eye"></i> Ver Detalhes
                            </button>
                            ${approveButton}
                        </div>
                    </div>
                </div>
            `;
            cardsContainer.appendChild(cardCol);

            // Create Table Row
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <div class="fw-bold">${item.user}</div>
                    <small class="text-muted">${item.type_label}</small>
                </td>
                <td class="text-end">${formatCurrency(item.initial_balance)}</td>
                <td class="text-end text-success">${formatCurrency(item.total_in)}</td>
                <td class="text-end text-danger">${formatCurrency(item.total_out)}</td>
                <td class="text-end fw-bold">${formatCurrency(item.final_balance)}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-light border" onclick="openDetailsModal(${index})">
                        <i class="bi bi-list"></i>
                    </button>
                </td>
            `;
            tableBody.appendChild(row);
        });

        // Update Footer Totals
        document.getElementById('totalInitial').textContent = formatCurrency(totalInitial);
        document.getElementById('totalIn').textContent = formatCurrency(totalIn);
        document.getElementById('totalOut').textContent = formatCurrency(totalOut);
        document.getElementById('totalFinal').textContent = formatCurrency(totalFinal);
    }
    
    function openDetailsModal(index) {
        const item = currentData[index];
        if (!item) return;
        
        document.getElementById('detailsModalLabel').textContent = `Detalhamento: ${item.user}`;
        const tbody = document.getElementById('detailsModalBody');
        tbody.innerHTML = '';
        
        if (item.sessions && item.sessions.length > 0) {
            item.sessions.forEach((s, sIdx) => {
                const tr = document.createElement('tr');
                const transCount = s.transactions_count !== undefined ? s.transactions_count : (s.transactions ? s.transactions.length : 0);
                const hasTrans = transCount > 0;
                const collapseId = `session-trans-${index}-${sIdx}`;
                const hasDiff = Math.abs(s.difference || 0) > 0.01;
                const approved = !!s.difference_approved;
                const continuityIssue = !!s.continuity_issue;
                const diffClass = hasDiff ? (approved ? 'text-secondary' : 'text-danger') : 'text-muted';
                const diffText = hasDiff ? `Dif: ${formatCurrency(s.difference)}` : '';
                const continuityText = continuityIssue ? 'Abertura diferente do fechamento anterior' : '';
                const statusBadge = hasDiff ? (approved
                    ? '<span class="badge bg-secondary text-light">Divergência aprovada</span>'
                    : '<span class="badge bg-warning text-dark">Divergência pendente</span>') : '';
                const approveBtn = isAdminUser && hasDiff && !approved ? `
                    <button class="btn btn-sm btn-outline-warning ms-2" onclick="approveSessionDivergence('${s.id}')">
                        <i class="bi bi-check-circle"></i>
                    </button>
                ` : '';
                let closingSummary = '';
                const cashVal = s.closing_cash !== undefined && s.closing_cash !== null ? s.closing_cash : null;
                const nonCashVal = s.closing_non_cash !== undefined && s.closing_non_cash !== null ? s.closing_non_cash : null;
                if (cashVal !== null || nonCashVal !== null) {
                    const cashNum = cashVal !== null ? cashVal : 0;
                    const nonCashNum = nonCashVal !== null ? nonCashVal : 0;
                    closingSummary = `<div class="small text-muted">Dinheiro: ${formatCurrency(cashNum)} | Outras: ${formatCurrency(nonCashNum)}</div>`;
                }
                
                tr.innerHTML = `
                    <td>
                        ${hasTrans ? `<button class="btn btn-sm btn-link p-0 text-decoration-none me-1" type="button" 
                            onclick="toggleSessionDetails('${s.id}', '${collapseId}')"
                            aria-expanded="false" aria-controls="${collapseId}">
                            <i class="bi bi-caret-down-fill" id="icon-${collapseId}"></i>
                        </button>` : ''}
                        ${s.opened_at || '-'}
                    </td>
                    <td>${s.closed_at || '-'}</td>
                    <td>${s.user || '-'}</td>
                    <td class="text-end">${formatCurrency(s.opening_balance || 0)}</td>
                    <td class="text-end fw-bold">
                        ${formatCurrency(s.closing_balance || 0)}
                        ${closingSummary}
                        ${diffText ? `<div class="small ${diffClass}">${diffText}</div>` : ''}
                        ${continuityText ? `<div class="small text-danger">${continuityText}</div>` : ''}
                        ${statusBadge ? `<div class="mt-1 d-flex justify-content-end align-items-center gap-1">${statusBadge}${approveBtn}</div>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);

                if (hasTrans) {
                    const trTrans = document.createElement('tr');
                    trTrans.innerHTML = `
                        <td colspan="5" class="p-0 border-0">
                            <div class="collapse" id="${collapseId}">
                                <div class="card card-body bg-light border-0 rounded-0 p-2" id="content-${collapseId}">
                                    <div class="text-center py-2 text-muted">
                                        <div class="spinner-border spinner-border-sm me-2"></div> Carregando transações...
                                    </div>
                                </div>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(trTrans);
                }
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhuma sessão encontrada para este período.</td></tr>';
        }
        
        new bootstrap.Modal(document.getElementById('detailsModal')).show();
    }

    async function toggleSessionDetails(sessionId, collapseId) {
        const collapseEl = document.getElementById(collapseId);
        const contentEl = document.getElementById(`content-${collapseId}`);
        const iconEl = document.getElementById(`icon-${collapseId}`);
        const bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseEl, { toggle: false });

        if (collapseEl.classList.contains('show')) {
            bsCollapse.hide();
            if(iconEl) iconEl.classList.replace('bi-caret-up-fill', 'bi-caret-down-fill');
        } else {
            bsCollapse.show();
            if(iconEl) iconEl.classList.replace('bi-caret-down-fill', 'bi-caret-up-fill');
            
            // Fetch if not loaded (check for specific attribute or class)
            if (!contentEl.dataset.loaded) {
                try {
                    const response = await fetch(`/api/finance/session/${sessionId}`);
                    if (!response.ok) throw new Error('Falha na comunicação');
                    
                    const result = await response.json();
                    
                    if (result.success && result.data && result.data.transactions) {
                        renderSessionTransactions(contentEl, result.data.transactions);
                        contentEl.dataset.loaded = "true";
                    } else {
                        contentEl.innerHTML = '<div class="alert alert-warning m-2 small">Nenhuma transação encontrada.</div>';
                    }
                } catch (e) {
                    contentEl.innerHTML = `<div class="alert alert-danger m-2 small">Erro ao carregar: ${e.message}</div>`;
                }
            }
        }
    }

    function renderSessionTransactions(container, transactions) {
        if (!transactions || transactions.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-2 small">Sem transações registradas.</div>';
            return;
        }

        let totalCash = 0;
        let totalAll = 0;

        const rows = transactions.map(t => {
            const isOut = ['withdrawal', 'out'].includes(t.type);
            const colorClass = isOut ? 'text-danger' : 'text-success';
            const sign = isOut ? '-' : '+';
            const amount = parseFloat(t.amount || 0);

            const method = (t.payment_method || '').toString().toLowerCase();
            const tType = (t.type || '').toString().toLowerCase();
            let isCash = false;
            if (method.includes('dinheiro') || method.includes('espécie') || method.includes('especie')) {
                isCash = true;
            } else if (['supply', 'suprimento', 'bleeding', 'sangria'].includes(tType)) {
                isCash = true;
            } else if (method.includes('transfer') || method.includes('transferência') || method.includes('transferencia')) {
                isCash = true;
            }
            
            if (isOut) {
                totalAll -= amount;
                if (isCash) totalCash -= amount;
            } else {
                totalAll += amount;
                if (isCash) totalCash += amount;
            }

            const timeStr = t.timestamp && t.timestamp.includes(' ') ? t.timestamp.split(' ')[1] : t.timestamp;
            
            return `
                <tr>
                    <td class="small text-nowrap">${timeStr || '-'}</td>
                    <td class="small text-truncate" style="max-width: 250px;" title="${t.description}">${t.description || '-'}</td>
                    <td class="small">${t.payment_method || '-'}</td>
                    <td class="small text-end ${colorClass}">${sign} ${formatCurrency(amount)}</td>
                </tr>
            `;
        }).join('');

        container.innerHTML = `
            <h6 class="small fw-bold text-muted mb-2 ps-2">Transações da Sessão</h6>
            <div class="table-responsive bg-white border rounded">
                <table class="table table-sm table-hover mb-0">
                    <thead class="table-light">
                        <tr class="small text-muted">
                            <th>Hora</th>
                            <th>Descrição</th>
                            <th>Pagamento</th>
                            <th class="text-end">Valor</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                    <tfoot class="table-light">
                        <tr class="fw-bold small">
                            <td colspan="3" class="text-end">Total em dinheiro:</td>
                            <td class="text-end ${totalCash >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(totalCash)}</td>
                        </tr>
                        <tr class="fw-bold small">
                            <td colspan="3" class="text-end">Total geral (todas as formas):</td>
                            <td class="text-end ${totalAll >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(totalAll)}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        `;
    }

    async function approveDivergences(typeKey) {
        if (!isAdminUser) {
            alert('Apenas administradores podem aprovar divergências.');
            return;
        }
        if (!confirm('Confirmar aprovação das divergências deste caixa para o período selecionado?')) {
            return;
        }
        try {
            const response = await fetch('/api/finance/balances/approve_divergences', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    type_key: typeKey,
                    period_type: currentFilters.period_type,
                    year: currentFilters.year,
                    specific_value: currentFilters.specific_value
                })
            });
            const result = await response.json();
            if (!response.ok || !result.success) {
                alert('Erro ao aprovar divergências: ' + (result.message || 'Falha na operação.'));
                return;
            }
            alert('Divergências aprovadas com sucesso.');
            loadBalanceData();
        } catch (e) {
            alert('Erro de comunicação: ' + e.message);
        }
    }

    async function approveSessionDivergence(sessionId) {
        if (!isAdminUser) {
            alert('Apenas administradores podem aprovar divergências.');
            return;
        }
        if (!confirm('Confirmar aprovação desta divergência de sessão?')) {
            return;
        }
        try {
            const response = await fetch(`/api/finance/session/${sessionId}/approve_divergence`, {
                method: 'POST'
            });
            const result = await response.json();
            if (!response.ok || !result.success) {
                alert('Erro ao aprovar divergência da sessão: ' + (result.message || 'Falha na operação.'));
                return;
            }
            alert('Divergência da sessão aprovada com sucesso.');
            loadBalanceData();
        } catch (e) {
            alert('Erro de comunicação: ' + e.message);
        }
    }


    function exportBalanceData() {
        const formData = new FormData(document.getElementById('balanceFilterForm'));
        const params = new URLSearchParams(formData);
        window.location.href = `{{ url_for('finance.finance_balances_export') }}?${params.toString()}`;
    }

    let currentClosedAccountsOrigin = '';
    let currentClosedAccountsPage = 1;

    function filterClosedAccounts(origin) {
        currentClosedAccountsOrigin = origin;
        currentClosedAccountsPage = 1;
        
        // Update active pill UI
        document.querySelectorAll('#closedAccountsPills .nav-link').forEach(btn => {
            btn.classList.remove('active');
        });
        
        let activeId = 'pill-all-tab';
        if (origin === 'reception_room') activeId = 'pill-reception-tab';
        else if (origin === 'restaurant_table') activeId = 'pill-restaurant-tab';
        
        const activeEl = document.getElementById(activeId);
        if(activeEl) activeEl.classList.add('active');

        loadClosedAccounts(1);
    }

    async function loadClosedAccounts(page = 1) {
        currentClosedAccountsPage = page;
        const tbody = document.getElementById('closedAccountsBody');
        const paginationContainer = document.getElementById('closedAccountsPagination');
        
        tbody.innerHTML = '<tr><td colspan="7" class="text-center"><div class="spinner-border text-primary spinner-border-sm"></div> Carregando...</td></tr>';
        if(paginationContainer) paginationContainer.innerHTML = '';
        
        let url = `/api/closed_accounts?page=${page}&per_page=20`;
        if (currentClosedAccountsOrigin) {
            url += `&origin=${currentClosedAccountsOrigin}`;
        }

        try {
            const response = await fetch(url);
            if (!response.ok) {
                // If 403, might be session expired or unauthorized
                if (response.status === 403) throw new Error("Acesso não autorizado.");
                throw new Error(`Erro ${response.status}`);
            }
            
            const result = await response.json();
            
            // Normalize data (support both list and dict response)
            let data = [];
            let pagination = null;
            
            if (Array.isArray(result)) {
                data = result;
            } else {
                data = result.items || [];
                pagination = {
                    page: result.page,
                    pages: result.pages,
                    total: result.total
                };
            }
            
            tbody.innerHTML = '';
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhuma conta fechada encontrada.</td></tr>';
                return;
            }
            
            data.forEach(acc => {
                const tr = document.createElement('tr');
                const originLabel = acc.origin === 'restaurant_table' ? 'Mesa' : (acc.origin === 'reception_room' ? 'Quarto' : acc.origin);
                
                tr.innerHTML = `
                    <td><small title="${acc.id}">${acc.id.substring(0, 15)}...</small></td>
                    <td>${acc.closed_at}</td>
                    <td>${originLabel} ${acc.original_id}</td>
                    <td class="fw-bold">${formatCurrency(acc.total)}</td>
                    <td>${acc.closed_by}</td>
                    <td><span class="badge bg-secondary">${acc.status === 'reopened' ? 'Reaberta' : 'Fechada'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="openReopenModal('${acc.id}')">
                            <i class="bi bi-arrow-counterclockwise"></i> Reabrir
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // Render Pagination
            if (pagination && pagination.pages > 1) {
                renderPagination(pagination);
            }
            
        } catch (e) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Erro: ${e.message}</td></tr>`;
        }
    }
    
    function renderPagination(pg) {
        const container = document.getElementById('closedAccountsPagination');
        if (!container) return;
        
        let html = '<nav><ul class="pagination">';
        
        // Prev
        html += `<li class="page-item ${pg.page <= 1 ? 'disabled' : ''}">
                    <button class="page-link" onclick="loadClosedAccounts(${pg.page - 1})">Anterior</button>
                 </li>`;
                 
        // Info
        html += `<li class="page-item disabled"><span class="page-link">Página ${pg.page} de ${pg.pages}</span></li>`;
        
        // Next
        html += `<li class="page-item ${pg.page >= pg.pages ? 'disabled' : ''}">
                    <button class="page-link" onclick="loadClosedAccounts(${pg.page + 1})">Próxima</button>
                 </li>`;
                 
        html += '</ul></nav>';
        container.innerHTML = html;
    }

    function openReopenModal(id) {
        document.getElementById('reopenClosedId').value = id;
        document.getElementById('reopenReason').value = '';
        new bootstrap.Modal(document.getElementById('reopenModal')).show();
    }

    async function confirmReopen() {
        const id = document.getElementById('reopenClosedId').value;
        const reason = document.getElementById('reopenReason').value;
        
        if (!reason.trim()) {
            alert('Por favor, informe o motivo.');
            return;
        }
        
        try {
            const response = await fetch('/admin/reopen_account', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id, reason })
            });
            
            const res = await response.json();
            
            if (res.success) {
                alert('Conta reaberta com sucesso!');
                bootstrap.Modal.getInstance(document.getElementById('reopenModal')).hide();
                loadClosedAccounts(); // Refresh list
            } else {
                alert('Erro: ' + res.error);
            }
        } catch (e) {
            alert('Erro de comunicação: ' + e.message);
        }
    }

    document.addEventListener('DOMContentLoaded', initFilters);
</script>
{% endblock %}
