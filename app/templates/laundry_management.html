{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
        <h1 class="h2 mb-0">Contador de Etiquetas (RFID)</h1>
        <div class="d-flex gap-2 flex-wrap">
             <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left"></i> Voltar</a>
             <button id="fullSetBtn" class="btn btn-outline-primary btn-sm">Enchoval completo</button>
             <button id="laundryStatusBtn" class="btn btn-outline-warning btn-sm">Status Lavanderia</button>
             <button id="headerInvBtn" class="btn btn-outline-primary btn-sm">Conferência</button>
             <button id="manageCategoriesBtn" class="btn btn-outline-secondary btn-sm">Categorias</button>
             <button id="addBrandBtn" class="btn btn-outline-secondary btn-sm">Nova Marca</button>
             <button id="groupRegBtn" class="btn btn-outline-secondary btn-sm">Grupo</button>
             <button id="clientBtn" class="btn btn-primary btn-sm">Cliente: Padrão</button>
        </div>
    </div>

    <div class="row g-4">
        <!-- Left Column: Scanner & Stats -->
        <div class="col-lg-7">
            <!-- Scanner Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <label for="scanInput" class="form-label fw-bold">Scanner RFID</label>
                    <div class="input-group mb-2">
                        <span class="input-group-text"><i class="bi bi-upc-scan"></i></span>
                        <input id="scanInput" type="text" class="form-control form-control-lg" inputmode="text" autocomplete="off" autofocus placeholder="Digite ou escaneie o código (24 chars)">
                    </div>
                    <div class="form-text text-muted mb-3">A maioria dos leitores envia Enter no final.</div>
                    
                    <div class="d-flex gap-3 flex-wrap">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoCapture">
                            <label class="form-check-label" for="autoCapture">Captura auto (24)</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="streamMode" checked>
                            <label class="form-check-label" for="streamMode">Modo contínuo</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Row -->
            <div class="row g-3 mb-4">
                <div class="col-12">
                    <div class="card text-center h-100 shadow-sm border-success bg-light">
                        <div class="card-body py-2">
                            <div class="text-uppercase text-muted small fw-bold">Itens Únicos Escaneados</div>
                            <div id="uniqueCount" class="display-6 fw-bold text-success">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Active Bag -->
        <div class="col-lg-5">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white fw-bold">Sacola Atual</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="bagName" class="form-label">Nome da Sacola</label>
                        <input id="bagName" type="text" class="form-control" placeholder="Nome da sacola">
                        <div class="form-text">Todos os códigos serão atribuídos a esta sacola.</div>
                    </div>

                    <div class="d-grid gap-2 d-md-block">
                        <button id="newBagBtn" class="btn btn-success btn-sm w-100 mb-2">Nova Sacola (Finalizar)</button>
                        <div class="btn-group w-100" role="group">
                            <button id="exportBagExcelBtn" class="btn btn-outline-success btn-sm">Excel</button>
                            <button id="printBagBtn" class="btn btn-outline-dark btn-sm">Imprimir</button>
                            <button id="clearBagBtn" class="btn btn-outline-danger btn-sm">Limpar</button>
                        </div>
                    </div>

                    <div id="bagWarn" class="alert alert-danger mt-3" style="display:none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scanned Items Table -->
    <div class="card shadow-sm mt-4">
        <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
            <span>Itens Escaneados</span>
            <span class="badge bg-secondary">Recentes primeiro</span>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width:50px;">#</th>
                        <th>Tag</th>
                        <th>Nome</th>
                        <th>Marca</th>
                        <th>Categoria</th>
                        <th>Variante</th>
                        <th>Sacola</th>
                        <th>Hora</th>
                        <th style="width:100px;">Ação</th>
                    </tr>
                </thead>
                <tbody id="rows"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- ================= MODALS ================= -->

<!-- Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Registrar Produto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info py-2 small">A Tag deve começar com E e ter 23 caracteres hexadecimais (Total 24).</div>
                
                <div class="mb-3">
                    <label for="pmRfid" class="form-label">Tag</label>
                    <input id="pmRfid" type="text" class="form-control font-monospace" readonly maxlength="24">
                </div>

                <div class="mb-3">
                     <label class="form-label">Categoria</label>
                     <div id="pmCategoryTabs" class="d-flex flex-wrap gap-2"></div>
                     <input type="hidden" id="pmCategory">
                </div>

                <!-- pmName removed/hidden as it was redundant with Category+Variant logic -->
                <div class="mb-3" style="display:none;">
                     <label for="pmName" class="form-label">Item / Nome</label>
                     <select id="pmName" class="form-select"></select>
                </div>
                
                <div id="pmVariantContainer" class="mb-3">
                    <label for="pmVariant" class="form-label">Variante / Subtipo</label>
                    <select id="pmVariant" class="form-select"></select>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="pmBrand" class="form-label">Marca</label>
                        <input id="pmBrand" type="text" class="form-control" list="brandList" placeholder="Marca do item">
                        <datalist id="brandList"></datalist>
                    </div>
                    <div class="col-md-6">
                        <label for="pmAcqDate" class="form-label">Data de Aquisição</label>
                        <input id="pmAcqDate" type="date" class="form-control" placeholder="dd/mm/yyyy">
                    </div>
                    <div class="col-md-6">
                        <label for="pmPrice" class="form-label">Preço de Lavagem (R$)</label>
                        <input id="pmPrice" type="number" class="form-control" min="0" step="0.01" placeholder="0,00">
                    </div>
                    <div class="col-md-6">
                        <label for="pmItemPrice" class="form-label">Preço da Peça (R$)</label>
                        <input id="pmItemPrice" type="number" class="form-control" min="0" step="0.01" placeholder="0,00">
                    </div>
                    <div class="col-md-6">
                        <label for="pmDestination" class="form-label">Destino Lavanderia</label>
                        <select id="pmDestination" class="form-select">
                            <option value="Almareia">Almareia</option>
                            <option value="Terceirizado">Terceirizado</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="pmCancel" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="pmSave">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Group Register Modal -->
<div class="modal fade" id="groupRegisterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cadastro em Grupo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info py-2 small">Selecione o produto e escaneie múltiplas tags para aplicar os mesmos dados.</div>
                
                <div class="row">
                    <!-- Left: Settings -->
                    <div class="col-md-5 border-end">
                        <h6 class="text-primary mb-3">1. Defina o Produto</h6>
                        
                        <div class="mb-3">
                            <label class="form-label">Categoria</label>
                            <div id="grCategoryTabs" class="d-flex flex-wrap gap-2"></div>
                            <input type="hidden" id="grCategory">
                        </div>

                        <div class="mb-3" style="display:none;">
                            <label for="grName" class="form-label">Item / Nome</label>
                            <select id="grName" class="form-select"></select>
                        </div>
                        
                        <div id="grVariantContainer" class="mb-3">
                            <label for="grVariant" class="form-label">Variante</label>
                            <select id="grVariant" class="form-select"></select>
                        </div>

                        <div class="mb-3">
                            <label for="grBrand" class="form-label">Marca</label>
                            <input id="grBrand" type="text" class="form-control" list="brandList" placeholder="Selecione ou digite">
                        </div>

                        <div class="row g-2">
                            <div class="col-6">
                                <label for="grPrice" class="form-label">Preço Lavagem</label>
                                <input id="grPrice" type="number" class="form-control" min="0" step="0.01">
                            </div>
                            <div class="col-6">
                                <label for="grItemPrice" class="form-label">Preço Peça</label>
                                <input id="grItemPrice" type="number" class="form-control" min="0" step="0.01">
                            </div>
                            <div class="col-6">
                                <label for="grAcqDate" class="form-label">Data Aquisição</label>
                                <input id="grAcqDate" type="date" class="form-control" placeholder="dd/mm/yyyy">
                            </div>
                            <div class="col-12 mt-2">
                                <label for="grDestination" class="form-label">Destino</label>
                                <select id="grDestination" class="form-select">
                                    <option value="Almareia">Almareia</option>
                                    <option value="Terceirizado">Terceirizado</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right: Scanning -->
                    <div class="col-md-7 d-flex flex-column">
                        <h6 class="text-primary mb-3">2. Escaneie as Tags (<span id="grCount">0</span>)</h6>
                        <input id="grScanInput" type="text" class="form-control mb-3 border-primary" placeholder="Escaneie aqui...">
                        <div id="grList" class="border rounded bg-light p-2 flex-grow-1" style="height:300px; overflow-y:auto;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="grCancel" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="grSave">Salvar Todos</button>
            </div>
        </div>
    </div>
</div>

<!-- Full Set Modal -->
<div class="modal fade" id="fullSetModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Enchoval Completo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="fsContent" class="border rounded" style="max-height: 500px; overflow:auto;">
                    <table class="table table-sm table-striped mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Categoria</th>
                                <th>Nome</th>
                                <th>Variante</th>
                                <th>Tag</th>
                                <th>Destino</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="fsRows"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Inventory Modal -->
<div class="modal fade" id="inventoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Conferência de Inventário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3 text-center mb-4 bg-light py-3 rounded mx-0">
                    <div class="col-4">
                        <div class="small text-uppercase text-muted">Total Cadastro</div>
                        <div id="invTotalDb" class="h3 fw-bold mb-0">0</div>
                    </div>
                    <div class="col-4 border-start border-end">
                        <div class="small text-uppercase text-muted">Conferidos</div>
                        <div id="invCount" class="h3 fw-bold text-success mb-0">0</div>
                    </div>
                    <div class="col-4">
                        <div class="small text-uppercase text-muted">Faltando</div>
                        <div id="invMissing" class="h3 fw-bold text-danger mb-0">0</div>
                    </div>
                </div>

                <div id="invControls">
                    <button id="invStartBtn" class="btn btn-primary w-100 mb-3">Iniciar Nova Conferência</button>
                    
                    <div id="invActiveArea" style="display:none;">
                        <input id="invInput" type="text" class="form-control form-control-lg mb-2" placeholder="Escanear item...">
                        <div id="invLastMsg" class="fw-bold text-center mb-2" style="min-height:24px;"></div>
                        
                        <div class="border rounded mb-3" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-striped mb-0 small">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>Item</th>
                                        <th>Tag</th>
                                        <th class="text-center">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="invRows"></tbody>
                            </table>
                        </div>

                        <button id="invFinishBtn" class="btn btn-success w-100">Finalizar e Gerar Relatório</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="invClose" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- History Modal REMOVED -->

<!-- Client Modal -->
<div class="modal fade" id="clientModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Selecionar Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small">Cada cliente possui seu próprio banco de dados separado.</p>
                
                <h6>Clientes Existentes:</h6>
                <div id="clientList" class="list-group mb-3" style="max-height: 200px; overflow-y: auto;"></div>

                <hr>
                <h6>Novo Cliente:</h6>
                <div class="d-flex flex-column gap-2">
                    <input id="newClientInput" type="text" class="form-control" placeholder="Nome do cliente">
                    <button id="addNewClientBtn" class="btn btn-primary w-100">Criar e Salvar</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="clientClose" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Verification Modal -->
<div class="modal fade" id="verificationModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Conferência de Sacola</h5>
            </div>
            <div class="modal-body">
                <p class="text-muted small">Escaneie os itens novamente para confirmar o envio.</p>
                
                <div class="text-center my-3">
                    <h1 class="display-4 fw-bold text-primary">
                        <span id="verCount">0</span> / <span id="verTotal">0</span>
                    </h1>
                </div>

                <div class="mb-3">
                    <input id="verInput" type="text" class="form-control form-control-lg border-primary" placeholder="Escaneie para conferir...">
                </div>
                
                <div id="verMsg" class="fw-bold text-center mb-3" style="min-height: 24px;"></div>
                
                <div id="verJustificationArea" class="mb-3" style="display:none;">
                    <label for="verJustification" class="form-label text-danger fw-bold">Justificativa de Divergência</label>
                    <textarea id="verJustification" class="form-control" rows="2" placeholder="Explique a falta ou sobra de itens..."></textarea>
                </div>

                <h6>Itens Pendentes / Extras:</h6>
                <div id="verPendingList" class="border rounded bg-light p-2 small" style="max-height: 150px; overflow-y: auto;"></div>
            </div>
            <div class="modal-footer justify-content-between">
                <button id="verCancel" class="btn btn-secondary">Cancelar</button>
                <button id="verFinish" class="btn btn-success" disabled>Confirmar</button>
            </div>
        </div>
    </div>
</div>

<!-- Manage Categories Modal -->
<div class="modal fade" id="manageCategoriesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gerenciar Categorias</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Main Actions -->
                <div id="catMainActions">
                    <div class="d-flex justify-content-between mb-3">
                        <div class="input-group">
                            <input id="catNewName" type="text" class="form-control" placeholder="Nova categoria...">
                            <button id="catAddBtn" class="btn btn-success">+ Adicionar</button>
                        </div>
                    </div>
                    <div id="catList" class="list-group"></div>
                </div>

                <!-- Edit Area -->
                <div id="catEditArea" style="display:none;">
                    <h6 id="catEditTitle" class="mb-3">Editar Categoria</h6>
                    <input type="hidden" id="catEditOldName">
                    
                    <div class="mb-3">
                        <label class="form-label">Variantes / Subtipos</label>
                        <div class="d-flex gap-2 mb-2">
                            <input id="catNewVariantInput" type="text" class="form-control form-control-sm" placeholder="Nome">
                            <button id="catAddVariantBtn" class="btn btn-outline-primary btn-sm">Add</button>
                        </div>
                        <ul id="catEditVariantsList" class="list-group"></ul>
                    </div>
                    
                    <div class="d-flex justify-content-end gap-2">
                        <button id="catEditCancel" class="btn btn-secondary">Voltar</button>
                        <button id="catEditSave" class="btn btn-primary">Salvar</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Laundry Status Modal -->
<div class="modal fade" id="laundryStatusModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Status da Lavanderia</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Summary Table -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark fw-bold">Itens em Lavagem (Resumo)</div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 300px;">
                            <table class="table table-striped table-bordered mb-0">
                                <thead class="table-light sticky-top">
                                    <tr id="lsSummaryHeader">
                                        <!-- Dynamically populated -->
                                    </tr>
                                </thead>
                                <tbody id="lsSummaryRows"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Active Bags List -->
                <h6 class="fw-bold">Sacolas Enviadas (Pendentes de Retorno)</h6>
                <div class="list-group" id="lsActiveBagsList"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
    // --- Bootstrap Modal Management ---
    const bsModals = {};
    const modalIds = [
        'productModal', 'groupRegisterModal', 'fullSetModal', 
        'inventoryModal', 'clientModal', 
        'verificationModal', 'manageCategoriesModal', 'laundryStatusModal'
    ];

    document.addEventListener('DOMContentLoaded', () => {
        modalIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) bsModals[id] = new bootstrap.Modal(el);
        });
    });

    function showModal(id) { if(bsModals[id]) bsModals[id].show(); }
    function hideModal(id) { if(bsModals[id]) bsModals[id].hide(); }

    // --- State & Constants ---
    const DEFAULT_CATEGORIES = [
        "Lençol Solteiro", "Lençol Casal", "Lençol King", "Fronha", "Capa Edredom",
        "Toalha Banho", "Toalha Rosto", "Piso", "Toalha Piscina",
        "Roupão P", "Roupão M", "Roupão G", "Roupão GG",
        "Tapete", "Cortina", "Travesseiro"
    ];
    const DEFAULT_CATEGORY_OPTIONS = {
        "Lençol Solteiro": ["Lençol Solteiro"],
        "Lençol Casal": ["Lençol Casal"],
        "Lençol King": ["Lençol King"],
        "Fronha": ["Fronha"],
        "Capa Edredom": ["Capa Edredom"],
        "Toalha Banho": ["Toalha Banho"],
        "Toalha Rosto": ["Toalha Rosto"],
        "Piso": ["Piso"],
        "Toalha Piscina": ["Toalha Piscina"],
        "Roupão P": ["Roupão P"],
        "Roupão M": ["Roupão M"],
        "Roupão G": ["Roupão G"],
        "Roupão GG": ["Roupão GG"],
        "Tapete": ["Tapete"],
        "Cortina": ["Cortina"],
        "Travesseiro": ["Travesseiro"]
    };

    const state = {
      scans: [],
      codes: new Set(),
      total: 0,
      unique: 0,
      duplicates: 0,
      uniqueOnly: false,
      autoCapture: false,
      streamMode: true,
      bagName: "Bag 1",
      products: {},
      bagHistory: [],
      brands: [],
      categories: [...DEFAULT_CATEGORIES],
      categoryOptions: JSON.parse(JSON.stringify(DEFAULT_CATEGORY_OPTIONS)),
      inventoryAudit: { active: false, scanned: [] },
      verification: { active: false, items: [], verified: new Set() }
    };

    let currentClient = "default";
    let pendingScanCode = null;

    // --- Core Functions ---
    function normalizeCode(input) {
      return (input || "").toUpperCase().replace(/[^A-Z0-9]+/g, "").trim();
    }

    function persist() {
        try {
            const payload = {
                scans: state.scans,
                bagName: state.bagName,
                products: state.products,
                bagHistory: state.bagHistory,
                brands: state.brands,
                categories: state.categories,
                categoryOptions: state.categoryOptions,
                inventoryAudit: state.inventoryAudit
            };
            localStorage.setItem(`laundry-counter-${currentClient}`, JSON.stringify(payload));

            // Sync with server
            fetch('/api/laundry/data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).catch(e => console.error("Sync error:", e));

        } catch (e) { console.error(e); }
    }

    async function restore() {
       let serverData = null;
       try {
           const res = await fetch('/api/laundry/data');
           if (res.ok) {
               serverData = await res.json();
           }
       } catch (e) {
           console.warn("Could not fetch from server, using local storage", e);
       }

       let payload = serverData;

       if (!payload) {
           let raw = localStorage.getItem(`laundry-counter-${currentClient}`);
           if (!raw && currentClient === "default") raw = localStorage.getItem("laundry-counter");
           if (raw) payload = JSON.parse(raw);
       }

       if (payload) {
           state.scans = payload.scans || [];
           state.bagName = payload.bagName || "Bag 1";
           state.products = payload.products || {};
           state.bagHistory = payload.bagHistory || [];
           state.brands = payload.brands || [];
           state.categories = (payload.categories && payload.categories.length > 0) ? payload.categories : [...DEFAULT_CATEGORIES];
           // MIGRATION: Force new categories if old schema detected
           if (state.categories.includes("Cama") || state.categories.includes("Lençol") || state.categories.includes("Roupao")) {
               console.log("Migrating categories to new flattened schema...");
               state.categories = [...DEFAULT_CATEGORIES];
               state.categoryOptions = JSON.parse(JSON.stringify(DEFAULT_CATEGORY_OPTIONS));
           } else {
               state.categoryOptions = (payload.categoryOptions && Object.keys(payload.categoryOptions).length > 0) ? payload.categoryOptions : JSON.parse(JSON.stringify(DEFAULT_CATEGORY_OPTIONS));
           }
           state.inventoryAudit = payload.inventoryAudit || { active: false, scanned: [] };
           
           // Recalc stats
           const unique = new Set(state.scans.filter(s => s.bag === state.bagName).map(s => s.code));
           state.unique = unique.size;
           state.total = state.scans.filter(s => s.bag === state.bagName).length;
           state.duplicates = state.total - state.unique;
           state.codes = new Set(state.scans.map(s => s.code));
       } else {
            // Initialize defaults
            state.categories = [...DEFAULT_CATEGORIES];
            state.categoryOptions = JSON.parse(JSON.stringify(DEFAULT_CATEGORY_OPTIONS));
       }
       render();
    }

    function render() {
      // Stats
      const currentBagItems = state.scans.filter(s => s.bag === state.bagName);
      const uniqueItems = new Set(currentBagItems.map(s => s.code));
      
      document.getElementById("uniqueCount").textContent = uniqueItems.size;
      
      document.getElementById("bagName").value = state.bagName;
      
      renderRows(currentBagItems);
      document.getElementById("clientBtn").textContent = "Cliente: " + (currentClient === "default" ? "Padrão" : currentClient);
      
      // Ensure brands are updated
      if (typeof renderBrandList === "function") renderBrandList();
    }

    function renderRows(items) {
      const tbody = document.getElementById("rows");
      tbody.innerHTML = "";
      items.slice().reverse().forEach((scan, index) => {
        const p = state.products[scan.code] || {};
        const tr = document.createElement("tr");
        if (scan.type === "duplicate") tr.classList.add("table-warning");
        
        tr.innerHTML = `
            <td>${items.length - index}</td>
            <td class="font-monospace small">${scan.code.substring(0,6)}...${scan.code.slice(-4)}</td>
            <td>${p.name || "-"}</td>
            <td>${p.brand || "-"}</td>
            <td>${p.category || "-"}</td>
            <td>${p.variant || "-"}</td>
            <td>${scan.bag}</td>
            <td>${new Date(scan.timestamp).toLocaleTimeString()}</td>
            <td>
                <div class="table-actions">
                    <button class="btn btn-sm btn-outline-primary py-0" onclick="editProduct('${scan.code}')">Edit</button>
                    <button class="btn btn-sm btn-outline-danger py-0" onclick="removeScanByCode('${scan.code}')">&times;</button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // --- Scanning Logic with Continuous Stream Support ---
    function extractCodes(input) {
        // Regex to find all occurrences of E followed by 23 alphanumeric chars
        const regex = /E[A-Z0-9]{23}/g;
        return input.toUpperCase().match(regex) || [];
    }

    function handleContinuousInput(inputElement, callback) {
        inputElement.addEventListener("input", (e) => {
            const val = e.target.value;
            const codes = extractCodes(val);
            
            if (codes.length > 0) {
                codes.forEach(code => callback(code));
                // Clear input after processing to get ready for next
                // We keep any trailing partial characters if needed, but for now clearing is safer for bulk
                e.target.value = ""; 
            }
        });
        
        // Keep Enter key as fallback/manual trigger
        inputElement.addEventListener("keydown", (e) => {
            if(e.key === "Enter") {
                const val = e.target.value;
                const codes = extractCodes(val);
                if (codes.length > 0) {
                    codes.forEach(code => callback(code));
                    e.target.value = "";
                } else if (val.trim().length > 0) {
                    // Try to process raw if it doesn't match strict regex but might be valid manual entry
                    // or let the validation inside callback handle it
                    callback(normalizeCode(val));
                    e.target.value = "";
                }
            }
        });
    }

    function removeScanByCode(code) {
        if(!confirm("Remover este item da sacola?")) return;
        state.scans = state.scans.filter(s => !(s.code === code && s.bag === state.bagName));
        state.codes = new Set(state.scans.map(s => s.code));
        persist();
        render();
    }

    function addScan(raw) {
        if (!raw) return;
        const code = normalizeCode(raw);
        // Strict validation for automated flows
        if (!code.startsWith("E") || code.length !== 24) return;

        // Inventory Mode Intercept
        if (state.inventoryAudit.active && document.getElementById("inventoryModal").classList.contains("show")) {
            processInventoryScan(code);
            return;
        }

        // Group Registration Mode Intercept
        if (document.getElementById("groupRegisterModal").classList.contains("show")) {
            onGroupScan(code);
            return;
        }

        // Verification Mode Intercept
        if (state.verification.active && document.getElementById("verificationModal").classList.contains("show")) {
            processVerificationScan(code);
            return;
        }

        // Normal Scanning
        // Check if product is registered
        if (!state.products[code]) {
            // If not registered, do NOT add to bag yet.
            // Open registration modal and wait for save.
            pendingScanCode = code;
            
            // Debounce slightly to avoid opening multiple modals if scanning bulk
            if (!document.getElementById("productModal").classList.contains("show")) {
                setTimeout(() => editProduct(code), 200);
            }
            return; 
        }

        // Discard duplicates automatically
        const isDup = state.scans.some(s => s.code === code && s.bag === state.bagName);
        if (isDup) return;

        const scan = {
            code: code,
            timestamp: new Date().toISOString(),
            type: "unique",
            bag: state.bagName
        };

        state.scans.push(scan);
        state.codes.add(code);
        persist();
        render();
    }

    // Attach continuous scanning to main input
    handleContinuousInput(document.getElementById("scanInput"), addScan);

    // --- Product Modal ---
    function renderTabs(containerId, inputId, variantSelectId, selectedVal, selectedVariant) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        
        // Fallback if categories missing
        const cats = (state.categories && state.categories.length) ? state.categories : DEFAULT_CATEGORIES;
        
        cats.forEach(cat => {
            const btn = document.createElement("button");
            const isActive = cat === selectedVal;
            btn.className = `btn btn-sm ${isActive ? 'btn-primary' : 'btn-outline-primary'}`;
            btn.type = "button";
            btn.textContent = cat;
            btn.onclick = () => {
                document.getElementById(inputId).value = cat;
                renderTabs(containerId, inputId, variantSelectId, cat);
                updateVariantOptions(cat, variantSelectId);
            };
            container.appendChild(btn);
        });
        
        if (selectedVal) {
            document.getElementById(inputId).value = selectedVal;
            updateVariantOptions(selectedVal, variantSelectId, selectedVariant);
        } else {
             document.getElementById(inputId).value = "";
             document.getElementById(variantSelectId).innerHTML = '<option value="">Selecione a categoria...</option>';
        }
    }

    function updateVariantOptions(cat, selectId, selectedVariant) {
        const sel = document.getElementById(selectId);
        sel.innerHTML = '<option value="">Selecione...</option>';
        
        // Ensure options exist, fallback to default if needed
        let options = state.categoryOptions[cat];
        if (!options && DEFAULT_CATEGORY_OPTIONS[cat]) {
            options = DEFAULT_CATEGORY_OPTIONS[cat];
            // Auto-repair state
            state.categoryOptions[cat] = options; 
        }

        if (options) {
            options.forEach(v => {
                const isSel = v === selectedVariant ? 'selected' : '';
                sel.innerHTML += `<option value="${v}" ${isSel}>${v}</option>`;
            });
        }
    }

    function editProduct(code) {
        document.getElementById("pmRfid").value = code;
        const p = state.products[code] || {};
        
        // Use Tabs for Category
        renderTabs("pmCategoryTabs", "pmCategory", "pmVariant", p.category, p.variant);
        
        document.getElementById("pmBrand").value = p.brand || "";
        document.getElementById("pmPrice").value = p.washPrice || "";
        document.getElementById("pmItemPrice").value = p.itemPrice || "";
        document.getElementById("pmDestination").value = p.destination || "Almareia";
        document.getElementById("pmAcqDate").value = p.acqDate || "";

        showModal('productModal');
    }

    // Removed old event listener for pmCategory change as it's handled by tabs now
    // document.getElementById("pmCategory").addEventListener("change", ...) - REMOVED

    // updateVariantSelect function replaced by updateVariantOptions - REMOVED

    document.getElementById("pmSave").onclick = () => {
        const code = document.getElementById("pmRfid").value;
        if (!code) return;
        
        const cat = document.getElementById("pmCategory").value;
        const variant = document.getElementById("pmVariant").value;
        
        if (!cat) { alert("Selecione a categoria!"); return; }

        state.products[code] = {
            ...state.products[code],
            rfid: code,
            category: cat,
            variant: variant,
            name: (variant && variant !== cat) ? `${cat} ${variant}`.trim() : cat,
            brand: document.getElementById("pmBrand").value,
            acqDate: document.getElementById("pmAcqDate").value,
            washPrice: document.getElementById("pmPrice").value,
            itemPrice: document.getElementById("pmItemPrice").value,
            destination: document.getElementById("pmDestination").value
        };
        persist();
        render();
        hideModal('productModal');

        // Check if this was a pending scan
        if (pendingScanCode === code) {
            addScan(code);
            pendingScanCode = null;
        }
    };

    // --- Group Register ---
    let groupScans = [];
    document.getElementById("groupRegBtn").onclick = () => {
        groupScans = [];
        document.getElementById("grList").innerHTML = "";
        document.getElementById("grCount").textContent = "0";
        
        // Use Tabs for Category
        renderTabs("grCategoryTabs", "grCategory", "grVariant");
        
        showModal('groupRegisterModal');
    };

    // Old event listener removed
    // document.getElementById("grCategory").addEventListener("change", ...); - REMOVED

    function onGroupScan(code) {
        // Enforce strict E+23 format
        if (!code.startsWith("E") || code.length !== 24) return;
        if(groupScans.includes(code)) return;
        groupScans.push(code);
        const div = document.createElement("div");
        div.className = "border-bottom py-1";
        div.textContent = code;
        document.getElementById("grList").appendChild(div);
        document.getElementById("grCount").textContent = groupScans.length;
        document.getElementById("grScanInput").value = "";
        document.getElementById("grScanInput").focus();
    }
    
    // Attach continuous scanning to Group Register input
    handleContinuousInput(document.getElementById("grScanInput"), onGroupScan);

    document.getElementById("grSave").onclick = () => {
        const cat = document.getElementById("grCategory").value;
        const variant = document.getElementById("grVariant").value;
        const brand = document.getElementById("grBrand").value;
        const price = document.getElementById("grPrice").value;
        const itemPrice = document.getElementById("grItemPrice").value;
        const dest = document.getElementById("grDestination").value;
        const acqDate = document.getElementById("grAcqDate").value;

        if (!cat) {
            alert("Selecione uma categoria!");
            return;
        }

        groupScans.forEach(code => {
            // Update local state
            state.products[code] = {
                ...state.products[code], // keep existing props if any
                rfid: code,
                category: cat,
                variant: variant,
                name: (variant && variant !== cat) ? `${cat} ${variant}`.trim() : cat,
                brand: brand,
                washPrice: price,
                itemPrice: itemPrice,
                destination: dest,
                acqDate: acqDate
            };
        });
        persist();
        alert(`${groupScans.length} itens atualizados!`);
        hideModal('groupRegisterModal');
        render();
    };

    // --- Inventory ---
    // Use continuous scanning logic
    handleContinuousInput(document.getElementById("invInput"), processInventoryScan);

    document.getElementById("headerInvBtn").onclick = () => {
        // Init UI
        const allCodes = Object.keys(state.products);
        document.getElementById("invTotalDb").textContent = allCodes.length;
        
        if(state.inventoryAudit.active) {
            document.getElementById("invActiveArea").style.display = "block";
            document.getElementById("invStartBtn").style.display = "none";
            updateInventoryUI();
        } else {
            document.getElementById("invActiveArea").style.display = "none";
            document.getElementById("invStartBtn").style.display = "block";
            document.getElementById("invCount").textContent = "0";
            document.getElementById("invMissing").textContent = allCodes.length;
        }
        showModal('inventoryModal');
    };

    document.getElementById("invStartBtn").onclick = () => {
        if(!confirm("Iniciar nova conferência?")) return;
        state.inventoryAudit = { active: true, scanned: [] };
        document.getElementById("invActiveArea").style.display = "block";
        document.getElementById("invStartBtn").style.display = "none";
        updateInventoryUI();
        persist();
        setTimeout(() => document.getElementById("invInput").focus(), 500);
    };

    function processInventoryScan(code) {
        if (!state.inventoryAudit.active) return;
        // Strict E+23 check (already done by handleContinuousInput if used, but good safety)
        if (!code.startsWith("E") || code.length !== 24) return;

        const input = document.getElementById("invInput");
        
        if (state.inventoryAudit.scanned.includes(code)) {
            document.getElementById("invLastMsg").textContent = "Já escaneado!";
            document.getElementById("invLastMsg").className = "fw-bold text-center mb-2 text-warning";
            input.value = "";
            return;
        }
        
        state.inventoryAudit.scanned.push(code);
        const p = state.products[code];
        document.getElementById("invLastMsg").textContent = p ? `OK: ${p.name}` : "OK: Novo/Desconhecido";
        document.getElementById("invLastMsg").className = "fw-bold text-center mb-2 text-success";
        
        updateInventoryUI();
        persist();
        input.value = "";
    }
    
    // Removed manual keydown listener as handleContinuousInput covers it
    // document.getElementById("invInput").addEventListener("keydown", ...);

    function updateInventoryUI() {
        const allCodes = Object.keys(state.products);
        const scanned = state.inventoryAudit.scanned;
        
        document.getElementById("invCount").textContent = scanned.length;
        document.getElementById("invMissing").textContent = allCodes.length - scanned.length;

        const tbody = document.getElementById("invRows");
        tbody.innerHTML = "";
        scanned.slice(-10).reverse().forEach(code => {
            const p = state.products[code] || {};
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${p.name || "-"}</td>
                <td class="font-monospace small">${code}</td>
                <td class="text-center text-success"><i class="bi bi-check"></i></td>
            `;
            tbody.appendChild(tr);
        });
    }

    document.getElementById("invFinishBtn").onclick = () => {
        if(!confirm("Finalizar conferência e baixar relatório de faltas?")) return;
        
        const allCodes = Object.keys(state.products);
        const missing = allCodes.filter(c => !state.inventoryAudit.scanned.includes(c));
        
        // Generate CSV
        const data = missing.map(c => {
            const p = state.products[c];
            return {
                Tag: c,
                Nome: p.name,
                Categoria: p.category,
                Marca: p.brand
            };
        });
        
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Faltando");
        XLSX.writeFile(wb, "Inventario_Faltas.xlsx");
        
        state.inventoryAudit = { active: false, scanned: [] };
        persist();
        hideModal('inventoryModal');
    };

    // --- History - REMOVED ---

    // --- Verification & Sending ---
    document.getElementById("newBagBtn").onclick = () => {
        const currentBagItems = state.scans.filter(s => s.bag === state.bagName);
        if (currentBagItems.length === 0) { alert("Sacola vazia!"); return; }
        
        if(!confirm(`Enviar sacola "${state.bagName}" para lavanderia?`)) return;

        // Calculate expected return date (2 days, skip Sunday)
        const sentDate = new Date();
        let returnDate = new Date(sentDate);
        let daysAdded = 0;
        while (daysAdded < 2) {
            returnDate.setDate(returnDate.getDate() + 1);
            if (returnDate.getDay() !== 0) { // If not Sunday
                daysAdded++;
            }
        }

        // Add to history with 'sent' status
        state.bagHistory.push({
            date: sentDate.toISOString(),
            sentDate: sentDate.toISOString(),
            expectedReturn: returnDate.toISOString(),
            name: state.bagName,
            status: 'sent', // sent, received
            items: currentBagItems.map(s => s.code),
            justification: ""
        });

        alert("Sacola enviada!");
        state.bagName = "Bag " + Date.now();
        state.scans = []; 
        persist();
        render();
    };

    // --- Laundry Status & Receiving ---
    document.getElementById("laundryStatusBtn").onclick = () => {
        renderLaundryStatus();
        showModal('laundryStatusModal');
    };

    function renderLaundryStatus() {
        const sentBags = state.bagHistory.filter(b => b.status === 'sent');
        
        // --- 1. Aggregation for Summary ---
        // Map: Category -> { total: 0, byDate: { "YYYY-MM-DD": count } }
        const summary = {};
        
        sentBags.forEach(bag => {
            // Expected date key
            const expDate = new Date(bag.expectedReturn);
            const dateKey = expDate.toISOString().split('T')[0]; // YYYY-MM-DD
            const dateLabel = `${expDate.getDate()}-${expDate.toLocaleString('default', { month: 'short' })}`;

            bag.items.forEach(code => {
                const p = state.products[code] || {};
                const cat = p.category || "Sem Categoria";
                
                if (!summary[cat]) summary[cat] = { total: 0, byDate: {} };
                summary[cat].total++;
                
                if (!summary[cat].byDate[dateKey]) {
                    summary[cat].byDate[dateKey] = { count: 0, label: dateLabel };
                }
                summary[cat].byDate[dateKey].count++;
            });
        });

        // Render Summary Table
        const thead = document.getElementById("lsSummaryHeader");
        const tbody = document.getElementById("lsSummaryRows");
        thead.innerHTML = `<th>Categoria</th><th>Total</th><th>Previsão de Retorno</th>`;
        tbody.innerHTML = "";

        Object.keys(summary).sort().forEach(cat => {
            const data = summary[cat];
            const datesHtml = Object.keys(data.byDate).sort().map(d => {
                const info = data.byDate[d];
                return `<span class="badge bg-info text-dark me-1">(${info.count}) ${info.label}</span>`;
            }).join(" ");

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td class="fw-bold">${cat}</td>
                <td class="text-center fw-bold">${data.total}</td>
                <td>${datesHtml}</td>
            `;
            tbody.appendChild(tr);
        });

        // --- 2. Active Bags List ---
        const list = document.getElementById("lsActiveBagsList");
        list.innerHTML = "";
        
        if (sentBags.length === 0) {
            list.innerHTML = `<div class="alert alert-secondary">Nenhuma sacola na lavanderia.</div>`;
        }

        sentBags.forEach((bag, idx) => {
            const sent = new Date(bag.sentDate).toLocaleDateString();
            const exp = new Date(bag.expectedReturn).toLocaleDateString();
            
            const div = document.createElement("div");
            div.className = "list-group-item d-flex justify-content-between align-items-center";
            div.innerHTML = `
                <div>
                    <h6 class="mb-0 fw-bold">${bag.name}</h6>
                    <small class="text-muted">Enviado: ${sent} | Retorno: <span class="text-primary fw-bold">${exp}</span> | Itens: ${bag.items.length}</small>
                </div>
                <button class="btn btn-primary btn-sm" onclick="startReceiving('${bag.name}')">Receber / Conferir</button>
            `;
            list.appendChild(div);
        });
    }

    window.startReceiving = (bagName) => {
        const bag = state.bagHistory.find(b => b.name === bagName && b.status === 'sent');
        if (!bag) return;

        state.verification = {
            active: true,
            bagName: bagName,
            items: bag.items, // Expected items
            scanned: new Set(), // Scanned items (Set of codes)
            verified: new Set() // Verified items (Set of codes) - keeping for compatibility but redundant with scanned
        };
        
        hideModal('laundryStatusModal');
        updateVerificationUI();
        showModal('verificationModal');
        setTimeout(() => document.getElementById("verInput").focus(), 500);
    };

    function processVerificationScan(code) {
        if (!state.verification.active) return;
        // Strict E+23 check
        if (!code.startsWith("E") || code.length !== 24) return;
        
        state.verification.scanned.add(code);
        state.verification.verified.add(code); // Keep synced
        updateVerificationUI();
    }

    // Use continuous scanning for Verification
    handleContinuousInput(document.getElementById("verInput"), processVerificationScan);

    function updateVerificationUI() {
        const expected = state.verification.items || []; // Array of codes
        const scannedSet = state.verification.scanned || new Set();
        
        // Calculate diffs
        const missing = expected.filter(c => !scannedSet.has(c));
        const extra = Array.from(scannedSet).filter(c => !expected.includes(c));
        
        const totalExpected = expected.length;
        const totalScanned = scannedSet.size;

        document.getElementById("verCount").textContent = totalScanned;
        document.getElementById("verTotal").textContent = totalExpected;
        
        const hasDiscrepancy = missing.length > 0 || extra.length > 0;
        const justArea = document.getElementById("verJustificationArea");
        const justInput = document.getElementById("verJustification");
        const btn = document.getElementById("verFinish");

        if (hasDiscrepancy) {
             justArea.style.display = "block";
             document.getElementById("verMsg").textContent = "Divergência encontrada!";
             document.getElementById("verMsg").className = "text-danger fw-bold text-center mb-3";
             
             // Require justification to enable button
             btn.disabled = justInput.value.trim().length === 0;
             justInput.oninput = () => {
                 btn.disabled = justInput.value.trim().length === 0;
             };
        } else {
             justArea.style.display = "none";
             document.getElementById("verMsg").textContent = "Conferência OK!";
             document.getElementById("verMsg").className = "text-success fw-bold text-center mb-3";
             btn.disabled = false;
        }

        const list = document.getElementById("verPendingList");
        list.innerHTML = "";
        
        // Show Missing
        missing.forEach(c => {
            const div = document.createElement("div");
            const p = state.products[c] || {};
            div.className = "text-danger border-bottom py-1";
            div.innerHTML = `<i class="bi bi-x-circle"></i> Faltando: <strong>${p.name || c}</strong> <small class="text-muted font-monospace">${c}</small>`;
            list.appendChild(div);
        });

        // Show Extra
        extra.forEach(c => {
            const div = document.createElement("div");
            const p = state.products[c] || {};
            div.className = "text-warning border-bottom py-1";
            div.innerHTML = `<i class="bi bi-exclamation-triangle"></i> Sobra: <strong>${p.name || c}</strong> <small class="text-muted font-monospace">${c}</small>`;
            list.appendChild(div);
        });
    }

    document.getElementById("verFinish").onclick = () => {
        const bagName = state.verification.bagName;
        const bagIndex = state.bagHistory.findIndex(b => b.name === bagName && b.status === 'sent');
        
        if (bagIndex === -1) {
            // Fallback for "sending" flow if it was used (but we removed it)
            alert("Erro: Sacola não encontrada.");
            return;
        }

        const expected = state.verification.items || [];
        const scannedSet = state.verification.scanned || new Set();
        const missing = expected.filter(c => !scannedSet.has(c));
        const extra = Array.from(scannedSet).filter(c => !expected.includes(c));
        const justification = document.getElementById("verJustification").value.trim();

        state.bagHistory[bagIndex].status = 'received';
        state.bagHistory[bagIndex].receivedDate = new Date().toISOString();
        state.bagHistory[bagIndex].discrepancies = { missing, extra };
        state.bagHistory[bagIndex].justification = justification;

        alert("Sacola recebida e conferida com sucesso!");
        state.verification.active = false;
        document.getElementById("verJustification").value = "";
        persist();
        render(); // Update laundry status if open?
        hideModal('verificationModal');
        
        // Re-open laundry status to show updated list
        renderLaundryStatus();
        showModal('laundryStatusModal');
    };
    
    document.getElementById("verCancel").onclick = () => {
        state.verification.active = false;
        hideModal('verificationModal');
    };

    // --- Manage Categories ---
    document.getElementById("manageCategoriesBtn").onclick = () => {
        renderCategoryList();
        document.getElementById("catEditArea").style.display = "none";
        document.getElementById("catMainActions").style.display = "block";
        showModal('manageCategoriesModal');
    };

    function renderCategoryList() {
        const div = document.getElementById("catList");
        div.innerHTML = "";
        state.categories.forEach(cat => {
            const btn = document.createElement("button");
            btn.className = "list-group-item list-group-item-action d-flex justify-content-between align-items-center";
            const count = (state.categoryOptions[cat]||[]).length;
            btn.innerHTML = `${cat} <span class="badge bg-secondary rounded-pill">${count} var</span>`;
            btn.onclick = () => editCategory(cat);
            div.appendChild(btn);
        });
    }

    document.getElementById("catAddBtn").onclick = () => {
        const name = document.getElementById("catNewName").value.trim();
        if(name && !state.categories.includes(name)) {
            state.categories.push(name);
            state.categoryOptions[name] = [];
            persist();
            renderCategoryList();
            document.getElementById("catNewName").value = "";
        }
    };

    let editingCategory = null;
    function editCategory(cat) {
        editingCategory = cat;
        document.getElementById("catMainActions").style.display = "none";
        document.getElementById("catEditArea").style.display = "block";
        document.getElementById("catEditTitle").textContent = "Editar: " + cat;
        
        renderEditVariants();
    }

    function renderEditVariants() {
        const list = document.getElementById("catEditVariantsList");
        list.innerHTML = "";
        (state.categoryOptions[editingCategory]||[]).forEach(v => {
            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center p-2";
            li.innerHTML = `
                ${v}
                <button class="btn btn-sm btn-outline-danger py-0" onclick="removeVariant('${v}')">&times;</button>
            `;
            list.appendChild(li);
        });
    }
    
    window.removeVariant = (v) => {
        state.categoryOptions[editingCategory] = state.categoryOptions[editingCategory].filter(x => x !== v);
        renderEditVariants();
        persist();
    };

    document.getElementById("catAddVariantBtn").onclick = () => {
        const v = document.getElementById("catNewVariantInput").value.trim();
        if(v && !state.categoryOptions[editingCategory].includes(v)) {
            state.categoryOptions[editingCategory].push(v);
            document.getElementById("catNewVariantInput").value = "";
            renderEditVariants();
            persist();
        }
    };

    document.getElementById("catEditCancel").onclick = () => {
        document.getElementById("catEditArea").style.display = "none";
        document.getElementById("catMainActions").style.display = "block";
        renderCategoryList();
    };
    
    document.getElementById("catEditSave").onclick = () => {
        // Save handled in real-time for variants, just close view
        document.getElementById("catEditArea").style.display = "none";
        document.getElementById("catMainActions").style.display = "block";
        renderCategoryList();
    };

    // --- Brand Management ---
    document.getElementById("addBrandBtn").onclick = () => {
        const brand = prompt("Digite o nome da nova marca:");
        if (brand) {
            if (!state.brands) state.brands = [];
            if (!state.brands.includes(brand)) {
                state.brands.push(brand);
                state.brands.sort();
                persist();
                renderBrandList();
                alert(`Marca "${brand}" adicionada.`);
            } else {
                alert("Esta marca já existe.");
            }
        }
    };

    function renderBrandList() {
        const list = document.getElementById("brandList");
        if (!list) return;
        const allBrands = new Set(state.brands || []);
        Object.values(state.products).forEach(p => {
            if (p.brand) allBrands.add(p.brand);
        });
        list.innerHTML = Array.from(allBrands).sort().map(b => `<option value="${b}">`).join("");
    }

    // --- Clients ---
    document.getElementById("clientBtn").onclick = () => {
        renderClientList();
        showModal('clientModal');
    };

    function renderClientList() {
        const list = document.getElementById("clientList");
        list.innerHTML = "";
        const clients = ["default"];
        for (let i=0; i<localStorage.length; i++) {
            const k = localStorage.key(i);
            if(k.startsWith("laundry-counter-")) {
                const c = k.replace("laundry-counter-", "");
                if(!clients.includes(c)) clients.push(c);
            }
        }
        
        clients.forEach(c => {
            const item = document.createElement("button");
            item.className = `list-group-item list-group-item-action ${c === currentClient ? 'active' : ''}`;
            item.textContent = c === "default" ? "Padrão" : c;
            item.onclick = () => {
                if(confirm(`Trocar para ${c}?`)) {
                    currentClient = c;
                    restore();
                    hideModal('clientModal');
                }
            };
            list.appendChild(item);
        });
    }

    document.getElementById("addNewClientBtn").onclick = () => {
        const name = document.getElementById("newClientInput").value.trim();
        if (name) {
            currentClient = name;
            state.scans = [];
            state.products = {};
            state.bagHistory = [];
            state.bagName = "Bag 1";
            persist();
            restore();
            hideModal('clientModal');
            document.getElementById("newClientInput").value = "";
        }
    };

    // --- Full Set Modal (Basic View) ---
    document.getElementById("fullSetBtn").onclick = () => {
        const tbody = document.getElementById("fsRows");
        tbody.innerHTML = "";
        Object.keys(state.products).forEach(code => {
            const p = state.products[code];
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${p.category || "-"}</td>
                <td>${p.name || "-"}</td>
                <td>${p.variant || "-"}</td>
                <td class="font-monospace small">${code}</td>
                <td>${p.destination || "-"}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editProductFromFullSet('${code}')">
                        <i class="bi bi-pencil"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        showModal('fullSetModal');
    };
    
    window.editProductFromFullSet = (code) => {
        hideModal('fullSetModal');
        setTimeout(() => editProduct(code), 200);
    };
    
    // --- Initial Load ---
    // Removed manual listeners for scanInput as handleContinuousInput is attached earlier
    
    // Clear Bag
    document.getElementById("clearBagBtn").onclick = () => {
        if(confirm("Limpar sacola atual? (Isso remove os itens da lista, mas não apaga do histórico se já salvos)")) {
            state.scans = state.scans.filter(s => s.bag !== state.bagName);
            persist();
            render();
        }
    };

    window.onload = () => {
        restore();
    };

</script>
{% endblock %}
