{% extends "base.html" %}

{% block content %}
<style>
    .category-btn {
        transition: all 0.2s ease-in-out;
        white-space: nowrap; /* Garante que o texto fique em uma linha */
        font-size: 0.95rem; /* Tamanho de fonte legível e compacto */
        padding: 0.5rem 1rem !important; /* py-2 px-3 equivalente, forçando override */
        min-width: 44px; /* Touch target minimum width */
        min-height: 44px; /* Touch target minimum height */
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    .category-btn:hover {
        transform: translateY(-1px);
        filter: brightness(0.9); /* Escurece levemente no hover, funciona com cores customizadas */
        box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important;
    }
    
    .category-btn:active {
        transform: translateY(1px);
        filter: brightness(0.8);
    }
    
    .category-btn:focus {
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); /* Anel de foco padrão do Bootstrap */
        outline: none;
    }

    /* Ensure all buttons in this view have minimum touch target size */
    button.btn, a.btn, .action-btn {
        min-height: 44px;
        min-width: 44px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Adjust padding for small buttons to maintain visual balance while meeting target size */
    .btn-sm {
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
    }
</style>
<div class="container mt-4">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 gap-3">
        <h2>
            <a href="{{ url_for('governance.governance_rooms') if mode == 'minibar' else url_for('restaurant.restaurant_tables') }}" class="text-decoration-none text-dark">
                <i class="bi bi-arrow-left"></i>
            </a>
            {% if order and order.customer_type == 'funcionario' %}
                Conta: {{ order.staff_name }}
            {% else %}
                Mesa {{ table_id }}
            {% endif %}
            
            {% if order and order.total_paid|default(0) > 0 %}
                {% set calculated_total = order.total * 1.1 %}
                {% if order.total_paid >= calculated_total - 0.01 %}
                    <span class="badge bg-success text-white ms-2 fs-6 align-middle" id="statusBadge">
                        <i class="bi bi-check-circle-fill me-1"></i> Paga
                    </span>
                {% else %}
                    <span class="badge bg-warning text-dark ms-2 fs-6 align-middle" id="statusBadge">
                        <i class="bi bi-pie-chart-fill me-1"></i> Parcialmente Paga
                    </span>
                {% endif %}
            {% endif %}
            
            {% if order and order.get('is_breakfast') %}
                <span class="badge bg-warning text-dark ms-2 fs-6 align-middle" title="Mesa aberta durante Café da Manhã (07h-10h)">
                    <i class="bi bi-cup-hot-fill me-1"></i> Café da Manhã
                </span>
            {% endif %}
        </h2>
        
        {% if order %}
        <div class="d-flex gap-2 align-items-center flex-wrap justify-content-center justify-content-md-end">
            <div class="text-center text-md-end w-100 w-md-auto mb-2 mb-md-0">
                <div class="text-muted small">
                    Adultos: <strong>{{ order.num_adults }}</strong>
                    {% if mode != 'minibar' %}
                    <a href="#" class="text-decoration-none ms-1" data-bs-toggle="modal" data-bs-target="#editPaxModal">
                        <i class="bi bi-pencil-square"></i>
                    </a>
                    {% endif %}
                </div>
                <div class="text-muted small">
                    Tipo: <strong>{{ order.customer_type|default('Passante')|title }}</strong>
                </div>
                {% if order.room_number %}
            <div class="text-muted small">Quarto: <strong>{{ order.room_number|format_room }}</strong></div>
            {% endif %}
            </div>
            
            {% if order %}
                {% set is_locked = order.locked if order.locked is defined else false %}
                {% if session.get('role') in ['admin', 'gerente', 'supervisor'] %}
                <button type="button" class="btn btn-warning btn-sm text-dark" data-bs-toggle="modal" data-bs-target="#transferModal">
                    <i class="bi bi-arrow-left-right"></i> <span class="d-none d-sm-inline">Transferir</span><span class="d-inline d-sm-none">Transf.</span>
                </button>
                {% endif %}

                {% if mode != 'minibar' %}
                {% if order.get('last_transfer') and session.get('role') in ['admin', 'gerente', 'supervisor'] %}
                <form action="{{ url_for('restaurant.restaurant_table_order', table_id=table_id) }}" method="POST" class="d-inline" id="cancelTransferForm">
                    <input type="hidden" name="action" value="cancel_transfer">
                    <input type="hidden" name="return_table_id" id="return_table_id">
                    <button type="button" class="btn btn-outline-warning btn-sm text-dark" onclick="handleCancelTransfer('{{ order.last_transfer.source_table }}')">
                        <i class="bi bi-arrow-counterclockwise"></i> <span class="d-none d-sm-inline">Cancelar Transferência</span><span class="d-inline d-sm-none">Cancelar</span>
                    </button>
                </form>
                {% endif %}
                {% endif %}

                {% if mode != 'minibar' %}
                    {% if is_locked %}
                        <div class="alert alert-warning py-1 px-2 d-inline-flex align-items-center mb-0">
                            <i class="bi bi-exclamation-triangle me-1"></i> <span class="d-none d-sm-inline">Conta puxada</span>
                        </div>
                        <form action="{{ url_for('restaurant.restaurant_table_order', table_id=table_id) }}" method="POST" class="d-inline">
                            <input type="hidden" name="action" value="unlock_table">
                            <button type="submit" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-arrow-counterclockwise"></i> <span class="d-none d-sm-inline">Reabrir Mesa</span><span class="d-inline d-sm-none">Reabrir</span>
                            </button>
                        </form>
                    {% else %}
                        <form action="{{ url_for('restaurant.restaurant_table_order', table_id=table_id) }}" method="POST" class="d-inline">
                            <input type="hidden" name="action" value="pull_bill">
                            <button type="submit" class="btn btn-outline-dark btn-sm">
                                <i class="bi bi-receipt"></i> <span class="d-none d-sm-inline">Puxar Conta</span><span class="d-inline d-sm-none">Puxar</span>
                            </button>
                        </form>
                    {% endif %}
                {% endif %}

                {% if table_id == breakfast_table_id and mode != 'minibar' %}
                    <!-- Breakfast Close Button -->
                    <form action="{{ url_for('restaurant.restaurant_table_order', table_id=table_id) }}" method="POST" class="d-inline" onsubmit="return confirm('ATENÇÃO: Fechar Mesa do Café da Manhã?\n\n- Os itens serão baixados do estoque.\n- NÃO será gerado financeiro.\n- A mesa será limpa.');">
                        <input type="hidden" name="action" value="close_breakfast">
                        <button type="submit" class="btn btn-info btn-sm text-white">
                            <i class="bi bi-cup-hot-fill"></i> <span class="d-none d-sm-inline">Fechar Café</span><span class="d-inline d-sm-none">Fechar</span>
                        </button>
                    </form>
                {% endif %}

                {% if order.customer_type == 'hospede' and order.room_number %}
                    {% set formatted_transfer_total = "%.2f"|format(grand_total) %}
                    {% set confirm_msg = 'Confirmar consumo do frigobar?' if mode == 'minibar' else 'Transferir R$ ' + formatted_transfer_total + ' para o quarto ' + order.room_number|string + ' e fechar mesa?' %}
                    <form action="{{ url_for('restaurant.restaurant_table_order', table_id=table_id) }}" method="POST" class="d-inline" onsubmit="return confirm('{{ confirm_msg }}');">
                        <input type="hidden" name="action" value="transfer_to_room">
                        <input type="hidden" name="mode" value="{{ mode if mode else '' }}">
                        <input type="hidden" name="room_number" value="{{ order.room_number }}">
                        <button type="submit" class="btn btn-primary btn-sm">
                            {% if mode == 'minibar' %}
                            <i class="bi bi-check-circle"></i> <span class="d-none d-sm-inline">Confirmar Consumo</span><span class="d-inline d-sm-none">Confirmar</span>
                            {% else %}
                            <i class="bi bi-door-closed"></i> <span class="d-none d-sm-inline">Transferir para Quarto</span><span class="d-inline d-sm-none">Transf.</span>
                            {% endif %}
                        </button>
                    </form>
                {% elif mode != 'minibar' and session.get('role') in ['admin', 'gerente', 'supervisor'] %}
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#transferToRoomModal">
                        <i class="bi bi-door-closed"></i> <span class="d-none d-sm-inline">Enviar p/ Quarto</span><span class="d-inline d-sm-none">Quarto</span>
                    </button>
                {% endif %}

                <!-- Standard Payment Option (Available for All Tables) -->
                {% if order.customer_type == 'funcionario' %}
                    <div class="alert alert-info py-1 px-3 d-inline-block mb-0">
                        <i class="bi bi-info-circle"></i> <span class="d-none d-sm-inline">Consumo Salvo</span>
                    </div>
                    
                    {% if (table_id|string)[:5] != 'FUNC_' %}
                    <!-- Option to release physical table -->
                    <form action="{{ url_for('restaurant.restaurant_table_order', table_id=table_id) }}" method="POST" class="d-inline" onsubmit="return confirm('Isso irá mover o consumo para a conta mensal do funcionário e liberar esta mesa. Confirmar?');">
                        <input type="hidden" name="action" value="transfer_to_staff_account">
                        <button type="submit" class="btn btn-warning btn-sm text-dark">
                            <i class="bi bi-box-arrow-right"></i> <span class="d-none d-sm-inline">Liberar Mesa</span><span class="d-inline d-sm-none">Liberar</span>
                        </button>
                    </form>
                    {% endif %}
                {% elif is_cashier_open and mode != 'minibar' %}
                    <button type="button" class="btn btn-outline-primary btn-sm me-1" data-bs-toggle="modal" data-bs-target="#partialPaymentModal">
                        <i class="bi bi-wallet2"></i> <span class="d-none d-sm-inline">Pagamento Parcial</span><span class="d-inline d-sm-none">Parcial</span>
                    </button>
                    <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#checkoutModal">
                        <i class="bi bi-cash-coin"></i> <span class="d-none d-sm-inline">Fechar Conta</span><span class="d-inline d-sm-none">Fechar</span>
                    </button>
                {% elif mode != 'minibar' %}
                <div class="d-inline-block" tabindex="0" data-bs-toggle="tooltip" title="Abra o caixa para fechar contas">
                    <button type="button" class="btn btn-secondary btn-sm" disabled>
                        <i class="bi bi-lock-fill"></i> <span class="d-none d-sm-inline">Fechar Conta (Caixa Fechado)</span><span class="d-inline d-sm-none">Cx. Fechado</span>
                    </button>
                </div>
                {% endif %}

                {% if session.get('role') == 'admin' %}
                <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#cancelTableModal">
                    <i class="bi bi-x-octagon"></i> <span class="d-none d-sm-inline">Cancelar Mesa</span><span class="d-inline d-sm-none">Cancelar</span>
                </button>
                {% endif %}
            {% endif %}
        </div>
        {% endif %}
    </div>

    {% if not order %}
    <!-- Open Table Form -->
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Abrir Mesa</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <input type="hidden" name="action" value="open_table">
                        
                        <div class="mb-3">
                            <label for="num_adults" class="form-label fw-bold">Número de Adultos *</label>
                            {% set default_adults = 1 %}
                            {% if is_room and room_occupancy and room_occupancy.get(table_id|string) %}
                                {% set default_adults = room_occupancy[table_id|string].get('num_adults', 1) %}
                            {% endif %}
                            <input type="number" class="form-control form-control-lg" id="num_adults" name="num_adults" required min="1" value="{{ default_adults }}" inputmode="numeric">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Tipo de Cliente *</label>
                            {% if is_room %}
                                <div class="alert alert-info py-2">
                                    <i class="bi bi-info-circle"></i> Esta mesa é um Quarto.
                                    <input type="hidden" name="customer_type" value="hospede">
                                </div>
                                {% if room_occupancy and room_occupancy.get(table_id|string) %}
                                    <div class="card mb-3">
                                        <div class="card-body py-2 bg-light">
                                            <strong>Hóspede:</strong> {{ room_occupancy[table_id|string].guest_name }}<br>
                                            <small class="text-muted">Período: {{ room_occupancy[table_id|string].checkin|default('?') }} até {{ room_occupancy[table_id|string].checkout|default('?') }}</small>
                                        </div>
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="d-flex gap-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="customer_type" id="type_passante" value="passante" checked="checked" onchange="toggleRoomInput()">
                                        <label class="form-check-label" for="type_passante">
                                            Passante
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="customer_type" id="type_hospede" value="hospede" onchange="toggleRoomInput()">
                                        <label class="form-check-label" for="type_hospede">
                                            Hóspede
                                        </label>
                                    </div>
                                </div>
                            {% endif %}
                        </div>

                        {% if not is_room %}
                        <div class="mb-3" id="customer_name_container">
                            <label for="customer_name" class="form-label">Nome do Passante (Opcional)</label>
                            <input type="text" class="form-control" id="customer_name" name="customer_name" placeholder="Nome do Passante">
                        </div>
                        {% endif %}
                        
                        {% if not is_room %}
                        <!-- Staff Input Container Removed (Use Staff Button on Tables Page) -->

                        <div class="mb-4" id="room_input_container" style="display: none;">
                            <label class="form-label">Selecione o Quarto *</label>
                            <div class="d-flex flex-wrap gap-2" id="room-list" style="max-height: 200px; overflow-y: auto;">
                                {% set excluded_rooms = [4, 5, 6, 7, 8, 9, 10, 13, 18, 19, 20, 27, 28, 29, 30] %}
                                {% for r in range(1, 36) %}
                                    {% if r not in excluded_rooms %}
                                        {% set r_str = r|string %}
                                        {% set r_padded = "%02d"|format(r) %}
                                        {% set guest = room_occupancy.get(r_padded) or room_occupancy.get(r_str) %}
                                        <button type="button" 
                                                class="btn {{ 'btn-outline-primary' if guest else 'btn-outline-secondary' }} room-btn text-start" 
                                                onclick="selectRoom('{{ r }}', this)"
                                                style="min-width: 60px;">
                                            <div class="fw-bold text-center">{{ r }}</div>
                                            {% if guest %}
                                            <div style="font-size: 0.7em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80px;" title="{{ guest.guest_name }}">
                                                {{ guest.guest_name }}
                                            </div>
                                            {% endif %}
                                        </button>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <input type="hidden" id="room_number" name="room_number">
                        </div>
                        {% endif %}
                        
                        <button type="submit" class="btn btn-success w-100 btn-lg">
                            <i class="bi bi-door-open"></i> Abrir Mesa
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Order Interface -->
    <div class="row">
        <!-- Add Item Form -->
        <div class="col-md-5 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Novo Pedido (Lote)</h5>
                </div>
                <div class="card-body">
                    <!-- Product Selection Interface (No Form Submission Here) -->
                    <div id="product-selection-area">
                        <input type="hidden" id="selected_product">
                        
                        <!-- Search -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Buscar Item:</label>
                            <input type="text" id="productSearch" class="form-control" placeholder="Digite para buscar..." onkeyup="searchProducts()">
                            <div id="searchResults" class="list-group mt-2" style="display:none; max-height: 200px; overflow-y: auto;"></div>
                        </div>

                        <!-- Categoria -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">1. Selecione a Categoria:</label>
                            
                            <div class="d-flex flex-wrap gap-2" id="category-list" style="display: flex !important;">
                                {% if grouped_products|length == 0 %}
                                    <div class="alert alert-danger w-100">
                                        Nenhuma categoria encontrada. Verifique se há produtos ativos no menu.
                                    </div>
                                {% endif %}

                                {% for category, items in grouped_products %}
                                {% set cat_safe = category if category else 'Outros' %}
                                {% set cat_color = category_colors.get(cat_safe) if category_colors else None %}
                                {% set is_visible = (cat_safe not in ['Frigobar', 'Geral']) or (session.get('role') in ['admin', 'gerente', 'supervisor']) %}
                                
                                {% if is_visible %}
                                    {% if cat_color %}
                                        <button type="button" 
                                                class="btn fw-bold category-btn shadow-sm" 
                                                data-index="{{ loop.index }}"
                                                onclick="selectCategoryByIndex(this.getAttribute('data-index'), this)"
                                                title="{{ cat_safe }}"
                                                style="--cat-color: {{ cat_color }}; min-width: 120px; text-align: center; background-color: var(--cat-color); color: white; border-color: var(--cat-color);">
                                            {{ cat_safe }}
                                            <span class="badge rounded-pill bg-light text-dark ms-1 opacity-75">{{ items|length }}</span>
                                        </button>
                                    {% else %}
                                        <button type="button" 
                                                class="btn btn-outline-primary fw-bold category-btn shadow-sm" 
                                                data-index="{{ loop.index }}"
                                                onclick="selectCategoryByIndex(this.getAttribute('data-index'), this)"
                                                title="{{ cat_safe }}"
                                                style="min-width: 120px; text-align: center;">
                                            {{ cat_safe }}
                                            <span class="badge rounded-pill bg-secondary text-white ms-1 opacity-75">{{ items|length }}</span>
                                        </button>
                                    {% endif %}
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Produtos -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">2. Selecione o Produto:</label>
                            <div class="border rounded p-2 bg-light" style="min-height: 250px; max-height: 450px; overflow-y: auto;">
                                <div id="instruction-msg" class="text-center text-muted py-5">
                                    <i class="bi bi-arrow-up-circle fs-1"></i>
                                    <p class="mt-2">Selecione uma categoria acima para ver os produtos</p>
                                </div>

                                {% for category, items in grouped_products %}
                                <div id="group_{{ loop.index }}" class="product-group" data-cat="{{ category if category else 'Outros' }}" style="display: none;">
                                    <div class="row row-cols-3 row-cols-sm-4 row-cols-md-5 g-2">
                                        {% for p in items %}
                                        {% if p.product_type != 'accompaniment_only' or p.category in ['Doses', 'Drinks', 'Café da Manhã'] %}
                                        <div class="col">
                                            <div class="position-relative h-100">
                                                {% if p.paused %}
                                                <button type="button" 
                                                        class="btn btn-light w-100 h-100 p-2 text-start d-flex flex-column justify-content-between shadow-sm border"
                                                        disabled
                                                        style="opacity: 0.7; cursor: not-allowed;">
                                                    <div class="d-flex justify-content-between align-items-start w-100">
                                                        <span class="fw-bold lh-sm mb-1 text-muted text-break" style="font-size: 0.85rem; overflow-wrap: break-word; text-decoration: line-through;">{{ p.name }}</span>
                                                        <span class="badge bg-danger ms-1" style="font-size: 0.6em;">PAUSADO</span>
                                                    </div>
                                                    <span class="badge bg-light text-muted border align-self-start mt-1" style="font-size: 0.75em;">R$ {{ "%.2f"|format(p.price|default(0)) }}</span>
                                                </button>
                                                {% else %}
                                                <button type="button" 
                                                        class="btn btn-outline-secondary w-100 h-100 p-2 product-btn text-start d-flex flex-column justify-content-between shadow-sm"
                                                        onclick="selectProductFromId('{{ p.id }}', this)">
                                                    <span class="fw-bold lh-sm mb-1 text-break" style="font-size: 0.85rem; overflow-wrap: break-word;">{{ p.name }}</span>
                                                    <span class="badge bg-light text-dark border align-self-start mt-1" style="font-size: 0.75em;">R$ {{ "%.2f"|format(p.price|default(0)) }}</span>
                                                </button>
                                                {% endif %}

                                                {% if can_manage_items %}
                                                <button type="button" 
                                                        class="btn btn-sm {{ 'btn-success' if p.paused else 'btn-danger' }} position-absolute top-0 end-0 m-1 p-0 px-1 shadow-sm"
                                                        style="z-index: 10; width: 24px; height: 24px; line-height: 1;"
                                                        onclick="toggleProductPause('{{ p.id }}', event)"
                                                        title="{{ 'Ativar' if p.paused else 'Pausar' }}">
                                                    <i class="bi {{ 'bi-play-fill' if p.paused else 'bi-pause-fill' }}"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="mb-3" id="flavors-container" style="display: none;">
                            <label class="form-label fw-bold">Selecione o Sabor:</label>
                            <div class="border rounded p-2 bg-light" id="flavors-list" style="max-height: 200px; overflow-y: auto;">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <div class="mb-3" id="accompaniments-container" style="display: none;">
                            <label class="form-label fw-bold">Acompanhamentos:</label>
                            <div class="border rounded p-2 bg-light" id="accompaniments-list" style="max-height: 200px; overflow-y: auto;">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <div class="mb-3" id="complements-container" style="display: none;">
                            <label class="form-label fw-bold">3. Complementos:</label>
                            <div class="border rounded p-2 bg-light" id="complements-list" style="max-height: 200px; overflow-y: auto;">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <div class="mb-3" id="questions-container" style="display: none;">
                            <label class="form-label fw-bold">Perguntas Obrigatórias:</label>
                            <div class="border rounded p-2 bg-light" id="questions-list" style="max-height: 300px; overflow-y: auto;">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <div class="mb-3" id="observations-container" style="display: none;">
                            <label class="form-label fw-bold">4. Observações:</label>
                            <div class="border rounded p-2 bg-light" id="observations-list" style="max-height: 150px; overflow-y: auto;">
                                <!-- Populated by JS -->
                            </div>
                            <input type="text" class="form-control mt-2" id="custom-observation" placeholder="Outra observação (Enter para adicionar)" onkeypress="handleCustomObservation(event)">
                        </div>

                        <div class="mb-3">
                            <label for="qty" class="form-label">Quantidade</label>
                            <div class="input-group">
                                <button type="button" class="btn btn-outline-secondary btn-lg" onclick="decrementQty()">-</button>
                                <input type="number" class="form-control text-center form-control-lg" id="qty" value="1" min="1" step="1" inputmode="numeric">
                                <button type="button" class="btn btn-outline-secondary btn-lg" onclick="incrementQty()">+</button>
                            </div>
                        </div>

                        <button type="button" class="btn btn-outline-primary w-100 btn-lg mb-4" onclick="addToPending()">
                            <i class="bi bi-cart-plus"></i> Adicionar à Lista
                        </button>
                    </div>

                    <!-- Pending Items List -->
                    <div id="pending-items-container" style="display: none;" class="border-top pt-3">
                        <h6 class="fw-bold text-primary">Itens Pendentes (Enviar para Cozinha)</h6>
                        <div class="table-responsive mb-3 border rounded">
                            <table class="table table-sm table-hover mb-0" style="font-size: 0.9em;">
                                <thead class="table-light">
                                    <tr>
                                        <th>Item</th>
                                        <th class="text-center">Qtd</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="pending-items-body">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Final Batch Submission Form -->
                        <form method="POST" id="batchForm">
                            <input type="hidden" name="action" value="add_batch_items">
                            <input type="hidden" name="batch_id" id="batch_id">
                            <input type="hidden" name="mode" value="{{ mode if mode else '' }}">
                            <input type="hidden" name="items_json" id="items_json">
                            <input type="hidden" name="waiter" value="{{ session.get('user', 'Garçom') }}">
                            
                            <div class="mb-3 text-muted">
                                <i class="bi bi-person-badge"></i> Garçom: <strong>{{ session.get('user', 'Garçom') }}</strong>
                            </div>

                            <button type="submit" class="btn btn-success w-100 btn-lg py-3 shadow-sm" onclick="return prepareBatchSubmit()">
                                <i class="bi bi-send-check-fill me-2"></i> ENVIAR PEDIDOS
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Items -->
        <div class="col-md-7">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Itens do Pedido</h5>
                    <div class="d-flex gap-2 align-items-center">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="btnToggleHistory" onclick="toggleHistoryView()">
                            <i class="bi bi-clock-history"></i> Ver Histórico
                        </button>
                        {% set has_pending = false %}
                        {% if order is defined and order %}
                            {% set items_list = order.get('items', []) %}
                            {% if items_list %}
                                {% for item in items_list %}
                                    {% if not item.printed %}{% set has_pending = true %}{% endif %}
                                {% endfor %}
                            {% endif %}
                        {% endif %}
                        
                        {% if has_pending %}
                        <form method="POST" class="d-inline" onsubmit="return confirm('Reenviar TODOS os itens pendentes para impressão?');">
                            <input type="hidden" name="action" value="reprint_pending">
                            <button type="submit" class="btn btn-warning btn-sm fw-bold text-dark">
                                <i class="bi bi-printer-fill me-1"></i> Reenviar Pendentes
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if order.total_paid|default(0) > 0 %}
                    <div class="alert alert-warning m-3 border-start border-5 border-warning shadow-sm">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-cash-coin fs-1 me-3 text-warning"></i>
                            <div class="flex-grow-1">
                                <h5 class="alert-heading fw-bold mb-1">Pagamento Parcial Realizado</h5>
                                <div class="fs-6">
                                    Já pago: <strong>R$ {{ "%.2f"|format(order.total_paid) }}</strong>
                                    <span class="mx-2">|</span>
                                    Restante: <strong>R$ {{ "%.2f"|format(grand_total - order.total_paid) }}</strong>
                                </div>
                            </div>
                            {% if (grand_total - order.total_paid) <= 0.05 %}
                                <span class="badge bg-success fs-6">Quitado</span>
                            {% else %}
                                <span class="badge bg-warning text-dark fs-6">Pendente</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    <div id="standard-view" class="table-responsive">
                        <table class="table table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th class="text-center">Qtd</th>
                                    <th class="text-end">Preço Unit.</th>
                                    <th class="text-end">Total</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in grouped_order_items %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if item.print_status == 'printed' or item.printed %}
                                                <i class="bi bi-check-circle-fill text-success me-2 fs-5" title="Enviado para Produção"></i>
                                            {% elif item.print_status == 'error' %}
                                                <i class="bi bi-x-circle-fill text-danger me-2 fs-5" title="FALHA NA IMPRESSÃO - Verifique a Impressora"></i>
                                            {% else %}
                                                <i class="bi bi-hourglass-split text-secondary me-2 fs-5" title="Aguardando Envio"></i>
                                            {% endif %}
                                            <div>
                                                {{ item.name }}
                                                {% if item.flavor %} <br><small class="text-muted">{{ item.flavor }}</small>{% endif %}
                                                {% if item.complements %}
                                                <div class="small text-muted" style="font-size: 0.85em;">
                                                    {% for c in item.complements %}
                                                        {% if c.name is defined %}
                                                            + {{ c.name }} (R$ {{ "%.2f"|format(c.price) }})<br>
                                                        {% else %}
                                                            + {{ c }}<br>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                                {% endif %}
                                                {% for obs in item.observations %}
                                                <div class="text-danger small" style="font-size: 0.85em;"><i class="bi bi-pencil-fill"></i> {{ obs }}</div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center item-qty">{{ item.qty|int if item.qty % 1 == 0 else "%.1f"|format(item.qty) }}</td>
                                    <td class="text-end">R$ {{ "%.2f"|format(item.price) }}</td>
                                    <td class="text-end fw-bold item-total">
                                        R$ {{ "%.2f"|format(item.total) }}
                                    </td>
                                    <td class="text-end">
                                        {% if item.print_status == 'error' or (item.printed and item.print_status != 'printed') %}
                                        <form method="POST" style="display: inline;" onsubmit="return confirm('Reenviar {{ item.name }} para impressão?');">
                                            <input type="hidden" name="action" value="reprint_item">
                                            <input type="hidden" name="item_id" value="{{ item.ids[-1] }}">
                                            <button type="submit" class="btn btn-sm btn-outline-warning me-1" title="Reenviar Impressão">
                                                <i class="bi bi-printer"></i>
                                            </button>
                                        </form>
                                        {% endif %}

                                        {% if can_manage_items %}
                                        <button type="button" class="btn btn-sm btn-outline-primary me-1" title="Editar Item"
                                                data-id="{{ item.ids[-1] }}"
                                                data-name="{{ item.name }}"
                                                data-qty="{{ item.qty }}"
                                                data-obs="{{ item.observations|join(', ') }}"
                                                onclick="openEditItemModal(this)">
                                            <i class="bi bi-pencil-square"></i>
                                        </button>
                                        
                                        {% set unit_price = item.total / item.qty %}
                                        <div class="input-group input-group-sm mb-1 d-inline-flex w-auto cancel-group">
                                            <input type="text" class="form-control form-control-sm cancel-reason" placeholder="Motivo" style="width: 100px;">
                                            <button type="button" class="btn btn-outline-danger" title="Remover 1 unidade"
                                                    data-ids='{{ item.ids|tojson }}'
                                                    data-name="{{ item.name }}"
                                                    data-price="{{ unit_price }}"
                                                    onclick="cancelItem(this)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-info ms-1" title="Transferir Item" 
                                                data-id="{{ item.ids[-1] }}"
                                                data-name="{{ item.name }}"
                                                data-qty="{{ item.last_item_qty }}"
                                                onclick="openTransferModal(this)">
                                            <i class="bi bi-arrow-left-right"></i>
                                        </button>
                                        {% else %}
                                        <button type="button" class="btn btn-sm btn-outline-danger" title="Remover 1 unidade (Requer Autorização)" 
                                                data-id="{{ item.ids[-1] }}"
                                                data-name="{{ item.name }}"
                                                onclick="openDeleteModal(this)">
                                            <i class="bi bi-lock-fill"></i>
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">
                                        Nenhum item adicionado
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="fw-bold table-light">
                                    <td colspan="3" class="text-end">Subtotal:</td>
                                    <td class="text-end">R$ {{ "%.2f"|format(displayed_subtotal if displayed_subtotal is defined else order['total']) }}</td>
                                    <td></td>
                                </tr>
                                <tr class="table-light">
                                    <td colspan="3" class="text-end text-muted">Taxa de Serviço (10%):</td>
                                    <td class="text-end text-muted">R$ {{ "%.2f"|format(service_fee) }}</td>
                                    <td></td>
                                </tr>
                                <tr class="fw-bold table-success" style="font-size: 1.1em;">
                                    <td colspan="3" class="text-end">TOTAL GERAL:</td>
                                    <td class="text-end">R$ {{ "%.2f"|format(grand_total) }}</td>
                                    <td></td>
                                </tr>
                                {% if order.total_paid|default(0) > 0 %}
                                <tr class="fw-bold text-primary">
                                    <td colspan="3" class="text-end">Total Pago:</td>
                                    <td class="text-end">- R$ {{ "%.2f"|format(order.total_paid) }}</td>
                                    <td></td>
                                </tr>
                                <tr class="fw-bold text-danger" style="font-size: 1.2em;">
                                    <td colspan="3" class="text-end">RESTANTE:</td>
                                    <td class="text-end">R$ {{ "%.2f"|format(grand_total - order.total_paid) }}</td>
                                    <td></td>
                                </tr>
                                {% endif %}
                            </tfoot>
                        </table>
                    </div>

                    {% if order.partial_payments %}
                    <div class="mt-4 mb-3">
                        <h6 class="fw-bold text-primary border-bottom pb-2">Histórico de Pagamentos Parciais</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Data/Hora</th>
                                        <th>Responsável</th>
                                        <th>Método</th>
                                        <th class="text-end">Valor</th>
                                        <th class="text-center" style="width: 50px;">Ação</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for payment in order.partial_payments %}
                                    <tr>
                                        <td>{{ payment.timestamp }}</td>
                                        <td>{{ payment.user }}</td>
                                        <td>{{ payment.method }}</td>
                                        <td class="text-end fw-bold text-success">R$ {{ "%.2f"|format(payment.amount) }}</td>
                                        <td class="text-center">
                                            <form action="{{ url_for('restaurant.restaurant_table_order', table_id=table_id) }}" method="POST" onsubmit="return confirm('Tem certeza que deseja estornar este pagamento?');" style="margin: 0;">
                                                <input type="hidden" name="action" value="void_partial_payment">
                                                <input type="hidden" name="payment_id" value="{{ payment.id }}">
                                                <button type="submit" class="btn btn-sm btn-outline-danger py-0 px-2" title="Estornar">
                                                    <i class="bi bi-x-lg"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}

                    <!-- History View (Desagrupado) -->
                    <div id="history-view" class="table-responsive" style="display: none;">
                        <table class="table table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Atendente</th>
                                    <th>Produto</th>
                                    <th class="text-center">Qtd</th>
                                    <th class="text-end">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in order['items']|reverse %}
                                <tr>
                                    <td><small>{{ item.created_at if item.created_at else order.opened_at }}</small></td>
                                    <td><span class="badge bg-secondary">{{ item.waiter if item.waiter else 'N/A' }}</span></td>
                                    <td>
                                        {{ item.name }}
                                        {% if item.flavor %} <br><small class="text-muted">{{ item.flavor }}</small>{% endif %}
                                        {% if item.complements %}
                                        <div class="small text-muted">
                                            {% for c in item.complements %}
                                            + {{ c.name }}<br>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                        {% if item.observations %}
                                        <div class="small text-info fst-italic">
                                            Obs: {{ item.observations|join(', ') }}
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">{{ item.qty|int }}</td>
                                    <td class="text-end">
                                        {% set item_total = item.qty * item.price %}
                                        {% if item.complements %}
                                            {% set comps_total = item.complements|sum(attribute='price') * item.qty %}
                                            {% set item_total = item_total + comps_total %}
                                        {% endif %}
                                        R$ {{ "%.2f"|format(item_total) }}
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">Nenhum histórico disponível</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <script>
                function toggleHistoryView() {
                    const stdView = document.getElementById('standard-view');
                    const histView = document.getElementById('history-view');
                    const btn = document.getElementById('btnToggleHistory');
                    
                    if (stdView.style.display === 'none') {
                        stdView.style.display = 'block';
                        histView.style.display = 'none';
                        btn.innerHTML = '<i class="bi bi-clock-history"></i> Ver Histórico';
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-outline-primary');
                    } else {
                        stdView.style.display = 'none';
                        histView.style.display = 'block';
                        btn.innerHTML = '<i class="bi bi-list-ul"></i> Ver Pedido Agrupado';
                        btn.classList.remove('btn-outline-primary');
                        btn.classList.add('btn-primary');
                    }
                }
                </script>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% if order and mode != 'minibar' %}
<!-- Edit Pax Modal -->
<div class="modal fade" id="editPaxModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Atualizar Número de Adultos</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('restaurant.restaurant_table_order', table_id=table_id) }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="action" value="update_pax">
                    <div class="mb-3">
                        <label for="edit_num_adults" class="form-label fw-bold">Adultos na Mesa</label>
                        <input type="number"
                               class="form-control form-control-lg text-center"
                               id="edit_num_adults"
                               name="num_adults"
                               min="1"
                               required
                               value="{{ order.num_adults }}">
                        <div class="form-text">
                            Se a Música ao Vivo estiver ativa, novos adultos receberão Cover adicional.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Atualizar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Partial Payment Modal -->
<div class="modal fade" id="partialPaymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Adicionar Pagamento Parcial</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('restaurant.restaurant_table_order', table_id=table_id) }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="action" value="add_partial_payment">
                    
                    <div class="alert alert-info">
                        <div class="d-flex justify-content-between">
                            <span>Total Geral:</span>
                            <strong>R$ {{ "%.2f"|format(grand_total) }}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Já Pago:</span>
                            <strong>R$ {{ "%.2f"|format(order.total_paid|default(0)) }}</strong>
                        </div>
                        <div class="d-flex justify-content-between border-top mt-2 pt-2">
                            <span>Restante:</span>
                            <strong class="text-danger">R$ {{ "%.2f"|format(grand_total - order.total_paid|default(0)) }}</strong>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Valor do Pagamento</label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text">R$</span>
                            <input type="tel" class="form-control text-center fw-bold" name="amount" 
                                   placeholder="0.00" required onfocus="this.select()" 
                                   oninput="formatCurrency(this)">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Forma de Pagamento</label>
                        <div class="row g-2">
                            {% for method in payment_methods %}
                            <div class="col-6">
                                <input type="radio" class="btn-check" name="payment_method" id="partial_method_{{ method.id }}" value="{{ method.name }}" required>
                                <label class="btn btn-outline-primary w-100 py-2" for="partial_method_{{ method.id }}">
                                    {{ method.name }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Registrar Pagamento</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Checkout Modal -->
<div class="modal fade" id="checkoutModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Fechar Conta</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('restaurant.restaurant_table_order', table_id=table_id) }}" method="POST" id="checkoutForm">
                <div class="modal-body">
                    <input type="hidden" name="action" value="close_order">
                    <input type="hidden" name="payment_data" id="paymentData">
                    <input type="hidden" name="partial_only" id="partialOnlyInput" value="0">
                    
                    <h3 class="text-center mb-4">Total: R$ <span id="modalTotal">{{ "%.2f"|format(grand_total) }}</span></h3>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                             <div class="form-check form-switch pt-2">
                                <input class="form-check-input" type="checkbox" id="toggleServiceFee" name="remove_service_fee" onchange="recalculateTotal()">
                                <label class="form-check-label" for="toggleServiceFee">Remover 10% (R$ <span id="serviceFeeDisplay">{{ "%.2f"|format(service_fee) }}</span>)</label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">Desconto R$</span>
                                <input type="tel" class="form-control" id="discountInput" name="discount" onfocus="this.select()" oninput="formatCurrency(this); recalculateTotal()">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch p-3 bg-light rounded border">
                            <input class="form-check-input" type="checkbox" id="emitInvoice" name="emit_invoice" onchange="toggleCpfCnpj()">
                            <label class="form-check-label fw-bold text-primary" for="emitInvoice">
                                <i class="bi bi-receipt-cutoff"></i> Emitir Nota Fiscal
                            </label>
                            
                            <div class="mt-3" id="cpfCnpjContainer" style="display: none;">
                                <label class="form-label small text-muted">CPF ou CNPJ do Cliente (Opcional)</label>
                                <input type="text" class="form-control" name="customer_cpf_cnpj" placeholder="Apenas números">
                            </div>
                        </div>
                    </div>

                    <script>
                        function toggleCpfCnpj() {
                            const isChecked = document.getElementById('emitInvoice').checked;
                            const container = document.getElementById('cpfCnpjContainer');
                            container.style.display = isChecked ? 'block' : 'none';
                        }
                    </script>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Pagamentos Adicionados:</label>
                        <ul class="list-group mb-3" id="paymentList">
                            <!-- JS will populate this -->
                        </ul>
                        <div class="text-end fw-bold text-danger" id="remainingContainer">
                            Restante: R$ <span id="remainingAmount">{{ "%.2f"|format(grand_total) }}</span>
                        </div>
                    </div>

                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title">Adicionar Pagamento</h6>
                            
                            <div class="mb-3">
                                <label class="form-label">Valor a Pagar</label>
                                <input type="tel" class="form-control form-control-lg text-center fw-bold" id="newPaymentAmount" placeholder="R$ 0.00" onfocus="this.select()" oninput="formatCurrency(this)">
                            </div>

                            <div class="d-grid gap-2">
                                <label class="form-label">Selecione a Forma de Pagamento:</label>
                                <div class="row g-2">
                                    {% for method in payment_methods %}
                                    <div class="col-6">
                                        <button type="button" class="btn btn-outline-primary w-100 py-3" onclick="addPayment('{{ method.id }}', '{{ method.name }}')">
                                            <i class="bi bi-wallet2 me-2"></i>{{ method.name }}
                                        </button>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-outline-primary" id="partialPaymentBtn" onclick="setPartialMode(true)">Pagamento Parcial</button>
                    <button type="submit" class="btn btn-success" id="confirmPaymentBtn" onclick="setPartialMode(false)" disabled>Confirmar Pagamento</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Cancel Table Modal -->
<div class="modal fade" id="cancelTableModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Cancelar Mesa</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja cancelar esta mesa?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> Todos os itens serão estornados para o estoque.<br>
                    <i class="bi bi-trash"></i> A mesa será excluída permanentemente.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <form action="{{ url_for('restaurant.restaurant_table_order', table_id=table_id) }}" method="POST">
                    <input type="hidden" name="action" value="cancel_table">
                    <button type="submit" class="btn btn-danger">Confirmar Cancelamento</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Authorization Modal -->
<div class="modal fade" id="deleteAuthModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Autorização Necessária</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('restaurant.restaurant_table_order', table_id=table_id) }}" method="POST">
                <div class="modal-body">
                    <p class="small text-muted">Um gerente ou administrador deve autorizar a exclusão de:</p>
                    <p class="fw-bold text-center" id="deleteItemNameDisplay"></p>
                    
                    <input type="hidden" name="action" value="remove_item">
                    <input type="hidden" name="item_index" id="deleteItemIndex">
                    <input type="hidden" name="item_id" id="deleteItemId">
                    <input type="hidden" name="product_name" id="deleteItemNameHidden">
                    
                    <div class="mb-3">
                        <label class="form-label">Justificativa do Cancelamento</label>
                        <textarea class="form-control" name="cancellation_reason" required rows="2" placeholder="Motivo do cancelamento..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Senha de Autorização</label>
                        <input type="password" class="form-control text-center fs-4" name="auth_password" required autofocus autocomplete="off" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="****">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger btn-sm">Autorizar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Transfer Item Modal -->
<div class="modal fade" id="transferItemModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Transferir Item</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Transferir item da Mesa <strong>{{ table_id }}</strong></p>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Produto</label>
                    <input type="text" class="form-control" id="transferItemName" readonly>
                    <input type="hidden" id="transferItemIndex">
                    <input type="hidden" id="transferItemId">
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Quantidade</label>
                    <input type="number" class="form-control" id="transferItemQty" min="0.1" step="0.1" required>
                    <div class="form-text">Máximo disponível: <span id="transferItemMaxQty"></span></div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Mesa de Destino</label>
                    <select class="form-select" id="transferItemTarget" onchange="checkTransferTarget(this)">
                        <option value="">Selecione a mesa...</option>
                        {% for t_id in all_tables %}
                            {% if t_id|int != table_id|int %}
                                {% set is_occupied = t_id in occupied_tables %}
                                <option value="{{ t_id }}" 
                                        {% if is_occupied %}data-occupied="true" class="fw-bold text-danger"{% else %}data-occupied="false" class="text-success"{% endif %}>
                                    Mesa {{ t_id }} {% if is_occupied %}(OCUPADA){% else %}(Livre){% endif %}
                                </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    <div id="transferTargetStatus" class="mt-2 small fw-bold"></div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Observações (Opcional)</label>
                    <textarea class="form-control" id="transferItemObs" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-info text-white" onclick="submitTransferItem()">Transferir</button>
            </div>
        </div>
    </div>
</div>

<script type="application/json" id="flavor-groups-data">
    {{ flavor_groups|default([])|tojson }}
</script>
<script type="application/json" id="products-data">
    {{ products|tojson|default('[]') }}
</script>
<script type="application/json" id="complements-data">
    {{ complements|tojson|default('[]') }}
</script>
<script type="application/json" id="observations-data">
    {{ observations|tojson|default('[]') }}
</script>
<script type="application/json" id="grand-total-data">
    {{ grand_total|default(0) }}
</script>
<script type="application/json" id="service-fee-data">
    {{ service_fee|default(0) }}
</script>
<script type="application/json" id="paid-amount-data">
    {{ order.total_paid|default(0) if order else 0 }}
</script>

<!-- Transfer to Room Modal (For manual room selection) -->
<div class="modal fade" id="transferToRoomModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Enviar para Quarto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('restaurant.restaurant_table_order', table_id=table_id) }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="action" value="transfer_to_room">
                    <p>Transferir o total desta mesa para a conta de um quarto.</p>
                    <div class="mb-3">
                        <label class="form-label">Número do Quarto</label>
                        <select class="form-select" name="room_number" required>
                            <option value="">Selecione...</option>
                            {% for i in range(1, 36) %}
                            <option value="{{ i }}">Quarto {{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Confirmar Transferência</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Transfer Modal -->
<div class="modal fade" id="transferModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">Transferir Mesa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('restaurant.restaurant_table_order', table_id=table_id) }}" method="POST" id="transferForm">
                <div class="modal-body">
                    <input type="hidden" name="action" value="transfer_table">
                    <p>Transferir todos os pedidos desta mesa para outra.</p>
                    
                    <div class="mb-3">
                        <label for="target_table_id" class="form-label">Mesa de Destino</label>
                        <select class="form-select" id="target_table_id" name="target_table_id" required>
                            <option value="">Selecione a mesa...</option>
                            {% for t_id in all_tables %}
                                {% if t_id|int != table_id|int %}
                                    {% set is_occupied = t_id in occupied_tables %}
                                    <option value="{{ t_id }}" 
                                            {% if is_occupied %}class="fw-bold text-danger"{% else %}class="text-success"{% endif %}>
                                        Mesa {{ t_id }} {% if is_occupied %}(OCUPADA - Será mesclada){% else %}(Livre){% endif %}
                                    </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        <div class="form-text">Selecione uma mesa válida. Para quartos, use a opção "Enviar para Quarto".</div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-dark" onclick="document.getElementById('target_table_id').value = '{{ breakfast_table_id }}'">
                            <i class="bi bi-cup-hot"></i> Café da Manhã (Mesa {{ breakfast_table_id }})
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" onclick="checkTransfer()">Transferir</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    console.log('Table Order Script Loaded');
    
    // Global error handler for this script
    window.onerror = function(msg, url, lineNo, columnNo, error) {
        console.error('Error: ' + msg + '\nURL: ' + url + '\nLine: ' + lineNo + '\nColumn: ' + columnNo + '\nError object: ' + JSON.stringify(error));
        return false;
    };

    let allProducts = [];
    try {
        const productsDataEl = document.getElementById('products-data');
        if (productsDataEl && productsDataEl.textContent) {
            allProducts = JSON.parse(productsDataEl.textContent);
            console.log('Products loaded:', allProducts.length);
        } else {
            console.warn('Products data element not found or empty');
            allProducts = [];
        }
    } catch (e) {
        console.error('CRITICAL: Failed to parse products data:', e);
        alert('Erro crítico ao carregar dados dos produtos. Por favor, recarregue a página.');
        allProducts = [];
    }
    
    // Delete Authorization
    window.openDeleteModal = function(btn) {
        const index = btn.dataset.index || -1;
        const id = btn.dataset.id || '';
        const name = btn.dataset.name;
        
        document.getElementById('deleteItemIndex').value = index;
        document.getElementById('deleteItemId').value = id;
        document.getElementById('deleteItemNameDisplay').textContent = name;
        document.getElementById('deleteItemNameHidden').value = name;
        document.getElementById('cancellationReason').value = ""; // Clear previous reason
        
        var myModal = new bootstrap.Modal(document.getElementById('deleteAuthModal'));
        myModal.show();
    };
    
    // Transfer Item Logic
    window.openTransferModal = function(btn) {
        const index = btn.dataset.index || -1;
        const id = btn.dataset.id || '';
        const name = btn.dataset.name;
        const qty = parseFloat(btn.dataset.qty);

        document.getElementById('transferItemIndex').value = index;
        document.getElementById('transferItemId').value = id;
        document.getElementById('transferItemName').value = name;
        document.getElementById('transferItemQty').value = qty;
        document.getElementById('transferItemQty').max = qty;
        document.getElementById('transferItemMaxQty').textContent = qty;
        document.getElementById('transferItemTarget').value = "";
        document.getElementById('transferTargetStatus').textContent = "";
        document.getElementById('transferItemObs').value = "";
        
        var myModal = new bootstrap.Modal(document.getElementById('transferItemModal'));
        myModal.show();
    };

    window.checkTransferTarget = function(selectElement) {
        const statusDiv = document.getElementById('transferTargetStatus');
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        
        if (!selectedOption || !selectedOption.value) {
            statusDiv.textContent = '';
            statusDiv.className = 'mt-2 small fw-bold';
            return;
        }

        const isOccupied = selectedOption.getAttribute('data-occupied') === 'true';
        const targetTable = selectedOption.value;
        console.log('Checking transfer target:', targetTable, 'Occupied:', isOccupied);

        // Validate Table 1-35 (Only if numeric)
        // Check if it's a numeric ID (and not a staff ID starting with FUNC_)
        if (/^\d+$/.test(targetTable)) {
            const tableId = parseInt(targetTable);
            if (tableId >= 1 && tableId <= 35) {
                 statusDiv.textContent = 'Erro: Transferência para quartos (1-35) não permitida por aqui.';
                 statusDiv.className = 'mt-2 small fw-bold text-danger';
                 selectElement.value = ""; // Reset selection
                 return;
            }
        }

        if (isOccupied) {
            statusDiv.textContent = 'Nota: Mesa já ocupada. O item será adicionado à conta existente.';
            statusDiv.className = 'mt-2 small fw-bold text-warning';
        } else {
            statusDiv.textContent = 'Mesa Livre - Disponível para transferência.';
            statusDiv.className = 'mt-2 small fw-bold text-success';
        }
    };

    window.submitTransferItem = function() {
        const index = document.getElementById('transferItemIndex').value;
        const id = document.getElementById('transferItemId').value;
        const qty = parseFloat(document.getElementById('transferItemQty').value);
        const maxQty = parseFloat(document.getElementById('transferItemMaxQty').textContent);
        const targetSelect = document.getElementById('transferItemTarget');
        const targetTable = targetSelect.value;
        const obs = document.getElementById('transferItemObs').value;

        console.log('Submitting transfer. Target:', targetTable, 'Qty:', qty);

        if (!targetTable) {
            alert('Por favor, selecione a mesa de destino.');
            return;
        }

        // Real-time Validation Checks
        const selectedOption = targetSelect.options[targetSelect.selectedIndex];
        const isOccupied = selectedOption.getAttribute('data-occupied') === 'true';

        // Check 1: Invalid Range (Rooms) - Only if numeric
        if (/^\d+$/.test(targetTable)) {
            const tableId = parseInt(targetTable);
            if (tableId >= 1 && tableId <= 35) {
                alert('Erro: Não é permitido transferir itens individualmente para quartos (Mesas 1-35). Use a função "Enviar para Quarto" se necessário.');
                return;
            }
        }

        // Check 2: Occupied Table - ALLOWED (Merged) but maybe confirm?
        // Backend handles merging, so we just allow it. The previous block was incorrect.
        if (isOccupied) {
            console.log('Transferring to occupied table (Merge operation)');
        }

        if (isNaN(qty) || qty <= 0 || qty > maxQty) {
            alert('Quantidade inválida.');
            return;
        }

        let confirmMsg = 'Confirmar transferência deste item para a Mesa ' + targetTable + '?';
        if (isOccupied) {
            confirmMsg += '\n\nATENÇÃO: A mesa de destino já está ocupada. O item será adicionado à conta existente.';
        }

        if (!confirm(confirmMsg)) return;

        fetch('/restaurant/transfer_item', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                source_table_id: '{{ table_id }}',
                target_table_id: targetTable,
                item_index: parseInt(index),
                item_id: id,
                qty: qty,
                observations: obs
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Transferência realizada com sucesso!');
                location.reload();
            } else {
                alert('Erro: ' + (data.error || 'Falha desconhecida'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao processar transferência.');
        });
    };

    // Cancel Item Logic (AJAX)
    window.cancelItem = function(btn) {
        // Read data attributes
        const itemName = btn.getAttribute('data-name');
        const unitPrice = parseFloat(btn.getAttribute('data-price'));

        const group = btn.closest('.cancel-group');
        const reasonInput = group.querySelector('.cancel-reason');
        const reason = reasonInput.value.trim();

        if (!reason) {
            alert('Por favor, informe o motivo do cancelamento.');
            reasonInput.focus();
            return;
        }

        // Get IDs from data attribute
        let ids = [];
        try {
            // Using dataset is safer for JSON
            const idsData = btn.getAttribute('data-ids');
            ids = JSON.parse(idsData || '[]');
        } catch (e) {
            console.error('Failed to parse IDs', e);
            alert('Erro interno: IDs inválidos.');
            return;
        }

        if (ids.length === 0) {
            alert('Erro: Nenhum ID disponível para cancelamento neste agrupamento. Atualize a página.');
            return;
        }

        // Use the last ID (stack behavior)
        const itemId = ids[ids.length - 1];

        if (!confirm('Remover 1 unidade de ' + itemName + '?')) {
            return;
        }

        // UI Feedback - Spinner
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

        const formData = new FormData();
        formData.append('action', 'remove_item');
        formData.append('item_id', itemId);
        formData.append('product_name', itemName);
        formData.append('cancellation_reason', reason);

        fetch(window.location.href, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update IDs list
                ids.pop(); // Remove used ID
                btn.setAttribute('data-ids', JSON.stringify(ids));

                // Update UI
                const row = btn.closest('tr');
                const qtyCell = row.querySelector('.item-qty');
                const totalCell = row.querySelector('.item-total');
                
                let currentQty = parseFloat(qtyCell.innerText);
                let newQty = currentQty - 1;

                if (newQty <= 0.001) { // Floating point safety
                    row.remove();
                } else {
                    qtyCell.innerText = newQty % 1 === 0 ? parseInt(newQty) : newQty.toFixed(1);
                    
                    // Update Row Total
                    let newRowTotal = newQty * unitPrice;
                    totalCell.innerText = 'R$ ' + newRowTotal.toFixed(2);
                }

                // Update Grand Total (Footer)
                const tfoot = document.querySelector('table tfoot');
                if (tfoot) {
                    const grandTotalRow = tfoot.querySelector('.table-success');
                    if (grandTotalRow) {
                        // The structure is: <td colspan="3" class="text-end">TOTAL GERAL:</td> <td class="text-end">R$ ...</td>
                        // So it's the 2nd cell (index 1)
                        const grandTotalCell = grandTotalRow.children[1];
                        if (grandTotalCell) {
                             grandTotalCell.innerText = 'R$ ' + parseFloat(data.new_total).toFixed(2);
                        }
                    }
                    
                    // Also update Subtotal (first row)
                    const subtotalRow = tfoot.rows[0];
                    if (subtotalRow) {
                         const subtotalCell = subtotalRow.children[1];
                         if (subtotalCell) {
                             // Approximation: If service fee is fixed/calc server side, we might miss it here.
                             // But we can assume data.new_total is the grand total. 
                             // If service fee is 10%, Subtotal = Total / 1.1
                             // But let's just update Grand Total as it's the most critical.
                         }
                    }
                }
                
                // Optional: Show a transient success message instead of alert
                // alert(data.message); 
                // Clear input
                reasonInput.value = '';
                
            } else {
                alert('Erro: ' + (data.error || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro de conexão ao remover item.');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        });
    };

    // Table Transfer Logic
    window.checkTransfer = function() {
        const targetId = document.getElementById('target_table_id').value;
        if (!targetId) {
            alert('Por favor, informe a mesa de destino.');
            return;
        }
        
        // Basic confirmation
        if (confirm('Tem certeza que deseja transferir TODA a mesa para o destino ' + targetId + '?')) {
            document.getElementById('transferForm').submit();
        }
    };

    
    // Injected Data
    const allComplements = JSON.parse(document.getElementById('complements-data').textContent);
    const allObservations = JSON.parse(document.getElementById('observations-data').textContent);
    const allFlavorGroups = JSON.parse(document.getElementById('flavor-groups-data').textContent || '[]');

    // Multi-Payment Logic
    let initialGrandTotal = parseFloat(document.getElementById('grand-total-data').textContent);
    let initialServiceFee = parseFloat(document.getElementById('service-fee-data').textContent);
    let paidAmount = 0;
    const paidAmountEl = document.getElementById('paid-amount-data');
    if (paidAmountEl) {
        const parsedPaid = parseFloat(paidAmountEl.textContent);
        if (!isNaN(parsedPaid) && parsedPaid > 0) {
            paidAmount = parsedPaid;
        }
    }
    let grandTotal = initialGrandTotal;
    let payments = [];

    window.formatCurrency = function(input) {
        let value = input.value.replace(/\D/g, '');
        if (value === '') {
            input.value = '';
            return;
        }
        let floatVal = parseInt(value) / 100;
        input.value = floatVal.toFixed(2);
    };

    window.recalculateTotal = function() {
        const removeFee = document.getElementById('toggleServiceFee').checked;
        const discountVal = parseFloat(document.getElementById('discountInput').value) || 0;
        
        let newTotal = initialGrandTotal;
        
        if (removeFee) {
            newTotal -= initialServiceFee;
        }
        
        newTotal -= discountVal;
        newTotal -= paidAmount;
        if (newTotal < 0) newTotal = 0;
        
        grandTotal = newTotal; // Update global variable used by payment logic
        document.getElementById('modalTotal').textContent = grandTotal.toFixed(2);
        
        updatePaymentUI();
    };

    window.addPayment = function(methodId, methodName) {
        const amountInput = document.getElementById('newPaymentAmount');
        let amount = parseFloat(amountInput.value);

        if (!methodId || isNaN(amount) || amount <= 0) {
            alert('Valor inválido.');
            return;
        }
        
        // Calculate current total paid
        const currentPaid = payments.reduce((sum, p) => sum + p.amount, 0);
        const remaining = grandTotal - currentPaid;

        // Check if Cash Payment (allows change)
        const isCash = methodName.toLowerCase().includes('dinheiro');

        if (!isCash && amount > remaining + 0.01) { // Tolerance for float errors
            alert('O valor excede o restante a pagar.');
            amount = remaining; 
        }

        payments.push({
            id: methodId,
            name: methodName,
            amount: amount
        });

        // Reset input for next payment (auto-fill remaining)
        amountInput.value = "";
        
        // Determine next auto-fill amount
        const nextRemaining = grandTotal - payments.reduce((sum, p) => sum + p.amount, 0);
        if (nextRemaining > 0) {
            amountInput.value = nextRemaining.toFixed(2);
        } else {
             amountInput.value = "0.00";
        }

        updatePaymentUI();
    };

    window.removePayment = function(index) {
        payments.splice(index, 1);
        updatePaymentUI();
    };

    function updatePaymentUI() {
        const list = document.getElementById('paymentList');
        list.innerHTML = '';
        
        let totalPaid = 0;

        payments.forEach((p, index) => {
            totalPaid += p.amount;
            const item = document.createElement('li');
            item.className = 'list-group-item d-flex justify-content-between align-items-center';
            item.innerHTML = `
                <span>${p.name}</span>
                <span class="badge bg-primary rounded-pill me-2">R$ ${p.amount.toFixed(2)}</span>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removePayment(${index})">&times;</button>
            `;
            list.appendChild(item);
        });

        const remaining = grandTotal - totalPaid;
        const remainingSpan = document.getElementById('remainingAmount');
        const remainingContainer = document.getElementById('remainingContainer');
        
        // Change logic
        if (remaining < -0.01) {
             const change = Math.abs(remaining);
             remainingContainer.classList.remove('text-danger', 'text-success');
             remainingContainer.classList.add('text-primary');
             remainingContainer.innerHTML = 'Troco: R$ <span id="remainingAmount">' + change.toFixed(2) + '</span>';
             document.getElementById('confirmPaymentBtn').disabled = false;
        } else if (remaining <= 0.01) {
             remainingContainer.classList.remove('text-danger', 'text-primary');
             remainingContainer.classList.add('text-success');
             remainingContainer.innerHTML = 'Pagamento Completo <i class="bi bi-check-circle"></i>';
             document.getElementById('confirmPaymentBtn').disabled = false;
        } else {
             remainingContainer.classList.remove('text-success', 'text-primary');
             remainingContainer.classList.add('text-danger');
             remainingContainer.innerHTML = 'Restante: R$ <span id="remainingAmount">' + Math.abs(remaining).toFixed(2) + '</span>';
             document.getElementById('confirmPaymentBtn').disabled = true;
        }

        // Update Status Badge
        const statusBadge = document.getElementById('statusBadge');
        if (statusBadge) {
             if (remaining <= 0.01) {
                 statusBadge.className = 'badge bg-success text-white ms-2 fs-6 align-middle';
                 statusBadge.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i> Paga';
             } else {
                 statusBadge.className = 'badge bg-warning text-dark ms-2 fs-6 align-middle';
                 statusBadge.innerHTML = '<i class="bi bi-pie-chart-fill me-1"></i> Parcialmente Paga';
             }
        }
        
        // Pre-fill input if empty and remaining > 0
        const amountInput = document.getElementById('newPaymentAmount');
        if (amountInput.value === '' && remaining > 0) {
             amountInput.value = remaining.toFixed(2);
        }

        // Update hidden JSON
        document.getElementById('paymentData').value = JSON.stringify(payments);
    }

    window.setPartialMode = function(isPartial) {
        const input = document.getElementById('partialOnlyInput');
        if (input) {
            input.value = isPartial ? '1' : '0';
        }
    };

    // Initialize Modal
    const checkoutModal = document.getElementById('checkoutModal');
    if (checkoutModal) {
        checkoutModal.addEventListener('shown.bs.modal', function () {
            payments = [];
            updatePaymentUI();
            // Auto-fill first amount
            const modalTotalEl = document.getElementById('modalTotal');
            if (modalTotalEl) {
                 // Recalculate based on current state (service fee might be unchecked)
                 // But strictly, we should just use the grandTotal global
                 document.getElementById('newPaymentAmount').value = grandTotal.toFixed(2);
            }
        });
        
        // Auto-open if requested
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('open_checkout') === 'true') {
            const modal = new bootstrap.Modal(checkoutModal);
            modal.show();
        }
    }

    
    window.selectCategoryByIndex = function(index, btn) {
        try {
            console.log('selectCategoryByIndex called with index:', index);
            
            // Visual feedback on buttons
            document.querySelectorAll('.category-btn').forEach(b => {
                b.classList.remove('btn-primary', 'text-white');
                b.classList.add('btn-outline-primary');
            });
            if (btn) {
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-primary', 'text-white');
            }
            
            // Loading feedback (hidden immediately if found)
            const msg = document.getElementById('instruction-msg');
            if (msg) {
                msg.style.display = 'block';
                msg.innerHTML = '<div class="text-muted py-5"><div class="spinner-border spinner-border-sm me-2" role="status"></div>Carregando produtos...</div>';
            }
            
            // Hide all groups first
            document.querySelectorAll('.product-group').forEach(g => {
                g.style.display = 'none';
                g.classList.remove('active-group'); // Optional helper class
            });
            
            const gid = 'group_' + index;
            const target = document.getElementById(gid);
            
            if (target) {
                console.log('Found target group:', target.id);
                // Use setProperty for priority
                target.style.setProperty('display', 'block', 'important');
                target.classList.add('active-group');
                
                // Check if group is empty
                const products = target.querySelectorAll('.product-btn');
                if (products.length === 0) {
                     if (msg) {
                         msg.innerHTML = '<div class="alert alert-warning my-2">Esta categoria não possui produtos disponíveis.</div>';
                     }
                } else {
                     if (msg) msg.style.display = 'none';
                }
            } else {
                console.error('CRITICAL: Product group not found for index:', index, 'Expected ID:', gid);
                // Try to find by index attribute as fallback if IDs are messed up
                const fallback = document.querySelector(`.product-group[data-index="${index}"]`);
                 if (fallback) {
                     console.log('Found group via fallback data-index');
                     fallback.style.display = 'block';
                     if (msg) msg.style.display = 'none';
                 } else {
                    if (msg) {
                        msg.innerHTML = '<div class="alert alert-warning my-2">Erro de interface: Grupo de produtos não encontrado (ID: ' + gid + '). Recarregue a página.</div>';
                    }
                 }
            }
        } catch (e) {
            console.error('Error selecting category by index:', e);
            const msg = document.getElementById('instruction-msg');
            if (msg) {
                msg.style.display = 'block';
                msg.innerHTML = '<div class="alert alert-danger my-2">Ocorreu um erro ao selecionar a categoria. Verifique o console.</div>';
            }
        }
    };

    window.selectCategoryByName = function(name, btn) {
        try {
            console.log('Selecting category by name:', name);
            
            // Visual feedback on buttons
            document.querySelectorAll('.category-btn').forEach(b => {
                b.classList.remove('btn-primary', 'text-white');
                b.classList.add('btn-outline-primary');
            });
            if (btn) {
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-primary', 'text-white');
            }
            
            const msg = document.getElementById('instruction-msg');
            if (msg) {
                msg.style.display = 'block';
                msg.innerHTML = '<div class="text-muted py-5"><div class="spinner-border spinner-border-sm me-2" role="status"></div>Carregando produtos...</div>';
            }
            
            // Hide all groups first
            document.querySelectorAll('.product-group').forEach(g => g.style.display = 'none');
            
            let target = null;
            const groups = document.querySelectorAll('.product-group');
            console.log(`Searching for group with data-cat="${name}" among ${groups.length} groups`);
            
            for (const g of groups) {
                const gCat = g.getAttribute('data-cat');
                // Loose matching: trim and case-insensitive if needed, but strict for now with trim
                if (gCat && gCat.trim() === name.trim()) {
                    target = g;
                    break;
                }
            }
            
            if (target) {
                console.log('Found target group:', target.id);
                if (msg) msg.style.display = 'none';
                target.style.display = 'block';
            } else {
                console.error('Product group not found for category:', name);
                console.log('Available groups:', Array.from(groups).map(g => g.getAttribute('data-cat')));
                
                if (msg) {
                    msg.style.display = 'block';
                    msg.innerHTML = '<div class="alert alert-warning my-2">Não foi possível carregar os produtos da categoria selecionada. (' + name + ')</div>';
                }
            }
        } catch (e) {
            console.error('Error selecting category by name:', e);
            const msg = document.getElementById('instruction-msg');
            if (msg) {
                msg.style.display = 'block';
                msg.innerHTML = '<div class="alert alert-danger my-2">Ocorreu um erro ao selecionar a categoria. Verifique o console.</div>';
            }
        }
    };

    window.selectProductFromId = function(id, btn) {
        console.log('Selecting product by ID:', id);
        // Ensure ID types match (string vs number)
        const product = allProducts.find(p => p.id == id);
        
        if (!product) {
            console.error('Product not found in allProducts for ID:', id);
            console.log('Total products loaded:', allProducts.length);
            alert('Erro: Produto não encontrado nos dados carregados.');
            return;
        }
        
        console.log('Product found:', product.name);
        window.currentSelectedProduct = product;
        window.selectProduct(btn, product);
    };

    window.selectProduct = function(btn, product) {
        window.currentSelectedProduct = product;
        // Remove active class from all buttons
        document.querySelectorAll('.product-btn').forEach(b => {
            b.classList.remove('btn-primary', 'text-white');
            b.classList.add('btn-outline-secondary');
        });
        
        // Add active class to clicked button
        if (btn) {
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-primary', 'text-white');
        }
        
        // Extract basic info
        const productName = product.name;
        const category = product.category;

        // Update hidden input
        document.getElementById('selected_product').value = productName;
        
        // Handle Flavors
        const flavorContainer = document.getElementById('flavors-container');
        const flavorList = document.getElementById('flavors-list');
        
        if (flavorContainer && flavorList) {
            flavorList.innerHTML = '';
            flavorContainer.style.display = 'none'; // Default hide
            
                if (product.flavor_group_id) {
                     const group = allFlavorGroups.find(g => g.id === product.flavor_group_id);
                     
                     if (group && group.items && group.items.length > 0) {
                        // Check if SINGLE item and SIMPLE
                        const simpleItem = group.items.find(i => i.is_simple);
                        
                        if (group.items.length === 1 && simpleItem) {
                            // Auto-select ONLY if it is the ONLY option
                            flavorContainer.style.display = 'none';
                            const div = document.createElement('div');
                            div.innerHTML = `<input type="hidden" name="selected_flavor" value="${simpleItem.id}">`;
                            flavorList.appendChild(div);
                        } else {
                            flavorContainer.style.display = 'block';
                            
                            // Determine input type based on max_flavors
                            const maxFlavors = product.max_flavors || 1;
                            const inputType = maxFlavors > 1 ? 'checkbox' : 'radio';
                            const inputName = maxFlavors > 1 ? 'selected_flavors' : 'selected_flavor';
                            
                            // Add instructions
                            if (maxFlavors > 1) {
                                const instruction = document.createElement('div');
                                instruction.className = 'alert alert-info py-1 px-2 mb-2 small';
                                instruction.innerHTML = `<i class="bi bi-info-circle"></i> Escolha até <b>${maxFlavors}</b> sabores.`;
                                flavorList.appendChild(instruction);
                            }

                            group.items.forEach((flavor, idx) => {
                                const div = document.createElement('div');
                                div.className = 'form-check mb-2';
                                
                                // Onclick handler for limits
                                const clickHandler = maxFlavors > 1 ? `onclick="handleFlavorLimit(this, ${maxFlavors})"` : '';

                                // Auto-check the first simple item if it's a radio group (default selection)
                                const isChecked = (inputType === 'radio' && idx === 0) ? 'checked' : '';

                                div.innerHTML = `
                                   <input class="form-check-input flavor-check" type="${inputType}" name="${inputName}" value="${flavor.id}" id="flavor_${flavor.id}" data-name="${flavor.name}" ${clickHandler} ${isChecked}>
                                   <label class="form-check-label w-100" for="flavor_${flavor.id}" style="cursor: pointer;">
                                       ${flavor.name}
                                   </label>
                                `;
                                flavorList.appendChild(div);
                            });
                        }
                   }
                }
            }
        
        // Handle Accompaniments
        const accContainer = document.getElementById('accompaniments-container');
        const accList = document.getElementById('accompaniments-list');
        
        if (accContainer && accList) {
            accList.innerHTML = ''; // Clear previous
            
            if (product.has_accompaniments && product.allowed_accompaniments && product.allowed_accompaniments.length > 0) {
                accContainer.style.display = 'block';
                
                // Filter allowed products
                const allowedIds = product.allowed_accompaniments;
                const accompaniments = allProducts.filter(p => allowedIds.some(id => id == p.id));
                
                accompaniments.forEach(acc => {
                    const div = document.createElement('div');
                    div.className = 'form-check mb-2';
                    div.innerHTML = `
                        <input class="form-check-input" type="checkbox" name="accompaniments" value="${acc.id}" id="acc_${acc.id}">
                        <label class="form-check-label d-flex justify-content-between w-100 pe-3" for="acc_${acc.id}" style="cursor: pointer;">
                            <span>${acc.name}</span>
                            <span class="text-muted fw-bold">+ R$ ${parseFloat(acc.price).toFixed(2)}</span>
                        </label>
                    `;
                    accList.appendChild(div);
                });
            } else {
                accContainer.style.display = 'none';
            }
        }
        
        // Handle Mandatory Questions
        const questionsContainer = document.getElementById('questions-container');
        const questionsList = document.getElementById('questions-list');
        
        console.log('Handling Mandatory Questions for:', product.name);
        console.log('Product data:', product);
        
        if (questionsContainer && questionsList) {
            questionsList.innerHTML = '';
            questionsContainer.style.display = 'none';

            if (product.mandatory_questions && product.mandatory_questions.length > 0) {
                console.log('Found mandatory questions:', product.mandatory_questions);
                questionsContainer.style.setProperty('display', 'block', 'important');
                
                product.mandatory_questions.forEach((q, idx) => {
                    console.log('Rendering question:', q);
                    const div = document.createElement('div');
                    div.className = 'mb-3 border-bottom pb-2';
                    const requiredStar = q.required ? '<span class="text-danger">*</span>' : '';
                    
                    let inputHtml = '';
                    const inputName = `question_${idx}`;
                    
                    // Normalize types
                    const type = q.type || 'text';
                    
                    if (type === 'text') {
                        inputHtml = `<input type="text" class="form-control" name="${inputName}" data-question="${q.question}" ${q.required ? 'required' : ''}>`;
                    } else if (type === 'single_choice' || type === 'choice') {
                        // Radio buttons (Single Choice)
                        q.options.forEach((opt, optIdx) => {
                            inputHtml += `
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="${inputName}" id="${inputName}_${optIdx}" value="${opt}" data-question="${q.question}" ${q.required && optIdx === 0 ? '' : ''}>
                                    <label class="form-check-label" for="${inputName}_${optIdx}">${opt}</label>
                                </div>`;
                        });
                    } else if (type === 'multiple_choice' || type === 'check') {
                        // Checkboxes (Multiple Choice)
                        q.options.forEach((opt, optIdx) => {
                            inputHtml += `
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="${inputName}" id="${inputName}_${optIdx}" value="${opt}" data-question="${q.question}">
                                    <label class="form-check-label" for="${inputName}_${optIdx}">${opt}</label>
                                </div>`;
                        });
                    }
                    
                    div.innerHTML = `
                        <label class="form-label fw-bold small">${q.question} ${requiredStar}</label>
                        ${inputHtml}
                    `;
                    questionsList.appendChild(div);
                });
            }
        }

        // Filter Complements
        const container = document.getElementById('complements-container');
        const list = document.getElementById('complements-list');
        if (container && list) {
            list.innerHTML = '';
            
            const filteredComplements = allComplements.filter(c => c.category === category);
            
            if (filteredComplements.length > 0) {
                container.style.display = 'block';
                filteredComplements.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'form-check mb-2';
                    div.innerHTML = `
                        <input class="form-check-input" type="checkbox" name="complements" value="${c.id}" id="comp_${c.id}">
                        <label class="form-check-label d-flex justify-content-between w-100 pe-3" for="comp_${c.id}" style="cursor: pointer;">
                            <span>${c.name}</span>
                            <span class="text-muted fw-bold">+ R$ ${c.price.toFixed(2)}</span>
                        </label>
                    `;
                    list.appendChild(div);
                });
            } else {
                container.style.display = 'none';
            }
        }

        // Filter Observations
        const obsContainer = document.getElementById('observations-container');
        const obsList = document.getElementById('observations-list');
        const customObsInput = document.getElementById('custom-observation');
        
        if (obsContainer && obsList) {
            obsList.innerHTML = '';
            if (customObsInput) customObsInput.value = '';

            const filteredObs = allObservations.filter(o => o.categories.includes(category));
            
            filteredObs.forEach(o => {
                const div = document.createElement('div');
                div.className = 'form-check mb-2';
                
                // Tooltip for "Não Imprimir"
                const isNoPrint = o.text === 'Não Imprimir';
                const tooltipAttr = isNoPrint ? 'title="Este item NÃO será enviado para a impressora da cozinha/balcão."' : '';
                const labelContent = isNoPrint ? `${o.text} <i class="bi bi-printer-slash text-danger ms-1"></i>` : o.text;
                
                div.innerHTML = `
                    <input class="form-check-input" type="checkbox" name="observations" value="${o.text}" id="obs_${o.id}">
                    <label class="form-check-label w-100" for="obs_${o.id}" style="cursor: pointer;" ${tooltipAttr}>
                        ${labelContent}
                    </label>
                `;
                obsList.appendChild(div);
            });
            
            // Always show container to allow custom inputs
            obsContainer.style.display = 'block';
        }
        
        // Enable submit button
        const submitBtn = document.getElementById('add-item-btn');
        if (submitBtn) submitBtn.disabled = false;
    };

    window.selectRoom = function(roomNum, btn) {
        document.querySelectorAll('.room-btn').forEach(b => {
            b.classList.remove('btn-primary', 'text-white');
            b.classList.add('btn-outline-secondary');
        });
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-primary', 'text-white');
        document.getElementById('room_number').value = roomNum;
    };

    window.toggleRoomInput = function() {
            const isHospede = document.getElementById('type_hospede').checked;
            // Removed isFuncionario logic as option was removed from physical tables
            
            const roomContainer = document.getElementById('room_input_container');
            const roomInput = document.getElementById('room_number');
            const nameContainer = document.getElementById('customer_name_container');
            const nameInput = document.getElementById('customer_name');
            
            // Staff container removed
            
            if (roomContainer) {
                if (isHospede) {
                    roomContainer.style.display = 'block';
                    roomInput.required = true;
                    if (nameContainer) {
                        nameContainer.style.display = 'none';
                        if (nameInput) nameInput.value = '';
                    }
                } else {
                    roomContainer.style.display = 'none';
                    roomInput.required = false;
                    roomInput.value = '';
                    document.querySelectorAll('.room-btn').forEach(b => {
                        b.classList.remove('btn-primary', 'text-white');
                        b.classList.add('btn-outline-secondary');
                    });
                    if (nameContainer) {
                        nameContainer.style.display = 'block';
                    }
                }
            }
        };

    window.incrementQty = function() {
        const input = document.getElementById('qty');
        if (input) {
            input.value = parseInt(input.value) + 1;
        }
    };

    window.decrementQty = function() {
        const input = document.getElementById('qty');
        if (input && parseInt(input.value) > 1) {
            input.value = parseInt(input.value) - 1;
        }
    };

    window.handleCustomObservation = function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            const input = event.target;
            const text = input.value.trim();
            
            if (text) {
                const list = document.getElementById('observations-list');
                const div = document.createElement('div');
                div.className = 'form-check mb-2';
                const id = 'custom_' + Date.now();
                div.innerHTML = `
                    <input class="form-check-input" type="checkbox" name="observations" value="${text}" id="${id}" checked>
                    <label class="form-check-label w-100" for="${id}" style="cursor: pointer;">
                        ${text} <span class="badge bg-info text-dark">Custom</span>
                    </label>
                `;
                list.appendChild(div);
                input.value = '';
            }
        }
    };

    // --- BATCH ORDER LOGIC ---
    let pendingItems = [];

    window.addToPending = function() {
        const product = document.getElementById('selected_product').value;
        if (!product) {
            alert('Por favor, selecione um produto.');
            return;
        }

        // Validate Flavor Selection
        let selectedFlavorId = null;
        let selectedFlavorName = null;

        if (window.currentSelectedProduct && window.currentSelectedProduct.flavor_group_id) {
            const maxFlavors = window.currentSelectedProduct.max_flavors || 1;
            
            if (maxFlavors > 1) {
                const checked = document.querySelectorAll('input[name="selected_flavors"]:checked');
                if (checked.length === 0) {
                    alert('Por favor, selecione pelo menos um sabor.');
                    return;
                }
                const names = [];
                const ids = [];
                checked.forEach(cb => {
                    names.push(cb.getAttribute('data-name'));
                    ids.push(cb.value);
                });
                selectedFlavorName = names.join(' + ');
                selectedFlavorId = ids.join(',');
            } else {
                const selectedFlavor = document.querySelector('input[name="selected_flavor"]:checked');
                if (!selectedFlavor) {
                    alert('Por favor, selecione um sabor.');
                    return;
                }
                selectedFlavorId = selectedFlavor.value;
                selectedFlavorName = selectedFlavor.getAttribute('data-name');
            }
        }

        // Validate Mandatory Accompaniment
        if (window.currentSelectedProduct && window.currentSelectedProduct.has_accompaniments) {
            const selectedAccCount = document.querySelectorAll('input[name="accompaniments"]:checked').length;
            if (selectedAccCount === 0) {
                alert('Este item requer a seleção de pelo menos um acompanhamento.');
                return;
            }
        }

        const qtyInput = document.getElementById('qty');
        const qty = parseInt(qtyInput.value) || 1;

        // Collect Complements
        const complements = [];
        document.querySelectorAll('input[name="complements"]:checked').forEach(cb => {
            complements.push(cb.value);
        });

        // Collect Observations
        const observations = [];
        document.querySelectorAll('input[name="observations"]:checked').forEach(cb => {
            observations.push(cb.value);
        });
        
        // Add custom observation from input if user didn't press Enter
        const customObsInput = document.getElementById('custom-observation');
        if (customObsInput && customObsInput.value.trim() !== '') {
            observations.push(customObsInput.value.trim());
            customObsInput.value = ''; // Clear after adding
        }

        // Collect Accompaniments
        const selectedAccompaniments = [];
        document.querySelectorAll('input[name="accompaniments"]:checked').forEach(cb => {
             const accId = cb.value;
             // Find product name for the ID
             const accProduct = allProducts.find(p => p.id == accId);
             if (accProduct) {
                 selectedAccompaniments.push(accProduct.name);
             }
        });

        // Validate and Collect Mandatory Questions
        const questionsAnswers = [];
        if (window.currentSelectedProduct && window.currentSelectedProduct.mandatory_questions) {
            let allValid = true;
            
            window.currentSelectedProduct.mandatory_questions.forEach((q, idx) => {
                const inputName = `question_${idx}`;
                let answer = null;
                
                if (q.type === 'text') {
                    const input = document.querySelector(`input[name="${inputName}"]`);
                    if (input) answer = input.value.trim();
                } else if (q.type === 'single_choice' || q.type === 'choice') {
                    const checked = document.querySelector(`input[name="${inputName}"]:checked`);
                    if (checked) answer = checked.value;
                } else if (q.type === 'multiple_choice' || q.type === 'check') {
                    const checked = document.querySelectorAll(`input[name="${inputName}"]:checked`);
                    if (checked.length > 0) {
                        answer = Array.from(checked).map(cb => cb.value).join(', ');
                    }
                }
                
                if (q.required && (!answer || answer === '')) {
                    allValid = false;
                }
                
                if (answer) {
                    questionsAnswers.push({
                        question: q.question,
                        answer: answer
                    });
                }
            });
            
            if (!allValid) {
                alert('Por favor, responda todas as perguntas obrigatórias.');
                return;
            }
        }

        // Add Main Item
        pendingItems.push({
            product: product,
            flavor_id: selectedFlavorId,
            flavor_name: selectedFlavorName,
            qty: qty,
            complements: complements,
            observations: observations,
            accompaniments: selectedAccompaniments,
            questions_answers: questionsAnswers
        });

        // Reset UI for next item
        qtyInput.value = 1;
        
        // Uncheck complements
        document.querySelectorAll('input[name="complements"]:checked').forEach(cb => {
            cb.checked = false;
        });
        
        // Uncheck observations
        document.querySelectorAll('input[name="observations"]:checked').forEach(cb => {
            cb.checked = false;
        });

        // Uncheck accompaniments
        document.querySelectorAll('input[name="accompaniments"]:checked').forEach(cb => {
            cb.checked = false;
        });

        // Visual feedback
        const btn = document.querySelector('button[onclick="addToPending()"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check-lg"></i> Adicionado!';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-success', 'text-white');
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.add('btn-outline-primary');
            btn.classList.remove('btn-success', 'text-white');
        }, 1000);

        updatePendingUI();
    };

    window.removeFromPending = function(index) {
        pendingItems.splice(index, 1);
        updatePendingUI();
    };

    window.updatePendingUI = function() {
        const container = document.getElementById('pending-items-container');
        const tbody = document.getElementById('pending-items-body');
        
        if (pendingItems.length === 0) {
            container.style.display = 'none';
            return;
        }

        container.style.display = 'block';
        tbody.innerHTML = '';

        pendingItems.forEach((item, index) => {
            let flavorText = '';
            if (item.flavor_name) {
                flavorText = `<br><small class="text-muted">Sabor: ${item.flavor_name}</small>`;
            }

            let compText = '';
            if (item.complements.length > 0) {
                 // Look up names
                 const compNames = item.complements.map(id => {
                     // allComplements is global
                     const c = allComplements.find(x => x.id == id);
                     return c ? c.name : id;
                 });
                 compText = `<br><small class="text-muted">+ ${compNames.join(', ')}</small>`;
            }

            let accText = '';
            if (item.accompaniments && item.accompaniments.length > 0) {
                accText = item.accompaniments.map(acc => `<br><small class="text-muted">- ${acc}</small>`).join('');
            }

            let obsText = '';
            if (item.observations && item.observations.length > 0) {
                 obsText = `<br><small class="text-danger"><i class="bi bi-pencil"></i> ${item.observations.join(', ')}</small>`;
            }

            let qaText = '';
            if (item.questions_answers && item.questions_answers.length > 0) {
                qaText = item.questions_answers.map(qa => `<br><small class="text-primary fw-bold">${qa.question}: ${qa.answer}</small>`).join('');
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>${item.product}</strong>${flavorText}${compText}${accText}${obsText}${qaText}</td>
                <td class="text-center">${item.qty}</td>
                <td class="text-end">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFromPending(${index})">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        // Scroll to bottom of list
        container.scrollIntoView({ behavior: 'smooth', block: 'end' });
    };

    let isSubmittingBatch = false;
    window.prepareBatchSubmit = function() {
        if (isSubmittingBatch) {
            return false;
        }
        if (pendingItems.length === 0) {
            alert('A lista de pedidos está vazia.');
            return false;
        }

        // Generate unique Batch ID to prevent duplicates
        const batchId = 'batch_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        document.getElementById('batch_id').value = batchId;
        document.getElementById('items_json').value = JSON.stringify(pendingItems);
        
        // Visual loading state (não desabilitar antes de submeter)
        const btn = document.querySelector('#batchForm button[type="submit"]');
        if (btn) {
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enviando...';
        }
        
        // Marcar estado e submeter programaticamente
        isSubmittingBatch = true;
        const form = document.getElementById('batchForm');
        if (form) {
            form.submit();
        }
        
        // Fallback: se não houver navegação em até 12s, reverter estado
        setTimeout(() => {
            if (isSubmittingBatch) {
                isSubmittingBatch = false;
                if (btn) {
                    btn.innerHTML = '<i class="bi bi-send-check-fill me-2"></i> ENVIAR PEDIDOS';
                }
                alert('Tempo excedido ao enviar. Verifique sua conexão ou tente novamente.');
            }
        }, 12000);
        
        return false;
    };

    window.searchProducts = function() {
        const query = document.getElementById('productSearch').value.toLowerCase();
        const resultsContainer = document.getElementById('searchResults');
        
        if (query.length < 2) {
            resultsContainer.style.display = 'none';
            resultsContainer.innerHTML = '';
            return;
        }
        
        const matches = allProducts.filter(p => p.name.toLowerCase().includes(query));
        
        if (matches.length > 0) {
            resultsContainer.innerHTML = matches.map(p => `
                <button type="button" class="list-group-item list-group-item-action" onclick="selectProductFromSearch('${p.id}')">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>${p.name}</strong>
                        <span class="badge bg-primary rounded-pill">R$ ${parseFloat(p.price).toFixed(2)}</span>
                    </div>
                    <small class="text-muted">${p.category}</small>
                </button>
            `).join('');
            resultsContainer.style.display = 'block';
        } else {
            resultsContainer.innerHTML = '<div class="p-2 text-muted">Nenhum produto encontrado.</div>';
            resultsContainer.style.display = 'block';
        }
    };

    window.selectProductFromSearch = function(id) {
        const product = allProducts.find(p => p.id == id);
        if (!product) {
            console.error('Product not found via search:', id);
            return;
        }

        document.getElementById('productSearch').value = '';
        document.getElementById('searchResults').style.display = 'none';
        
        window.selectProduct(null, product);

        const area = document.getElementById('product-selection-area');
        if (area) {
             const msg = document.createElement('div');
             msg.className = 'alert alert-success mt-2';
             msg.textContent = 'Produto selecionado: ' + product.name;
             area.insertBefore(msg, area.firstChild);
             setTimeout(() => msg.remove(), 3000);
        }
    };

    window.handleFlavorLimit = function(checkbox, limit) {
        const checked = document.querySelectorAll('input[name="selected_flavors"]:checked');
        let count = 0;
        checked.forEach(cb => {
            if (cb.value !== 'tradicional') {
                count++;
            }
        });
        
        if (count > limit) {
            checkbox.checked = false;
            alert(`Você só pode escolher até ${limit} sabores (Tradicional não conta para o limite).`);
        }
    };

    window.checkTransfer = function() {
        const target = document.getElementById('target_table_id').value;
        if(!target) {
            alert('Digite o número da mesa de destino.');
            return;
        }
        
        fetch('/api/check_table/' + target)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'occupied') {
                    // Custom modal or confirm
                    if (confirm('ATENÇÃO: A mesa ' + target + ' já está ABERTA. \n\nDeseja realmente transferir e misturar os pedidos?')) {
                        document.getElementById('transferForm').submit();
                    }
                } else {
                    document.getElementById('transferForm').submit();
                }
            })
            .catch(err => {
                console.error('Error checking table:', err);
                if(confirm('Erro ao verificar status da mesa. Tentar transferir mesmo assim?')) {
                    document.getElementById('transferForm').submit();
                }
            });
    };

    window.handleCancelTransfer = async function(defaultSource) {
        let target = prompt('Para qual mesa deseja devolver os itens da transferência? Deixe em branco para usar a mesa original ' + defaultSource + '.');
        if (target === null) {
            return;
        }
        target = target.trim();
        if (target === '') {
            target = defaultSource;
        }
        
        // Validation relaxed to allow alphanumeric (e.g. FUNC_...)
        if (target.length < 1) {
             alert('Mesa inválida.');
             return;
        }

        try {
            const response = await fetch('/api/check_table/' + encodeURIComponent(target));
            if (!response.ok) throw new Error('Erro na verificação da mesa');
            const data = await response.json();

            if (data.status === 'occupied') {
                 // Case 1: Target Occupied -> Merge or Suggest
                 if (confirm('A mesa ' + target + ' está OCUPADA.\n\nClique OK para MESCLAR os pedidos nesta mesa.\nClique Cancelar para ver sugestões de outras mesas livres.')) {
                     // User chose Merge
                     submitCancelTransfer(target);
                 } else {
                     // User chose Suggestion
                     await suggestAlternativeTables();
                 }
            } else {
                // Case 2: Target Open -> Restore
                if (confirm('Cancelar a transferência e devolver os itens para a mesa ' + target + '?')) {
                    submitCancelTransfer(target);
                }
            }
        } catch (error) {
            console.error('Erro:', error);
            // Fallback to simple confirm if API fails
            if (confirm('Não foi possível verificar o status da mesa. Tentar devolver para ' + target + ' mesmo assim?')) {
                submitCancelTransfer(target);
            }
        }
    };

    window.suggestAlternativeTables = async function() {
        try {
            const response = await fetch('/api/available_tables');
            const tables = await response.json();
            
            if (!tables || tables.length === 0) {
                alert('Não foram encontradas mesas disponíveis no momento.');
                return;
            }
            
            // Show first 15 tables
            const suggestionList = tables.slice(0, 15).join(', ');
            let msg = 'A mesa original está ocupada. Aqui estão algumas mesas livres:\n\n' + suggestionList + '\n\nDigite o número da mesa desejada para transferir:';
            
            let newTarget = prompt(msg);
            if (newTarget) {
                newTarget = newTarget.trim();
                if (newTarget) {
                    submitCancelTransfer(newTarget);
                }
            }
        } catch (e) {
            alert('Erro ao buscar sugestões de mesas.');
        }
    };

    window.submitCancelTransfer = function(target) {
        document.getElementById('return_table_id').value = target;
        document.getElementById('cancelTransferForm').submit();
    };

    // Audio Alert for Print Errors
    document.addEventListener('DOMContentLoaded', function() {
        const errorAlerts = document.querySelectorAll('.alert-danger');
        if (errorAlerts.length > 0) {
            playErrorSound();
        }
    });

    function playErrorSound() {
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            
            const ctx = new AudioContext();
            
            // Create a sequence of beeps
            const now = ctx.currentTime;
            
            // Beep 1
            const osc1 = ctx.createOscillator();
            const gain1 = ctx.createGain();
            osc1.type = 'square';
            osc1.frequency.value = 300;
            gain1.gain.setValueAtTime(0.1, now);
            gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
            osc1.connect(gain1);
            gain1.connect(ctx.destination);
            osc1.start(now);
            osc1.stop(now + 0.2);
            
            // Beep 2
            const osc2 = ctx.createOscillator();
            const gain2 = ctx.createGain();
            osc2.type = 'square';
            osc2.frequency.value = 200;
            gain2.gain.setValueAtTime(0.1, now + 0.3);
            gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
            osc2.connect(gain2);
            gain2.connect(ctx.destination);
            osc2.start(now + 0.3);
            osc2.stop(now + 0.5);
            
        } catch (e) {
            console.error('Audio playback failed:', e);
        }
    }
</script>
{% endblock %}
