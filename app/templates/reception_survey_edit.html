{% extends "base.html" %}

{% block title %}Editar Pesquisa - Recepção{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-1"><i class="bi bi-sliders"></i> Editar Pesquisa</h2>
      <div class="text-muted small">{{ survey.id }}</div>
    </div>
    <div class="d-flex gap-2">
      <a href="/reception/surveys" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Voltar
      </a>
      <a href="{{ url_for('reception.reception_survey_questions', survey_id=survey.id) }}" class="btn btn-success">
        <i class="bi bi-list-check"></i> Perguntas ({{ questions_count }})
      </a>
      <a href="{{ url_for('reception.reception_survey_dashboard', survey_id=survey.id) }}" class="btn btn-outline-primary">
        <i class="bi bi-graph-up"></i> Dashboard
      </a>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-lg-7">
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <strong>Configurações</strong>
        </div>
        <div class="card-body">
          <form method="POST" class="row g-3">
            <div class="col-12">
              <label class="form-label">Título</label>
              <input type="text" class="form-control" name="title" value="{{ survey.title }}" maxlength="120" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Público</label>
              <select class="form-select" name="audience" required>
                <option value="hotel" {{ 'selected' if survey.audience == 'hotel' else '' }}>Hóspedes</option>
                <option value="restaurant" {{ 'selected' if survey.audience == 'restaurant' else '' }}>Restaurante</option>
                <option value="colaboradores" {{ 'selected' if survey.audience == 'colaboradores' else '' }}>Colaboradores</option>
                <option value="candidatos" {{ 'selected' if survey.audience == 'candidatos' else '' }}>Candidatos</option>
              </select>
            </div>
            <div class="col-md-6 d-flex align-items-end">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="is_active" id="isActive" {{ 'checked' if survey.is_active else '' }}>
                <label class="form-check-label" for="isActive">Ativa</label>
              </div>
            </div>
            <div class="col-12">
              <label class="form-label">Texto de abertura</label>
              <textarea class="form-control" name="intro_text" rows="3" placeholder="Mensagem exibida antes das perguntas.">{{ survey.intro_text or '' }}</textarea>
            </div>
            <div class="col-12">
              <label class="form-label">Mensagem de agradecimento</label>
              <textarea class="form-control" name="thank_you_text" rows="2" placeholder="Mensagem exibida após o envio.">{{ survey.thank_you_text or '' }}</textarea>
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> Salvar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <strong>Link Público</strong>
          <span class="badge bg-light text-dark border">Enviadas: {{ invites_count }} • Respostas: {{ responses_count }}</span>
        </div>
        <div class="card-body">
          <div class="input-group">
            <input type="text" class="form-control" value="{{ public_url }}" readonly onclick="this.select()">
            <button class="btn btn-outline-secondary" type="button" onclick="navigator.clipboard.writeText('{{ public_url }}')">
              <i class="bi bi-clipboard"></i>
            </button>
            <a class="btn btn-outline-primary" href="{{ public_url }}" target="_blank">
              <i class="bi bi-box-arrow-up-right"></i>
            </a>
          </div>
          <div class="mt-3">
            <div class="text-muted small mb-1">Link com ID (para rastrear o envio)</div>
            <div class="input-group">
              <input id="inviteLink" type="text" class="form-control" value="" readonly onclick="this.select()">
              <button class="btn btn-outline-secondary" type="button" onclick="copyInviteLink()">
                <i class="bi bi-clipboard"></i>
              </button>
              <button class="btn btn-outline-primary" type="button" onclick="regenInviteLink()">
                <i class="bi bi-arrow-repeat"></i>
              </button>
            </div>
          </div>
          <div class="text-muted small mt-2">
            Use este link para enviar aos clientes pelo WhatsApp.
          </div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <strong>Atalhos</strong>
        </div>
        <div class="card-body d-grid gap-2">
          <a href="{{ url_for('reception.reception_survey_questions', survey_id=survey.id) }}" class="btn btn-success">
            <i class="bi bi-list-check"></i> Editar Perguntas
          </a>
          <a href="/reception/surveys" class="btn btn-outline-secondary">
            <i class="bi bi-grid"></i> Ver Todas
          </a>
        </div>
      </div>
    </div>
  </div>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
function randomRef(len) {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let out = '';
  for (let i = 0; i < len; i++) out += chars[Math.floor(Math.random() * chars.length)];
  return out;
}
async function regenInviteLink() {
  const base = '{{ public_url }}';
  try {
    const res = await fetch('{{ url_for("reception.reception_survey_invite_new", survey_id=survey.id) }}', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) });
    if (res.ok) {
      const data = await res.json();
      if (data && data.ok && data.ref) {
        const link = data.link || (base + (base.includes('?') ? '&' : '?') + 'ref=' + encodeURIComponent(data.ref));
        const el = document.getElementById('inviteLink');
        if (el) el.value = link;
        return link;
      }
    }
  } catch (e) {}
  const ref = randomRef(8);
  const link = base + (base.includes('?') ? '&' : '?') + 'ref=' + encodeURIComponent(ref);
  const el = document.getElementById('inviteLink');
  if (el) el.value = link;
  return link;
}
async function copyInviteLink() {
  const el = document.getElementById('inviteLink');
  let value = (el && el.value) ? el.value : '';
  if (!value) value = await regenInviteLink();
  navigator.clipboard.writeText(value);
}
document.addEventListener('DOMContentLoaded', () => {
  regenInviteLink();
  const tbody = document.getElementById('questionsTableBody');
  if (tbody) {
    const reorderUrl = '{{ url_for("reception.reception_survey_questions_reorder", survey_id=survey.id) }}';
    new Sortable(tbody, {
      handle: '.drag-handle',
      animation: 150,
      onEnd: () => {
        const order = [];
        tbody.querySelectorAll('tr[data-question-id]').forEach(row => {
          const id = row.getAttribute('data-question-id');
          if (id) order.push(id);
        });
        fetch(reorderUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ order })
        }).catch(() => {});
      }
    });
  }
});
</script>
{% if questions is defined %}
<div class="container mt-3">
  <div class="card shadow-sm">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
      <strong>Perguntas</strong>
      <span class="text-muted small">{{ questions|length }} item(ns)</span>
    </div>
    <div class="card-body">
      <form method="POST" action="{{ url_for('reception.reception_survey_questions', survey_id=survey.id) }}" class="row g-2 mb-3">
        <input type="hidden" name="action" value="add_question">
        <div class="col-md-6">
          <input type="text" class="form-control" name="question_text" placeholder="Texto da pergunta" required>
        </div>
        <div class="col-md-3">
          <select class="form-select" name="question_type">
            <option value="rating_0_10">Nota 0 a 10</option>
            <option value="text">Texto</option>
            <option value="multiple_choice">Múltipla escolha</option>
          </select>
        </div>
        <div class="col-md-3">
          <textarea class="form-control" name="options_raw" rows="2" placeholder="Opções (uma por linha)"></textarea>
        </div>
        <div class="col-md-1 d-flex align-items-center">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="required" id="required">
            <label class="form-check-label" for="required">Obrig.</label>
          </div>
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-success btn-sm">
            <i class="bi bi-plus-circle"></i> Adicionar
          </button>
        </div>
      </form>
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width: 60px;">#</th>
              <th>Pergunta</th>
              <th style="width: 180px;">Tipo</th>
              <th>Opções</th>
              <th style="width: 110px;">Obrigatória</th>
              <th class="text-end" style="width: 260px;">Ações</th>
            </tr>
          </thead>
          <tbody id="questionsTableBody">
            {% for q in questions %}
            <tr data-question-id="{{ q.id }}">
              <td class="align-middle drag-handle">
                <i class="bi bi-grip-vertical me-1"></i> {{ q.position }}
              </td>
              <td>
                <input form="qform-{{ q.id }}" type="text" class="form-control form-control-sm" name="question_text" value="{{ q.question_text }}">
              </td>
              <td>
                <select form="qform-{{ q.id }}" class="form-select form-select-sm" name="question_type">
                  <option value="rating_0_10" {{ 'selected' if q.question_type == 'rating_0_10' else '' }}>Nota 0 a 10</option>
                  <option value="text" {{ 'selected' if q.question_type == 'text' else '' }}>Texto</option>
                  <option value="multiple_choice" {{ 'selected' if q.question_type == 'multiple_choice' else '' }}>Múltipla escolha</option>
                </select>
              </td>
              <td>
                {% if q.question_type == 'multiple_choice' %}
                  <textarea form="qform-{{ q.id }}" class="form-control form-control-sm" name="options_raw" rows="2" placeholder="Uma opção por linha">{{ q.options_lines or '' }}</textarea>
                {% else %}
                  <span class="text-muted small">—</span>
                {% endif %}
              </td>
              <td class="text-center">
                <div class="form-check d-flex justify-content-center">
                  <input form="qform-{{ q.id }}" class="form-check-input" type="checkbox" name="required" id="required_{{ q.id }}" {{ 'checked' if q.required else '' }}>
                </div>
              </td>
              <td class="text-end">
                <form id="qform-{{ q.id }}" method="POST" action="{{ url_for('reception.reception_survey_questions', survey_id=survey.id) }}" class="d-inline">
                  <input type="hidden" name="question_id" value="{{ q.id }}">
                  <button type="submit" name="action" value="update_question" class="btn btn-primary btn-sm">
                    <i class="bi bi-save"></i> Salvar
                  </button>
                  <button type="submit" name="action" value="move_up" class="btn btn-outline-secondary btn-sm" title="Subir">
                    <i class="bi bi-arrow-up"></i>
                  </button>
                  <button type="submit" name="action" value="move_down" class="btn btn-outline-secondary btn-sm" title="Descer">
                    <i class="bi bi-arrow-down"></i>
                  </button>
                  <button type="submit" name="action" value="delete_question" class="btn btn-outline-danger btn-sm" onclick="return confirm('Remover pergunta?')">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="5" class="text-center text-muted py-4">Nenhuma pergunta cadastrada.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}
