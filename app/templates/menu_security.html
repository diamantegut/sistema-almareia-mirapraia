{% extends 'base.html' %}

{% block title %}Segurança do Menu e Vendas{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-shield-lock"></i> Segurança de Menu e Vendas</h2>
        <div>
            <button class="btn btn-primary" onclick="runIntegrityCheck()">
                <i class="bi bi-activity"></i> Verificar Integridade Agora
            </button>
            <button class="btn btn-secondary" onclick="createCheckpoint()">
                <i class="bi bi-save"></i> Criar Checkpoint
            </button>
        </div>
    </div>

    <div class="row">
        <!-- Status Cards -->
        <div class="col-md-4 mb-4">
            <div class="card h-100 border-success">
                <div class="card-body">
                    <h5 class="card-title text-success"><i class="bi bi-check-circle"></i> Status do Sistema</h5>
                    <p class="card-text">O sistema de segurança do Menu está ativo.</p>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Validação & Hashing
                            <span class="badge bg-success rounded-pill">Ativo</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Backup Automático (2h)
                            <span class="badge bg-success rounded-pill">Ativo</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Log de Auditoria Imutável
                            <span class="badge bg-success rounded-pill">Ativo</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Proteção Anti-Sobrescrita
                            <span class="badge bg-success rounded-pill">Ativo</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-md-8 mb-4">
            <div class="card h-100">
                <div class="card-header bg-dark text-white">
                    <i class="bi bi-journal-text"></i> Logs de Auditoria Recentes (Menu/Vendas)
                </div>
                <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-striped table-hover mb-0" style="font-size: 0.9em;">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Ação</th>
                                <th>Usuário</th>
                                <th>Item/ID</th>
                                <th>Detalhes</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogBody">
                            <!-- Populated via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Integrity Report -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="bi bi-bug"></i> Relatório de Integridade (Menu Items)
        </div>
        <div class="card-body">
            <div id="integrityResult" class="alert alert-info">
                Aguardando verificação...
            </div>
            <table class="table table-bordered d-none" id="integrityTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Produto</th>
                        <th>Problema</th>
                        <th>Hash Armazenado</th>
                        <th>Hash Calculado</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', loadAuditLogs);

    function runIntegrityCheck() {
        const resultDiv = document.getElementById('integrityResult');
        const table = document.getElementById('integrityTable');
        
        resultDiv.className = 'alert alert-info';
        resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Verificando integridade dos dados...';
        table.classList.add('d-none');

        fetch('/api/menu/security/integrity_check', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    if (data.anomalies.length === 0) {
                        resultDiv.className = 'alert alert-success';
                        resultDiv.innerHTML = '<i class="bi bi-check-circle-fill"></i> Integridade verificada. Nenhuma anomalia encontrada em ' + data.total_checked + ' registros.';
                    } else {
                        resultDiv.className = 'alert alert-danger';
                        resultDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> Encontradas ${data.anomalies.length} anomalias!`;
                        
                        const tbody = table.querySelector('tbody');
                        tbody.innerHTML = '';
                        data.anomalies.forEach(a => {
                            tbody.innerHTML += `
                                <tr>
                                    <td>${a.id}</td>
                                    <td>${a.name}</td>
                                    <td>${a.issue}</td>
                                    <td class="text-muted small">${a.stored ? a.stored.substring(0, 10) + '...' : 'N/A'}</td>
                                    <td class="text-muted small">${a.calculated ? a.calculated.substring(0, 10) + '...' : 'N/A'}</td>
                                </tr>
                            `;
                        });
                        table.classList.remove('d-none');
                    }
                } else {
                    resultDiv.className = 'alert alert-danger';
                    resultDiv.innerText = 'Erro: ' + data.error;
                }
            })
            .catch(err => {
                resultDiv.className = 'alert alert-danger';
                resultDiv.innerText = 'Erro de conexão.';
            });
    }

    function createCheckpoint() {
        if(!confirm('Criar um checkpoint manual de segurança agora?')) return;
        
        fetch('/api/menu/security/checkpoint', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    alert('Checkpoint criado com sucesso em: ' + data.path);
                } else {
                    alert('Erro: ' + data.error);
                }
            });
    }

    function loadAuditLogs() {
        fetch('/api/menu/security/audit_logs')
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('auditLogBody');
                tbody.innerHTML = '';
                if(data.logs && data.logs.length) {
                    data.logs.slice().reverse().forEach(log => {
                        let details = JSON.stringify(log.details || {});
                        // Shorten if too long
                        if (details.length > 100) details = details.substring(0, 100) + '...';
                        
                        if(log.changes && log.changes.length) {
                            details += ` <br><small class="text-muted">${log.changes.length} alterações</small>`;
                        }
                        
                        tbody.innerHTML += `
                            <tr>
                                <td>${new Date(log.timestamp).toLocaleString()}</td>
                                <td><span class="badge bg-secondary">${log.action}</span></td>
                                <td>${log.user}</td>
                                <td>${log.item_id}</td>
                                <td class="text-truncate" style="max-width: 300px;" title="${JSON.stringify(log.details)}">${details}</td>
                            </tr>
                        `;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">Sem logs recentes.</td></tr>';
                }
            });
    }
</script>
{% endblock %}
