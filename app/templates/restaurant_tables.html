{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-2 px-2">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
        <h2 class="fs-4 mb-0">Mesas do Restaurante</h2>
        <div class="d-flex flex-wrap gap-2">
            {% if session.get('role') in ['admin', 'gerente', 'supervisor'] %}
            <a href="{{ url_for('restaurant.restaurant_cashier') }}" class="btn btn-warning text-dark">
                <i class="bi bi-cash-coin"></i> <span class="d-none d-sm-inline">Caixa</span>
            </a>
            {% endif %}
            {% if session.get('role') in ['admin', 'gerente', 'supervisor', 'recepcao'] or 'restaurante_full_access' in session.get('permissions', []) or 'recepcao' in session.get('permissions', []) %}
            <a href="{{ url_for('menu.menu_management') }}" class="btn btn-primary">
                <i class="bi bi-journal-text"></i> <span class="d-none d-sm-inline">Cardápio</span>
            </a>
            {% endif %}
            <a href="{{ url_for('restaurant.restaurant_dashboard') }}" class="btn btn-outline-info">
                <i class="bi bi-graph-up"></i> <span class="d-none d-sm-inline">Dashboard</span><span class="d-inline d-sm-none">Stats</span>
            </a>
            <a href="{{ url_for('reception.reception_waiting_list') }}" class="btn btn-outline-warning text-dark" title="Gerenciar Fila de Espera">
                <i class="bi bi-people-fill"></i> <span class="d-none d-sm-inline">Chamar Próximo</span><span class="d-inline d-sm-none">Fila</span>
                {% if waiting_queue_count and waiting_queue_count > 0 %}
                <span class="badge bg-danger rounded-pill ms-1">{{ waiting_queue_count }}</span>
                {% endif %}
            </a>
            {% if session.get('role') in ['admin', 'gerente', 'supervisor'] %}
            <form method="POST" action="{{ url_for('restaurant.toggle_live_music') }}">
                <button type="submit" class="btn {% if live_music_active %}btn-success{% else %}btn-outline-success{% endif %}">
                    <i class="bi bi-music-note-beamed"></i>
                    <span class="d-none d-sm-inline">
                        Música ao Vivo: {% if live_music_active %}Ativada{% else %}Desativada{% endif %}
                    </span>
                    <span class="d-inline d-sm-none">
                        Música
                    </span>
                </button>
            </form>
            {% endif %}
            <button type="button" class="btn btn-secondary text-white" data-bs-toggle="modal" data-bs-target="#legendModal" title="Legenda Visual">
                <i class="bi bi-info-circle"></i> <span class="d-none d-sm-inline">Legenda</span>
            </button>
            <button type="button" class="btn btn-info text-white" data-bs-toggle="modal" data-bs-target="#staffOrderModal">
                <i class="bi bi-person-badge"></i> <span class="d-none d-sm-inline">Consumo Funcionário</span><span class="d-inline d-sm-none">Func.</span>
            </button>
        </div>
    </div>

    {% if waiting_queue_count and waiting_queue_count > 0 %}
    <div class="px-2 mb-2">
        <div class="alert alert-warning py-1 px-2 mb-0 small d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-people-fill"></i>
                <span>Fila de espera: {{ waiting_queue_count }} grupo(s) aguardando.</span>
            </div>
            <a class="fw-bold text-decoration-none" href="{{ url_for('reception.reception_waiting_list') }}">Abrir</a>
        </div>
    </div>
    {% endif %}



    {% set static_disabled_tables = [4, 5, 6, 7, 8, 9, 10, 13, 18, 19, 20, 27, 28, 29, 30] %}
    
    {% set areas = [
        {'name': 'Área 1', 'tables': range(40, 50)|list},
        {'name': 'Área 2', 'tables': range(50, 58)|list},
        {'name': 'Área 3', 'tables': [58, 59, 60, 61]},
        {'name': 'Área 4 - Praia', 'tables': range(70, 80)|list},
        {'name': 'Área 5 - Salão', 'tables': range(89, 101)|list},
        {'name': 'Área 6 - Deck', 'tables': range(80, 89)|list},
        {'name': 'Quartos', 'tables': range(1, 36)|list},
        {'name': 'Outros', 'tables': range(36, 40)|list + range(62, 70)|list}
    ] %}

    {% for area in areas %}
    {% if area.tables %}
    <h5 class="mt-3 mb-2 px-2 text-secondary fw-bold border-bottom pb-1">{{ area.name }}</h5>
    <div class="row row-cols-4 row-cols-sm-4 row-cols-md-6 row-cols-lg-8 row-cols-xl-10 g-1 px-1">
        {% for i in area.tables %}
            {% set table_id = i|format_room %}
            {% set is_room = i <= 35 %}
            {% set is_breakfast = i == 36 %}
            {% set is_occupied_room = is_room and occupancy is defined and (table_id in occupancy or (i|string) in occupancy) %}
            {% set is_static_disabled = i in static_disabled_tables %}
            {% set is_dynamic_disabled = i in dynamic_disabled_tables %}
            {% set is_disabled = is_static_disabled or is_dynamic_disabled %}
            {% set has_order = table_id in open_orders %}
            {% set show_for_admin = session.get('role') == 'admin' %}
            
            {% if (not is_disabled) or has_order or is_occupied_room or show_for_admin %}
                
                <div class="col">
                    {% set order = open_orders[table_id] if has_order else None %}
                    {% set is_locked = has_order and order and order.get('locked') %}
                    {% set cust_type = order.get('customer_type', 'passante') if order else '' %}
                    
                    <div class="card table-card {{ 'occupied' if has_order else 'free' }} {{ 'is-breakfast' if is_breakfast else ('is-room' if is_room else 'is-table') }} {% if is_locked %}locked{% endif %} {% if cust_type == 'hospede' %}is-guest-table{% elif cust_type == 'passante' %}is-passerby-table{% endif %}"
                         data-cust-type="{{ cust_type }}">
                        <a href="{{ url_for('restaurant.restaurant_table_order', table_id=table_id) }}" class="stretched-link text-decoration-none"></a>
                        
                        <!-- Breakfast Icon (Hidden by default, toggled by JS) -->
                        <div class="breakfast-icon-container" style="display: none; position: absolute; top: -5px; right: -5px; z-index: 5;">
                            <span class="badge rounded-pill bg-warning text-dark border border-dark shadow-sm" data-bs-toggle="tooltip" title="Café da Manhã (Hóspede)">
                                <i class="bi bi-cup-hot-fill"></i>
                            </span>
                        </div>

                        <div class="card-body d-flex flex-column justify-content-center align-items-center p-0 position-relative">
                            <h5 class="card-title mb-0 fs-6 fw-bold">
                                {% if is_breakfast %}
                                    <i class="bi bi-cup-hot-fill small"></i> {{ table_id }}
                                {% elif is_room %}
                                    <i class="bi bi-door-closed small"></i> {{ table_id }}
                                {% else %}
                                    {{ table_id }}
                                {% endif %}
                            </h5>
                            
                            {% if is_occupied_room %}
                                {% set guest = occupancy.get(table_id) or occupancy.get(i|string) %}
                                <div class="text-center mb-1 w-100 px-1" style="line-height: 1.1;">
                                    <div class="text-truncate fw-bold" style="font-size: 0.7em;">{{ guest.guest_name }}</div>
                                    <div style="font-size: 0.6em; opacity: 0.9;">
                                        {{ guest.num_adults }} Adt. • {{ guest.checkin[8:10] }}/{{ guest.checkin[5:7] }} - {{ guest.checkout[8:10] }}/{{ guest.checkout[5:7] }}
                                    </div>
                                </div>
                            {% endif %}

                            {% if has_order %}
                                <div class="status-indicator occupied"></div>
                                <small class="price-tag">
                                    R$ {{ "%.0f"|format(open_orders[table_id]['total']|default(0)) }}
                                </small>
                                
                                {# Breakfast Icon #}
                                {% if open_orders[table_id].get('is_breakfast') %}
                                    <div class="mt-1">
                                        <span class="badge bg-warning text-dark border border-light shadow-sm" style="font-size: 0.6em;">
                                            <i class="bi bi-cup-hot-fill"></i> Café
                                        </span>
                                    </div>
                                {% endif %}

                                {# Visual Badge for Customer Type #}
                                {% if cust_type == 'hospede' %}
                                    <span class="badge bg-primary text-white border border-light shadow-sm mt-1" style="font-size: 0.6em;">Hóspede</span>
                                {% elif cust_type == 'passante' %}
                                    <span class="badge bg-success text-white border border-light shadow-sm mt-1" style="font-size: 0.6em;">Passante</span>
                                {% endif %}
                                
                                {# Display Customer Name if available (for passersby or guests) #}
                                {% if order and order.get('customer_name') %}
                                    <div class="text-truncate px-1 w-100 text-center fw-bold text-dark mt-1" style="font-size: 0.65em;">
                                        {{ order.customer_name }}
                                    </div>
                                {% elif order and order.get('room_number') and occupancy is defined and order.room_number in occupancy %}
                                    <div class="text-truncate px-1 w-100 text-center fw-bold text-dark mt-1" style="font-size: 0.65em;">
                                        {{ occupancy[order.room_number].guest_name }}
                                    </div>
                                {% endif %}

                                {% if order.customer_type == 'funcionario' %}
                                    <div class="alert alert-info py-1 px-1 d-inline-block mb-0 mt-1" style="font-size: 0.6em;">
                                        <i class="bi bi-info-circle"></i> Consumo Salvo
                                    </div>
                                {% endif %}

                                {% if order and order.get('last_transfer') and session.get('role') in ['admin', 'gerente', 'supervisor'] %}
                                    <div class="mt-1">
                                        <span class="badge bg-warning text-dark" style="font-size: 0.65em;">
                                            <i class="bi bi-arrow-counterclockwise"></i> Desfazer
                                        </span>
                                    </div>
                                {% endif %}
                            {% else %}
                                {% if not is_occupied_room %}
                                    <div class="status-indicator free"></div>
                                    <small class="status-text">{{ 'Livre' if not is_room else 'Disponível' }}</small>
                                {% endif %}
                            {% endif %}

                            {% if is_locked %}
                                <div class="mt-1">
                                    <span class="badge bg-warning text-dark">Conta puxada</span>
                                </div>
                            {% endif %}

                            {% if show_for_admin %}
                                <form method="POST" action="{{ url_for('restaurant.toggle_table_disabled', table_id=i) }}" class="mt-1 position-relative" style="z-index: 2;">
                                    <button type="submit" class="btn btn-sm {% if is_dynamic_disabled %}btn-outline-success{% else %}btn-outline-dark{% endif %}">
                                        {% if is_dynamic_disabled %}
                                            Reativar
                                        {% else %}
                                            Ocultar
                                        {% endif %}
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>
    {% endif %}
    {% endfor %}

    {% if staff_orders %}
    <div class="card mt-5 mb-4 shadow-sm border-info">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="bi bi-person-badge"></i> Contas de Funcionários Abertas</h5>
        </div>
        <div class="card-body">
            <div class="row row-cols-2 row-cols-md-4 row-cols-lg-6 g-2">
                {% for t_id, order in staff_orders.items() %}
                    <div class="col">
                        <a href="{{ url_for('restaurant.restaurant_table_order', table_id=t_id) }}" class="text-decoration-none">
                            <div class="card h-100 border-info bg-light">
                                <div class="card-body p-2 text-center">
                                    <div class="fw-bold text-truncate">{{ users[order.staff_name].full_name if order.staff_name in users else order.staff_name }}</div>
                                    <!-- Value hidden -->
                                    <div class="text-muted" style="font-size: 0.7em;">Desde: {{ order.opened_at }}</div>
                                </div>
                            </div>
                        </a>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

</div>

<style>
    .table-card {
        aspect-ratio: 1 / 1;
        transition: all 0.2s;
        border: none;
        min-width: 44px;
        min-height: 44px;
    }
    
    .table-card:hover {
        transform: scale(1.05);
        z-index: 10;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* Styles for Tables (Default Green) */
    .table-card.free.is-table {
        background-color: #198754; /* Green */
        color: white;
    }

    /* Styles for Rooms (Purple) */
    .table-card.free.is-room {
        background-color: #6f42c1; /* Purple */
        color: white;
    }

    /* Styles for Breakfast (Orange) */
    .table-card.free.is-breakfast {
        background-color: #fd7e14; /* Orange */
        color: white;
    }
    .table-card.occupied.is-breakfast {
        background-color: #fff3cd !important;
        border-color: #fd7e14 !important;
        color: #fd7e14 !important;
    }

    .table-card.free .status-text {
        color: rgba(255,255,255,0.9);
    }
    
    .table-card.free .status-indicator {
        background-color: white;
    }

    .table-card.occupied {
        background-color: #e7f1ff;
        border: 2px solid #0d6efd;
        color: #0d6efd;
    }
    
    /* Room occupied style - slightly different? Or same standard occupied look? 
       Let's keep occupied look consistent but maybe change border color for rooms?
       For now, keep consistent "Occupied" state (Blue) for simplicity.
    */

    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-bottom: 2px;
    }

    .status-indicator.free {
        background-color: white;
    }

    .status-indicator.occupied {
        background-color: #dc3545; /* Red */
    }
    
    .price-tag {
        font-weight: bold;
        font-size: 0.8em;
    }
    
    .status-text {
        font-size: 0.7em;
    }
    
    /* Guest/Passerby Distinctions */
    .table-card.is-guest-table {
        border: 2px solid #0d6efd !important; /* Primary Blue */
        background-color: #e7f1ff;
    }
    
    .table-card.is-passerby-table {
        border: 2px solid #198754 !important; /* Success Green */
        background-color: #e8f5e9;
    }

    .table-card.is-guest-table .card-title {
        color: #0d6efd;
    }

    .table-card.is-passerby-table .card-title {
        color: #198754;
    }
    
    /* Transition for icons */
    .breakfast-icon-container {
        transition: opacity 0.5s ease-in-out;
    }
</style>

<!-- Legend Modal -->
<div class="modal fade" id="legendModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-info-circle"></i> Legenda Visual</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="list-group">
                    <div class="list-group-item d-flex align-items-center gap-3">
                        <div class="status-indicator free border border-dark" style="width: 20px; height: 20px;"></div>
                        <div>
                            <strong>Mesa Livre</strong><br>
                            <small class="text-muted">Disponível para uso.</small>
                        </div>
                    </div>
                    <div class="list-group-item d-flex align-items-center gap-3">
                        <div class="d-flex align-items-center justify-content-center bg-primary text-white rounded p-1" style="width: 30px; height: 30px;">
                            <i class="bi bi-door-closed"></i>
                        </div>
                        <div>
                            <strong>Hóspede (Mesa ou Quarto)</strong><br>
                            <small class="text-muted">Borda Azul + Badge "Hóspede".</small>
                        </div>
                    </div>
                    <div class="list-group-item d-flex align-items-center gap-3">
                        <div class="d-flex align-items-center justify-content-center bg-success text-white rounded p-1" style="width: 30px; height: 30px;">
                            <i class="bi bi-person"></i>
                        </div>
                        <div>
                            <strong>Passante</strong><br>
                            <small class="text-muted">Borda Verde + Badge "Passante".</small>
                        </div>
                    </div>
                    <div class="list-group-item d-flex align-items-center gap-3">
                        <span class="badge rounded-pill bg-warning text-dark border border-dark">
                            <i class="bi bi-cup-hot-fill"></i>
                        </span>
                        <div>
                            <strong>Café da Manhã (7h - 10h)</strong><br>
                            <small class="text-muted">Ícone aparece automaticamente em mesas de hóspedes durante o horário do café.</small>
                        </div>
                    </div>
                    <div class="list-group-item d-flex align-items-center gap-3">
                         <span class="badge bg-warning text-dark">Conta puxada</span>
                         <div>
                             <strong>Conta Bloqueada</strong><br>
                             <small class="text-muted">Pré-fechamento realizado.</small>
                         </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Staff Order -->
<div class="modal fade" id="staffOrderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Novo Consumo Funcionário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('restaurant.open_staff_table') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Selecione o Colaborador</label>
                        <select class="form-select form-select-lg" name="staff_name" required>
                            <option value="">Selecione...</option>
                            {% for username, data in users.items() %}
                                <option value="{{ username }}">{{ data.full_name or username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-info text-white">Abrir Conta</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script id="breakfast-tables-data" type="application/json">
    {{ breakfast_tables|default([])|tojson|safe }}
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        checkBreakfastTime();
        // Check every minute
        setInterval(checkBreakfastTime, 60000);
        
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    });

    function checkBreakfastTime() {
        const now = new Date();
        const hour = now.getHours();
        const isBreakfastTime = hour >= 7 && hour < 10;
        
        // Debug
        // const isBreakfastTime = true; // For testing
        
        // Backend data about breakfast tables
        const breakfastTables = JSON.parse(document.getElementById('breakfast-tables-data').textContent);

        document.querySelectorAll('.table-card').forEach(card => {
            const isGuest = card.classList.contains('is-guest-table') || card.classList.contains('is-room');
            const iconContainer = card.querySelector('.breakfast-icon-container');
            const tableId = card.querySelector('.card-title').innerText.trim();
            const hasBreakfastItems = breakfastTables.includes(tableId);
            
            if (iconContainer) {
                // Show if it's breakfast time (for potential breakfast) OR if it already has breakfast items (persisted)
                if ((isBreakfastTime && isGuest) || hasBreakfastItems) {
                    iconContainer.style.display = 'block';
                } else {
                    iconContainer.style.display = 'none';
                }
            }
        });
    }
</script>
{% endblock %}
