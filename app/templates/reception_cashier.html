{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>üè® Caixa Recep√ß√£o - Contas</h2>
            <p class="text-muted">Gest√£o de Contas de Quartos e Frigobar</p>
        </div>
        <div>
            <a href="{{ url_for('reception.reception_reservations_cashier') }}" class="btn btn-outline-primary me-2">
                <i class="bi bi-calendar-check"></i> Ir para Reservas
            </a>
        </div>
    </div>

    {% if not cashier %}
    <!-- CASHIER CLOSED STATE -->
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white text-center py-3">
                    <h4 class="mb-0"><i class="bi bi-lock-fill"></i> Caixa Fechado</h4>
                </div>
                <div class="card-body p-4">
                    <p class="text-center text-muted mb-4">O caixa est√° fechado. Informe o valor inicial para abrir.</p>
                    
                    <form method="POST">
                        <input type="hidden" name="action" value="open_cashier">
                        <div class="mb-4">
                            <label class="form-label">Fundo de Caixa (R$)</label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text">R$</span>
                                <input type="tel" class="form-control" name="opening_balance" value="0.00" required onfocus="this.select()" oninput="formatCurrency(this)">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success w-100 btn-lg">
                            <i class="bi bi-unlock-fill"></i> Abrir Caixa
                        </button>
                    </form>
                </div>
            </div>
            

        </div>
    </div>
    
    {% else %}
    <!-- CASHIER OPEN STATE -->
    <div class="row g-3">
        <!-- Summary Cards -->
        <div class="col-md-4">
            <div class="card bg-primary text-white h-100">
                <div class="card-body text-center">
                    <h6 class="card-title opacity-75">Saldo Atual</h6>
                    {% if session.get('role') == 'admin' %}
                    <h2 class="display-6 fw-bold">R$ {{ "%.2f"|format(total_balance) }}</h2>
                    <div class="small mt-2 opacity-75">
                        Abertura: R$ {{ "%.2f"|format(cashier.opening_balance) }}
                    </div>
                    {% else %}
                    <h2 class="display-6 fw-bold">R$ ****</h2>
                    <div class="small mt-2 opacity-75">
                        Abertura: R$ ****
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Recebimentos por Forma de Pagamento</h5>
                </div>
                <div class="card-body">
                    <div class="row row-cols-2 row-cols-md-4 g-2">
                        {% for method, amount in (current_totals|default({})).items() %}
                        <div class="col">
                            <div class="border rounded p-2 text-center bg-light">
                                <div class="small text-muted text-uppercase">{{ method }}</div>
                                {% if session.get('role') == 'admin' %}
                                <div class="fw-bold">R$ {{ "%.2f"|format(amount) }}</div>
                                {% else %}
                                <div class="fw-bold">R$ ****</div>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <div class="col-12 text-center text-muted py-3">
                            Nenhum recebimento registrado ainda.
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Room Charges -->
        {% if grouped_charges %}
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center sticky-top shadow-sm" style="top: 0; z-index: 1020;">
                    <h5 class="mb-0"><i class="bi bi-receipt"></i> Contas de Quartos Pendentes</h5>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-dark text-white shadow-sm">{{ pending_charges|length }} Transfer√™ncia(s) em {{ grouped_charges|length }} Quarto(s)</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="accordion" id="accordionCharges">
                        {% for room in grouped_charges %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading{{ room.room_number }}">
                                <button class="accordion-button {{ 'collapsed' if not loop.first }}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ room.room_number }}">
                                    <div class="d-flex justify-content-between w-100 me-3 align-items-center">
                                        <div>
                                            <span class="badge bg-primary me-2">Quarto {{ room.room_number }}</span>
                                            <span class="fw-bold">{{ room.guest_name }}</span>
                                        </div>
                                        <div class="text-danger fw-bold fs-5">
                                            Total: R$ {{ "%.2f"|format(room.total_debt) }}
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="collapse{{ room.room_number }}" class="accordion-collapse collapse {{ 'show' if loop.first }}" data-bs-parent="#accordionCharges">
                                <div class="accordion-body p-0">
                                    <div class="d-flex justify-content-end p-2 bg-light border-bottom">
                                        <button class="btn btn-sm btn-outline-dark me-2" 
                                                data-room="{{ room.room_number }}"
                                                data-guest="{{ room.guest_name }}"
                                                data-charges="{{ room.charges|tojson|forceescape }}"
                                                onclick="openIndividualBillsModal(this)">
                                            <i class="bi bi-receipt-cutoff"></i> Imprimir Contas Individuais
                                        </button>
                                    </div>
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Data</th>
                                                <th>Origem</th>
                                                <th>Itens</th>
                                                <th class="text-end">Valor</th>
                                                <th class="text-center">A√ß√£o</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for charge in room.charges %}
                                            <tr>
                                                <td class="align-middle">{{ charge.date }}</td>
                                                <td class="align-middle">
                                                    {% if charge.source == 'minibar' or charge.type == 'minibar' %}
                                                        <span class="badge bg-info text-dark"><i class="bi bi-snow"></i> Frigobar</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary"><i class="bi bi-shop"></i> Restaurante</span>
                                                        <small class="d-block text-muted">Mesa {{ charge.table_id }}</small>
                                                    {% endif %}
                                                    {% if charge.flags %}
                                                        <div class="mt-1">
                                                        {% for flag in charge.flags %}
                                                            {% if flag.type == 'service_removed' %}
                                                                <span class="badge bg-warning text-dark" title="Servi√ßo Removido">Sem 10%</span>
                                                            {% elif flag.type == 'discount_applied' %}
                                                                <span class="badge bg-info text-dark" title="Desconto: R$ {{ '%.2f'|format(flag.value) }}">Desconto</span>
                                                            {% endif %}
                                                        {% endfor %}
                                                        </div>
                                                    {% endif %}
                                                </td>
                                                <td class="align-middle">
                                                    <small class="text-muted" style="line-height: 1.2; display: block;">
                                                        {% for item in charge.get('items', []) %}
                                                            <div>{{ item.qty }}x {{ item.name }}</div>
                                                        {% endfor %}
                                                    </small>
                                                </td>
                                                <td class="text-end align-middle fw-bold">R$ {{ "%.2f"|format(charge.total) }}</td>
                                                <td class="text-center align-middle">
                                                    <button class="btn btn-sm btn-success" onclick="openPaymentModal('{{ charge.id }}', '{{ charge.room_number }}', '{{ charge.total }}')">
                                                        <i class="bi bi-cash"></i> Receber
                                                    </button>
                                                    {% if session.role in ['admin', 'gerente', 'supervisor'] or 'recepcao' in session.get('permissions', []) %}
                                                    <button class="btn btn-sm btn-outline-primary ms-1" 
                                                        data-id="{{ charge.id }}"
                                                        data-total="{{ charge.total }}"
                                                        data-date="{{ charge.date }}"
                                                        data-status="{{ charge.status }}"
                                                        data-notes="{{ charge.notes|default('') }}"
                                                        data-service-fee-removed="{{ charge.get('service_fee_removed', False)|tojson }}"
                                                        data-items="{{ charge.get('items', []) | tojson | forceescape }}"
                                                        onclick="openEditModal(this)">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    {% if session.get('role') in ['admin', 'gerente'] and charge.get('table_id') %}
                                                    <button class="btn btn-sm btn-outline-info ms-1" 
                                                            title="Devolver para Restaurante"
                                                            onclick="returnToRestaurant('{{ charge.id }}')">
                                                        <i class="bi bi-arrow-left"></i>
                                                    </button>
                                                    {% endif %}
                                                    {% if session.role == 'admin' %}
                                                    <button class="btn btn-sm btn-outline-danger ms-1" 
                                                            title="Cancelar Consumo"
                                                            onclick="openCancelModal('{{ charge.id }}', '{{ charge.date }}', '{{ charge.total }}', '{{ room.guest_name }}')">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                    {% endif %}
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Actions -->
        <div class="col-md-12">
            <div class="card">
                <div class="card-body d-grid gap-2 d-md-flex justify-content-md-end bg-light">
                    <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#sangriaModal">
                        <i class="bi bi-dash-circle"></i> Sangria
                    </button>
                    <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#suprimentoModal">
                        <i class="bi bi-plus-circle"></i> Suprimento
                    </button>
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#transferModal">
                        <i class="bi bi-arrow-left-right"></i> Transfer√™ncia
                    </button>
                    <button type="button" class="btn btn-dark ms-md-auto" data-bs-toggle="modal" data-bs-target="#closeCashierModal">
                        <i class="bi bi-lock-fill"></i> Fechar Caixa
                    </button>
                </div>
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Movimenta√ß√µes</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Hor√°rio</th>
                                <th>Tipo</th>
                                <th>Descri√ß√£o</th>
                                <th>Forma Pagto</th>
                                <th class="text-end">Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for t in displayed_transactions %}
                            <tr>
                                <td>{{ t.timestamp.split(' ')[1] if t.timestamp else t.time }}</td>
                                <td>
                                    {% if t.type == 'sale' %}
                                        <span class="badge bg-success">Venda Restaurante</span>
                                    {% elif t.category == 'Pagamento de Conta' or t.type == 'in' %}
                                        <span class="badge bg-success">Recebimento</span>
                                    {% elif t.category == 'Suprimento' or t.type == 'deposit' %}
                                        <span class="badge bg-info text-dark">Suprimento</span>
                                    {% elif t.category == 'Sangria' or t.type == 'withdrawal' or t.type == 'out' %}
                                        <span class="badge bg-danger">Sangria</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ t.category|default(t.type) }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ t.description }}
                                    {% if t.flags %}
                                        {% for flag in t.flags %}
                                            {% if flag.type == 'service_removed' %}
                                                <span class="badge bg-warning text-dark ms-1" title="Valor: R$ {{ '%.2f'|format(flag.value) }}">Sem Servi√ßo</span>
                                            {% elif flag.type == 'discount_applied' %}
                                                <span class="badge bg-info text-dark ms-1" title="Valor: R$ {{ '%.2f'|format(flag.value) }}">Desconto</span>
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        {# Fallback for legacy transactions #}
                                        {% if '10% Off' in t.description %}
                                            <span class="badge bg-warning text-dark ms-1">Sem 10%</span>
                                        {% endif %}
                                        {% if 'Desc:' in t.description %}
                                            <span class="badge bg-info text-dark ms-1">Desconto</span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if t.payment_method == 'M√∫ltiplos' %}
                                        <button class="btn btn-sm btn-outline-secondary" onclick="showPaymentDetails({{ t.details.payment_details|tojson|forceescape }})">
                                            <i class="bi bi-info-circle"></i> M√∫ltiplos
                                        </button>
                                    {% else %}
                                        {{ t.payment_method|default('-')|title }}
                                    {% endif %}
                                </td>
                                <td class="text-end fw-bold {{ 'text-danger' if t.type in ['out', 'withdrawal'] else 'text-success' }}">
                                    {% if t.type in ['out', 'withdrawal'] %}-{% endif %}
                                    R$ {{ "%.2f"|format(t.amount) }}
                                </td>
                            </tr>
                            {% else %}
                            <tr id="no-transactions-row">
                                <td colspan="5" class="text-center py-4 text-muted">
                                    Nenhuma movimenta√ß√£o registrada.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    {% if has_more %}
                    <div class="text-center p-3" id="loading-more-container">
                        <button id="load-more-btn" class="btn btn-outline-primary" onclick="loadMoreTransactions()">
                            Carregar Mais
                        </button>
                        <div id="loading-spinner" class="spinner-border text-primary d-none" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Receber Conta - Quarto <span id="modalRoomNum"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" id="paymentForm">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="pay_charge">
                        <input type="hidden" name="charge_id" id="modalChargeId">
                        <input type="hidden" name="payment_data" id="paymentData">
                        
                        <h3 class="text-center mb-4">Total: R$ <span id="modalTotal"></span></h3>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Pagamentos Adicionados:</label>
                            <ul class="list-group mb-3" id="paymentList">
                                <!-- JS will populate this -->
                            </ul>
                            <div class="text-end fw-bold text-danger" id="remainingContainer">
                                Restante: R$ <span id="remainingAmount"></span>
                            </div>
                        </div>

                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Adicionar Pagamento</h6>
                                
                                <div class="mb-3">
                                    <label class="form-label">Valor a Pagar</label>
                                    <input type="tel" class="form-control form-control-lg text-center fw-bold" id="newPaymentAmount" placeholder="R$ 0.00" onfocus="this.select()" oninput="formatCurrency(this)">
                                </div>

                                <div class="d-grid gap-2">
                                    <label class="form-label">Selecione a Forma de Pagamento:</label>
                                    <div class="row g-2">
                                        {% for method in payment_methods %}
                                        <div class="col-6">
                                            <button type="button" class="btn btn-outline-primary w-100 py-3" onclick="addPayment('{{ method.id }}', '{{ method.name }}')">
                                                <i class="bi bi-wallet2 me-2"></i>{{ method.name }}
                                            </button>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success" id="confirmPaymentBtn" disabled>Confirmar Recebimento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sangria Modal -->
    <div class="modal fade" id="sangriaModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Realizar Sangria (Retirada)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="sangriaForm" onsubmit="handleTransaction(event, 'sangriaModal')">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="add_transaction">
                        <input type="hidden" name="type" value="withdrawal">
                        <input type="hidden" name="idempotency_key" class="idempotency-key">
                        <div class="mb-3">
                            <label class="form-label">Valor (R$)</label>
                            <input type="tel" class="form-control" name="amount" required onfocus="this.select()" oninput="formatCurrency(this)">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descri√ß√£o / Motivo</label>
                            <input type="text" class="form-control" name="description" required placeholder="Ex: Pagamento fornecedor">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">
                            <span class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                            Confirmar Sangria
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Suprimento Modal -->
    <div class="modal fade" id="suprimentoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Realizar Suprimento (Entrada)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="suprimentoForm" onsubmit="handleTransaction(event, 'suprimentoModal')">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="add_transaction">
                        <input type="hidden" name="type" value="deposit">
                        <input type="hidden" name="idempotency_key" class="idempotency-key">
                        <div class="mb-3">
                            <label class="form-label">Valor (R$)</label>
                            <input type="tel" class="form-control" name="amount" required onfocus="this.select()" oninput="formatCurrency(this)">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descri√ß√£o / Origem</label>
                            <input type="text" class="form-control" name="description" required placeholder="Ex: Troco adicional">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">
                            <span class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                            Confirmar Suprimento
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Transfer Modal -->
    <div class="modal fade" id="transferModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Realizar Transfer√™ncia</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="transferForm" onsubmit="handleTransaction(event, 'transferModal')">
                    <input type="hidden" name="action" value="add_transaction">
                    <input type="hidden" name="type" value="transfer">
                    <input type="hidden" name="idempotency_key" class="idempotency-key">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Caixa de Destino</label>
                            <select class="form-select" name="target_cashier" required>
                                <option value="restaurant_service">Caixa Restaurante</option>
                                <option value="reception_reservations">Caixa Reservas</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Valor (R$)</label>
                            <input type="tel" class="form-control" name="amount" required onfocus="this.select()" oninput="formatCurrency(this)">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Motivo / Descri√ß√£o</label>
                            <input type="text" class="form-control" name="description" required placeholder="Ex: Transfer√™ncia de troco">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <span class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                            Realizar Transfer√™ncia
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Close Cashier Modal -->
    <div class="modal fade" id="closeCashierModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">Fechar Caixa</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" onsubmit="return confirm('ATEN√á√ÉO: Voc√™ est√° prestes a fechar o caixa. Esta a√ß√£o √© irrevers√≠vel e bloquear√° novas opera√ß√µes at√© a reabertura.\n\nTem certeza que conferiu todos os valores e deseja continuar?');">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="close_cashier">
                        <p>Confira os valores antes de fechar.</p>
                        <div class="alert alert-info">
                            Saldo Calculado em Dinheiro pelo Sistema: <strong>R$ {{ "%.2f"|format(total_balance) }}</strong>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Saldo Final em Dinheiro (Gaveta)</label>
                            <input type="tel" class="form-control" name="closing_cash" required placeholder="0,00" onfocus="this.select()" oninput="formatCurrency(this)">
                            <div class="form-text">Informe o valor em dinheiro contado fisicamente na gaveta.</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Total em Outras Formas de Pagamento</label>
                            <input type="tel" class="form-control" name="closing_non_cash" required placeholder="0,00" onfocus="this.select()" oninput="formatCurrency(this)">
                            <div class="form-text">Somat√≥rio declarado de cart√µes, Pix e demais formas.</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-dark">Confirmar Fechamento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Edit Charge Modal -->
    <div class="modal fade" id="editChargeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Editar Conta</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{{ url_for('reception.reception_edit_charge') }}" onsubmit="prepareEditSubmit()">
                    <div class="modal-body">
                        <div class="row">
                            <!-- Left Column: Basic Info -->
                            <div class="col-md-5 border-end">
                                <ul class="nav nav-tabs mb-3" id="editTabs" role="tablist">
                                    <li class="nav-item">
                                        <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button">Detalhes</button>
                                    </li>
                                </ul>

                                <div class="tab-content" id="editTabContent">
                                    <!-- Details Tab -->
                                    <div class="tab-pane fade show active" id="details" role="tabpanel">
                                        <div class="mb-2">
                                            <label class="form-label text-muted small">ID da Conta</label>
                                            <input type="text" class="form-control-plaintext fw-bold py-0" name="charge_id" id="editChargeId" readonly>
                                        </div>
                                        
                                        <div class="mb-2">
                                            <label class="form-label small">Data</label>
                                            <input type="text" class="form-control form-control-sm" name="new_date" id="editChargeDate" required placeholder="DD/MM/YYYY HH:MM">
                                        </div>
                                        
                                        <div class="mb-2">
                                            <label class="form-label small">Status</label>
                                            <select class="form-select form-select-sm" name="new_status" id="editChargeStatus">
                                                <option value="pending">Pendente</option>
                                                <option value="cancelled">Cancelado</option>
                                                <option value="paid">Pago (Manual)</option>
                                            </select>
                                        </div>

                                        <div class="mb-2">
                                            <label class="form-label small fw-bold text-danger">Motivo da Edi√ß√£o *</label>
                                            <textarea class="form-control form-control-sm" name="justification" id="editJustification" rows="2" required placeholder="Obrigat√≥rio para auditoria..."></textarea>
                                        </div>
                                        
                                        <div class="mb-2">
                                            <label class="form-label small">Observa√ß√µes (Internas)</label>
                                            <textarea class="form-control form-control-sm" name="new_notes" id="editChargeNotes" rows="2"></textarea>
                                        </div>
                                        
                                        <div class="alert alert-warning small py-1 mt-2">
                                            <i class="bi bi-exclamation-triangle"></i> Estoque ajustado auto.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right Column: Items -->
                            <div class="col-md-7">
                                <h6 class="text-primary mb-3">Itens do Pedido</h6>
                                
                                <!-- Add Item Section -->
                                <div class="card bg-light mb-3">
                                    <div class="card-body p-2">
                                        <label class="form-label small fw-bold">Adicionar Item</label>
                                        <div class="input-group input-group-sm mb-2">
                                            <select class="form-select" id="newItemSelect">
                                                <option value="">Selecione um produto...</option>
                                                {% for p in products %}
                                                <option value="{{ p.id }}" data-price="{{ p.price }}" data-name="{{ p.name }}">{{ p.name }} - R$ {{ "%.2f"|format(p.price) }}</option>
                                                {% endfor %}
                                            </select>
                                            <input type="number" class="form-control" id="newItemQty" value="1" min="0.1" step="0.1" style="max-width: 70px;">
                                            <button type="button" class="btn btn-success" onclick="addNewEditItem()">
                                                <i class="bi bi-plus-lg"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Items List -->
                                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                    <table class="table table-sm table-hover" id="editItemsTable">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Item</th>
                                                <th class="text-end">Qtd</th>
                                                <th class="text-end">Total</th>
                                                <th class="text-center">A√ß√£o</th>
                                            </tr>
                                        </thead>
                                        <tbody id="editItemsList">
                                            <!-- JS will populate -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="form-check d-flex justify-content-end mb-2">
                                    <input class="form-check-input me-2" type="checkbox" id="removeServiceFee" name="remove_service_fee" onchange="renderEditItems()">
                                    <label class="form-check-label small" for="removeServiceFee">
                                        Retirar 10% (Taxa de Servi√ßo)
                                    </label>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center mt-3 pt-2 border-top">
                                    <span class="text-muted">Total Estimado:</span>
                                    <span class="fw-bold fs-5 text-primary" id="editGrandTotal">R$ 0.00</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden Inputs for JSON Data -->
                        <input type="hidden" name="items_to_add" id="itemsToAddInput">
                        <input type="hidden" name="items_to_remove" id="itemsToRemoveInput">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Print Pending Bills Modal -->
    <div class="modal fade" id="printPendingBillsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="bi bi-printer"></i> Imprimir Relat√≥rio Pendente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="printModalDescription">Selecione a impressora para o relat√≥rio consolidado das contas pendentes.</p>
                    <input type="hidden" id="targetRoomNumber" value="">
                    
                    <div class="mb-3">
                        <label class="form-label">Impressora</label>
                        <select class="form-select" id="reportPrinterSelect">
                            <option value="">Selecione...</option>
                            {% for p in printers %}
                            <option value="{{ p.id }}" {% if printer_settings.get('default_reception_report_printer_id') == p.id %}selected{% endif %}>
                                {{ p.name }} ({{ p.ip }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="savePrinterPref" checked>
                        <label class="form-check-label" for="savePrinterPref">
                            Lembrar minha escolha
                        </label>
                    </div>

                    <div id="printResult" class="alert d-none"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" onclick="submitPrintReport()" id="btnPrintReport">
                        <i class="bi bi-printer-fill"></i> Imprimir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Individual Bills Print Modal -->
    <div class="modal fade" id="individualBillsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="bi bi-receipt-cutoff"></i> Imprimir Contas Individuais</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Selecione as contas que deseja imprimir (Formato T√©rmico 80mm):</p>
                    <input type="hidden" id="indivRoomNumber">
                    <input type="hidden" id="indivGuestName">
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAllBills" checked onchange="toggleAllBills(this)">
                            <label class="form-check-label fw-bold" for="selectAllBills">
                                Selecionar Todos
                            </label>
                        </div>
                        <div class="list-group mt-2" id="billsList" style="max-height: 200px; overflow-y: auto;">
                            <!-- JS populated -->
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Impressora</label>
                        <select class="form-select" id="indivPrinterSelect">
                            <option value="">Selecione...</option>
                            {% for p in printers %}
                            <option value="{{ p.id }}" {% if printer_settings.get('default_reception_printer_id') == p.id %}selected{% endif %}>
                                {{ p.name }} ({{ p.ip }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div id="indivPrintResult" class="alert d-none"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="submitIndividualBillsPrint()" id="btnIndivPrint">
                        <i class="bi bi-printer-fill"></i> Imprimir Selecionados
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cancel Confirmation Modal -->
    <div class="modal fade" id="cancelConsumptionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill"></i> Cancelar Consumo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja cancelar este consumo?</p>
                    <div class="alert alert-light border">
                        <p class="mb-1"><strong>H√≥spede:</strong> <span id="cancelGuestName"></span></p>
                        <p class="mb-1"><strong>Data:</strong> <span id="cancelDate"></span></p>
                        <p class="mb-0"><strong>Valor:</strong> R$ <span id="cancelTotal"></span></p>
                    </div>
                    
                    <form id="cancelConsumptionForm">
                        <input type="hidden" id="cancelChargeId" name="charge_id">
                        <div class="mb-3">
                            <label for="cancelJustification" class="form-label fw-bold">Justificativa (Obrigat√≥rio)</label>
                            <textarea class="form-control" id="cancelJustification" rows="3" required placeholder="Motivo do cancelamento..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-danger" onclick="submitCancelConsumption()">Confirmar Cancelamento</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Details Modal -->
    <div class="modal fade" id="paymentDetailsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">Detalhes do Pagamento</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="list-group" id="paymentDetailsList">
                        <!-- Populated by JS -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="returnToRestaurantModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill"></i> Mesa Ocupada</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>A mesa original est√° ocupada. Por favor, selecione uma mesa livre para devolver os itens:</p>
                    <input type="hidden" id="returnChargeId">
                    <div class="mb-3">
                        <label for="returnTargetTable" class="form-label">Mesa Destino</label>
                        <select class="form-select" id="returnTargetTable">
                            <!-- Options populated via JS -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="submitReturnToRestaurant()">Confirmar Devolu√ß√£o</button>
                </div>
            </div>
        </div>
    </div>

    {% endif %}
</div>

<script>
function showPaymentDetails(details) {
    const list = document.getElementById('paymentDetailsList');
    list.innerHTML = '';
    
    if (details && details.length > 0) {
        details.forEach(p => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `
                ${p.method_name}
                <span class="badge bg-primary rounded-pill">R$ ${parseFloat(p.amount).toFixed(2)}</span>
            `;
            list.appendChild(li);
        });
    } else {
        list.innerHTML = '<li class="list-group-item">Nenhum detalhe dispon√≠vel</li>';
    }
    
    const modal = new bootstrap.Modal(document.getElementById('paymentDetailsModal'));
    modal.show();
}

function returnToRestaurant(chargeId) {
    if (!confirm('Tem certeza que deseja devolver este consumo para o restaurante?')) {
        return;
    }
    performReturnToRestaurant(chargeId);
}

function performReturnToRestaurant(chargeId, targetTableId = null) {
    const payload = { charge_id: chargeId };
    if (targetTableId) {
        payload.target_table_id = targetTableId;
    }

    fetch('/api/reception/return_to_restaurant', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json().then(data => ({ status: response.status, body: data })))
    .then(({ status, body }) => {
        if (status === 200 && body.success) {
            alert('Consumo devolvido ao restaurante com sucesso!');
            location.reload();
        } else if (status === 409 && body.error_code === 'TABLE_OCCUPIED') {
            showReturnTableModal(chargeId, body.free_tables);
        } else {
            alert('Erro ao devolver consumo: ' + (body.error || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erro de conex√£o ao tentar devolver o consumo.');
    });
}

function showReturnTableModal(chargeId, freeTables) {
    const modalEl = document.getElementById('returnToRestaurantModal');
    const select = document.getElementById('returnTargetTable');
    document.getElementById('returnChargeId').value = chargeId;
    
    select.innerHTML = '';
    freeTables.forEach(t => {
        const option = document.createElement('option');
        option.value = t;
        option.text = `Mesa ${t}`;
        select.appendChild(option);
    });
    
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
}

function submitReturnToRestaurant() {
    const chargeId = document.getElementById('returnChargeId').value;
    const targetTable = document.getElementById('returnTargetTable').value;
    
    if (!targetTable) {
        alert('Selecione uma mesa.');
        return;
    }
    
    // Hide modal
    const modalEl = document.getElementById('returnToRestaurantModal');
    const modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();
    
    performReturnToRestaurant(chargeId, targetTable);
}

    function openIndividualBillsModal(btn) {
        const roomNum = btn.dataset.room;
        const guestName = btn.dataset.guest;
        const chargesJson = btn.dataset.charges;
        
        document.getElementById('indivRoomNumber').value = roomNum;
        document.getElementById('indivGuestName').value = guestName;
        
        let charges = [];
        try {
            charges = JSON.parse(chargesJson || '[]');
        } catch(e) {
            console.error("Error parsing charges", e);
        }
        
        const list = document.getElementById('billsList');
        list.innerHTML = '';
        
        if (charges.length === 0) {
            list.innerHTML = '<div class="list-group-item text-muted">Nenhuma conta pendente.</div>';
        } else {
            charges.forEach(c => {
                const date = c.date || 'N/A';
                const total = parseFloat(c.total || 0).toFixed(2);
                const desc = (c.items && c.items.length > 0) 
                    ? c.items.map(i => `${i.qty}x ${i.name}`).join(', ').substring(0, 30) + '...'
                    : 'Consumo Diverso';
                
                const item = document.createElement('label');
                item.className = 'list-group-item d-flex gap-2';
                item.innerHTML = `
                    <input class="form-check-input flex-shrink-0 bill-checkbox" type="checkbox" value="${c.id}" checked>
                    <span>
                        <small class="fw-bold d-block">${date} - R$ ${total}</small>
                        <small class="text-muted">${desc}</small>
                    </span>
                `;
                list.appendChild(item);
            });
        }
        
        document.getElementById('selectAllBills').checked = true;
        document.getElementById('indivPrintResult').className = 'alert d-none';
        
        const modal = new bootstrap.Modal(document.getElementById('individualBillsModal'));
        modal.show();
    }
    
    function toggleAllBills(checkbox) {
        const checkboxes = document.querySelectorAll('.bill-checkbox');
        checkboxes.forEach(cb => cb.checked = checkbox.checked);
    }
    
    function submitIndividualBillsPrint() {
        const roomNum = document.getElementById('indivRoomNumber').value;
        const guestName = document.getElementById('indivGuestName').value;
        const printerId = document.getElementById('indivPrinterSelect').value;
        const btn = document.getElementById('btnIndivPrint');
        const resultDiv = document.getElementById('indivPrintResult');
        
        if (!printerId) {
            alert('Selecione uma impressora.');
            return;
        }
        
        const selectedIds = Array.from(document.querySelectorAll('.bill-checkbox:checked')).map(cb => cb.value);
        
        if (selectedIds.length === 0) {
            alert('Selecione pelo menos uma conta para imprimir.');
            return;
        }
        
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Imprimindo...';
        resultDiv.className = 'alert d-none';
        
        fetch('/reception/print_individual_bills', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                room_number: roomNum,
                guest_name: guestName,
                printer_id: printerId,
                selected_charge_ids: selectedIds
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                resultDiv.className = 'alert alert-success';
                resultDiv.textContent = data.message;
                resultDiv.classList.remove('d-none');
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('individualBillsModal')).hide();
                }, 1500);
            } else {
                resultDiv.className = 'alert alert-danger';
                resultDiv.textContent = 'Erro: ' + data.message;
                resultDiv.classList.remove('d-none');
            }
        })
        .catch(err => {
            console.error(err);
            resultDiv.className = 'alert alert-danger';
            resultDiv.textContent = 'Erro de comunica√ß√£o.';
            resultDiv.classList.remove('d-none');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-printer-fill"></i> Imprimir Selecionados';
        });
    }

function openPrintModal(roomNumber = null) {
    const modal = new bootstrap.Modal(document.getElementById('printPendingBillsModal'));
    const desc = document.getElementById('printModalDescription');
    const input = document.getElementById('targetRoomNumber');
    
    if (roomNumber) {
        desc.textContent = `Selecione a impressora para o relat√≥rio do Quarto ${roomNumber}.`;
        input.value = roomNumber;
    } else {
        desc.textContent = 'Selecione a impressora para o relat√≥rio consolidado das contas pendentes.';
        input.value = '';
    }
    
    modal.show();
}

function submitPrintReport() {
    const printerId = document.getElementById('reportPrinterSelect').value;
    const savePref = document.getElementById('savePrinterPref').checked;
    const btn = document.getElementById('btnPrintReport');
    const resultDiv = document.getElementById('printResult');
    const roomNumber = document.getElementById('targetRoomNumber').value;

    if (!printerId) {
        alert('Por favor, selecione uma impressora.');
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Imprimindo...';
    resultDiv.className = 'alert d-none';

    fetch('/reception/print_pending_bills', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            printer_id: printerId,
            save_default: savePref,
            room_number: roomNumber || null
        })
    })
    .then(async response => {
        const ct = response.headers.get('content-type') || '';
        const isJson = ct.includes('application/json');
        
        if (response.status === 401) {
            alert('Sess√£o expirada. Fa√ßa login novamente.');
            window.location.href = '/login';
            throw new Error('unauthorized');
        }

        if (!isJson) {
            if (response.status === 302) {
                window.location.href = '/login';
                throw new Error('unauthorized');
            }
            throw new Error('non-json');
        }
        const data = await response.json();
        data._status = response.status;
        return data;
    })
    .then(data => {
        resultDiv.className = data.success ? 'alert alert-success' : 'alert alert-danger';
        resultDiv.textContent = data.message;
        resultDiv.classList.remove('d-none');
        
        if (data.success) {
            setTimeout(() => {
                var modal = bootstrap.Modal.getInstance(document.getElementById('printPendingBillsModal'));
                modal.hide();
                resultDiv.classList.add('d-none');
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (String(error && error.message).includes('unauthorized')) {
            return;
        }
        resultDiv.className = 'alert alert-danger';
        resultDiv.textContent = 'Erro de comunica√ß√£o com o servidor.';
        resultDiv.classList.remove('d-none');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-printer-fill"></i> Imprimir';
    });
}

    var cancelModal;

    function openCancelModal(id, date, total, guestName) {
        if (!cancelModal) {
            cancelModal = new bootstrap.Modal(document.getElementById('cancelConsumptionModal'));
        }
        document.getElementById('cancelChargeId').value = id;
        document.getElementById('cancelGuestName').innerText = guestName;
        document.getElementById('cancelDate').innerText = date;
        document.getElementById('cancelTotal').innerText = parseFloat(total).toFixed(2);
        document.getElementById('cancelJustification').value = ''; 
        cancelModal.show();
    }

    function submitCancelConsumption() {
        const chargeId = document.getElementById('cancelChargeId').value;
        const justification = document.getElementById('cancelJustification').value;
        
        if (!justification.trim()) {
            alert('Por favor, informe uma justificativa para o cancelamento.');
            return;
        }
        
        const btn = document.querySelector('#cancelConsumptionModal .btn-danger');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processando...';
        btn.disabled = true;
        
        fetch('/admin/consumption/cancel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                charge_id: chargeId,
                justification: justification
            })
        })
        .then(async response => {
            const ct = response.headers.get('content-type') || '';
            const isJson = ct.includes('application/json');

            if (response.status === 401) {
                alert('Sess√£o expirada. Fa√ßa login novamente.');
                window.location.href = '/login';
                throw new Error('unauthorized');
            }

            if (!isJson) {
                if (response.status === 302) {
                    window.location.href = '/login';
                    throw new Error('unauthorized');
                }
                throw new Error('non-json');
            }
            const data = await response.json();
            data._status = response.status;
            return data;
        })
        .then(data => {
            if (data.success) {
                alert('Consumo cancelado com sucesso!');
                location.reload(); 
            } else {
                alert('Erro: ' + data.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (String(error && error.message).includes('unauthorized')) {
                return;
            }
            alert('Erro ao processar a solicita√ß√£o.');
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }

    // Existing Scripts
    // Edit Modal Logic
    let itemsToAdd = [];
    let itemsToRemove = [];
    let editItems = [];

    window.openEditModal = function(btn) {
        const id = btn.dataset.id;
        const total = btn.dataset.total;
        const date = btn.dataset.date;
        const status = btn.dataset.status;
        const notes = btn.dataset.notes;
        const itemsJson = btn.dataset.items;
        const serviceFeeRemoved = btn.dataset.serviceFeeRemoved === 'true';

        document.getElementById('editChargeId').value = id;
        
        const removeServiceFeeCheckbox = document.getElementById('removeServiceFee');
        if (removeServiceFeeCheckbox) {
            removeServiceFeeCheckbox.checked = serviceFeeRemoved;
        }
        document.getElementById('editChargeTotal').value = parseFloat(total).toFixed(2);
        document.getElementById('editChargeDate').value = date;
        document.getElementById('editChargeStatus').value = status;
        document.getElementById('editChargeNotes').value = notes;
        
        // Reset Justification
        const justField = document.getElementById('editJustification');
        if(justField) justField.value = '';

        // Parse Items
        try {
            editItems = JSON.parse(itemsJson || '[]');
        } catch (e) {
            console.error("Error parsing items", e);
            editItems = [];
        }
        
        // Reset Tab to Details
        const firstTabEl = document.querySelector('#editTabs button[data-bs-target="#details"]');
        if (firstTabEl) {
            const tab = new bootstrap.Tab(firstTabEl);
            tab.show();
        }

        // Reset Changes
        itemsToRemove = [];
        itemsToAdd = [];
        document.getElementById('itemsToAddInput').value = '';
        document.getElementById('itemsToRemoveInput').value = '';
        document.getElementById('newItemQty').value = '1';
        document.getElementById('newItemSelect').value = '';

        renderEditItems();
        
        var myModal = new bootstrap.Modal(document.getElementById('editChargeModal'));
        myModal.show();
    };

    window.renderEditItems = function() {
        const tbody = document.getElementById('editItemsList');
        tbody.innerHTML = '';
        
        let estimatedTotal = 0;

        // Render Existing Items (unless removed)
        editItems.forEach(item => {
            if (itemsToRemove.includes(item.id)) return; // Skip removed items
            
            const price = parseFloat(item.price || 0);
            const qty = parseFloat(item.qty || 1);
            
            // Calculate complements
            let compsTotal = 0;
            if (item.complements) {
                item.complements.forEach(c => compsTotal += parseFloat(c.price || 0));
            }
            
            const itemTotal = qty * (price + compsTotal);
            estimatedTotal += itemTotal;
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    ${item.name}
                    ${item.complements ? '<br><small class="text-muted">+ ' + item.complements.map(c => c.name).join(', ') + '</small>' : ''}
                </td>
                <td class="text-end">${qty}</td>
                <td class="text-end">R$ ${itemTotal.toFixed(2)}</td>
                <td class="text-center">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeEditItem('${item.id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });

        // Render Newly Added Items
        itemsToAdd.forEach((item, index) => {
             const price = parseFloat(item.price || 0);
             const qty = parseFloat(item.qty || 1);
             const itemTotal = qty * price;
             estimatedTotal += itemTotal;

             const row = document.createElement('tr');
             row.classList.add('table-success'); // Highlight new items
             row.innerHTML = `
                <td>${item.name} <span class="badge bg-success">Novo</span></td>
                <td class="text-end">${qty}</td>
                <td class="text-end">R$ ${itemTotal.toFixed(2)}</td>
                <td class="text-center">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeNewItem(${index})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        // Update Total Display (Estimate with 10% service fee)
        const removeServiceFee = document.getElementById('removeServiceFee').checked;
        const serviceFee = removeServiceFee ? 0 : (estimatedTotal * 0.10);
        const grandTotal = estimatedTotal + serviceFee;
        
        document.getElementById('editChargeTotal').value = grandTotal.toFixed(2);
        document.getElementById('editGrandTotal').textContent = "R$ " + grandTotal.toFixed(2);
    };

    window.removeEditItem = function(itemId) {
        if (!itemsToRemove.includes(itemId)) {
            itemsToRemove.push(itemId);
            renderEditItems();
        }
    };

    window.removeNewItem = function(index) {
        itemsToAdd.splice(index, 1);
        renderEditItems();
    };

    window.addNewEditItem = function() {
        const select = document.getElementById('newItemSelect');
        const qtyInput = document.getElementById('newItemQty');
        
        const productId = select.value;
        if (!productId) return;
        
        const option = select.options[select.selectedIndex];
        const name = option.dataset.name;
        const price = parseFloat(option.dataset.price);
        const qty = parseFloat(qtyInput.value);
        
        if (qty <= 0) {
            alert("Quantidade inv√°lida");
            return;
        }
        
        itemsToAdd.push({
            id: productId,
            name: name,
            price: price,
            qty: qty
        });
        
        renderEditItems();
        
        // Reset inputs
        select.value = '';
        qtyInput.value = '1';
    };

    window.prepareEditSubmit = function() {
        document.getElementById('itemsToAddInput').value = JSON.stringify(itemsToAdd);
        document.getElementById('itemsToRemoveInput').value = JSON.stringify(itemsToRemove);
        return true;
    };

    window.formatCurrency = function(input) {
        let value = input.value.replace(/\D/g, '');
        if (value === '') {
            input.value = '';
            return;
        }
        let floatVal = parseInt(value) / 100;
        input.value = floatVal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };

    // Multi-Payment Logic
    let grandTotal = 0;
    let payments = [];

    window.openPaymentModal = function(chargeId, roomNum, total) {
        document.getElementById('modalChargeId').value = chargeId;
        document.getElementById('modalRoomNum').textContent = roomNum;
        
        // Reset Payment State
        grandTotal = parseFloat(total);
        document.getElementById('modalTotal').textContent = grandTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        payments = [];
        document.getElementById('newPaymentAmount').value = grandTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        updatePaymentUI();
        
        var myModal = new bootstrap.Modal(document.getElementById('paymentModal'));
        myModal.show();
    };

    window.addPayment = function(methodId, methodName) {
        const amountInput = document.getElementById('newPaymentAmount');
        // Robust parsing using formatCurrency logic style
        let valueStr = amountInput.value.replace(/\./g, '').replace(',', '.');
        let amount = parseFloat(valueStr);
        if (isNaN(amount)) amount = 0;

        if (!methodId || amount <= 0) {
            alert('Valor inv√°lido.');
            return;
        }
        
        // Calculate current total paid
        const currentPaid = payments.reduce((sum, p) => sum + p.amount, 0);
        const remaining = grandTotal - currentPaid;

        // Check if Cash Payment (allows change)
        const isCash = methodName.toLowerCase().includes('dinheiro');

        if (!isCash && amount > remaining + 0.01) { // Tolerance for float errors
            alert('O valor excede o restante a pagar.');
            amount = remaining; 
        }

        payments.push({
            id: methodId,
            name: methodName,
            amount: amount
        });

        // Reset input for next payment (auto-fill remaining)
        amountInput.value = "";
        
        // Determine next auto-fill amount
        const nextRemaining = grandTotal - payments.reduce((sum, p) => sum + p.amount, 0);
        if (nextRemaining > 0) {
            amountInput.value = nextRemaining.toFixed(2);
        } else {
             amountInput.value = "0.00";
        }

        updatePaymentUI();
    };

    window.removePayment = function(index) {
        payments.splice(index, 1);
        updatePaymentUI();
    };

    function updatePaymentUI() {
        const list = document.getElementById('paymentList');
        list.innerHTML = '';
        
        let totalPaid = 0;

        payments.forEach((p, index) => {
            totalPaid += p.amount;
            const item = document.createElement('li');
            item.className = 'list-group-item d-flex justify-content-between align-items-center';
            item.innerHTML = `
                <span>${p.name}</span>
                <span class="badge bg-primary rounded-pill me-2">R$ ${p.amount.toFixed(2)}</span>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removePayment(${index})">&times;</button>
            `;
            list.appendChild(item);
        });

        const remaining = grandTotal - totalPaid;
        const remainingEl = document.getElementById('remainingAmount');
        const confirmBtn = document.getElementById('confirmPaymentBtn');
        const paymentDataInput = document.getElementById('paymentData');

        remainingEl.textContent = remaining > 0 ? remaining.toFixed(2) : '0.00';
        
        if (remaining <= 0.01) {
            document.getElementById('remainingContainer').classList.remove('text-danger');
            document.getElementById('remainingContainer').classList.add('text-success');
            document.getElementById('remainingContainer').innerHTML = 'Total Pago <i class="bi bi-check-circle-fill"></i>';
            confirmBtn.disabled = false;
        } else {
            document.getElementById('remainingContainer').classList.add('text-danger');
            document.getElementById('remainingContainer').classList.remove('text-success');
             document.getElementById('remainingContainer').innerHTML = `Restante: R$ <span id="remainingAmount">${remaining.toFixed(2)}</span>`;
            confirmBtn.disabled = true;
        }

        // Update Hidden Input with JSON
        paymentDataInput.value = JSON.stringify(payments);
    }

    window.returnToRestaurant = function(chargeId, targetTableId = null) {
        if (!targetTableId && !confirm('Tem certeza que deseja devolver esta conta para o Restaurante?\nA mesa ser√° reaberta e os itens devolvidos.')) {
            return;
        }

        const payload = { charge_id: chargeId };
        if (targetTableId) {
            payload.target_table_id = targetTableId;
        }

        fetch('/api/reception/return_to_restaurant', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        })
        .then(async response => {
            const ct = response.headers.get('content-type') || '';
            if (ct.includes('application/json')) {
                return response.json();
            } else {
                const text = await response.text();
                // Check for common HTML error pages
                if (text.includes('<!doctype html>') || text.includes('<html')) {
                    console.error('HTML Error Response:', text);
                    throw new Error(`Erro do servidor (${response.status}). Consulte o console.`);
                }
                throw new Error(text || `Erro desconhecido (${response.status})`);
            }
        })
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                if (data.error_code === 'TABLE_OCCUPIED') {
                    let freeTablesMsg = '';
                    if (data.free_tables && data.free_tables.length > 0) {
                        freeTablesMsg = '\nMesas livres sugeridas: ' + data.free_tables.slice(0, 15).join(', ') + (data.free_tables.length > 15 ? '...' : '');
                    }
                    
                    const newTable = prompt(data.message + '\n\nPor favor, informe o n√∫mero de uma nova mesa para transferir:' + freeTablesMsg);
                    
                    if (newTable) {
                        window.returnToRestaurant(chargeId, newTable);
                    }
                } else {
                    alert('Erro: ' + data.message);
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao processar solicita√ß√£o: ' + error.message);
        });
    };
</script>

<script>
    // Fix for Suprimento Modal
    document.addEventListener('DOMContentLoaded', function() {
        const suprimentoForm = document.getElementById('suprimentoForm');
        if (suprimentoForm) {
            suprimentoForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const btn = document.getElementById('btnConfirmSuprimento');
                const btnCancel = document.getElementById('btnCancelSuprimento');
                const spinner = document.getElementById('suprimentoSpinner');
                const btnText = document.getElementById('suprimentoBtnText');
                const errorDiv = document.getElementById('suprimentoError');
                
                // 1. Immediate Disable
                btn.disabled = true;
                btnCancel.disabled = true;
                
                // 2. Loading Indicator
                spinner.classList.remove('d-none');
                btnText.textContent = 'Processando...';
                
                // Clear previous errors
                errorDiv.classList.add('d-none');
                errorDiv.textContent = '';
                
                // 3. State Validation (Implicit via disabled button)
                
                const formData = new FormData(suprimentoForm);
                
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    const ct = response.headers.get('content-type') || '';
                    if (ct.includes('application/json')) {
                        return response.json();
                    } else {
                         // Fallback for HTML error pages
                         return response.text().then(text => {
                            throw new Error('Erro no servidor. Consulte o console.');
                         });
                    }
                })
                .then(data => {
                    if (data.success) {
                        // 4. Auto Close only on success (via Reload)
                        window.location.reload(); 
                    } else {
                        // 5. Error Handling
                        throw new Error(data.message || 'Erro desconhecido');
                    }
                })
                .catch(error => {
                    // Keep modal open, show error
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('d-none');
                    
                    // Re-enable controls
                    btn.disabled = false;
                    btnCancel.disabled = false;
                    spinner.classList.add('d-none');
                    btnText.textContent = 'Confirmar Suprimento';
                });
            });
        }
    });
</script>

<script>
    // Infinite Scroll / Pagination Logic
    let currentPage = {{ current_page|default(1) }};
    let isLoading = false;
    let hasMore = {{ 'true' if has_more else 'false' }};

    function loadMoreTransactions() {
        if (isLoading || !hasMore) return;

        isLoading = true;
        document.getElementById('load-more-btn').classList.add('d-none');
        document.getElementById('loading-spinner').classList.remove('d-none');

        const nextPage = currentPage + 1;
        
        fetch(`${window.location.pathname}?page=${nextPage}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            const tbody = document.querySelector('.table-responsive tbody');
            const noTxRow = document.getElementById('no-transactions-row');
            if (noTxRow) noTxRow.remove();

            data.transactions.forEach(t => {
                const row = document.createElement('tr');
                
                // Determine badges
                let typeBadge = '';
                if (t.type === 'sale') typeBadge = '<span class="badge bg-success">Venda Restaurante</span>';
                else if (t.category === 'Pagamento de Conta' || t.type === 'in') typeBadge = '<span class="badge bg-success">Recebimento</span>';
                else if (t.category === 'Suprimento' || t.type === 'deposit') typeBadge = '<span class="badge bg-info text-dark">Suprimento</span>';
                else if (t.category === 'Sangria' || t.type === 'withdrawal' || t.type === 'out') typeBadge = '<span class="badge bg-danger">Sangria</span>';
                else typeBadge = `<span class="badge bg-secondary">${t.category || t.type}</span>`;

                // Payment Method
                let paymentCol = '';
                if (t.payment_method === 'M√∫ltiplos') {
                    paymentCol = `<button class="btn btn-sm btn-outline-secondary" onclick='alert("Detalhes de pagamentos m√∫ltiplos n√£o dispon√≠veis no carregamento din√¢mico simplificado.")'>
                                    <i class="bi bi-info-circle"></i> M√∫ltiplos
                                  </button>`;
                } else {
                    paymentCol = (t.payment_method || '-');
                    paymentCol = paymentCol.charAt(0).toUpperCase() + paymentCol.slice(1);
                }

                // Amount
                const isNegative = ['out', 'withdrawal'].includes(t.type);
                const amountClass = isNegative ? 'text-danger' : 'text-success';
                const prefix = isNegative ? '-' : '';

                row.innerHTML = `
                    <td>${t.timestamp ? t.timestamp.split(' ')[1] : t.time}</td>
                    <td>${typeBadge}</td>
                    <td>${t.description}</td>
                    <td>${paymentCol}</td>
                    <td class="text-end fw-bold ${amountClass}">
                        ${prefix} R$ ${parseFloat(t.amount).toFixed(2)}
                    </td>
                `;
                tbody.appendChild(row);
            });

            currentPage = data.current_page;
            hasMore = data.has_more;

            if (!hasMore) {
                const container = document.getElementById('loading-more-container');
                if (container) container.remove();
            } else {
                document.getElementById('load-more-btn').classList.remove('d-none');
                document.getElementById('loading-spinner').classList.add('d-none');
            }
        })
        .catch(err => {
            console.error('Error loading transactions:', err);
            alert('Erro ao carregar mais transa√ß√µes.');
            document.getElementById('load-more-btn').classList.remove('d-none');
            document.getElementById('loading-spinner').classList.add('d-none');
        })
        .finally(() => {
            isLoading = false;
        });
    }

    // Generic Async Transaction Handler
    async function handleTransaction(event, modalId) {
        event.preventDefault();
        
        const form = event.target;
        const submitBtn = form.querySelector('button[type="submit"]');
        const spinner = submitBtn.querySelector('.spinner-border');
        
        // Disable UI
        submitBtn.disabled = true;
        if (spinner) spinner.classList.remove('d-none');
        
        const formData = new FormData(form);
        
        try {
            const response = await fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            const result = await response.json();
            
            if (result.success || (result.message && !result.error)) {
                // Success
                const modalEl = document.getElementById(modalId);
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
                form.reset();
                
                // Regenerate UUID for next time
                const keyInput = form.querySelector('.idempotency-key');
                if (keyInput) keyInput.value = generateUUID();
                
                // Reload to show new data
                window.location.reload(); 
            } else {
                // Error
                alert(result.error || result.message || 'Erro ao processar transa√ß√£o.');
                submitBtn.disabled = false;
                if (spinner) spinner.classList.add('d-none');
            }
        } catch (error) {
            console.error('Error:', error);
            // If response is not JSON (e.g. standard redirect), reload
            window.location.reload();
        }
    }

    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    // Initialize UUIDs on Modal Show
    document.addEventListener('DOMContentLoaded', function() {
        ['suprimentoModal', 'sangriaModal', 'transferModal'].forEach(id => {
            const modal = document.getElementById(id);
            if (modal) {
                modal.addEventListener('show.bs.modal', function () {
                    const form = modal.querySelector('form');
                    const keyInput = form.querySelector('.idempotency-key');
                    if (keyInput) keyInput.value = generateUUID();
                });
            }
        });
    });

    // Existing functions preserved/restored if not already present
    // Note: openIndividualBillsModal, openPaymentModal, etc., are likely defined in base.html or elsewhere.
    // If they were inline in the original file, we should be careful not to overwrite them unless we saw them in the read.
    // The read showed they are used in onclick attributes, so they must be defined somewhere.
    // I will assume they are global or I need to keep them if they were in the previous script block.
    // The previous script block wasn't fully shown in the read (it was truncated at the end).
    // Let's assume the complex logic for editChargeModal etc is in a separate file or was in the truncated part.
    // Wait, the truncated part was the TOP of the file. The bottom read (tool 5) showed the modals but NO SCRIPT block at all at the end of tool 5 output.
    // Actually, tool 5 output ended at line 626 with `Total Estimado:</span>`. It was inside `editChargeModal`.
    // So I haven't seen the end of `reception_cashier.html` yet!
    // This is risky. I might be overwriting existing scripts if I just append.
    // I should read the VERY END of `reception_cashier.html` first.
</script>
{% endblock %}
