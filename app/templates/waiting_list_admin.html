{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-people-fill"></i> Fila de Espera - Recepção</h2>
        <div>
            <span class="badge bg-{{ 'success' if settings.is_open else 'danger' }} me-2">
                {{ 'ABERTA' if settings.is_open else 'FECHADA' }}
            </span>
            <div class="btn-group">
                <a href="{{ url_for('reception.toggle_queue_status') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-power"></i> {{ 'Fechar Fila' if settings.is_open else 'Abrir Fila' }}
                </a>
                <a href="{{ queue_public_url }}" target="_blank" class="btn btn-outline-primary">
                    <i class="bi bi-box-arrow-up-right"></i> Link Público
                </a>
            </div>
            <a href="{{ url_for('reception.reception_dashboard') }}" class="btn btn-secondary ms-2">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Queue List -->
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Na Fila ({{ queue|length }})</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Ações</th>
                                <th>Pos</th>
                                <th>Nome</th>
                                <th>Pessoas</th>
                                <th>Entrada</th>
                                <th>Espera</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in queue %}
                            <tr class="{{ 'table-warning' if item.wait_minutes > 45 else '' }}">
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button"
                                                class="btn btn-success"
                                                data-wa-phone="{{ item.wa_phone }}"
                                                data-wa-message="{{ item.call_message|e }}"
                                                onclick="callCustomer('{{ item.id }}', this)">
                                            <i class="bi bi-whatsapp"></i> Chamar
                                        </button>
                                        <a href="{{ url_for('reception.update_queue_status', id=item.id, status='seated') }}" class="btn btn-primary" title="Marcar como Sentado">
                                            <i class="bi bi-check-lg"></i>
                                        </a>
                                        <button type="button"
                                                class="btn btn-outline-danger"
                                                data-remove-url="{{ url_for('reception.update_queue_status', id=item.id, status='removed') }}"
                                                onclick="removeCustomer(this.getAttribute('data-remove-url'))"
                                                title="Remover/Cancelar">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                </td>
                                <td class="fw-bold text-center">#{{ loop.index }}</td>
                                <td>
                                    <div class="fw-bold">
                                        {{ item.name }}
                                        {% if item.is_recurring %}
                                        <span class="badge bg-warning text-dark ms-2">
                                            <i class="bi bi-arrow-repeat"></i> Recorrente{% if item.visit_number %} #{{ item.visit_number }}{% endif %}
                                        </span>
                                        {% endif %}
                                    </div>
                                    <div class="small text-muted">{{ item.phone }}</div>
                                </td>
                                <td><span class="badge bg-secondary rounded-pill">{{ item.party_size }}</span></td>
                                <td>{{ item.entry_time_fmt }}</td>
                                <td>
                                    <span class="fw-bold {{ 'text-danger' if item.wait_minutes > 45 else 'text-success' }}">
                                        {{ item.wait_minutes }} min
                                    </span>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center py-4 text-muted">Ninguém na fila de espera.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Metrics & Settings -->
        <div class="col-md-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Métricas de Hoje</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <h3>{{ metrics.active_count }}</h3>
                            <small class="text-muted">Em Espera</small>
                        </div>
                        <div class="col-6">
                            <h3>{{ metrics.avg_wait_today }} min</h3>
                            <small class="text-muted">Tempo Médio</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Configurações</h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('reception.update_queue_settings') }}" method="POST">
                        <div class="mb-3">
                            <label class="form-label">Tempo Médio p/ Grupo (min)</label>
                            <input type="number" name="avg_wait" class="form-control" value="{{ settings.average_wait_per_party }}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Capacidade Máxima da Fila</label>
                            <input type="number" name="max_size" class="form-control" value="{{ settings.max_queue_size }}">
                        </div>
                        <h6 class="text-secondary">Integração WhatsApp (API Cloud)</h6>
                        <div class="mb-3">
                            <label class="form-label small">ID do Telefone (Phone ID)</label>
                            <input type="text" name="whatsapp_phone_id" class="form-control form-control-sm" value="{{ settings.whatsapp_phone_id }}" placeholder="Ex: 100609...">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">Token de Acesso (Meta)</label>
                            <input type="password" name="whatsapp_token" class="form-control form-control-sm" value="{{ settings.whatsapp_api_token }}" placeholder="EAA...">
                            <div class="alert alert-light border mt-2 py-2 small" style="font-size: 0.75em;">
                                <strong>Como obter o Token Permanente:</strong>
                                <ol class="mb-0 ps-3">
                                    <li>No Meta Business, vá em <em>Contas > Apps</em> e clique em <strong>Adicionar</strong> > <strong>Conectar um ID de App</strong> (se seu App não aparecer na lista).</li>
                                    <li>Vá em <em>Usuários > Usuários do Sistema</em>.</li>
                                    <li>Clique em <strong>Adicionar Ativos</strong> > Selecione <strong>Apps</strong> > Escolha seu App > Ative "Gerenciar App".</li>
                                    <li>Clique em <strong>Gerar novo token</strong>.</li>
                                    <li>Selecione o App e as permissões: <code>whatsapp_business_messaging</code>.</li>
                                </ol>
                                <div class="mt-1 text-muted">
                                    *Se estiver criando o App e pedir "Casos de uso": Escolha <strong>Outros > Empresa</strong> ou adicione o produto <strong>WhatsApp</strong>.
                                </div>
                            </div>
                        </div>
                        <h6 class="text-secondary mt-4">Configuração do Webhook (Para Receber Mensagens)</h6>
                        <div class="alert alert-info border py-2 small" style="font-size: 0.8em;">
                            <p class="mb-1"><strong>Callback URL:</strong> <code>{{ whatsapp_webhook_url }}</code></p>
                            <p class="mb-0"><strong>Verify Token:</strong> <code>almareia_webhook_token</code></p>
                            <hr class="my-1">
                            <p class="mb-0 text-muted">
                                *Para receber mensagens (Chat), você precisa configurar o Webhook no painel da Meta.<br>
                                Use o <strong>ngrok</strong> para expor seu localhost: <code>ngrok http 5001 --domain={{ whatsapp_ngrok_domain }}</code>
                            </p>
                        </div>
                        
                        <button type="submit" class="btn btn-secondary w-100 mt-3">Salvar Configurações</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function removeCustomer(removeUrl) {
        const reason = prompt("Motivo da remoção (ex: Desistiu, No-show):", "Desistiu");
        if (reason) {
            window.location.href = removeUrl + "?reason=" + encodeURIComponent(reason);
        }
    }

    function logNotification(id) {
        fetch("{{ url_for('reception.log_queue_notification') }}", {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id: id})
        });
    }

    function callCustomer(id, btn) {
        const phone = btn.getAttribute('data-wa-phone');
        const message = btn.getAttribute('data-wa-message') || '';
        const originalContent = btn.innerHTML;

        if (!phone) {
            alert('Número de WhatsApp inválido.');
            return;
        }

        const encodedMessage = encodeURIComponent(message);
        const appUrl = `whatsapp://send?phone=${phone}&text=${encodedMessage}`;
        const webUrl = `https://wa.me/${phone}?text=${encodedMessage}`;

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

        logNotification(id);

        const isMobile = /Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);

        if (isMobile) {
            const start = Date.now();
            window.location.href = appUrl;
            setTimeout(function () {
                if (Date.now() - start < 1500) {
                    window.open(webUrl, '_blank');
                }
            }, 1200);
        } else {
            window.open(webUrl, '_blank');
        }

        setTimeout(function () {
            btn.disabled = false;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-success');
            btn.innerHTML = '<i class="bi bi-check-lg"></i> Enviado';
        }, 1500);
    }

    // Auto-refresh every 30 seconds
    setTimeout(function(){
        location.reload();
    }, 30000);
</script>
{% endblock %}
