{% extends 'base.html' %}

{% block title %}Insumos - Principal{% endblock %}

{% block content %}
<style>
    /* Spacing Adjustments */
    .table-sm td, .table-sm th {
        padding: 0.5rem 0.5rem !important; /* Reduced padding */
        vertical-align: middle;
    }
    .service-page {
        padding-bottom: 2rem;
    }
    .status-badge {
        font-size: 0.75rem;
        padding: 0.25em 0.6em;
        border-radius: 4px;
        font-weight: 600;
    }
    .supplier-tooltip {
        position: relative;
        display: inline-block;
        cursor: pointer;
    }
    /* Collapsible Section Style */
    .collapsible-header {
        background-color: #f8f9fa;
        padding: 10px 15px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1rem;
    }
    .collapsible-content {
        padding: 15px;
        border: 1px solid #dee2e6;
        border-top: none;
        border-bottom-left-radius: 4px;
        border-bottom-right-radius: 4px;
        display: none;
        background-color: white;
    }
    .collapsible-content.show {
        display: block;
    }
</style>

<div class="service-page">
    <div class="service-header">
        <span class="service-icon"><i class="bi bi-clipboard-data"></i></span>
        <h2>Insumos (Estoque) <small style="font-size: 0.5em; color: #7f8c8d;">(Total: {{ products|length }})</small></h2>
    </div>

    <div style="margin-bottom: 16px;">
        <a href="{{ url_for('stock.stock_inventory') }}" class="action-btn" style="background-color: #34495e; text-decoration: none; margin-left: 10px;"><i class="bi bi-bar-chart"></i> Ver Inventário Detalhado</a>
    </div>

    <div style="display: flex; gap: 10px; margin-bottom: 16px;">
        <button id="toggleFormBtn" class="action-btn" onclick="toggleForm()"><i class="bi bi-plus-lg"></i> Novo Insumo</button>
        <button id="smartSuggestionBtn" class="action-btn" onclick="openSmartReviewModal()" style="background-color: #8e44ad;"><i class="bi bi-stars"></i> Sugestão Inteligente (IA)</button>
        {% if request.args.get('filter') == 'low_stock' %}
        <a href="{{ url_for('stock.stock_products') }}" class="action-btn" style="background-color: #95a5a6; text-decoration: none;"><i class="bi bi-list-ul"></i> Ver Todos</a>
        {% else %}
        <a href="?filter=low_stock" class="action-btn" style="background-color: #e74c3c; text-decoration: none;"><i class="bi bi-exclamation-triangle"></i> Ver Críticos</a>
        {% endif %}
    </div>

    <!-- Smart Review Modal -->
    <div id="smartReviewModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
        <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 1200px; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <h2 style="color: #8e44ad; margin: 0;"><i class="bi bi-stars"></i> Sugestão Inteligente de Estoque</h2>
                </div>
                <span onclick="closeSmartReviewModal()" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
            </div>
            
            <div style="background-color: #f3e5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #8e44ad;">
                <h4 style="margin-top: 0; color: #4a148c;">Como funciona o cálculo:</h4>
                <p style="margin-bottom: 5px; font-size: 0.9em;">Análise dos últimos <strong>60 dias</strong> de movimentação. Fórmula:</p>
                <code style="background: white; padding: 2px 5px; border-radius: 4px;">Estoque Mínimo = (Demanda Média * Lead Time) + Estoque de Segurança</code>
            </div>
            
            <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button onclick="calculateSmartSuggestions()" class="action-btn" style="background-color: #8e44ad; font-size: 0.9em;"><i class="bi bi-arrow-repeat"></i> Recalcular Agora</button>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="hideNoHistoryCheckbox" onchange="renderSmartTable()" checked style="margin-right: 5px;"> Ocultar sem histórico
                    </label>
                </div>
                <button onclick="applySmartSuggestions()" class="action-btn" style="background-color: #27ae60; font-size: 0.9em;"><i class="bi bi-check-all"></i> Aplicar Selecionados</button>
            </div>

            <div style="max-height: 500px; overflow-y: auto;">
                <table class="table table-striped table-hover" style="width: 100%; font-size: 0.85em;">
                     <thead style="position: sticky; top: 0; background: white; z-index: 1;">
                         <tr>
                             <th style="width: 30px;"><input type="checkbox" id="selectAllSmart" onchange="toggleSelectAllSmart()"></th>
                             <th>Produto</th>
                             <th>Atual</th>
                             <th>Média Mensal</th>
                             <th>Desvio Padrão</th>
                             <th>Lead Time</th>
                             <th>Sugestão (IA)</th>
                             <th>Diferença</th>
                             <th>Justificativa / Detalhes</th>
                             <th>Ação</th>
                         </tr>
                     </thead>
                     <tbody id="smartReviewTableBody">
                         <tr>
                             <td colspan="10" style="text-align: center;">Clique em "Recalcular Agora" para iniciar a análise.</td>
                         </tr>
                     </tbody>
                 </table>
            </div>
            
            <div style="margin-top: 20px; text-align: right;">
                 <button onclick="closeSmartReviewModal()" class="action-btn" style="background-color: #95a5a6;">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Product Form -->
    <div class="card" id="productFormCard" style="display: none; margin-bottom: 16px;">
        <h3 id="formTitle">Adicionar Novo Insumo</h3>
        <form method="POST" class="maintenance-form" style="max-width: 100%;" id="productForm">
            <input type="hidden" id="product_id" name="id">
            <input type="hidden" name="return_url" value="{{ request.full_path }}">
            <input type="hidden" name="current_department" value="{{ request.args.get('department', '') }}">
            <input type="hidden" name="current_category" value="{{ request.args.get('category', '') }}">
            <input type="hidden" name="current_search" value="{{ request.args.get('search', '') }}">
            <input type="hidden" name="current_sort" value="{{ request.args.get('sort', '') }}">
            <input type="hidden" name="current_filter" value="{{ request.args.get('filter', '') }}">
            <h4 style="background-color: #e8f6f3; padding: 10px 15px; border-left: 5px solid #1abc9c; color: #2c3e50; margin-top: 0; margin-bottom: 16px; border-radius: 4px; font-size: 1.1em;"><i class="bi bi-box-seam"></i> Informações do Insumo e Estoque</h4>

            <div class="form-row" style="margin-bottom: 12px;">
                <div class="form-group" style="flex: 2;">
                    <label for="name">Nome do Insumo:</label>
                    <input type="text" id="name" name="name" required placeholder="Ex: Papel A4, Detergente..." style="padding: 6px;">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="department">Estoque:</label>
                    <select id="department" name="department" required style="padding: 6px;">
                        {% for dept in departments %}
                        <option value="{{ dept }}">{{ dept }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-row" style="margin-bottom: 12px;">
                <div class="form-group" style="flex: 1;">
                    <label for="category">Categoria:</label>
                    <input type="text" id="category" name="category" placeholder="Ex: Limpeza, Perecíveis..." required style="padding: 6px;">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="unit">Unidade:</label>
                    <select id="unit" name="unit" required style="padding: 6px;">
                        <option value="Unidades">Unidades</option>
                        <option value="Litros">Litros</option>
                        <option value="Gramas">Gramas</option>
                        <option value="Kilogramas">Kilogramas</option>
                        <option value="Garrafa">Garrafa</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="price">Preço Unitário (R$):</label>
                    <input type="number" id="price" name="price" step="0.01" min="0" required placeholder="0.00" style="padding: 6px;">
                </div>
            </div>

            <div class="form-row" style="margin-bottom: 12px;">
                <div class="form-group" style="flex: 1;">
                    <label for="min_stock">Estoque Mínimo:</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="number" id="min_stock" name="min_stock" step="0.01" min="0" required placeholder="0" style="flex: 1; padding: 6px;">
                        <button type="button" onclick="suggestMinStock()" title="Sugerir baseado no consumo médio" style="padding: 0 10px; background: #1e3a8a; color: white; border: none; border-radius: 4px; cursor: pointer;"><i class="bi bi-lightbulb"></i></button>
                    </div>
                </div>
            </div>

            <h4 style="background-color: #fef9e7; padding: 10px 15px; border-left: 5px solid #f1c40f; color: #2c3e50; margin-top: 24px; margin-bottom: 16px; border-radius: 4px; font-size: 1.1em;"><i class="bi bi-cart"></i> Informações de Compra</h4>

            <div class="form-row" style="margin-bottom: 12px;">
                <div class="form-group" style="flex: 1;">
                    <label for="frequency">Frequência de Compra:</label>
                    <select id="frequency" name="frequency" style="padding: 6px;">
                        <option value="Sem Frequência">Sem Frequência</option>
                        <option value="Semanal">Semanal</option>
                        <option value="Quinzenal">Quinzenal</option>
                        <option value="Mensal">Mensal</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="package_size">Tamanho da Embalagem (Qtd/Peso):</label>
                    <input type="number" id="package_size" name="package_size" step="0.01" min="1" placeholder="Ex: 12" style="padding: 6px;">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="purchase_unit">Unidade de Compra:</label>
                    <input type="text" id="purchase_unit" name="purchase_unit" placeholder="Ex: Caixa" style="padding: 6px;">
                </div>
            </div>

            <div class="form-group" style="margin-bottom: 12px;">
                <label>Fornecedores (1 a 3):</label>
                <div id="suppliersContainer">
                    <div class="supplier-row" style="margin-bottom: 10px; display: flex; gap: 10px;">
                        <input type="text" name="suppliers[]" list="suppliersList" required placeholder="Nome do Fornecedor 1" style="flex: 1; padding: 6px;">
                    </div>
                </div>
                <button type="button" id="addSupplierBtn" class="action-btn" style="background-color: #95a5a6; font-size: 0.8em; padding: 5px 10px;" onclick="addSupplier()"><i class="bi bi-plus"></i> Adicionar Fornecedor</button>
            </div>

            <datalist id="suppliersList">
                {% for supplier in suppliers %}
                <option value="{{ supplier.name }}">{{ supplier.name }}</option>
                {% endfor %}
            </datalist>

            <!-- Collapsible Fiscal Info -->
            <div class="collapsible-section" style="margin-bottom: 20px;">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <span><i class="bi bi-file-earmark-text"></i> Informações Fiscais de Insumos</span>
                    <i class="bi bi-chevron-down"></i>
                </div>
                <div class="collapsible-content">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">NCM (Nomenclatura Comum do Mercosul)</label>
                            <input type="text" class="form-control" name="ncm" id="ncm" placeholder="Ex: 0000.00.00">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">CEST (Código Especificador)</label>
                            <input type="text" class="form-control" name="cest" id="cest" placeholder="Ex: 00.000.00">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Alíquota ICMS (%)</label>
                            <input type="number" class="form-control" name="icms_rate" id="icms_rate" step="0.01" placeholder="Ex: 18.00">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Código ANP (Combustíveis)</label>
                            <input type="text" class="form-control" name="anp_code" id="anp_code" placeholder="Opcional">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">CFOP Padrão</label>
                            <input type="text" class="form-control" name="cfop_default" id="cfop_default" placeholder="Ex: 5102">
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-actions" style="justify-content: flex-start; gap: 10px;">
                <button type="submit" class="action-btn" style="margin-bottom: 0;" id="submitBtn">Salvar Produto</button>
                <button type="button" class="cancel-link" onclick="toggleForm()" style="margin: 0; align-self: center;">Cancelar</button>
            </div>
        </form>
    </div>

    <div class="card" style="margin-top: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 20px;">
            <h3>Lista de Insumos</h3>
            
            <form method="GET" action="{{ url_for('stock.stock_products') }}" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                {% if request.args.get('filter') %}
                <input type="hidden" name="filter" value="{{ request.args.get('filter') }}">
                {% endif %}

                <!-- Multi-select department visual support could be added here, for now keeping select -->
                <select name="department" class="form-select" style="width: auto; padding: 5px;" onchange="this.form.submit()">
                    <option value="Todos">Todos Depts</option>
                    {% for dept in departments %}
                    <option value="{{ dept }}" {% if request.args.get('department') == dept %}selected{% endif %}>{{ dept }}</option>
                    {% endfor %}
                </select>

                <select name="category" class="form-select" style="width: auto; padding: 5px;" onchange="this.form.submit()">
                    <option value="Todas">Todas Categorias</option>
                    {% for cat in categories %}
                    <option value="{{ cat }}" {% if request.args.get('category') == cat %}selected{% endif %}>{{ cat }}</option>
                    {% endfor %}
                </select>

                <select name="sort" class="form-select" style="width: auto; padding: 5px;" onchange="this.form.submit()">
                    <option value="name" {% if request.args.get('sort') == 'name' %}selected{% endif %}>Nome (A-Z)</option>
                    <option value="department" {% if request.args.get('sort') == 'department' %}selected{% endif %}>Ordenar: Depto</option>
                    <option value="category" {% if request.args.get('sort') == 'category' %}selected{% endif %}>Categoria</option>
                    <option value="stock_asc" {% if request.args.get('sort') == 'stock_asc' %}selected{% endif %}>Estoque (Menor)</option>
                    <option value="stock_desc" {% if request.args.get('sort') == 'stock_desc' %}selected{% endif %}>Estoque (Maior)</option>
                    <option value="price" {% if request.args.get('sort') == 'price' %}selected{% endif %}>Preço</option>
                </select>

                <div style="display: flex;">
                    <input type="text" name="search" placeholder="Buscar nome..." value="{{ request.args.get('search', '') }}" style="padding: 5px; border: 1px solid #ddd; border-radius: 4px 0 0 4px;">
                    <button type="submit" style="padding: 5px 10px; background: #1e3a8a; color: white; border: none; border-radius: 0 4px 4px 0; cursor: pointer;"><i class="bi bi-search"></i></button>
                </div>
                
                {% if request.args.get('department') or request.args.get('category') or request.args.get('search') or request.args.get('sort') %}
                <a href="{{ url_for('stock.stock_products') }}" style="color: #e74c3c; text-decoration: none; margin-left: 5px;" title="Limpar Filtros"><i class="bi bi-x-lg"></i></a>
                {% endif %}
            </form>
        </div>
        
        <!-- Bulk Actions Panel -->
        <div id="bulkActionsPanel" style="display: none; background-color: #e8f6f3; padding: 10px; margin-bottom: 20px; border-radius: 4px; border: 1px solid #1abc9c; align-items: center; gap: 15px;">
            <span style="font-weight: bold; color: #16a085;"><span id="selectedCount">0</span> produtos selecionados</span>
            
            <div style="display: flex; gap: 10px; align-items: center;">
                <label>Definir Estoque Mínimo:</label>
                <input type="number" id="bulkMinStockInput" step="0.01" min="0" placeholder="0.00" style="padding: 5px; width: 80px;">
                <button onclick="applyBulkManualMinStock()" class="action-btn" style="padding: 5px 10px; background-color: #27ae60; margin: 0;">Aplicar a Todos</button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm" style="font-size: 0.8rem;">
                <thead>
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"></th>
                        <th>Produto</th>
                        <th>Estoque</th>
                        <th>Categoria</th>
                        <th>Unid.</th>
                        <th>Min</th>
                        <th>Estoque</th>
                        <th>Preço</th>
                        <th>Total</th>
                        <th>Fornec.</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr>
                        <td><input type="checkbox" class="product-checkbox" value="{{ product.id }}" onchange="updateBulkActionsUI()"></td>
                        <td>
                            <div class="fw-bold">{{ product.name }}</div>
                            {% if product.is_internal or product.category == 'Porcionado' %}
                            <span class="status-badge" style="background-color: #8e44ad; color: white; font-size: 0.7em; padding: 1px 4px;">Interno</span>
                            {% endif %}
                        </td>
                        <!-- New Split Columns -->
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-box-seam me-1 text-muted"></i>
                                <span>{{ product.department }}</span>
                            </div>
                        </td>
                        <td>
                            <span>{{ product.category or '-' }}</span>
                        </td>
                        
                        <td>{{ (product.unit or '-')|abbreviate_unit }}</td>
                        <td>{{ "%.2f"|format(product.min_stock) if product.min_stock is not none else '0.00' }}</td>
                        <td class="{% if (product.balance or 0) < (product.min_stock or 0) %}text-danger{% else %}text-success{% endif %}" style="font-weight: bold;">
                            {{ "%.2f"|format(product.balance) if product.balance else '0.00' }}
                            {% if (product.balance or 0) < (product.min_stock or 0) %}
                            <span title="Abaixo do Mínimo" style="cursor: help;"><i class="bi bi-exclamation-triangle-fill"></i></span>
                            {% endif %}
                        </td>
                        <td>R$ {{ "%.2f"|format(product.price) if product.price else '0.00' }}</td>
                        <td>R$ {{ "%.2f"|format(product.total_value) if product.total_value else '0.00' }}</td>
                        
                        <!-- Improved Supplier Column -->
                        <td style="font-size: 0.8em;">
                            {% if product.suppliers %}
                                {% set first_supplier_name = product.suppliers[0] %}
                                {% set s_obj = supplier_map.get(first_supplier_name) %}
                                
                                <div class="supplier-tooltip" title="{{ 'CNPJ: ' + (s_obj.cnpj or '') if s_obj else 'Sem CNPJ' }}">
                                    {% if s_obj and s_obj.active %}
                                        <i class="bi bi-circle-fill text-success" style="font-size: 6px; vertical-align: middle;"></i>
                                    {% else %}
                                        <i class="bi bi-circle-fill text-secondary" style="font-size: 6px; vertical-align: middle;"></i>
                                    {% endif %}
                                    
                                    {{ first_supplier_name|truncate(15, True) }}
                                    
                                    {% if product.suppliers|length > 1 %}
                                        <span class="badge bg-secondary rounded-pill" style="font-size: 0.6em; padding: 0.2em 0.4em;" title="Ver todos">+{{ product.suppliers|length - 1 }}</span>
                                    {% endif %}
                                </div>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        
                        <td>
                            <div class="table-actions">
                                <button 
                                    data-product="{{ product|tojson|forceescape }}"
                                    onclick="openEditProductModal(JSON.parse(this.dataset.product))" 
                                    class="action-btn" 
                                    style="padding: 5px 10px; font-size: 0.8em; background-color: #f39c12; min-width: 36px; min-height: 36px;" 
                                    title="Editar" aria-label="Editar"><i class="bi bi-pencil"></i></button>
                                <button 
                                    data-product="{{ product|tojson|forceescape }}"
                                    onclick="openStockEditModal(JSON.parse(this.dataset.product))" 
                                    class="action-btn" 
                                    style="padding: 5px 10px; font-size: 0.8em; background-color: #1e3a8a; min-width: 36px; min-height: 36px;" 
                                    title="Ajuste Rápido de Estoque" aria-label="Ajuste Rápido de Estoque"><i class="bi bi-box-seam"></i></button>
                                <button 
                                    onclick="viewHistory('{{ product.name }}')" 
                                    class="action-btn" 
                                    style="padding: 5px 10px; font-size: 0.8em; background-color: #34495e; min-width: 36px; min-height: 36px;" 
                                    title="Histórico" aria-label="Histórico"><i class="bi bi-clock-history"></i></button>
                                <button 
                                    data-id="{{ product.id }}"
                                    data-name="{{ product.name }}"
                                    data-balance="{{ product.balance or 0 }}"
                                    onclick="deleteProduct(this.dataset.id, this.dataset.name, parseFloat(this.dataset.balance))" 
                                    class="action-btn" 
                                    style="padding: 5px 10px; font-size: 0.8em; background-color: #e74c3c; margin-left: 0; min-width: 36px; min-height: 36px;" 
                                    title="Excluir" aria-label="Excluir"><i class="bi bi-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 10px; color: #7f8c8d;">
                            Nenhum produto encontrado na lista.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="form-actions" style="margin-top: 20px;">
        <a href="{{ url_for('main.index') }}" class="cancel-link">Voltar</a>
    </div>
</div>

<!-- Modals (Keep existing structure but cleaned up) -->
<!-- Delete Modal -->
<div id="deleteModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 400px; border-radius: 8px;">
        <h3 id="deleteModalTitle">Excluir Produto</h3>
        <p id="deleteModalMsg">Tem certeza que deseja excluir este produto?</p>
        
        <form id="deleteForm" method="POST" action="">
            <div id="stockExitFields" style="display: none;">
                <p style="color: #c0392b; font-weight: bold;">Este produto possui estoque positivo. Informe os dados para baixa:</p>
                <div class="form-group">
                    <label for="deleteReason">Motivo da Exclusão/Baixa:</label>
                    <input type="text" id="deleteReason" name="reason" placeholder="Ex: Produto descontinuado, Validade, etc." style="width: 100%; padding: 8px; margin-bottom: 10px;">
                </div>
                <div class="form-group">
                    <label for="deleteDestination">Destino do Estoque:</label>
                    <input type="text" id="deleteDestination" name="destination" placeholder="Ex: Descarte, Doação, Consumo..." style="width: 100%; padding: 8px; margin-bottom: 10px;">
                </div>
            </div>
            
            <div style="text-align: right; margin-top: 20px;">
                <button type="button" class="cancel-link" onclick="closeDeleteModal()">Cancelar</button>
                <button type="submit" class="action-btn" style="background-color: #e74c3c;">Confirmar Exclusão</button>
            </div>
        </form>
    </div>
</div>

<div id="editProductModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 900px; border-radius: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h3 style="margin: 0;">Editar Insumo</h3>
            <span onclick="closeEditProductModal()" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        </div>
        <form method="POST" action="{{ url_for('stock.stock_products') }}" id="editProductForm">
            <input type="hidden" name="id" id="edit_product_id">
            <input type="hidden" name="return_url" value="{{ request.full_path }}">
            <input type="hidden" name="current_department" value="{{ request.args.get('department', '') }}">
            <input type="hidden" name="current_category" value="{{ request.args.get('category', '') }}">
            <input type="hidden" name="current_search" value="{{ request.args.get('search', '') }}">
            <input type="hidden" name="current_sort" value="{{ request.args.get('sort', '') }}">
            <input type="hidden" name="current_filter" value="{{ request.args.get('filter', '') }}">

            <h4 style="background-color: #e8f6f3; padding: 10px 15px; border-left: 5px solid #1abc9c; color: #2c3e50; margin-top: 0; margin-bottom: 16px; border-radius: 4px; font-size: 1.0em;">
                <i class="bi bi-box-seam"></i> Informações do Insumo e Estoque
            </h4>

            <div class="form-row" style="margin-bottom: 12px;">
                <div class="form-group" style="flex: 2;">
                    <label for="edit_name">Nome do Insumo:</label>
                    <input type="text" id="edit_name" name="name" required style="padding: 6px;">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="edit_department">Estoque:</label>
                    <select id="edit_department" name="department" required style="padding: 6px;">
                        {% for dept in departments %}
                        <option value="{{ dept }}">{{ dept }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="form-row" style="margin-bottom: 12px;">
                <div class="form-group" style="flex: 1;">
                    <label for="edit_category">Categoria:</label>
                    <input type="text" id="edit_category" name="category" required style="padding: 6px;">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="edit_unit">Unidade:</label>
                    <select id="edit_unit" name="unit" required style="padding: 6px;">
                        <option value="Unidades">Unidades</option>
                        <option value="Litros">Litros</option>
                        <option value="Gramas">Gramas</option>
                        <option value="Kilogramas">Kilogramas</option>
                        <option value="Garrafa">Garrafa</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="edit_price">Preço Unitário (R$):</label>
                    <input type="number" id="edit_price" name="price" step="0.01" min="0" required style="padding: 6px;">
                </div>
            </div>
            <h4 style="background-color: #fef9e7; padding: 10px 15px; border-left: 5px solid #f1c40f; color: #2c3e50; margin-top: 16px; margin-bottom: 16px; border-radius: 4px; font-size: 1.0em;">
                <i class="bi bi-cart"></i> Informações de Compra
            </h4>
            <div class="form-row" style="margin-bottom: 12px;">
                <div class="form-group" style="flex: 1;">
                    <label for="edit_min_stock">Estoque Mínimo:</label>
                    <input type="number" id="edit_min_stock" name="min_stock" step="0.01" min="0" required style="padding: 6px;">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="edit_frequency">Frequência de Compra:</label>
                    <select id="edit_frequency" name="frequency" style="padding: 6px;">
                        <option value="Sem Frequência">Sem Frequência</option>
                        <option value="Semanal">Semanal</option>
                        <option value="Quinzenal">Quinzenal</option>
                        <option value="Mensal">Mensal</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="edit_package_size">Tamanho da Embalagem:</label>
                    <input type="number" id="edit_package_size" name="package_size" step="0.01" min="1" style="padding: 6px;">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="edit_purchase_unit">Unidade de Compra:</label>
                    <input type="text" id="edit_purchase_unit" name="purchase_unit" style="padding: 6px;">
                </div>
            </div>
            <div class="form-row" style="margin-bottom: 12px;">
                <div class="form-group" style="flex: 1;">
                    <label for="edit_ncm">NCM</label>
                    <input type="text" id="edit_ncm" name="ncm" style="padding: 6px;">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="edit_cest">CEST</label>
                    <input type="text" id="edit_cest" name="cest" style="padding: 6px;">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="edit_icms_rate">Alíquota ICMS (%)</label>
                    <input type="number" id="edit_icms_rate" name="icms_rate" step="0.01" style="padding: 6px;">
                </div>
            </div>
            <div class="form-row" style="margin-bottom: 12px;">
                <div class="form-group" style="flex: 1;">
                    <label for="edit_anp_code">Código ANP</label>
                    <input type="text" id="edit_anp_code" name="anp_code" style="padding: 6px;">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="edit_cfop_default">CFOP Padrão</label>
                    <input type="text" id="edit_cfop_default" name="cfop_default" style="padding: 6px;">
                </div>
            </div>
            <div style="margin-bottom: 12px;">
                <label>Fornecedores (1 a 3):</label>
                <div id="editSuppliersContainer"></div>
                <button type="button" class="action-btn" style="background-color: #95a5a6; font-size: 0.8em; padding: 5px 10px;" onclick="addEditSupplier()">Adicionar Fornecedor</button>
            </div>
            <div style="text-align: right; margin-top: 16px;">
                <button type="button" class="cancel-link" onclick="closeEditProductModal()">Cancelar</button>
                <button type="submit" class="action-btn" style="background-color: #27ae60;">Salvar</button>
            </div>
        </form>
    </div>
    </div>

<!-- Stock Edit Modal -->
<div id="stockEditModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 400px; border-radius: 8px;">
        <h3>Ajuste Rápido de Estoque</h3>
        <p id="stockEditProductName" style="font-weight: bold; color: #2c3e50;"></p>
        
        <div style="margin: 20px 0;">
            <div class="form-group">
                <label>Estoque Atual:</label>
                <input type="text" id="currentStockDisplay" disabled style="background-color: #eee; width: 100%; padding: 8px;">
            </div>
            <div class="form-group" style="margin-top: 10px;">
                <label for="newStockQuantity">Nova Quantidade:</label>
                <input type="number" id="newStockQuantity" step="0.001" style="width: 100%; padding: 8px;">
            </div>
            <div class="form-group" style="margin-top: 10px;">
                <label for="stockAdjustReason">Motivo do Ajuste:</label>
                <input type="text" id="stockAdjustReason" placeholder="Ex: Inventário, Quebra, Consumo Interno..." style="width: 100%; padding: 8px;">
            </div>
        </div>
        
        <div style="text-align: right; margin-top: 20px;">
            <button type="button" class="cancel-link" onclick="closeStockEditModal()">Cancelar</button>
            <button type="button" class="action-btn" onclick="submitStockAdjustment()" style="background-color: #27ae60;">Salvar Ajuste</button>
        </div>
    </div>
</div>

<!-- History Modal -->
<div id="historyModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 800px; border-radius: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>Histórico de Movimentação: <span id="historyProductName" style="color: #1e3a8a;"></span></h3>
            <span onclick="closeHistoryModal()" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        </div>

        <div style="margin-bottom: 15px; display: flex; justify-content: flex-end; align-items: center; gap: 10px; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 5px;">
                <label style="font-size: 0.9em;">Período:</label>
                <input type="date" id="historyStartDate" style="padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
                <span style="font-size: 0.9em;">até</span>
                <input type="date" id="historyEndDate" style="padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
                <button onclick="loadProductHistory()" class="action-btn" style="padding: 5px 10px; background-color: #1e3a8a; margin: 0; font-size: 0.9em;"><i class="bi bi-filter"></i> Filtrar</button>
            </div>
            <select id="historyDays" onchange="updateHistoryDatesFromDropdown()" style="padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
                <option value="" disabled selected>Predefinições</option>
                <option value="7">Últimos 7 dias</option>
                <option value="15">Últimos 15 dias</option>
                <option value="30">Últimos 30 dias</option>
                <option value="60">Últimos 60 dias</option>
                <option value="90">Últimos 90 dias</option>
            </select>
        </div>
        
        <div style="max-height: 400px; overflow-y: auto;">
            <table class="table table-striped table-hover" style="width: 100%; font-size: 0.9em;">
                <thead>
                    <tr>
                        <th>Data/Hora</th>
                        <th>Ação</th>
                        <th>Qtd</th>
                        <th>Detalhes</th>
                        <th>Usuário</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <tr><td colspan="5" style="text-align: center;">Carregando...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div style="text-align: right; margin-top: 20px;">
            <button type="button" class="action-btn" onclick="closeHistoryModal()" style="background-color: #95a5a6;">Fechar</button>
        </div>
    </div>
</div>

<script>
// --- Toggle Collapsible ---
function toggleCollapsible(header) {
    header.classList.toggle("active");
    var content = header.nextElementSibling;
    if (content.style.display === "block") {
        content.style.display = "none";
        header.querySelector('.bi-chevron-down').style.transform = "rotate(0deg)";
    } else {
        content.style.display = "block";
        header.querySelector('.bi-chevron-down').style.transform = "rotate(180deg)";
    }
}

// --- Original Scripts (Cleaned) ---

let currentHistoryProduct = '';

function viewHistory(productName) {
    currentHistoryProduct = productName;
    document.getElementById('historyProductName').innerText = productName;
    document.getElementById('historyModal').style.display = 'block';
    
    if (!document.getElementById('historyStartDate').value) {
        const end = new Date();
        const start = new Date();
        start.setDate(end.getDate() - 30);
        
        document.getElementById('historyEndDate').valueAsDate = end;
        document.getElementById('historyStartDate').valueAsDate = start;
    }
    
    loadProductHistory();
}

function updateHistoryDatesFromDropdown() {
    const days = parseInt(document.getElementById('historyDays').value);
    if (!days) return;
    
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - days);
    
    document.getElementById('historyEndDate').valueAsDate = end;
    document.getElementById('historyStartDate').valueAsDate = start;
    
    loadProductHistory();
}

function closeHistoryModal() {
    document.getElementById('historyModal').style.display = 'none';
    currentHistoryProduct = '';
}

function loadProductHistory() {
    if (!currentHistoryProduct) return;
    
    const startDate = document.getElementById('historyStartDate').value;
    const endDate = document.getElementById('historyEndDate').value;
    const tbody = document.getElementById('historyTableBody');
    
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Carregando...</td></tr>';
    
    fetch(`/api/stock/history/${encodeURIComponent(currentHistoryProduct)}?startDate=${startDate}&endDate=${endDate}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.history.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhuma movimentação encontrada no período.</td></tr>';
                    return;
                }
                
                let html = '';
                data.history.forEach(item => {
                    const qtyClass = item.qty < 0 ? 'text-danger' : 'text-success';
                    html += `
                        <tr>
                            <td>${item.date}</td>
                            <td>${item.action || (item.qty < 0 ? 'Saída' : 'Entrada')}</td>
                            <td class="${qtyClass}" style="font-weight: bold;">${item.qty}</td>
                            <td>${item.details}</td>
                            <td>${item.user}</td>
                        </tr>
                    `;
                });
                tbody.innerHTML = html;
            } else {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">Erro: ${data.error}</td></tr>`;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">Erro ao carregar histórico.</td></tr>';
        });
}

let currentEditingProduct = null;

function openStockEditModal(product) {
    currentEditingProduct = product;
    document.getElementById('stockEditProductName').innerText = product.name;
    document.getElementById('currentStockDisplay').value = (product.balance || 0) + ' ' + (product.unit || '');
    document.getElementById('newStockQuantity').value = product.balance || 0;
    document.getElementById('stockAdjustReason').value = '';
    document.getElementById('stockEditModal').style.display = 'block';
    document.getElementById('newStockQuantity').focus();
}

function closeStockEditModal() {
    document.getElementById('stockEditModal').style.display = 'none';
    currentEditingProduct = null;
}

function submitStockAdjustment() {
    if (!currentEditingProduct) return;
    
    const newQty = document.getElementById('newStockQuantity').value;
    const reason = document.getElementById('stockAdjustReason').value;
    
    if (newQty === '' || reason.trim() === '') {
        alert('Por favor, preencha a nova quantidade e o motivo.');
        return;
    }
    
    fetch('/api/stock/adjust', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            product_id: currentEditingProduct.id,
            product_name: currentEditingProduct.name,
            new_quantity: newQty,
            reason: reason
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Estoque atualizado com sucesso!');
            location.reload();
        } else {
            alert('Erro: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erro ao comunicar com o servidor.');
    });
}

function deleteProduct(id, name, balance) {
    const modal = document.getElementById('deleteModal');
    const form = document.getElementById('deleteForm');
    const title = document.getElementById('deleteModalTitle');
    const msg = document.getElementById('deleteModalMsg');
    const exitFields = document.getElementById('stockExitFields');
    const reasonInput = document.getElementById('deleteReason');
    const destInput = document.getElementById('deleteDestination');
    
    form.action = "/stock/product/delete/" + id;
    title.innerText = "Excluir: " + name;
    
    if (balance > 0) {
        msg.innerHTML = "O produto possui <strong>" + balance + "</strong> em estoque.";
        exitFields.style.display = 'block';
        reasonInput.required = true;
        destInput.required = true;
    } else {
        msg.innerText = "Tem certeza que deseja excluir este produto? Não há estoque registrado.";
        exitFields.style.display = 'none';
        reasonInput.required = false;
        destInput.required = false;
    }
    
    modal.style.display = 'block';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
}

window.onclick = function(event) {
    const deleteModal = document.getElementById('deleteModal');
    if (event.target == deleteModal) deleteModal.style.display = "none";
    const stockEditModal = document.getElementById('stockEditModal');
    if (event.target == stockEditModal) stockEditModal.style.display = "none";
    const historyModal = document.getElementById('historyModal');
    if (event.target == historyModal) historyModal.style.display = "none";
    const smartReviewModal = document.getElementById('smartReviewModal');
    if (event.target == smartReviewModal) smartReviewModal.style.display = "none";
    const editProductModal = document.getElementById('editProductModal');
    if (event.target == editProductModal) editProductModal.style.display = "none";
}

let currentSmartSuggestions = [];

function openSmartReviewModal() {
    document.getElementById('smartReviewModal').style.display = 'block';
    calculateSmartSuggestions();
}

function closeSmartReviewModal() {
    document.getElementById('smartReviewModal').style.display = 'none';
}

function calculateSmartSuggestions() {
    const tbody = document.getElementById('smartReviewTableBody');
    tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">Analisando histórico de vendas e calculando métricas... <i class="bi bi-cpu"></i></td></tr>';
    
    fetch('/api/stock/smart_suggestions')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentSmartSuggestions = data.suggestions;
                renderSmartTable();
            } else {
                tbody.innerHTML = `<tr><td colspan="10" style="text-align: center; color: red;">Erro: ${data.error}</td></tr>`;
            }
        })
        .catch(err => {
            console.error(err);
            tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: red;">Erro ao carregar dados.</td></tr>';
        });
}

function renderSmartTable() {
    const tbody = document.getElementById('smartReviewTableBody');
    const hideNoHistory = document.getElementById('hideNoHistoryCheckbox').checked;
    
    tbody.innerHTML = '';
    
    if (currentSmartSuggestions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">Nenhum produto analisado.</td></tr>';
        return;
    }
    
    let displayedCount = 0;
    
    currentSmartSuggestions.forEach(item => {
        if (hideNoHistory && !item.has_history) return;
        
        displayedCount++;
        
        const currentMin = parseFloat(item.current_min) || 0;
        const suggested = parseFloat(item.suggested_min);
        const diff = suggested - currentMin;
        const absDiff = Math.abs(diff);
        
        // Style Logic
        let rowStyle = '';
        let diffColor = 'inherit';
        
        if (item.has_history) {
            if (absDiff > 0.01) {
                if (diff > 0) {
                    diffColor = '#27ae60';
                    rowStyle = 'background-color: #f0f9f4;';
                } else {
                    diffColor = '#e74c3c';
                    rowStyle = 'background-color: #fdedec;';
                }
            }
        } else {
            rowStyle = 'color: #95a5a6;';
        }
        
        const row = `
            <tr style="${rowStyle}">
                <td><input type="checkbox" class="smart-checkbox" value="${item.id}" data-suggested="${suggested}" ${!item.has_history ? 'disabled' : ''}></td>
                <td>${item.product}</td>
                <td>${currentMin}</td>
                <td>${item.avg_monthly}</td>
                <td>${item.std_dev}</td>
                <td>${item.lead_time}d</td>
                <td style="font-weight: bold;">${suggested}</td>
                <td style="font-weight: bold; color: ${diffColor};">${diff > 0 ? '+' : ''}${diff.toFixed(2)}</td>
                <td style="font-size: 0.9em; font-style: italic;">${item.justification}</td>
                <td>
                    ${item.has_history ? `<button onclick="applyMinStock('${item.id}', ${suggested})" class="action-btn" style="padding: 2px 8px; font-size: 0.75em; background-color: #8e44ad;">Aplicar</button>` : '-'}
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
    
    if (displayedCount === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">Nenhum produto visível com os filtros atuais.</td></tr>';
    }
}

function toggleSelectAllSmart() {
    const checkboxes = document.querySelectorAll('.smart-checkbox:not(:disabled)');
    const selectAll = document.getElementById('selectAllSmart');
    for(let i=0; i<checkboxes.length; i++) {
        checkboxes[i].checked = selectAll.checked;
    }
}

function applySmartSuggestions() {
    const checkboxes = document.querySelectorAll('.smart-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('Nenhum item selecionado.');
        return;
    }
    
    const updates = [];
    checkboxes.forEach(cb => {
        updates.push({
            id: cb.value,
            min_stock: parseFloat(cb.dataset.suggested)
        });
    });
    
    if (!confirm(`Deseja aplicar as sugestões inteligentes para ${updates.length} produtos?`)) return;
    
    fetch('/stock/update_min_stock_bulk', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ updates: updates })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${data.count} produtos atualizados com sucesso!`);
            calculateSmartSuggestions();
        } else {
            alert('Erro: ' + data.message);
        }
    })
    .catch(err => alert('Erro na requisição.'));
}

function applyMinStock(productId, newValue) {
    if (!confirm(`Confirmar alteração do estoque mínimo para ${newValue}?`)) return;
    
    const formData = new FormData();
    formData.append('id', productId);
    formData.append('min_stock', newValue);
    
    fetch('/stock/update_min_stock', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Estoque mínimo atualizado!');
            calculateSmartSuggestions();
        } else {
            alert('Erro ao atualizar: ' + data.message);
        }
    })
    .catch(err => alert('Erro na requisição.'));
}

function toggleForm() {
    const card = document.getElementById('productFormCard');
    const btn = document.getElementById('toggleFormBtn');
    const form = document.getElementById('productForm');
    const title = document.getElementById('formTitle');
    const idInput = document.getElementById('product_id');
    
    if (card.style.display === 'none') {
        card.style.display = 'block';
        btn.innerHTML = '<i class="bi bi-dash-lg"></i> Cancelar';
        form.reset();
        idInput.value = '';
        title.innerText = 'Adicionar Novo Insumo';
        document.getElementById('suppliersContainer').innerHTML = `
            <div class="supplier-row" style="margin-bottom: 10px; display: flex; gap: 10px;">
                <input type="text" name="suppliers[]" list="suppliersList" required placeholder="Nome do Fornecedor 1" style="flex: 1; padding: 6px;">
            </div>`;
    } else {
        card.style.display = 'none';
        btn.innerHTML = '<i class="bi bi-plus-lg"></i> Novo Insumo';
    }
}

function suggestMinStock() {
    const name = document.getElementById('name').value;
    const minStockInput = document.getElementById('min_stock');
    
    if (!name) {
        alert('Por favor, preencha o nome do produto primeiro para buscar o histórico de consumo.');
        return;
    }
    
    const originalPlaceholder = minStockInput.placeholder;
    minStockInput.placeholder = "Calculando...";
    
    fetch(`/api/stock/consumption/${encodeURIComponent(name)}`)
        .then(response => response.json())
        .then(data => {
            if (data.suggested_min > 0) {
                const suggestion = data.suggested_min;
                if (confirm(`Com base no consumo dos últimos 30 dias:\nConsumo Semanal Médio: ${data.avg_weekly}\n\nSugestão de Estoque Mínimo (1.5 semanas): ${suggestion}\n\nDeseja aplicar este valor?`)) {
                    minStockInput.value = suggestion;
                }
            } else {
                alert('Não há dados de consumo suficientes nos últimos 30 dias para sugerir um estoque mínimo.');
            }
        })
        .catch(err => {
            console.error(err);
            alert('Erro ao calcular sugestão.');
        })
        .finally(() => {
            minStockInput.placeholder = originalPlaceholder;
        });
}

function editProduct(product) {
    openEditProductModal(product);
}

function addSupplier() {
    const container = document.getElementById('suppliersContainer');
    if (container.children.length >= 3) {
        alert('Máximo de 3 fornecedores.');
        return;
    }
    const div = document.createElement('div');
    div.className = 'supplier-row';
    div.style.marginBottom = '10px';
    div.style.display = 'flex';
    div.style.gap = '10px';
    div.innerHTML = `
        <input type="text" name="suppliers[]" list="suppliersList" required placeholder="Nome do Fornecedor" style="flex: 1; padding: 6px;">
        <button type="button" class="action-btn" style="background-color: #e74c3c; padding: 2px 8px; margin: 0;" onclick="this.parentElement.remove()"><i class="bi bi-trash"></i></button>
    `;
    container.appendChild(div);
}

function openEditProductModal(product) {
    document.getElementById('edit_product_id').value = product.id || '';
    document.getElementById('edit_name').value = product.name || '';
    document.getElementById('edit_department').value = product.department || 'Geral';
    document.getElementById('edit_category').value = product.category || '';
    document.getElementById('edit_unit').value = product.unit || 'Unidades';
    document.getElementById('edit_price').value = product.price || 0;
    document.getElementById('edit_min_stock').value = product.min_stock || 0;
    document.getElementById('edit_frequency').value = product.frequency || 'Sem Frequência';
    document.getElementById('edit_package_size').value = product.package_size || 1;
    document.getElementById('edit_purchase_unit').value = product.purchase_unit || '';
    document.getElementById('edit_ncm').value = product.ncm || '';
    document.getElementById('edit_cest').value = product.cest || '';
    document.getElementById('edit_icms_rate').value = product.icms_rate || '';
    document.getElementById('edit_anp_code').value = product.anp_code || '';
    document.getElementById('edit_cfop_default').value = product.cfop_default || '';

    const container = document.getElementById('editSuppliersContainer');
    container.innerHTML = '';
    if (product.suppliers && product.suppliers.length > 0) {
        product.suppliers.forEach(s => {
            const div = document.createElement('div');
            div.className = 'supplier-row';
            div.style.marginBottom = '10px';
            div.style.display = 'flex';
            div.style.gap = '10px';
            div.innerHTML = `
                <input type="text" name="suppliers[]" list="suppliersList" value="${s}" required style="flex: 1; padding: 6px;">
                <button type="button" class="action-btn" style="background-color: #e74c3c; padding: 2px 8px; margin: 0;" onclick="this.parentElement.remove()"><i class="bi bi-trash"></i></button>
            `;
            container.appendChild(div);
        });
    } else {
        const div = document.createElement('div');
        div.className = 'supplier-row';
        div.style.marginBottom = '10px';
        div.style.display = 'flex';
        div.style.gap = '10px';
        div.innerHTML = `
            <input type="text" name="suppliers[]" list="suppliersList" required style="flex: 1; padding: 6px;">
        `;
        container.appendChild(div);
    }
    document.getElementById('editProductModal').style.display = 'block';
}

function closeEditProductModal() {
    document.getElementById('editProductModal').style.display = 'none';
}

function addEditSupplier() {
    const container = document.getElementById('editSuppliersContainer');
    if (container.children.length >= 3) {
        alert('Máximo de 3 fornecedores.');
        return;
    }
    const div = document.createElement('div');
    div.className = 'supplier-row';
    div.style.marginBottom = '10px';
    div.style.display = 'flex';
    div.style.gap = '10px';
    div.innerHTML = `
        <input type="text" name="suppliers[]" list="suppliersList" required style="flex: 1; padding: 6px;">
        <button type="button" class="action-btn" style="background-color: #e74c3c; padding: 2px 8px; margin: 0;" onclick="this.parentElement.remove()"><i class="bi bi-trash"></i></button>
    `;
    container.appendChild(div);
}
</script>
{% endblock %}
