{% extends 'base.html' %}

{% block title %}Relatórios - Almareia Hotel{% endblock %}

{% block content %}
<div class="service-page">
    <div class="service-header">
        <span class="service-icon"><i class="bi bi-bar-chart-fill"></i></span>
        <h2>Relatórios Gerenciais - {{ department }}</h2>
    </div>

    <div style="margin-bottom: 20px;">
        <a href="{{ url_for('main.index') }}" class="action-btn" style="background-color: #95a5a6; text-decoration: none;"><i class="bi bi-arrow-left"></i> Voltar</a>
    </div>
    
    <div class="report-filters">
    <h5 class="mb-3"><i class="bi bi-funnel"></i> Filtros</h5>
    <form method="POST" action="{{ url_for('reports.reports') }}" class="filters-form">
        {% if is_admin %}
        <div class="filter-group">
            <label for="department">Departamento</label>
            <select id="department" name="department" class="filter-select">
                <option value="Todos" {% if department == 'Todos' %}selected{% endif %}>Todos</option>
                {% for dept in all_departments %}
                <option value="{{ dept }}" {% if dept == department %}selected{% endif %}>{{ dept }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <div class="filter-group">
                <label for="start_date">Data Início</label>
                <div class="date-input-wrapper" style="position: relative;">
                    <input type="text" id="start_date" name="start_date" required placeholder="DD/MM/AAAA" maxlength="10" value="{{ start_date if start_date else '' }}" autocomplete="off" class="datepicker-input">
                    <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; pointer-events: none;"><i class="bi bi-calendar"></i></span>
                </div>
            </div>
            <div class="filter-group">
                <label for="end_date">Data Fim</label>
                <div class="date-input-wrapper" style="position: relative;">
                    <input type="text" id="end_date" name="end_date" required placeholder="DD/MM/AAAA" maxlength="10" value="{{ end_date if end_date else '' }}" autocomplete="off" class="datepicker-input">
                    <span style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; pointer-events: none;"><i class="bi bi-calendar"></i></span>
                </div>
            </div>
            <button type="submit" class="action-btn">Gerar Relatório</button>
        </form>
    </div>

    <style>
        .datepicker-container {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            padding: 10px;
            z-index: 1000;
            width: 250px;
            font-family: sans-serif;
            display: none;
        }
        .datepicker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .datepicker-header button {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            padding: 2px 8px;
        }
        .datepicker-header span {
            font-weight: bold;
            color: #2c3e50;
        }
        .datepicker-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            text-align: center;
        }
        .datepicker-day-header {
            font-size: 0.8em;
            color: #7f8c8d;
            padding: 5px 0;
        }
        .datepicker-day {
            padding: 5px 0;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .datepicker-day:hover {
            background-color: #ecf0f1;
        }
        .datepicker-day.selected {
            background-color: #3498db;
            color: white;
        }
        .datepicker-day.today {
            border: 1px solid #3498db;
            color: #3498db;
        }
        .datepicker-day.empty {
            cursor: default;
        }
        .datepicker-day.empty:hover {
            background-color: transparent;
        }
    </style>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('.datepicker-input');
        
        inputs.forEach(input => {
            // Create calendar element
            const calendar = document.createElement('div');
            calendar.className = 'datepicker-container';
            document.body.appendChild(calendar);
            
            let currentDate = new Date();
            let selectedDate = null;
            
            // Try to parse initial value
            if (input.value) {
                const parts = input.value.split('/');
                if (parts.length === 3) {
                    selectedDate = new Date(parts[2], parts[1] - 1, parts[0]);
                    currentDate = new Date(selectedDate);
                }
            }

            function renderCalendar(date) {
                calendar.innerHTML = '';
                const year = date.getFullYear();
                const month = date.getMonth();
                
                // Header
                const header = document.createElement('div');
                header.className = 'datepicker-header';
                
                const prevBtn = document.createElement('button');
                prevBtn.innerText = '<';
                prevBtn.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    currentDate.setMonth(month - 1);
                    renderCalendar(currentDate);
                };
                
                const nextBtn = document.createElement('button');
                nextBtn.innerText = '>';
                nextBtn.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    currentDate.setMonth(month + 1);
                    renderCalendar(currentDate);
                };
                
                const title = document.createElement('span');
                const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                title.innerText = `${months[month]} ${year}`;
                
                header.appendChild(prevBtn);
                header.appendChild(title);
                header.appendChild(nextBtn);
                calendar.appendChild(header);
                
                // Grid
                const grid = document.createElement('div');
                grid.className = 'datepicker-grid';
                
                // Week headers
                const weekDays = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
                weekDays.forEach(day => {
                    const el = document.createElement('div');
                    el.className = 'datepicker-day-header';
                    el.innerText = day;
                    grid.appendChild(el);
                });
                
                // Days
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startDayOfWeek = firstDay.getDay(); // 0 = Sunday
                
                // Empty slots
                for (let i = 0; i < startDayOfWeek; i++) {
                    const el = document.createElement('div');
                    el.className = 'datepicker-day empty';
                    grid.appendChild(el);
                }
                
                // Day slots
                const today = new Date();
                for (let i = 1; i <= daysInMonth; i++) {
                    const el = document.createElement('div');
                    el.className = 'datepicker-day';
                    el.innerText = i;
                    
                    // Check if today
                    if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                        el.classList.add('today');
                    }
                    
                    // Check if selected
                    if (selectedDate && i === selectedDate.getDate() && month === selectedDate.getMonth() && year === selectedDate.getFullYear()) {
                        el.classList.add('selected');
                    }
                    
                    el.onclick = (e) => {
                        e.stopPropagation();
                        selectedDate = new Date(year, month, i);
                        const dayStr = i.toString().padStart(2, '0');
                        const monthStr = (month + 1).toString().padStart(2, '0');
                        input.value = `${dayStr}/${monthStr}/${year}`;
                        calendar.style.display = 'none';
                        // Re-render to update selection style
                        renderCalendar(currentDate);
                    };
                    
                    grid.appendChild(el);
                }
                
                calendar.appendChild(grid);
            }
            
            // Event listeners
            input.addEventListener('focus', () => {
                const rect = input.getBoundingClientRect();
                calendar.style.top = (rect.bottom + window.scrollY + 5) + 'px';
                calendar.style.left = (rect.left + window.scrollX) + 'px';
                calendar.style.display = 'block';
                renderCalendar(currentDate);
            });
            
            input.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent closing immediately
                const rect = input.getBoundingClientRect();
                calendar.style.top = (rect.bottom + window.scrollY + 5) + 'px';
                calendar.style.left = (rect.left + window.scrollX) + 'px';
                calendar.style.display = 'block';
                renderCalendar(currentDate);
            });
            
            // Mask for manual typing
            input.addEventListener('input', (e) => {
                let v = e.target.value.replace(/\D/g, '');
                if (v.length > 2) v = v.slice(0, 2) + '/' + v.slice(2);
                if (v.length > 5) v = v.slice(0, 5) + '/' + v.slice(5);
                e.target.value = v.slice(0, 10);
            });
        });
        
        // Close calendar when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.datepicker-container') && !e.target.closest('.datepicker-input')) {
                document.querySelectorAll('.datepicker-container').forEach(c => c.style.display = 'none');
            }
        });
    });
     </script>
     
     {% if stock_alerts %}
    <div class="alert-section" style="background-color: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <h3 style="color: #856404; margin-top: 0; display: flex; align-items: center; gap: 10px;"><i class="bi bi-exclamation-triangle-fill"></i> Alerta de Estoque Crítico</h3>
        <p style="color: #856404;">Com base na média de consumo do período selecionado, os seguintes produtos podem não durar até a próxima compra:</p>
        <div class="table-responsive">
            <table class="table table-striped table-hover" style="background: white;">
                <thead>
                    <tr>
                    <th>Produto</th>
                    <th>Estoque Atual</th>
                    <th>Média Semanal</th>
                    <th>Próxima Compra</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for alert in stock_alerts %}
                <tr>
                    <td><strong>{{ alert.product }}</strong></td>
                    <td>{{ alert.current_stock }}</td>
                    <td>{{ "%.2f"|format(alert.weekly_avg) }}</td>
                    <td>{{ alert.next_purchase }}</td>
                    <td style="color: #c0392b; font-weight: bold;">{{ alert.status }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if purchase_summary %}
    <div class="report-results" style="margin-bottom: 30px;">
        <h3><i class="bi bi-cash-stack"></i> Relatório de Compras</h3>
        <div style="background: #e8f8f5; padding: 15px; border-radius: 5px; margin-bottom: 15px; border-left: 5px solid #1abc9c;">
            <h4 style="margin: 0; color: #16a085;">Total Gasto no Período: R$ {{ "%.2f"|format(purchase_summary.total_spent) }}</h4>
        </div>
        <table class="report-table">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Produto</th>
                    <th>Fornecedor</th>
                    <th>Quantidade</th>
                    <th>Valor Unit.</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                {% for item in purchase_summary['items'] %}
                <tr>
                    <td>{{ item.date }}</td>
                    <td>{{ item.product }}</td>
                    <td>{{ item.supplier }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>R$ {{ "%.2f"|format(item.unit_price) }}</td>
                    <td>R$ {{ "%.2f"|format(item.total) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if consumption_summary %}
    <div class="report-results" style="margin-bottom: 30px;">
        <h3><i class="bi bi-graph-down"></i> Relatório de Consumo e Médias</h3>
        <table class="report-table">
            <thead>
                <tr>
                    <th>Produto</th>
                    <th>Total Consumido</th>
                    <th>Média Semanal</th>
                    <th>Estoque Atual</th>
                    <th>Situação</th>
                </tr>
            </thead>
            <tbody>
                {% for item in consumption_summary %}
                <tr>
                    <td>{{ item.product }}</td>
                    <td>{{ item.total_consumed }}</td>
                    <td>{{ "%.2f"|format(item.weekly_avg) }}</td>
                    <td>{{ item.current_stock }}</td>
                    <td>
                        {% if item.alert %}
                            <span style="color: #e74c3c; font-weight: bold;"><i class="bi bi-exclamation-triangle-fill"></i> Atenção</span>
                        {% else %}
                            <span style="color: #27ae60;">OK</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if stock_logs %}
    <div class="report-results" style="margin-top: 30px;">
        <h3><i class="bi bi-clipboard-data"></i> Log Detalhado de Estoque</h3>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Data/Hora</th>
                        <th>Usuário</th>
                        <th>Ação</th>
                        <th>Produto</th>
                        <th>Qtd.</th>
                        <th>Detalhes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in stock_logs %}
                    <tr>
                        <td>{{ log.date }}</td>
                        <td>{{ log.user }}</td>
                        <td>
                            <span
                                class="badge {% if 'Entrada' in log.action %}bg-success{% elif 'Retirada' in log.action %}bg-warning{% elif 'Ajuste' in log.action %}bg-info{% else %}bg-secondary{% endif %}"
                                style="padding: 5px 10px; border-radius: 4px; color: white; font-weight: bold;">
                                {{ log.action }}
                            </span>
                        </td>
                        <td>{{ log.product }}</td>
                        <td>{{ log.quantity }}</td>
                        <td>{{ log.details }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% elif request.method == 'POST' %}
    <div class="no-results">
        <p>Nenhum registro encontrado para o período selecionado.</p>
    </div>
    {% endif %}

    <a href="/" class="back-link"><i class="bi bi-arrow-left"></i> Voltar ao Menu Principal</a>
</div>
{% endblock %}
