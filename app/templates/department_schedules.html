{% extends 'base.html' %}

{% block title %}Agendamentos Pendentes - Back of the House{% endblock %}

{% block content %}
<div class="service-page">
    <div class="service-header">
        <span class="service-icon"><i class="bi bi-calendar-check"></i></span>
        <h2>Agendamento de Manutenção</h2>
    </div>

    <div style="margin-bottom: 20px;">
        <a href="{{ url_for('main.index') }}" class="action-btn" style="background-color: #95a5a6; text-decoration: none;">← Voltar</a>
    </div>

    <div class="requests-container">
        <p>A equipe de manutenção solicitou que você defina o melhor horário para os serviços abaixo:</p>

        {% if not requests %}
        <p>Nenhuma solicitação aguardando agendamento.</p>
        {% else %}
        
        {% for req in requests %}
        <div class="request-card status-aguardando-agendamento">
            <div class="request-header">
                <span class="req-id">#{{ req.id[-4:] }}</span>
                <span class="req-date">{{ req.date }} às {{ req.time }}</span>
                <span class="req-status">{{ req.status }}</span>
            </div>
            
            <div class="request-body">
                <p><strong>Solicitante:</strong> {{ req.user }}</p>
                <p><strong>Local:</strong> {{ req.location }}</p>
                <p><strong>Descrição:</strong> {{ req.description }}</p>
                
                {% if req.photo_url %}
                <div class="request-image">
                    <a href="{{ req.photo_url }}" target="_blank">
                        <img src="{{ req.photo_url }}" alt="Foto do problema">
                    </a>
                </div>
                {% endif %}
            </div>
            
            <div class="schedule-form-container" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                <h3>Definir Data e Horário</h3>
                <form action="{{ url_for('maintenance.confirm_schedule', req_id=req.id) }}" method="POST" class="schedule-form" onsubmit="return validateDate(this)">
                    <div class="form-group">
                        <label for="date-{{ req.id }}">Data:</label>
                        <input type="text" id="date-{{ req.id }}" name="scheduled_date" required placeholder="DD/MM/YYYY" maxlength="10" onkeyup="formatDateInput(this)">
                    </div>
                    <div class="form-group">
                        <label for="time-{{ req.id }}">Horário:</label>
                        <input type="time" id="time-{{ req.id }}" name="scheduled_time" required>
                    </div>
                    <button type="submit" class="action-btn" style="background-color: #9b59b6;">Confirmar Agendamento</button>
                </form>
            </div>
        </div>
        {% endfor %}
        
        {% endif %}
    </div>
</div>

<script>
function formatDateInput(input) {
    var v = input.value;
    if (v.match(/^\d{2}$/) !== null) {
        input.value = v + '/';
    } else if (v.match(/^\d{2}\/\d{2}$/) !== null) {
        input.value = v + '/';
    }
}

function validateDate(form) {
    var dateInput = form.querySelector('input[name="scheduled_date"]');
    var dateStr = dateInput.value;
    
    // Simple regex validation for DD/MM/YYYY
    var regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
    var match = dateStr.match(regex);
    
    if (!match) {
        alert("Por favor, insira uma data válida no formato DD/MM/AAAA");
        return false;
    }
    
    var day = parseInt(match[1], 10);
    var month = parseInt(match[2], 10);
    var year = parseInt(match[3], 10);
    
    // Check valid date components
    var date = new Date(year, month - 1, day);
    if (date.getFullYear() !== year || date.getMonth() + 1 !== month || date.getDate() !== day) {
        alert("Data inválida.");
        return false;
    }
    
    // Check if date is in the past (ignoring time)
    var today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (date < today) {
        alert("A data de agendamento não pode ser no passado.");
        return false;
    }
    
    return true;
}
</script>

<style>
.request-card {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.status-aguardando-agendamento { border-left: 5px solid #9b59b6; border-style: dashed; }

.request-header {
    display: flex;
    justify-content: space-between;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
    margin-bottom: 10px;
    font-weight: bold;
}

.request-image img {
    max-width: 100px;
    border-radius: 4px;
    margin-top: 5px;
}

.schedule-form {
    display: flex;
    gap: 15px;
    align-items: flex-end;
    flex-wrap: wrap;
}

.form-group {
    flex: 1;
    min-width: 150px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.form-group input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}
</style>
{% endblock %}
