{% extends 'base.html' %}

{% block title %}Gerenciar Usuários - Back of the House{% endblock %}

{% block content %}
<div class="service-container">
    <div class="header-section">
        <h1><i class="bi bi-people"></i> Gerenciar Usuários e Acessos</h1>
        <p>Controle de departamentos, cargos e permissões adicionais.</p>
    </div>

    <div style="margin-bottom: 20px;">
        <a href="{{ url_for('main.index') }}" class="action-btn" style="background-color: #6c757d; text-decoration: none;"><i class="bi bi-arrow-left"></i> Voltar</a>
        <a href="{{ url_for('admin.admin_export_users') }}" class="action-btn" style="background-color: #1e3a8a; text-decoration: none; margin-left: 10px;"><i class="bi bi-file-earmark-excel"></i> Exportar para Excel</a>
    </div>

    {% if password_requests %}
    <div class="card" style="margin-bottom: 30px; border-left: 5px solid #e74c3c;">
        <h3 style="color: #c0392b;"><i class="bi bi-bell"></i> Solicitações de Reset de Senha</h3>
        <p>Os seguintes usuários solicitaram reset de senha porque esqueceram.</p>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Usuário</th>
                    <th>Ação</th>
                </tr>
            </thead>
            <tbody>
                {% for req in password_requests %}
                <tr>
                    <td>{{ req.username }} <small style="color: #7f8c8d;">({{ req.request_date }})</small></td>
                    <td>
                        <a href="{{ url_for('auth.admin_reset_password_action', request_id=req.id, action='approve') }}" 
                           class="action-btn" 
                           style="background-color: #27ae60; color: white; text-decoration: none; margin-right: 5px;"
                           onclick="return confirm('Resetar a senha de {{ req.username }} para 1234? O usuário será forçado a trocá-la no próximo login.')">
                           Aprovar
                        </a>
                        <a href="{{ url_for('auth.admin_reset_password_action', request_id=req.id, action='deny') }}" 
                           class="action-btn" 
                           style="background-color: #c0392b; color: white; text-decoration: none;"
                           onclick="return confirm('Negar solicitação de {{ req.username }}?')">
                           Negar
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Adicionar Novo Usuário -->
    <div class="card" style="margin-bottom: 30px;">
        <h3>Adicionar Novo Usuário</h3>
        <form method="POST" action="{{ url_for('admin.admin_users') }}">
            <input type="hidden" name="action" value="add">
            <div class="form-row">
                <div class="form-group">
                    <label>Nome Completo:</label>
                    <input type="text" name="full_name" class="form-control" placeholder="Nome Completo">
                </div>
                <div class="form-group">
                    <label>Login (Usuário):</label>
                    <input type="text" name="username" required class="form-control" placeholder="login.usuario">
                </div>
                <div class="form-group">
                    <label>Senha (4 dígitos):</label>
                    <input type="text" name="password" required pattern="\d{4}" class="form-control">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Data de Admissão:</label>
                    <input type="date" name="admission_date" class="form-control">
                </div>
                <div class="form-group">
                    <label>Aniversário:</label>
                    <input type="date" name="birthday" class="form-control">
                </div>
                <div class="form-group">
                    <label>Carga diária (h):</label>
                    <input type="text" class="form-control" value="Padrão (44h/sem)" disabled>
                    <input type="hidden" name="daily_target_hours" value="8">
                </div>
                <div class="form-group">
                    <label>Folga semanal:</label>
                    <select name="weekly_day_off" class="form-control">
                        <option value="0">Segunda</option>
                        <option value="1">Terça</option>
                        <option value="2">Quarta</option>
                        <option value="3">Quinta</option>
                        <option value="4">Sexta</option>
                        <option value="5">Sábado</option>
                        <option value="6" selected>Domingo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Departamento Principal:</label>
                    <select name="department" class="form-control">
                        {% for dept in departments %}
                        <option value="{{ dept }}">{{ dept }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Cargo:</label>
                    {% if is_admin %}
                    <select name="role" class="form-control">
                        <option value="colaborador">Colaborador</option>
                        <option value="supervisor">Supervisor</option>
                        <option value="gerente">Gerente</option>
                        <option value="admin">Diretoria (Admin)</option>
                    </select>
                    {% else %}
                    <input type="hidden" name="role" value="colaborador">
                    <input type="text" class="form-control" value="Colaborador" disabled>
                    <small class="text-muted">Apenas Diretoria pode definir outros cargos.</small>
                    {% endif %}
                </div>
                <div class="form-group">
                    <label>Pontuação:</label>
                    <input type="number" name="score" class="form-control" min="0" max="5" step="1" placeholder="0">
                </div>
            </div>
            
            <div class="form-group">
                <label>Permissões Adicionais (Acesso de Gerente):</label>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    {% for service in services %}
                    <label style="display: flex; align-items: center; gap: 5px; background: #eee; padding: 5px 10px; border-radius: 4px;">
                        <input type="checkbox" name="permissions" value="{{ service.id }}">
                        {{ service.name }}
                    </label>
                    {% endfor %}
                </div>
                <small class="text-muted">Marque os serviços que este usuário pode gerenciar além do seu departamento.</small>
            </div>

            <div class="form-group">
                <label>Permissões Especiais:</label>
                <label style="display: inline-flex; align-items: center; gap: 5px; background: #fdf2e9; padding: 5px 10px; border-radius: 4px;">
                    <input type="checkbox" name="permissions" value="comissao">
                    Acesso ao Cálculo de Comissões
                </label>
            </div>

            <button type="submit" class="action-btn" style="background-color: #27ae60;">Criar Usuário</button>
        </form>
    </div>

    <!-- Lista de Usuários Separada por Departamento -->
    {% for group in dept_groups %}
    <div class="card" style="margin-bottom: 30px;">
        <h3 style="border-bottom: 2px solid #1e3a8a; padding-bottom: 10px; margin-bottom: 15px;">
            {{ group.name }} <span style="font-size: 0.7em; color: #7f8c8d; font-weight: normal;">({{ group.users|length }} usuários)</span>
        </h3>
        <div style="overflow-x: auto;">
            <table class="table admin-table">
                <thead>
                    <tr>
                        <th style="width: 20%;">Nome</th>
                        <th style="width: 20%;">RH (Datas / Folga)</th>
                        <th style="width: 20%;">Posição (Dept / Cargo)</th>
                        <th style="width: 10%;">Pontos</th>
                        <th style="width: 20%;">Acesso (Login / Senha)</th>
                        <th style="width: 10%;">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user, data in group.users.items() %}
                    {% set form_id = 'form_' ~ group.name|replace(' ', '') ~ '_' ~ loop.index %}
                    <tr>
                            <!-- Nome -->
                            <td>
                                <input form="{{ form_id }}" type="hidden" name="action" value="edit">
                                <input form="{{ form_id }}" type="hidden" name="username" value="{{ user }}">
                                <input form="{{ form_id }}" type="text" name="full_name" value="{{ data.get('full_name', '') }}" class="form-control" placeholder="Nome Completo">
                            </td>

                            <!-- RH (Datas/Folga) -->
                            <td>
                                <div style="display: flex; flex-direction: column; gap: 2px;">
                                    <div style="display: flex; gap: 4px; align-items: center;">
                                        <span style="font-size: 0.7em; color: #7f8c8d; width: 25px;">Adm:</span>
                                        <input form="{{ form_id }}" type="date" name="admission_date" value="{{ data.get('admission_date', '') }}" class="form-control">
                                    </div>
                                    <div style="display: flex; gap: 4px; align-items: center;">
                                        <span style="font-size: 0.7em; color: #7f8c8d; width: 25px;">Niv:</span>
                                        <input form="{{ form_id }}" type="date" name="birthday" value="{{ data.get('birthday', '') }}" class="form-control">
                                    </div>
                                    <div style="display: flex; gap: 4px; align-items: center;">
                                        <span style="font-size: 0.7em; color: #7f8c8d; width: 25px;">Fol:</span>
                                        <select form="{{ form_id }}" name="weekly_day_off" class="form-control">
                                            <option value="0" {% if data.get('weekly_day_off', 6)|int == 0 %}selected{% endif %}>Seg</option>
                                            <option value="1" {% if data.get('weekly_day_off', 6)|int == 1 %}selected{% endif %}>Ter</option>
                                            <option value="2" {% if data.get('weekly_day_off', 6)|int == 2 %}selected{% endif %}>Qua</option>
                                            <option value="3" {% if data.get('weekly_day_off', 6)|int == 3 %}selected{% endif %}>Qui</option>
                                            <option value="4" {% if data.get('weekly_day_off', 6)|int == 4 %}selected{% endif %}>Sex</option>
                                            <option value="5" {% if data.get('weekly_day_off', 6)|int == 5 %}selected{% endif %}>Sáb</option>
                                            <option value="6" {% if data.get('weekly_day_off', 6)|int == 6 %}selected{% endif %}>Dom</option>
                                        </select>
                                    </div>
                                </div>
                            </td>

                            <!-- Posição (Dept/Cargo) -->
                            <td>
                                <div style="display: flex; flex-direction: column; gap: 2px;">
                                    <select form="{{ form_id }}" name="department" class="form-control">
                                        {% for dept in departments %}
                                        <option value="{{ dept }}" {% if data.department == dept %}selected{% endif %}>{{ dept }}</option>
                                        {% endfor %}
                                    </select>
                                    
                                    {% if is_admin %}
                                    <select form="{{ form_id }}" name="role" class="form-control">
                                        <option value="colaborador" {% if data.role == 'colaborador' %}selected{% endif %}>Colaborador</option>
                                        <option value="supervisor" {% if data.role == 'supervisor' %}selected{% endif %}>Supervisor</option>
                                        <option value="gerente" {% if data.role == 'gerente' %}selected{% endif %}>Gerente</option>
                                        <option value="admin" {% if data.role == 'admin' %}selected{% endif %}>Diretoria</option>
                                    </select>
                                    {% else %}
                                    <input form="{{ form_id }}" type="hidden" name="role" value="{{ data.role }}">
                                    <span style="padding: 2px 4px; background: #eee; border-radius: 3px; font-size: 0.7em; display: block; text-align: center;">{{ data.role|title }}</span>
                                    {% endif %}
                                </div>
                            </td>

                            <!-- Pontos -->
                            <td>
                                <select form="{{ form_id }}" name="score" class="form-control">
                                    <option value="0" {% if not data.get('score') or data.get('score')|int == 0 %}selected{% endif %}>-</option>
                                    <option value="1" {% if data.get('score')|int == 1 %}selected{% endif %}>1</option>
                                    <option value="2" {% if data.get('score')|int == 2 %}selected{% endif %}>2</option>
                                    <option value="3" {% if data.get('score')|int == 3 %}selected{% endif %}>3</option>
                                    <option value="4" {% if data.get('score')|int == 4 %}selected{% endif %}>4</option>
                                    <option value="5" {% if data.get('score')|int == 5 %}selected{% endif %}>5</option>
                                </select>
                            </td>

                            <!-- Acesso (Login/Senha/Perm) -->
                            <td>
                                <div style="display: flex; flex-direction: column; gap: 2px;">
                                    <div style="display: flex; gap: 2px;">
                                        {% if (is_admin or is_rh) and data.role != 'admin' %}
                                        <input form="{{ form_id }}" type="text" name="new_username" value="{{ user }}" class="form-control" title="Login" style="width: 50%;">
                                        {% else %}
                                        <input type="text" value="{{ user }}" class="form-control" disabled title="Login" style="background: #eee; width: 50%;">
                                        {% endif %}
                                        <input form="{{ form_id }}" type="text" name="password" value="{{ data.password }}" class="form-control" placeholder="Senha" title="Senha" style="width: 50%;">
                                    </div>
                                    <details>
                                        <summary style="cursor: pointer; color: #1e3a8a; font-size: 0.7em; list-style: none; text-align: right;">
                                            + Permissões ({{ data.get('permissions', [])|length }})
                                        </summary>
                                        <div style="margin-top: 4px; background: white; border: 1px solid #ccc; padding: 10px; border-radius: 4px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); min-width: 200px; max-height: 220px; overflow-y: auto;">
                                            <p style="margin: 0 0 5px 0; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 2px; font-size: 0.8em;">Extras:</p>
                                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.8em; cursor: pointer; background: #fdf2e9; padding: 4px 6px; border-radius: 3px;">
                                                    <input form="{{ form_id }}" type="checkbox" name="permissions" value="comissao" 
                                                        {% if 'comissao' in data.get('permissions', []) %}checked{% endif %}>
                                                    Acesso ao Cálculo de Comissões
                                                </label>
                                                {% for service in services %}
                                                <label style="display: flex; align-items: center; gap: 5px; font-size: 0.8em; cursor: pointer;">
                                                    <input form="{{ form_id }}" type="checkbox" name="permissions" value="{{ service.id }}" 
                                                        {% if service.id in data.get('permissions', []) %}checked{% endif %}>
                                                    {{ service.name }}
                                                </label>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </details>
                                </div>
                            </td>

                            <!-- Ações -->
                            <td>
                                <div class="table-actions">
                                    <form id="{{ form_id }}" method="POST" action="{{ url_for('admin.admin_users') }}"></form>
                                    <button form="{{ form_id }}" type="submit" class="action-btn" style="background-color: #1e3a8a; min-width: 44px; min-height: 44px; display: inline-flex; align-items: center; justify-content: center;" title="Salvar" aria-label="Salvar"><i class="bi bi-save-fill"></i></button>
                                    <button type="button" onclick="showQRCode('{{ user }}')" class="action-btn" style="background-color: #8e44ad; min-width: 44px; min-height: 44px; display: inline-flex; align-items: center; justify-content: center;" title="QR Code" aria-label="Mostrar QR Code"><i class="bi bi-qr-code"></i></button>
                                    <a href="{{ url_for('hr.rh_dismiss_employee', username=user) }}" class="action-btn" style="background-color: #e67e22; text-decoration: none; min-width: 44px; min-height: 44px; display: inline-flex; align-items: center; justify-content: center;" onclick="return confirm('Confirmar demissão de {{ user }}?');" title="Demitir" aria-label="Demitir"><i class="bi bi-person-dash-fill"></i></a>
                                    {% if user != session['user'] %}
                                    <button form="{{ form_id }}" type="submit" name="action" value="delete" class="action-btn" style="background-color: #c0392b; min-width: 44px; min-height: 44px; display: inline-flex; align-items: center; justify-content: center;" onclick="return confirm('Tem certeza que deseja excluir PERMANENTEMENTE este usuário?');" title="Excluir" aria-label="Excluir"><i class="bi bi-trash-fill"></i></button>
                                    {% endif %}
                                </div>
                            </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endfor %}
</div>

<!-- QR Code Modal -->
<div id="qrModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:white; padding:30px; border-radius:10px; text-align:center; max-width:400px; width:90%;">
        <h3>QR Code de Acesso</h3>
        <h4 id="qrUser" style="color:#2980b9; margin-bottom:20px;"></h4>
        
        <div id="qrcode" style="display:flex; justify-content:center; margin-bottom:20px;"></div>
        
        <div style="display:flex; gap:10px; justify-content:center; flex-wrap: wrap;">
            <button onclick="printQRCode()" class="action-btn" style="background:#1e3a8a; min-width: 44px; min-height: 44px; display: inline-flex; align-items: center; justify-content: center;" aria-label="Imprimir"><i class="bi bi-printer-fill"></i> Imprimir</button>
            <button onclick="closeQRModal()" class="action-btn" style="background:#95a5a6; min-width: 44px; min-height: 44px; display: inline-flex; align-items: center; justify-content: center;" aria-label="Fechar">Fechar</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
function showQRCode(username) {
    document.getElementById('qrModal').style.display = 'flex';
    document.getElementById('qrUser').innerText = username;
    document.getElementById('qrcode').innerHTML = 'Carregando...';
    
    fetch(`/admin/generate_qr/${encodeURIComponent(username)}`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('qrcode').innerHTML = '';
                new QRCode(document.getElementById("qrcode"), {
                    text: data.token,
                    width: 200,
                    height: 200
                });
            } else {
                alert('Erro ao gerar token');
            }
        })
        .catch(err => alert('Erro: ' + err));
}

function closeQRModal() {
    document.getElementById('qrModal').style.display = 'none';
}

function printQRCode() {
    const printContent = document.getElementById('qrcode').innerHTML;
    const user = document.getElementById('qrUser').innerText;
    
    const win = window.open('', '', 'width=600,height=600');
    win.document.write('<html><head><title>Print QR</title></head><body style="text-align:center; font-family:sans-serif;">');
    win.document.write('<h1>' + user + '</h1>');
    win.document.write('<div style="display:flex; justify-content:center; margin-top:50px;">' + printContent + '</div>');
    win.document.write('</body></html>');
    win.document.close();
    win.focus();
    setTimeout(() => { win.print(); win.close(); }, 500);
}
</script>
{% endblock %}
