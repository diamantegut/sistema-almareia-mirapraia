{% extends "base.html" %}

{% block title %}Conciliação de Ativos{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Relatório de Conciliação de Transferências</h2>
    <p class="text-muted">Histórico de itens migrados do estoque de insumos para o ativo imobilizado.</p>

    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Data Inicial</label>
                    <input type="date" class="form-control" id="startDate">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Data Final</label>
                    <input type="date" class="form-control" id="endDate">
                </div>
                <div class="col-md-3 align-self-end">
                    <button class="btn btn-primary w-100" onclick="filterReport()">Filtrar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="table-responsive card p-3">
        <table class="table table-hover" id="reportTable">
            <thead class="table-light">
                <tr>
                    <th>Data/Hora</th>
                    <th>Patrimônio</th>
                    <th>Item</th>
                    <th>Origem</th>
                    <th>Qtd. Transferida</th>
                    <th>Valor Unit.</th>
                    <th>Total</th>
                    <th>Responsável</th>
                    <th>Justificativa</th>
                </tr>
            </thead>
            <tbody>
                {% for asset in assets %}
                <tr data-date="{{ asset.transfer_history.date }}">
                    <td>{{ asset.transfer_history.date }}</td>
                    <td>{{ asset.patrimony_number }}</td>
                    <td>{{ asset.description }}</td>
                    <td>{{ asset.transfer_history.from }}</td>
                    <td>{{ "%.2f"|format(asset.quantity) }}</td>
                    <td>R$ {{ "%.2f"|format(asset.acquisition_value) }}</td>
                    <td>R$ {{ "%.2f"|format(asset.quantity * asset.acquisition_value) }}</td>
                    <td>{{ asset.created_by }}</td>
                    <td>{{ asset.transfer_history.justification }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="9" class="text-center text-muted">Nenhuma transferência registrada.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="mt-3">
        <a href="{{ url_for('assets.index') }}" class="btn btn-secondary">Voltar</a>
    </div>
</div>

<script>
    function filterReport() {
        let start = document.getElementById('startDate').value;
        let end = document.getElementById('endDate').value;
        
        let rows = document.querySelectorAll('#reportTable tbody tr');
        
        rows.forEach(row => {
            let dateStr = row.getAttribute('data-date'); // dd/mm/yyyy HH:MM
            if (!dateStr) return;
            
            // Convert dd/mm/yyyy to yyyy-mm-dd for comparison
            let parts = dateStr.split(' ')[0].split('/');
            let rowDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
            
            let show = true;
            if (start && rowDate < start) show = false;
            if (end && rowDate > end) show = false;
            
            row.style.display = show ? '' : 'none';
        });
    }
</script>
{% endblock %}