{% extends "base.html" %}

{% block title %}Ativos Imobilizados{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Ativos Imobilizados</h2>
        <div class="d-flex gap-2">
            <a href="{{ url_for('assets.create') }}" class="btn btn-primary"><i class="bi bi-plus-lg"></i> Novo Ativo</a>
            <a href="{{ url_for('assets.transfer') }}" class="btn btn-warning"><i class="bi bi-arrow-left-right"></i> Transferir do Estoque</a>
            <a href="{{ url_for('assets.reconciliation') }}" class="btn btn-info text-white"><i class="bi bi-clipboard-check"></i> Conciliação</a>
            <button class="btn btn-outline-success" onclick="calculateTotalValue()"><i class="bi bi-calculator"></i> Valor Total</button>
            <div class="btn-group">
                <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-clipboard-data"></i> Conferência
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{{ url_for('assets.conference_setup') }}">Nova Conferência</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('assets.conference_history') }}">Histórico</a></li>
                </ul>
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()"><i class="bi bi-file-earmark-excel"></i> Importar Excel</button>
                <button type="button" class="btn btn-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                    <span class="visually-hidden">Toggle Dropdown</span>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{{ url_for('assets.download_template') }}"><i class="bi bi-download"></i> Baixar Modelo</a></li>
                </ul>
            </div>
            <form action="{{ url_for('assets.import_excel') }}" method="POST" enctype="multipart/form-data" style="display:none;">
                <input type="file" id="importFile" name="file" accept=".xlsx, .xls" onchange="this.form.submit()">
            </form>
        </div>
    </div>

    <!-- Alerts -->
    {% if alerts %}
    <div class="mb-4">
        {% for alert in alerts %}
        <div class="alert alert-{{ alert.type }} alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i> {{ alert.msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Search/Filter -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <i class="bi bi-funnel"></i> Filtros
        </div>
        <div class="card-body">
            <form action="{{ url_for('assets.index') }}" method="GET" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="search" class="form-label">Buscar</label>
                    <input type="text" class="form-control" id="search" name="search" value="{{ current_filters.search }}" placeholder="Nome, Patrimônio...">
                </div>
                <div class="col-md-3">
                    <label for="category" class="form-label">Categoria</label>
                    <select class="form-select" id="category" name="category">
                        <option value="Todas">Todas</option>
                        {% for cat in categories %}
                        <option value="{{ cat }}" {% if current_filters.category == cat %}selected{% endif %}>{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="location" class="form-label">Local</label>
                    <select class="form-select" id="location" name="location">
                        <option value="Todos">Todos</option>
                        {% for loc in locations %}
                        <option value="{{ loc }}" {% if current_filters.location == loc %}selected{% endif %}>{{ loc }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i> Filtrar</button>
                        <a href="{{ url_for('assets.index') }}" class="btn btn-outline-secondary btn-sm">Limpar</a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Table -->
    <div class="table-responsive card p-3">
        <table class="table table-hover align-middle" id="assetsTable">
            <thead class="table-light">
                <tr>
                    <th style="width: 40px;"><input type="checkbox" id="selectAll" class="form-check-input"></th>
                    <th>Foto</th>
                    <th>Patrimônio</th>
                    <th>Descrição</th>
                    <th>Categoria</th>
                    <th>Local</th>
                    <th>Responsável</th>
                    <th>Condição</th>
                    <th>Valor Unit.</th>
                    <th>Valor Total</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for asset in assets %}
                <tr>
                    <td><input type="checkbox" class="form-check-input asset-check" value="{{ asset.id }}"></td>
                    <td>
                        {% if asset.image_path %}
                            <a href="{{ asset.image_path }}" target="_blank">
                                <img src="{{ asset.image_path }}" class="img-thumbnail" style="width: 50px; height: 50px; object-fit: cover;">
                            </a>
                        {% else %}
                            <span class="text-muted"><i class="bi bi-image"></i></span>
                        {% endif %}
                    </td>
                    <td><strong>{{ asset.patrimony_number }}</strong></td>
                    <td>{{ asset.description }}</td>
                    <td><span class="badge bg-secondary">{{ asset.category or 'Geral' }}</span></td>
                    <td>{{ asset.location or '-' }}</td>
                    <td>{{ asset.responsible or '-' }}</td>
                    <td>
                        {% if asset.condition == 'Novo' or asset.condition == 'Bom' %}
                            <span class="badge bg-success">{{ asset.condition }}</span>
                        {% elif asset.condition == 'Regular' %}
                            <span class="badge bg-warning text-dark">{{ asset.condition }}</span>
                        {% else %}
                            <span class="badge bg-danger">{{ asset.condition }}</span>
                        {% endif %}
                    </td>
                    <td>R$ {{ "%.2f"|format(asset.acquisition_value) }}</td>
                    <td><strong>R$ {{ "%.2f"|format(asset.acquisition_value * asset.quantity) }}</strong></td>
                    <td>
                        <div class="d-flex gap-1">
                            <a href="{{ url_for('assets.edit', asset_id=asset.id) }}" class="btn btn-sm btn-outline-primary" title="Editar"><i class="bi bi-pencil"></i></a>
                            <button class="btn btn-sm btn-outline-success" onclick="openAdjustModal('add', '{{ asset.id }}', '{{ asset.description|replace("'", "\\'") }}', {{ asset.acquisition_value or 0 }})" title="Nova Compra"><i class="bi bi-cart-plus"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="openAdjustModal('remove', '{{ asset.id }}', '{{ asset.description|replace("'", "\\'") }}', {{ asset.acquisition_value or 0 }})" title="Baixa/Perda"><i class="bi bi-box-arrow-down"></i></button>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="text-center text-muted py-4">Nenhum ativo cadastrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="mt-3">
        <button class="btn btn-outline-dark" onclick="printLabels()"><i class="bi bi-printer"></i> Imprimir Etiquetas Selecionadas (80mm)</button>
    </div>
</div>

<!-- Adjust Modal -->
<div class="modal fade" id="adjustModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="adjustModalTitle">Ajuste de Estoque</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Ativo Selecionado</label>
                    <input type="text" class="form-control" id="adjustAssetName" disabled>
                    <input type="hidden" id="adjustAssetId">
                    <input type="hidden" id="adjustAction">
                </div>
                
                <div class="mb-3" id="adjustDateGroup" style="display:none;">
                    <label class="form-label">Data da Nova Compra</label>
                    <input type="date" class="form-control" id="adjustDate">
                </div>
                
                <div class="mb-3" id="adjustValueGroup" style="display:none;">
                    <label class="form-label">Valor Unitário (R$) - Opcional</label>
                    <input type="number" step="0.01" class="form-control" id="adjustValue" placeholder="Deixe em branco para manter o valor atual">
                </div>
                
                <div class="mb-3" id="adjustJustificationGroup" style="display:none;">
                    <label class="form-label">Justificativa da Baixa</label>
                    <textarea class="form-control" id="adjustJustification" rows="2"></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Quantidade</label>
                    <input type="number" class="form-control" id="adjustQty" min="0.01" step="0.01">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="submitAdjust()">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<script>
    function calculateTotalValue() {
        let rows = document.querySelectorAll('#assetsTable tbody tr');
        let total = 0;
        let count = 0;
        
        rows.forEach(row => {
            if (row.style.display !== 'none') {
                // Get value from the "Valor Total" column (index 9)
                // Format is "R$ 1.234,56" or similar.
                // Assuming format "R$ 1234.56" from backend (%.2f) which uses dot as decimal separator
                let cell = row.cells[9]; 
                if(cell) {
                    let text = cell.innerText.replace('R$', '').trim();
                    let val = parseFloat(text);
                    if (!isNaN(val)) {
                        total += val;
                        count++;
                    }
                }
            }
        });
        
        alert(`Valor Total do Patrimônio (Visível): R$ ${total.toFixed(2)}\nItens Contabilizados: ${count}`);
    }

    document.getElementById('selectAll').addEventListener('change', function() {
        let checkboxes = document.querySelectorAll('.asset-check');
        checkboxes.forEach(cb => cb.checked = this.checked);
    });

    function printLabels() {
        let selected = Array.from(document.querySelectorAll('.asset-check:checked')).map(cb => cb.value);
        if (selected.length === 0) {
            alert('Selecione pelo menos um ativo.');
            return;
        }
        window.open("{{ url_for('assets.print_labels') }}?ids=" + selected.join(','), '_blank');
    }

    function openAdjustModal(action, assetId, assetName, currentValue) {
        document.getElementById('adjustAssetId').value = assetId;
        document.getElementById('adjustAssetName').value = assetName;
        document.getElementById('adjustAction').value = action;
        document.getElementById('adjustQty').value = '';
        
        if (action === 'add') {
            document.getElementById('adjustModalTitle').innerText = 'Registrar Nova Compra';
            document.getElementById('adjustDateGroup').style.display = 'block';
            document.getElementById('adjustValueGroup').style.display = 'block';
            document.getElementById('adjustJustificationGroup').style.display = 'none';
            document.getElementById('adjustDate').value = new Date().toISOString().split('T')[0];
            
            // Set current value as placeholder or value?
            // User said: "caso nao for inserido mantenha". So let's leave value empty but show placeholder.
            let valInput = document.getElementById('adjustValue');
            valInput.value = ''; 
            valInput.placeholder = 'Atual: R$ ' + parseFloat(currentValue).toFixed(2);
            
        } else {
            document.getElementById('adjustModalTitle').innerText = 'Registrar Baixa / Perda';
            document.getElementById('adjustDateGroup').style.display = 'none';
            document.getElementById('adjustValueGroup').style.display = 'none';
            document.getElementById('adjustJustificationGroup').style.display = 'block';
            document.getElementById('adjustJustification').value = '';
        }
        
        new bootstrap.Modal(document.getElementById('adjustModal')).show();
    }
    
    function submitAdjust() {
        let id = document.getElementById('adjustAssetId').value;
        let action = document.getElementById('adjustAction').value;
        let qty = document.getElementById('adjustQty').value;
        let date = document.getElementById('adjustDate').value;
        let just = document.getElementById('adjustJustification').value;
        let val = document.getElementById('adjustValue').value;
        
        if (!qty || parseFloat(qty) <= 0) {
            alert('Informe uma quantidade válida.');
            return;
        }
        
        if (action === 'add' && !date) {
            alert('Informe a data da compra.');
            return;
        }
        
        if (action === 'remove' && !just) {
            alert('Informe a justificativa.');
            return;
        }
        
        fetch("{{ url_for('assets.adjust_quantity') }}", {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                asset_id: id,
                action: action,
                qty: qty,
                date: date,
                justification: just,
                new_value: val // Send new value (can be empty)
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('Ajuste realizado com sucesso.');
                location.reload();
            } else {
                alert('Erro: ' + data.error);
            }
        })
        .catch(err => alert('Erro de comunicação.'));
    }
</script>
{% endblock %}