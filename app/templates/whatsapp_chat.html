{% extends "base.html" %}

{% block title %}Chat WhatsApp - Recepção{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h3><i class="bi bi-whatsapp text-success"></i> Chat WhatsApp Recepção</h3>
            <a href="{{ url_for('reception.reception_dashboard') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    <div class="row" style="height: 75vh;">
        <!-- Conversation List -->
        <div class="col-md-4 col-lg-3 border-end d-flex flex-column h-100">
            <div class="p-2 border-bottom">
                <div class="d-flex gap-2">
                    <input type="text" id="searchContact" class="form-control form-control-sm" placeholder="Buscar conversa...">
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="openNewChatModal()" title="Nova conversa">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
            </div>
            <div class="list-group list-group-flush overflow-auto flex-grow-1" id="conversationList">
                <!-- Loaded via JS -->
                <div class="text-center p-3 text-muted">Carregando conversas...</div>
            </div>
        </div>

        <!-- Chat Window -->
        <div class="col-md-8 col-lg-9 d-flex flex-column h-100 bg-light">
            <!-- Header -->
            <div class="p-2 border-bottom bg-white d-none justify-content-between align-items-center" id="chatHeader">
                <div>
                    <h6 class="mb-0 d-flex align-items-center">
                        <span id="chatHeaderIcon" class="me-2"></span>
                        <span id="chatContactName">Selecione uma conversa</span>
                        <button class="btn btn-sm btn-link text-secondary p-0 ms-2" onclick="editName()" title="Editar Nome">
                            <i class="bi bi-pencil" style="font-size: 0.9rem;"></i>
                        </button>
                    </h6>
                    <small class="text-muted" id="chatContactPhone" style="font-size: 0.8rem;"></small>
                    <div id="chatTags" class="mt-1"></div>
                </div>
                <div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="tagDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-tag"></i> Tags
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="tagDropdown" id="tagDropdownMenu">
                            <!-- Loaded via JS -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Messages Area -->
            <div class="flex-grow-1 overflow-auto p-3" id="messagesArea" style="background-color: #e5ddd5;">
                <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                    Selecione um contato para iniciar o chat
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-2 bg-white border-top" id="inputArea" style="display: none;">
                <div class="input-group">
                    <button class="btn btn-outline-primary" type="button" id="improveBtn" title="Melhorar Gramática">
                        <i class="bi bi-magic"></i>
                    </button>
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="quickRepliesDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false" title="Respostas prontas">
                            <i class="bi bi-chat-square-text"></i>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="quickRepliesDropdownBtn" id="quickRepliesDropdownMenu"></ul>
                    </div>
                    
                    <button class="btn btn-outline-warning" type="button" id="templatesBtn" title="Enviar Template (Iniciar Conversa)">
                        <i class="bi bi-file-earmark-text"></i>
                    </button>

                    <input type="text" id="messageInput" class="form-control" placeholder="Digite sua mensagem...">
                    <button class="btn btn-success" type="button" id="sendBtn">
                        <i class="bi bi-send"></i> Enviar
                    </button>
                </div>
                <small class="text-muted" style="font-size: 0.7rem;">Mensagens enviadas via WhatsApp Cloud API.</small>
            </div>
        </div>
    </div>
</div>

<!-- Tag Management Modal -->
<div class="modal fade" id="tagsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gerenciar Tags</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" id="newTagName" class="form-control" placeholder="Nome da Tag">
                    <input type="color" id="newTagColor" class="form-control form-control-color" value="#6c757d" title="Cor da Tag">
                    <button class="btn btn-success" onclick="addNewTag()">Adicionar</button>
                </div>
                <div class="alert alert-info py-1 px-2 mb-2" style="font-size: 0.85rem;">
                    <i class="bi bi-info-circle"></i> Use as setas para reordenar a prioridade das tags.
                </div>
                <ul class="list-group" id="tagsListConfig">
                    <!-- Dynamic list -->
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Edit Name Modal -->
<div class="modal fade" id="nameModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Nome</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Nome do Contato</label>
                    <input type="text" id="editNameInput" class="form-control" placeholder="Ex: João da Silva">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary btn-sm" onclick="saveName()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- New Chat Modal -->
<div class="modal fade" id="newChatModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nova conversa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Número (WhatsApp)</label>
                    <input type="text" id="newChatPhoneInput" class="form-control" placeholder="Ex: 5511999999999">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success btn-sm" onclick="startNewChat()">Iniciar</button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Replies Modal -->
<div class="modal fade" id="quickRepliesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Respostas prontas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-2">
                    <div class="col-12 col-md-4">
                        <label class="form-label">Título (opcional)</label>
                        <input type="text" id="quickReplyTitle" class="form-control" placeholder="Ex: Horário do café">
                    </div>
                    <div class="col-12 col-md-8">
                        <label class="form-label">Texto</label>
                        <input type="text" id="quickReplyText" class="form-control" placeholder="Ex: Nosso café da manhã é das 7h às 10h.">
                    </div>
                </div>
                <div class="d-flex gap-2 mt-2">
                    <button class="btn btn-success btn-sm" type="button" id="quickReplySaveBtn" onclick="saveQuickReply()">Salvar</button>
                    <button class="btn btn-outline-secondary btn-sm d-none" type="button" id="quickReplyCancelEditBtn" onclick="cancelQuickReplyEdit()">Cancelar edição</button>
                </div>
                <hr class="my-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>Cadastro</strong>
                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="loadQuickReplies()">Atualizar</button>
                </div>
                <div class="list-group" id="quickRepliesList"></div>
            </div>
        </div>
    </div>
</div>

<!-- Templates Modal -->
<div class="modal fade" id="templatesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Enviar Modelo (Template)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="small text-muted">Use templates para iniciar conversas fora da janela de 24 horas.</p>
                <div class="list-group" id="templatesList">
                    <!-- Loaded via JS -->
                </div>
                
                <hr>
                <h6>Configuração Rápida (Adicionar Novo)</h6>
                <div class="input-group mb-2">
                    <input type="text" id="newTemplateName" class="form-control form-control-sm" placeholder="Nome técnico (ex: hello_world)">
                    <input type="text" id="newTemplateLabel" class="form-control form-control-sm" placeholder="Rótulo (ex: Boas vindas)">
                </div>
                <div class="input-group mb-2">
                     <input type="text" id="newTemplateLang" class="form-control form-control-sm" value="pt_BR" placeholder="Idioma (pt_BR)">
                     <button class="btn btn-primary btn-sm" onclick="addNewTemplate()">Adicionar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentPhone = null;
let currentTags = [];
let allTagsConfig = []; // Loaded from backend
let nameModalInstance = null;
let tagsModalInstance = null;
let newChatModalInstance = null;
let quickRepliesModalInstance = null;
let templatesModalInstance = null;
let allTemplates = [];
let quickReplies = [];
let editingQuickReplyId = null;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize Modals
    nameModalInstance = new bootstrap.Modal(document.getElementById('nameModal'));
    tagsModalInstance = new bootstrap.Modal(document.getElementById('tagsModal'));
    newChatModalInstance = new bootstrap.Modal(document.getElementById('newChatModal'));
    quickRepliesModalInstance = new bootstrap.Modal(document.getElementById('quickRepliesModal'));
    templatesModalInstance = new bootstrap.Modal(document.getElementById('templatesModal'));

    document.getElementById('templatesBtn').addEventListener('click', () => {
        loadTemplates();
        templatesModalInstance.show();
    });

    document.getElementById('searchContact').addEventListener('input', function(e) {
        loadConversations();
    });

    loadTagsConfig().then(() => {
        loadQuickReplies();
        loadConversations();

        const urlParams = new URLSearchParams(window.location.search);
        const phoneParam = urlParams.get('phone');
        const messageParam = urlParams.get('message');
        if (phoneParam) {
            const normalized = String(phoneParam).replace(/\D/g, '');
            if (normalized) {
                selectConversation(normalized);
            }
        }
        if (messageParam) {
            const input = document.getElementById('messageInput');
            if (input) {
                input.value = messageParam;
            }
        }
    });

    // Send on Enter
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    
    const newChatPhoneInput = document.getElementById('newChatPhoneInput');
    newChatPhoneInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            startNewChat();
        }
    });

    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    
    document.getElementById('improveBtn').addEventListener('click', function() {
        const input = document.getElementById('messageInput');
        const text = input.value;
        if (!text) return;
        
        const icon = this.querySelector('i');
        const originalClass = icon.className;
        icon.className = 'spinner-border spinner-border-sm';
        
        fetch('/api/chat/improve_text', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({text: text})
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                input.value = data.text;
            }
        })
        .finally(() => {
            icon.className = originalClass;
        });
    });

    // Auto refresh
    setInterval(function() {
        if (currentPhone) {
            loadMessages(currentPhone, false); 
        }
        loadConversations();
    }, 10000); // 10s
});

// --- Tags Management ---

function addNewTemplate() {
    const name = document.getElementById('newTemplateName').value.trim();
    const label = document.getElementById('newTemplateLabel').value.trim();
    const lang = document.getElementById('newTemplateLang').value.trim() || 'pt_BR';
    
    if (!name || !label) {
        alert('Nome e Rótulo são obrigatórios');
        return;
    }
    
    const newTpl = { name, label, language: lang };
    const updated = [...allTemplates, newTpl];
    
    fetch('/api/chat/templates', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(updated)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadTemplates();
            document.getElementById('newTemplateName').value = '';
            document.getElementById('newTemplateLabel').value = '';
        } else {
            alert('Erro ao salvar: ' + (data.message || data.error));
        }
    });
}

function loadTemplates() {
    fetch('/api/chat/templates')
        .then(r => r.json())
        .then(data => {
            allTemplates = data.templates || [];
            renderTemplates();
        });
}

function renderTemplates() {
    const list = document.getElementById('templatesList');
    list.innerHTML = '';
    
    if (allTemplates.length === 0) {
        list.innerHTML = '<div class="text-muted small">Nenhum template configurado.</div>';
        return;
    }
    
    allTemplates.forEach(tpl => {
        const item = document.createElement('a');
        item.href = '#';
        item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
        item.innerHTML = `
            <div>
                <strong>${tpl.label}</strong><br>
                <small class="text-muted">${tpl.name} (${tpl.language})</small>
            </div>
            <button class="btn btn-sm btn-primary">Enviar</button>
        `;
        item.querySelector('button').onclick = (e) => {
            e.preventDefault();
            sendTemplate(tpl);
        };
        list.appendChild(item);
    });
}

function sendTemplate(tpl) {
    if (!currentPhone) return;
    
    if (!confirm(`Enviar template "${tpl.label}" para ${currentPhone}?`)) return;
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    btn.disabled = true;
    
    fetch('/api/chat/send_template', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            phone: currentPhone,
            template_name: tpl.name,
            language_code: tpl.language
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            templatesModalInstance.hide();
            loadMessages(currentPhone, true);
        } else {
            alert('Erro ao enviar: ' + (data.message || 'Erro desconhecido'));
        }
    })
    .catch(err => alert('Erro de conexão'))
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

function normalizePhoneForChat(value) {
    let digits = String(value || '').replace(/\D/g, '');
    if (!digits) return '';
    // Fix: Ensure we don't double-prefix if user types 5511...
    // But simplistic check might fail if local number starts with 55 (rare).
    // Standard rule: 10 or 11 digits -> add 55. 12 or 13 digits (starting with 55) -> keep.
    if (digits.length === 10 || digits.length === 11) {
        digits = `55${digits}`;
    }
    return digits;
}

function openNewChatModal() {
    const input = document.getElementById('newChatPhoneInput');
    input.value = '';
    newChatModalInstance.show();
    setTimeout(() => input.focus(), 150);
}

function startNewChat() {
    const input = document.getElementById('newChatPhoneInput');
    const phone = normalizePhoneForChat(input.value);
    if (!phone) {
        alert('Informe um número válido.');
        input.focus();
        return;
    }
    newChatModalInstance.hide();
    selectConversation(phone);
    const msgInput = document.getElementById('messageInput');
    if (msgInput) {
        msgInput.focus();
    }
}

function loadTagsConfig() {
    return fetch('/api/chat/tags_config')
        .then(r => r.json())
        .then(data => {
            allTagsConfig = data.tags || [];
            updateTagDropdown();
            updateTagsConfigList();
        });
}

function updateTagDropdown() {
    const menu = document.getElementById('tagDropdownMenu');
    let html = '';
    
    allTagsConfig.forEach(tag => {
        const safeName = tag.name.replace(/'/g, "\\'");
        // Check if tag is active
        const isActive = currentTags.includes(tag.name);
        const checkMark = isActive ? '<i class="bi bi-check me-1"></i>' : '';
        const activeClass = isActive ? 'active' : '';
        
        html += `<li><a class="dropdown-item ${activeClass}" href="#" onclick="event.preventDefault(); event.stopPropagation(); toggleTag('${safeName}')">
            ${checkMark}<span class="badge" style="background-color: ${tag.color}">${tag.name}</span>
        </a></li>`;
    });
    
    html += `<li><hr class="dropdown-divider"></li>`;
    html += `<li><a class="dropdown-item" href="#" onclick="event.preventDefault(); openTagsModal()">
        <i class="bi bi-gear"></i> Gerenciar Tags
    </a></li>`;
    
    menu.innerHTML = html;
}

function openTagsModal() {
    tagsModalInstance.show();
}

function updateTagsConfigList() {
    const list = document.getElementById('tagsListConfig');
    let html = '';
    
    allTagsConfig.forEach((tag, index) => {
        html += `
        <li class="list-group-item d-flex justify-content-between align-items-center p-2">
            <div class="d-flex align-items-center">
                <input type="color" class="form-control form-control-color form-control-sm me-2" value="${tag.color}" onchange="updateTagColor(${index}, this.value)" title="Mudar cor">
                <input type="text" class="form-control form-control-sm border-0" value="${tag.name}" onchange="updateTagName(${index}, this.value)" style="width: 150px;">
            </div>
            <div>
                <button class="btn btn-sm btn-outline-secondary py-0 px-1" onclick="moveTag(${index}, -1)" ${index === 0 ? 'disabled' : ''} title="Subir">▲</button>
                <button class="btn btn-sm btn-outline-secondary py-0 px-1" onclick="moveTag(${index}, 1)" ${index === allTagsConfig.length - 1 ? 'disabled' : ''} title="Descer">▼</button>
                <button class="btn btn-sm btn-outline-danger py-0 px-1 ms-1" onclick="deleteTag(${index})" title="Remover">×</button>
            </div>
        </li>
        `;
    });
    
    list.innerHTML = html;
}

function addNewTag() {
    const nameInput = document.getElementById('newTagName');
    const colorInput = document.getElementById('newTagColor');
    const name = nameInput.value.trim();
    const color = colorInput.value;
    
    if (!name) return;
    
    allTagsConfig.push({name, color});
    nameInput.value = '';
    
    saveTagsConfig();
}

function deleteTag(index) {
    if (confirm('Tem certeza que deseja remover esta tag?')) {
        allTagsConfig.splice(index, 1);
        saveTagsConfig();
    }
}

function moveTag(index, direction) {
    if (direction === -1 && index > 0) {
        // Move Up
        [allTagsConfig[index], allTagsConfig[index - 1]] = [allTagsConfig[index - 1], allTagsConfig[index]];
    } else if (direction === 1 && index < allTagsConfig.length - 1) {
        // Move Down
        [allTagsConfig[index], allTagsConfig[index + 1]] = [allTagsConfig[index + 1], allTagsConfig[index]];
    }
    saveTagsConfig();
}

function updateTagColor(index, newColor) {
    allTagsConfig[index].color = newColor;
    saveTagsConfig();
}

function updateTagName(index, newName) {
    if (!newName.trim()) return;
    allTagsConfig[index].name = newName.trim();
    saveTagsConfig();
}

function saveTagsConfig() {
    // Update UI immediately
    updateTagsConfigList();
    updateTagDropdown();
    loadConversations(); // Re-render groups
    
    fetch('/api/chat/tags_config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({tags: allTagsConfig})
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success) {
            alert('Erro ao salvar tags: ' + (data.error || 'Erro desconhecido'));
        }
    });
}

// --- Conversation List & Chat ---

function loadConversations() {
    const search = document.getElementById('searchContact').value.toLowerCase();
    
    fetch('/api/chat/conversations')
        .then(r => r.json())
        .then(conversations => {
            const list = document.getElementById('conversationList');
            
            if (conversations.length === 0) {
                list.innerHTML = '<div class="text-center p-3 text-muted">Nenhuma conversa iniciada.</div>';
                return;
            }

            // Filter if searching
            if (search) {
                conversations = conversations.filter(c => 
                    c.phone.includes(search) || 
                    (c.name && c.name.toLowerCase().includes(search)) ||
                    (c.last_message && c.last_message.content && c.last_message.content.toLowerCase().includes(search))
                );
            }

            // Grouping Logic based on Priority (allTagsConfig order)
            const groups = {};
            // Initialize groups in order
            allTagsConfig.forEach(tag => {
                groups[tag.name] = [];
            });
            groups['Outros'] = [];

            conversations.forEach(conv => {
                let assigned = false;
                
                const tagName = (conv.tags && conv.tags.length > 0) ? conv.tags[0] : null;
                if (tagName && groups[tagName]) {
                    groups[tagName].push(conv);
                    assigned = true;
                }
                
                // If not assigned to any known tag, put in Outros
                
                if (!assigned) {
                    groups['Outros'].push(conv);
                }
            });

            let html = '';
            
            // Render groups in order
            const orderedGroupNames = [...allTagsConfig.map(t => t.name), 'Outros'];
            
            orderedGroupNames.forEach(groupName => {
                const convs = groups[groupName];
                if (!convs || convs.length === 0) return;
                
                // Sort conversations within group by date desc
                convs.sort((a, b) => {
                    const tA = a.last_message ? new Date(a.last_message.timestamp).getTime() : 0;
                    const tB = b.last_message ? new Date(b.last_message.timestamp).getTime() : 0;
                    return tB - tA;
                });

                html += `
                <div class="bg-light px-2 py-1 border-bottom border-top fw-bold text-uppercase d-flex justify-content-between align-items-center text-secondary" style="font-size: 0.7rem; background-color: #f8f9fa;">
                    ${groupName}
                    <span class="badge bg-secondary rounded-pill" style="font-size: 0.6em;">${convs.length}</span>
                </div>
                `;
                
                convs.forEach(conv => {
                    const activeClass = (currentPhone === conv.phone) ? 'active' : '';
                    const lastMsg = conv.last_message ? conv.last_message.content : '';
                    const timestamp = conv.last_message ? new Date(conv.last_message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                    const isUnread = conv.last_message && conv.last_message.type === 'received';
                    let displayName = conv.name || conv.phone; // Show name if available
                    
                    if (conv.channel === 'facebook' && !conv.name) {
                        displayName = "Facebook User";
                    }

                    // Channel Icon
                    let channelIcon = '<i class="bi bi-whatsapp text-success me-1"></i>';
                    if (conv.channel === 'facebook') {
                        channelIcon = '<i class="bi bi-messenger text-primary me-1"></i>';
                    }
                    
                    let tagHtml = '';
                    const tName = (conv.tags && conv.tags.length > 0) ? conv.tags[0] : '';
                    if (tName) {
                        const tConfig = allTagsConfig.find(t => t.name === tName);
                        const color = tConfig ? tConfig.color : '#6c757d';
                        tagHtml = `<span class="badge" style="background-color: ${color}; font-size: 0.7em; padding: 2px 5px; white-space: nowrap;">${tName}</span>`;
                    }

                    // Compact Item
                    html += `
                    <a href="#" class="list-group-item list-group-item-action ${activeClass} p-2 border-bottom-0" onclick="selectConversation('${conv.phone}', '${conv.channel || 'whatsapp'}')" style="font-size: 0.85rem;">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <strong class="text-truncate d-flex align-items-center flex-grow-1" style="max-width: 60%; font-size: 0.9rem; color: #333;">
                                ${isUnread ? '<span class="text-danger me-1">●</span>' : ''}
                                ${channelIcon}
                                <span class="text-truncate" title="${displayName}">${displayName}</span>
                            </strong>
                            <div class="d-flex align-items-center justify-content-end" style="max-width: 40%;">
                                ${tagHtml}
                            </div>
                        </div>
                    </a>
                    `;
                });
            });
            
            list.innerHTML = html;
        });
}

// --- Name Editing ---

function editName() {
    if (!currentPhone) return;
    
    // Get current name
    const currentName = document.getElementById('chatContactName').innerText;
    // If it's the phone number, empty the input
    const isPhone = currentName.replace(/\D/g, '') === currentPhone;
    
    document.getElementById('editNameInput').value = isPhone ? '' : currentName;
    nameModalInstance.show();
}

function saveName() {
    const name = document.getElementById('editNameInput').value.trim();
    if (!currentPhone) {
        console.error('saveName: No currentPhone set');
        return;
    }
    
    fetch('/api/chat/name', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            phone: currentPhone,
            name: name
        })
    })
    .then(r => {
        if (!r.ok) throw new Error('Network response was not ok: ' + r.statusText);
        return r.json();
    })
    .then(data => {
        if (data.success) {
            nameModalInstance.hide();
            // Update UI
            document.getElementById('chatContactName').innerText = name || currentPhone;
            loadConversations(); // Refresh list to show new name
        } else {
            console.error('Save name failed:', data);
            alert('Erro ao salvar nome: ' + (data.message || 'Erro desconhecido'));
        }
    })
    .catch(err => {
        console.error('Error saving name:', err);
        alert('Erro de conexão ao salvar nome.');
    });
}

let currentChannel = 'whatsapp';

function selectConversation(phone, channel = 'whatsapp') {
    currentPhone = phone;
    currentChannel = channel;
    
    const header = document.getElementById('chatHeader');
    header.classList.remove('d-none');
    header.classList.add('d-flex');
    document.getElementById('inputArea').style.display = 'block';
    
    // Update Header Icon
    const headerIcon = document.getElementById('chatHeaderIcon');
    if (headerIcon) {
        if (channel === 'facebook') {
            headerIcon.innerHTML = '<i class="bi bi-messenger text-primary"></i>';
        } else {
            headerIcon.innerHTML = '<i class="bi bi-whatsapp text-success"></i>';
        }
    }
    
    document.getElementById('chatContactName').innerText = phone;
    document.getElementById('chatContactPhone').innerText = phone;
    
    loadMessages(phone, true);
    loadTagsAndName(phone);
    loadConversations(); // Update active state
}

function loadTagsAndName(phone) {
    fetch(`/api/chat/tags/${phone}`)
        .then(r => r.json())
        .then(data => {
            currentTags = Array.isArray(data.tags) ? data.tags.slice(0, 1) : [];
            if (data.name) {
                document.getElementById('chatContactName').innerText = data.name;
            } else if (currentChannel === 'facebook') {
                document.getElementById('chatContactName').innerText = "Facebook User";
            }
            renderTags();
            updateTagDropdown();
        });
}

function sendMessage() {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    if (!text || !currentPhone) return;

    // Optimistic UI
    const container = document.getElementById('messagesContainer');
    const tempId = 'temp-' + Date.now();
    const tempMsg = {
        type: 'sent',
        content: text,
        timestamp: new Date().toISOString(),
        status: 'sent', // Optimistic
        id: tempId
    };
    
    // Use renderMessage logic or simplified
    // We can just append a sent message
    // Ideally we re-use the rendering logic but it's embedded in loadMessages usually.
    // Let's just force reload for simplicity as per existing code structure or enhance.
    // Existing `loadMessages` clears container? Yes usually.
    
    // Send
    fetch('/api/chat/send', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            phone: currentPhone,
            message: text,
            channel: currentChannel
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            input.value = '';
            loadMessages(currentPhone, true);
            loadConversations();
        } else {
            alert('Erro ao enviar: ' + (data.message || 'Erro desconhecido'));
        }
    })
    .catch(err => {
        console.error(err);
        alert('Erro de conexão');
    });
}

// ... existing message/tag functions ...

function escapeHtml(value) {
    return String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

function renderMessageContent(msg) {
    const caption = msg.caption ? `<div class="mt-1" style="font-size: 0.85rem;">${escapeHtml(msg.caption)}</div>` : '';
    if (msg.media_id && msg.media_type) {
        const src = `/api/chat/media/${encodeURIComponent(msg.media_id)}`;
        if (msg.media_type === 'audio') {
            return `<audio controls style="width: 100%;" src="${src}"></audio>${caption}`;
        }
        if (msg.media_type === 'video') {
            return `<video controls style="max-width: 100%;" src="${src}"></video>${caption}`;
        }
        if (msg.media_type === 'image') {
            return `<img src="${src}" style="max-width: 100%; border-radius: 10px;" />${caption}`;
        }
        if (msg.media_type === 'document') {
            const name = msg.filename ? escapeHtml(msg.filename) : 'Abrir documento';
            return `<a href="${src}" target="_blank" rel="noopener">${name}</a>${caption}`;
        }
    }
    return `<p class="mb-0" style="font-size: 0.9rem;">${escapeHtml(msg.content)}</p>`;
}

function loadMessages(phone, scroll) {
    fetch(`/api/chat/history/${phone}`)
        .then(r => r.json())
        .then(msgs => {
            const area = document.getElementById('messagesArea');
            let html = '';
            
            msgs.forEach(msg => {
                const isSent = msg.type === 'sent';
                const align = isSent ? 'end' : 'start';
                const bg = isSent ? 'bg-success text-white' : 'bg-white';
                const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                html += `
                <div class="d-flex justify-content-${align} mb-2">
                    <div class="card ${bg} shadow-sm" style="max-width: 70%; border-radius: 15px;">
                        <div class="card-body py-2 px-3 position-relative">
                            ${renderMessageContent(msg)}
                            <div class="d-flex justify-content-between align-items-center mt-1">
                                <div class="text-${isSent ? 'light' : 'muted'} small" style="font-size: 0.65rem;">${time}</div>
                                <button class="btn btn-sm btn-link p-0 ms-2 text-${isSent ? 'light' : 'secondary'}" onclick="deleteMessage('${msg.id || ''}', '${msg.timestamp}')" title="Excluir mensagem" style="font-size: 0.8rem; text-decoration: none; opacity: 0.7;">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            });
            
            if (msgs.length === 0) {
                html = '<div class="text-center p-3 text-muted">Inicie a conversa...</div>';
            }
            
            if (area.innerHTML !== html) {
                 area.innerHTML = html;
                 if (scroll) scrollToBottom();
            }
        });
}

function deleteMessage(messageId, timestamp) {
    if (!confirm('Tem certeza que deseja excluir esta mensagem? Esta ação será registrada.')) {
        return;
    }
    
    // Fallback if ID is missing (legacy messages)
    const identifier = messageId || timestamp;
    
    if (!identifier) {
        alert('Não foi possível identificar a mensagem para exclusão.');
        return;
    }

    fetch('/api/chat/delete_message', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            phone: currentPhone,
            message_id: identifier
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Reload messages
            loadMessages(currentPhone, false);
        } else {
            alert('Erro ao excluir: ' + (data.message || 'Erro desconhecido'));
        }
    })
    .catch(err => {
        console.error(err);
        alert('Erro de conexão');
    });
}

// Removed duplicate sendMessage function

function loadQuickReplies() {
    return fetch('/api/chat/quick_replies')
        .then(r => r.json())
        .then(data => {
            quickReplies = Array.isArray(data.items) ? data.items : [];
            renderQuickRepliesDropdown();
            renderQuickRepliesList();
        });
}

function renderQuickRepliesDropdown() {
    const menu = document.getElementById('quickRepliesDropdownMenu');
    let html = '';

    if (!quickReplies || quickReplies.length === 0) {
        html += '<li><span class="dropdown-item-text text-muted">Nenhuma resposta cadastrada</span></li>';
    } else {
        quickReplies.forEach(item => {
            const title = (item.title || '').trim();
            const display = title || (item.text || '').trim().slice(0, 60);
            html += `<li><a class="dropdown-item" href="#" onclick="event.preventDefault(); applyQuickReply('${String(item.id).replace(/'/g, "\\'")}')">${escapeHtml(display)}</a></li>`;
        });
    }

    html += `<li><hr class="dropdown-divider"></li>`;
    html += `<li><a class="dropdown-item" href="#" onclick="event.preventDefault(); openQuickRepliesModal()"><i class="bi bi-gear"></i> Gerenciar respostas</a></li>`;
    menu.innerHTML = html;
}

function openQuickRepliesModal() {
    loadQuickReplies().finally(() => {
        quickRepliesModalInstance.show();
        const input = document.getElementById('quickReplyText');
        if (input) {
            setTimeout(() => input.focus(), 150);
        }
    });
}

function applyQuickReply(replyId) {
    const item = (quickReplies || []).find(r => String(r.id) === String(replyId));
    if (!item) return;
    const input = document.getElementById('messageInput');
    if (!input) return;
    input.value = item.text || '';
    input.focus();
}

function renderQuickRepliesList() {
    const container = document.getElementById('quickRepliesList');
    if (!container) return;

    if (!quickReplies || quickReplies.length === 0) {
        container.innerHTML = '<div class="text-muted">Nenhuma resposta cadastrada.</div>';
        return;
    }

    const sorted = quickReplies.slice().sort((a, b) => {
        const tA = ((a.title || '') || (a.text || '')).toLowerCase();
        const tB = ((b.title || '') || (b.text || '')).toLowerCase();
        return tA.localeCompare(tB);
    });

    let html = '';
    sorted.forEach(item => {
        const title = (item.title || '').trim();
        const text = (item.text || '').trim();
        const header = title ? `<div class="fw-semibold">${escapeHtml(title)}</div>` : '';
        html += `
            <div class="list-group-item d-flex justify-content-between align-items-start">
                <div class="me-2">
                    ${header}
                    <div class="text-muted" style="font-size: 0.9rem;">${escapeHtml(text)}</div>
                </div>
                <div class="d-flex gap-1">
                    <button class="btn btn-outline-primary btn-sm" type="button" onclick="startQuickReplyEdit('${String(item.id).replace(/'/g, "\\'")}')">Editar</button>
                    <button class="btn btn-outline-danger btn-sm" type="button" onclick="deleteQuickReply('${String(item.id).replace(/'/g, "\\'")}')">Excluir</button>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

function startQuickReplyEdit(replyId) {
    const item = (quickReplies || []).find(r => String(r.id) === String(replyId));
    if (!item) return;
    editingQuickReplyId = String(item.id);
    document.getElementById('quickReplyTitle').value = item.title || '';
    document.getElementById('quickReplyText').value = item.text || '';
    document.getElementById('quickReplySaveBtn').innerText = 'Atualizar';
    document.getElementById('quickReplyCancelEditBtn').classList.remove('d-none');
    setTimeout(() => document.getElementById('quickReplyText').focus(), 100);
}

function cancelQuickReplyEdit() {
    editingQuickReplyId = null;
    document.getElementById('quickReplyTitle').value = '';
    document.getElementById('quickReplyText').value = '';
    document.getElementById('quickReplySaveBtn').innerText = 'Salvar';
    document.getElementById('quickReplyCancelEditBtn').classList.add('d-none');
}

function saveQuickReply() {
    const title = document.getElementById('quickReplyTitle').value.trim();
    const text = document.getElementById('quickReplyText').value.trim();
    if (!text) {
        alert('Informe o texto da resposta.');
        document.getElementById('quickReplyText').focus();
        return;
    }

    const isEditing = Boolean(editingQuickReplyId);
    const url = isEditing ? `/api/chat/quick_replies/${encodeURIComponent(editingQuickReplyId)}` : '/api/chat/quick_replies';
    const method = isEditing ? 'PUT' : 'POST';

    fetch(url, {
        method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({title, text})
    })
    .then(r => r.json().then(data => ({ok: r.ok, data})))
    .then(({ok, data}) => {
        if (!ok || !data.success) {
            alert(data.message || 'Erro ao salvar resposta.');
            return;
        }
        cancelQuickReplyEdit();
        loadQuickReplies();
    })
    .catch(() => {
        alert('Erro de conexão ao salvar resposta.');
    });
}

function deleteQuickReply(replyId) {
    if (!confirm('Excluir esta resposta pronta?')) return;
    fetch(`/api/chat/quick_replies/${encodeURIComponent(replyId)}`, { method: 'DELETE' })
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                alert('Não foi possível excluir.');
                return;
            }
            if (editingQuickReplyId && String(editingQuickReplyId) === String(replyId)) {
                cancelQuickReplyEdit();
            }
            loadQuickReplies();
        })
        .catch(() => {
            alert('Erro de conexão ao excluir.');
        });
}

function scrollToBottom() {
    const area = document.getElementById('messagesArea');
    area.scrollTop = area.scrollHeight;
}

function renderTags() {
    const container = document.getElementById('chatTags');
    let html = '';
    currentTags.forEach(tagName => {
        const tConfig = allTagsConfig.find(t => t.name === tagName);
        const color = tConfig ? tConfig.color : '#6c757d';
        html += `<span class="badge me-1" style="background-color: ${color}; font-size: 0.85em;">${tagName}</span>`;
    });
    container.innerHTML = html;
}

function toggleTag(tag) {
    if (!currentPhone) return;
    
    const current = (Array.isArray(currentTags) && currentTags.length > 0) ? currentTags[0] : '';
    currentTags = (current === tag) ? [] : [tag];
    
    renderTags();
    updateTagDropdown(); // Update checkmarks
    
    fetch('/api/chat/tags', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            phone: currentPhone,
            tags: currentTags
        })
    }).then(r => r.json())
      .then(data => {
          loadConversations();
      });
}

function formatPhone(phone) {
    return phone; 
}
</script>
{% endblock %}
