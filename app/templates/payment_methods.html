{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-credit-card-2-front"></i> Formas de Pagamento</h2>
        <a href="{{ url_for('main.index') }}" class="btn btn-secondary" style="min-width: 44px; min-height: 44px; display: inline-flex; align-items: center; justify-content: center;" aria-label="Voltar">
            <i class="bi bi-arrow-left"></i> Voltar
        </a>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Adicionar Nova</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <input type="hidden" name="action" value="add">
                        <div class="mb-3">
                            <label class="form-label">Nome da Forma de Pagamento</label>
                            <input type="text" class="form-control" name="name" required placeholder="Ex: Voucher">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label d-block">Disponível em:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="available_restaurant" id="addRest" checked>
                                <label class="form-check-label" for="addRest">Caixa Restaurante</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="available_reception" id="addRec" checked>
                                <label class="form-check-label" for="addRec">Caixa Recepção</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="available_reservas" id="addRes" checked>
                                <label class="form-check-label" for="addRes">Caixa Reservas</label>
                            </div>
                        </div>

                        <hr>
                        <h6 class="mb-3">Configuração Fiscal</h6>
                        
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="is_fiscal" id="addIsFiscal" onchange="toggleCnpjInput('add')">
                                <label class="form-check-label" for="addIsFiscal">Emitir Nota Fiscal (NFC-e)</label>
                            </div>
                        </div>

                        <div class="mb-3" id="addCnpjContainer" style="display: none;">
                            <label class="form-label">CNPJ Emissor</label>
                            <select class="form-select" name="fiscal_cnpj" id="addFiscalCnpj">
                                <option value="">Selecione um CNPJ...</option>
                                {% for fi in fiscal_integrations %}
                                <option value="{{ fi.cnpj_emitente }}">{{ fi.cnpj_emitente }} ({{ fi.provider }})</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">CNPJ que emitirá a nota para esta forma de pagamento.</div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-plus-circle"></i> Adicionar
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Formas de Pagamento Cadastradas</h5>
                </div>
                <div class="card-body">
                    {% if methods %}
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Nome</th>
                                        <th>Disponibilidade</th>
                                        <th class="text-end">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for method in methods %}
                                        {% set av = method.available_in or [] %}
                                        {% set is_rest = 'restaurant' in av or 'caixa_restaurante' in av %}
                                        {% set is_rec = 'reception' in av or 'caixa_recepcao' in av %}
                                        {% set is_res = 'reservas' in av or 'caixa_reservas' in av %}
                                        {% set is_fiscal = method.is_fiscal if method.is_fiscal is defined else false %}
                                        <tr>
                                            <td>
                                                <i class="bi bi-credit-card me-2 text-muted"></i>
                                                {{ method.name }}
                                                {% if is_fiscal %}
                                                    <span class="badge bg-warning text-dark ms-2" title="Emissão Fiscal Ativa: {{ method.fiscal_cnpj }}">
                                                        <i class="bi bi-receipt"></i> Fiscal
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if is_rest %}
                                                <span class="badge bg-success me-1">Restaurante</span>
                                                {% endif %}
                                                {% if is_rec %}
                                                <span class="badge bg-info text-dark me-1">Recepção</span>
                                                {% endif %}
                                                {% if is_res %}
                                                <span class="badge bg-primary">Reservas</span>
                                                {% endif %}
                                                
                                                {% if not is_rest and not is_rec and not is_res %}
                                                <span class="badge bg-secondary">Indisponível</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-end">
                                                <div class="table-actions justify-content-end" style="display: flex; gap: 5px;">
                                                    <button type="button" class="btn btn-outline-primary btn-sm" 
                                                            style="min-width: 44px; min-height: 44px; display: inline-flex; align-items: center; justify-content: center;"
                                                            data-id="{{ method.id }}"
                                                            data-name="{{ method.name }}"
                                                            data-rest="{{ 'true' if is_rest else 'false' }}"
                                                            data-rec="{{ 'true' if is_rec else 'false' }}"
                                                            data-res="{{ 'true' if is_res else 'false' }}"
                                                            data-fiscal="{{ 'true' if is_fiscal else 'false' }}"
                                                            data-cnpj="{{ method.fiscal_cnpj|default('') }}"
                                                            onclick="openEditModal(this)"
                                                            aria-label="Editar">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <form method="POST" onsubmit="return confirm('Tem certeza que deseja remover esta forma de pagamento?');" class="d-inline">
                                                        <input type="hidden" name="action" value="delete">
                                                        <input type="hidden" name="id" value="{{ method.id }}">
                                                        <button type="submit" class="btn btn-outline-danger btn-sm" style="min-width: 44px; min-height: 44px; display: inline-flex; align-items: center; justify-content: center;" aria-label="Excluir">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-wallet2 fs-1 mb-2"></i>
                            <p>Nenhuma forma de pagamento cadastrada.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editMethodModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Forma de Pagamento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="action" value="edit">
                    <input type="hidden" name="id" id="editMethodId">
                    <div class="mb-3">
                        <label class="form-label">Nome</label>
                        <input type="text" class="form-control" name="name" id="editMethodName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label d-block">Disponível em:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="available_restaurant" id="editRest">
                            <label class="form-check-label" for="editRest">Caixa Restaurante</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="available_reception" id="editRec">
                            <label class="form-check-label" for="editRec">Caixa Recepção</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="available_reservas" id="editRes">
                            <label class="form-check-label" for="editRes">Caixa Reservas</label>
                        </div>
                    </div>

                    <hr>
                    <h6 class="mb-3">Configuração Fiscal</h6>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="is_fiscal" id="editIsFiscal" onchange="toggleCnpjInput('edit')">
                            <label class="form-check-label" for="editIsFiscal">Emitir Nota Fiscal (NFC-e)</label>
                        </div>
                    </div>

                    <div class="mb-3" id="editCnpjContainer" style="display: none;">
                        <label class="form-label">CNPJ Emissor</label>
                        <select class="form-select" name="fiscal_cnpj" id="editFiscalCnpj">
                            <option value="">Selecione um CNPJ...</option>
                            {% for fi in fiscal_integrations %}
                            <option value="{{ fi.cnpj_emitente }}">{{ fi.cnpj_emitente }} ({{ fi.provider }})</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">CNPJ que emitirá a nota para esta forma de pagamento.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="min-width: 44px; min-height: 44px; display: inline-flex; align-items: center; justify-content: center;" aria-label="Cancelar">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="min-width: 44px; min-height: 44px; display: inline-flex; align-items: center; justify-content: center;" aria-label="Salvar Alterações">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function toggleCnpjInput(prefix) {
        const isFiscal = document.getElementById(prefix + 'IsFiscal').checked;
        const container = document.getElementById(prefix + 'CnpjContainer');
        container.style.display = isFiscal ? 'block' : 'none';
    }

    function openEditModal(button) {
        const id = button.getAttribute('data-id');
        const name = button.getAttribute('data-name');
        const isRest = button.getAttribute('data-rest') === 'true';
        const isRec = button.getAttribute('data-rec') === 'true';
        const isRes = button.getAttribute('data-res') === 'true';
        const isFiscal = button.getAttribute('data-fiscal') === 'true';
        const fiscalCnpj = button.getAttribute('data-cnpj');

        document.getElementById('editMethodId').value = id;
        document.getElementById('editMethodName').value = name;
        document.getElementById('editRest').checked = isRest;
        document.getElementById('editRec').checked = isRec;
        document.getElementById('editRes').checked = isRes;
        
        // Fiscal fields
        document.getElementById('editIsFiscal').checked = isFiscal;
        document.getElementById('editFiscalCnpj').value = fiscalCnpj;
        
        toggleCnpjInput('edit'); // Initialize visibility
        
        var modal = new bootstrap.Modal(document.getElementById('editMethodModal'));
        modal.show();
    }
</script>
{% endblock %}